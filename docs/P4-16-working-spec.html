<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>P416 Language Specification : The P4 Language Consortium</title>
<style>
@import url(//cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.0/css/font-awesome.css);
/* normalize.css v2.1.1 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address styling not present in IE 8/9. */
[hidden] { display: none; }

/* ========================================================================== Base ========================================================================== */
/** 1. Prevent system color scheme's background color being used in Firefox, IE, and Opera. 2. Prevent system color scheme's text color being used in Firefox, IE, and Opera. 3. Set default font family to sans-serif. 4. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { background: #fff; /* 1 */ color: #000; /* 2 */ font-family: sans-serif; /* 3 */ -ms-text-size-adjust: 100%; /* 4 */ -webkit-text-size-adjust: 100%; /* 4 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 15px; }

body { background: white; color: #0a0a0a; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

a:focus { outline: none; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.23333em; line-height: 1.6; }

.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #030303; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #4183c4; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #4183c4; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: helvetica, arial, freesans, clean, sans-serif; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.93333em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: helvetica, arial, freesans, clean, sans-serif; font-weight: bold; font-style: normal; color: #333333; text-rendering: optimizeLegibility; margin-top: 0.2em; margin-bottom: 0.5em; line-height: 1.2em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: gray; line-height: 0; }

h1 { font-size: 1.33333em; }

h2 { font-size: 0.93333em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 0.86667em; }

h4 { font-size: 0.66667em; }

h5 { font-size: 1em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.33333em 0 1.26667em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Monaco, "DejaVu Sans Mono", "Courier New", monospace; font-weight: normal; color: #B12146; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1em; list-style-position: outside; font-family: helvetica, arial, freesans, clean, sans-serif; }

ul, ol { margin-left: 0.7em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.33333em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }


/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.33333em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.33333em; font-weight: bold; }
dl dd { margin-bottom: 1.33333em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #030303; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1em; padding: 0; border-left: none; }
blockquote cite { display: block; font-size: 0.86667em; color: #030303; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #030303; }

blockquote, blockquote p { line-height: 1.4; color: #030303; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.33333em 0; border: 1px solid #dddddd; padding: 0.66667em 0.8em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 1em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.06667em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2em; }
  h2 { font-size: 1.6em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.2em; }
  h4 { font-size: 1em; } }
/* Print styles.  Inlined to avoid required HTTP connection: www.phpied.com/delay-loading-your-print-css/ Credit to Paul Irish and HTML5 Boilerplate (html5boilerplate.com)
*/
.print-only { display: none !important; }

@media print { * { background: transparent !important; color: #000 !important; /* Black prints faster: h5bp.com/s */ box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999999; page-break-inside: avoid; }
  thead { display: table-header-group; /* h5bp.com/t */ }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
/* Tables */
table { background: white; margin-bottom: 1.33333em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.53333em 0.66667em 0.66667em; font-size: 0.93333em; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.6em 0.66667em; font-size: 0.8em; color: black; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

a:hover, a:focus { text-decoration: underline; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: 0.86667em; padding: 1px 5px 1px 5px; white-space: nowrap; background-color: transparent; border: 1px solid #dddddd; -webkit-border-radius: 3px; border-radius: 3px; text-shadow: none; }

pre, pre > code { line-height: 1.6; color: black; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }

kbd.keyseq { color: black; }

kbd:not(.keyseq) { display: inline-block; color: black; font-size: 0.8em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

kbd kbd:first-child { margin-left: 0; }

kbd kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #1a1a1a; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 66.66667em; *zoom: 1; position: relative; padding-left: 1em; padding-right: 1em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#header { margin-bottom: 2.66667em;}
#header > h1 { color: #030303; font-weight: 300;  border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; text-align: center; }
#header span { color: #030303;}
#header #revnumber { text-align: center; text-transform: capitalize;}
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }

#toc { border-bottom: 0 solid #dddddd; padding-bottom: 1.33333em; }
#toc > ul { margin-left: 0.26667em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }

#toctitle { color: #030303; }

@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #dddddd; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul { font-size: .95em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1.33333em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.33333em; padding: 1.33333em; background: white; border-width: 0; -webkit-border-radius: 3px; border-radius: 3px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }

#content #toctitle { font-weight: bold; font-family: helvetica, arial, freesans, clean, sans-serif; font-size: 1.06667em; padding-left: 0.13333em; }

#footer { max-width: 100%; background-color: whitesmoke; padding: 1.33333em; }

#footer-text { color: #030303; line-height: 1.26; }

.sect1 { padding-bottom: 1.33333em; }

.sect1 + .sect1 { border-top: 0 solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #0830df; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #262626; }

.imageblock, .literalblock, .listingblock, .verseblock, .videoblock { margin-bottom: 1.33333em; }

.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: center; font-weight: bold; }

.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.2em; padding-right: 1.33333em; border-left: 1px solid #dddddd; color: #030303; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.33333em; padding: 1.33333em; background: white; -webkit-border-radius: 3px; border-radius: 3px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.66667em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }

.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #eaeaea; box-shadow: 0 1px 8px #eaeaea; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.33333em; padding: 1.33333em; background: white; -webkit-border-radius: 3px; border-radius: 3px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.66667em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #030303; margin-top: 0; line-height: 1.4; border-width: 0 0 1px 0; border-style: solid; border-color: #cacaca; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock > .content pre, .listingblock > .content pre { background: #F7F7F7; border-width: 2px; border-style: solid; border-color: #dddddd; -webkit-border-radius: 3px; border-radius: 3px; padding: 0.66667em; word-wrap: break-word; }
.literalblock > .content pre.nowrap, .listingblock > .content pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content pre > code, .listingblock > .content pre > code { display: block; }
@media only screen { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.69333em; } }
@media only screen and (min-width: 768px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.78em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.86667em; } }

.listingblock > .content { position: relative; }

.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.4em; right: 0.4em; }

.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }

table.pyhltable { border: 0; margin-bottom: 0; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }

.quoteblock { margin: 0 0 1em; padding: 0; border-left: none; }
.quoteblock blockquote { margin: 0 0 1em 0; padding: 0 0 0.6em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.6em; font-size: 0.86667em; color: #666666; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.66667em; }

table thead th, table tfoot th { font-weight: bold; }

table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 3px; border-radius: 3px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }

table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }

table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }

table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }

th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }

th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }

th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }

th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }

th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }

th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }

p.tableblock.header { color: #222222; font-weight: bold; }

td > div.verse { white-space: pre; }

ol { margin-left: 0.96667em; }

ul li ol { margin-left: 0.7em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.5em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.66667em; }

ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.5em auto; margin-left: -1.46667em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.46667em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .8em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.26667em 0; }

.qanda > ol > li > p > em:only-child { color: #3876b4; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.26667em 0.66667em 1.33333em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.26667em 0 1.33333em 0.66667em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.13333em; }

.image.left, .image.right { margin-top: 0.26667em; margin-bottom: 0.26667em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.66667em; }
.image.right { margin-left: 0.66667em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.93333em; }
span.footnote a, span.footnoteref a { text-decoration: none; }

#footnotes { padding-top: 0.8em; padding-bottom: 0.8em; margin-bottom: 0.66667em; }
#footnotes hr { width: 20%; min-width: 6.66667em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.4em; line-height: 1.3; font-size: 0.93333em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.66667em; margin-bottom: 0; padding: 0.8em 0; }

.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }

.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #4183c4; color: #2e6295; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum { display: inline-block; color: white !important; background-color: #333333; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1em; color: #666666; }

h2 { color: #030303; border-bottom: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { color: #333333; }

#header, #content, #footnotes { max-width: 660px; padding-left: 0; padding-right: 0; }


#content ul li { padding-left: .7em; }

.olist.procedure > ol { counter-reset: li; list-style: none; position: relative; }
.olist.procedure > ol > li { position: relative; padding: 5px 0 5px 55px; margin-bottom: 5px; }
.olist.procedure > ol > li:before { content: counter(li); counter-increment: li; position: absolute; top: 0; left: 0; height: 100%; width: 30px; padding: 0 10px 0 0; color: #999; font-size: 1.46667em; font-weight: bold; line-height: 1.6; text-align: right; border-right: 1px solid #ddd; }

.quoteblock blockquote { background: url('../images/github/blockquote-arrow.png?1372292342') 0 2px no-repeat; padding-left: 1em; }

.sidebarblock > .content > .title { margin-top: -20px; margin-right: -20px; margin-left: -20px; margin-bottom: 20px; padding: 1em; font-size: 0.8em; background: #eaeaea; }
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>P4<sub>16</sub> Language Specification : The P4 Language Consortium</h1>
<div class="details">
<span id="revnumber">version v1.2.5,</span>
<span id="revdate">2024-11-14</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Contents</div>
<ul class="sectlevel1">
<li><a href="#sec-scope">1. Scope</a></li>
<li><a href="#_terms_definitions_and_symbols">2. Terms, definitions, and symbols</a></li>
<li><a href="#_overview">3. Overview</a>
<ul class="sectlevel2">
<li><a href="#_benefits_of_p4">3.1. Benefits of P4</a></li>
<li><a href="#_p4_language_evolution_comparison_to_previous_versions_p4_v1_0v1_1">3.2. P4 language evolution: comparison to previous versions (P4 v1.0/v1.1)</a></li>
</ul>
</li>
<li><a href="#sec-arch">4. Architecture Model</a>
<ul class="sectlevel2">
<li><a href="#sec-p4-std-arch">4.1. Standard architectures</a></li>
<li><a href="#sec-dp-interfaces">4.2. Data plane interfaces</a></li>
<li><a href="#sec-external-units">4.3. Extern objects and functions</a></li>
</ul>
</li>
<li><a href="#sec-vss-example">5. Example: A very simple switch</a>
<ul class="sectlevel2">
<li><a href="#sec-vss-arch">5.1. Very Simple Switch Architecture</a></li>
<li><a href="#sec_vssarch">5.2. Very Simple Switch Architecture Description</a>
<ul class="sectlevel3">
<li><a href="#_arbiter_block">5.2.1. Arbiter block</a></li>
<li><a href="#_parser_runtime_block">5.2.2. Parser runtime block</a></li>
<li><a href="#_demux_block">5.2.3. Demux block</a></li>
<li><a href="#sec-vss-extern">5.2.4. Available extern blocks</a></li>
</ul>
</li>
<li><a href="#sec-vss-all">5.3. A complete Very Simple Switch program</a></li>
</ul>
</li>
<li><a href="#sec-p4-lang-def">6. P4 language definition</a>
<ul class="sectlevel2">
<li><a href="#sec-syntax">6.1. Syntax and semantics</a>
<ul class="sectlevel3">
<li><a href="#sec-grammar-intro">6.1.1. Grammar</a></li>
<li><a href="#_semantics_and_the_p4_abstract_machines">6.1.2. Semantics and the P4 abstract machines</a></li>
</ul>
</li>
<li><a href="#sec-preprocessor">6.2. Preprocessing</a></li>
<li><a href="#_p4_core_library">6.3. P4 core library</a></li>
<li><a href="#sec-lexical">6.4. Lexical constructs</a>
<ul class="sectlevel3">
<li><a href="#sec-identifiers">6.4.1. Identifiers</a></li>
<li><a href="#sec-comments">6.4.2. Comments</a></li>
<li><a href="#sec-literals">6.4.3. Literal constants</a>
<ul class="sectlevel4">
<li><a href="#sec-Boolean-literals">6.4.3.1. Boolean literals</a></li>
<li><a href="#sec-integer-literals">6.4.3.2. Integer literals</a></li>
<li><a href="#sec-string-literals">6.4.3.3. String literals</a></li>
</ul>
</li>
<li><a href="#sec-trailing-commas">6.4.4. Optional trailing commas</a></li>
</ul>
</li>
<li><a href="#sec-naming-conventions">6.5. Naming conventions</a></li>
<li><a href="#sec-p4-prog-structure">6.6. P4 programs</a>
<ul class="sectlevel3">
<li><a href="#sec-scopes">6.6.1. Scopes</a></li>
<li><a href="#sec-stateful-elems">6.6.2. Stateful elements</a></li>
</ul>
</li>
<li><a href="#sec-lvalues">6.7. L-values</a></li>
<li><a href="#sec-calling-convention">6.8. Calling convention: call by copy in/copy out</a>
<ul class="sectlevel3">
<li><a href="#sec-calling-convention-justification">6.8.1. Justification</a></li>
<li><a href="#sec-optional-parameters">6.8.2. Optional parameters</a></li>
</ul>
</li>
<li><a href="#sec-name-resolution">6.9. Name resolution</a></li>
<li><a href="#sec-name-visibility">6.10. Visibility</a></li>
</ul>
</li>
<li><a href="#sec-p4-type">7. P4 data types</a>
<ul class="sectlevel2">
<li><a href="#sec-base-types">7.1. Base types</a>
<ul class="sectlevel3">
<li><a href="#_the_void_type">7.1.1. The void type</a></li>
<li><a href="#_the_error_type">7.1.2. The error type</a></li>
<li><a href="#sec-match-kind-type">7.1.3. The match kind type</a></li>
<li><a href="#sec-bool-type">7.1.4. The Boolean type</a></li>
<li><a href="#sec-string-type">7.1.5. Strings</a></li>
<li><a href="#sec-integers">7.1.6. Integers (signed and unsigned)</a>
<ul class="sectlevel4">
<li><a href="#_portability">7.1.6.1. Portability</a></li>
<li><a href="#sec-unsigned-integers">7.1.6.2. Unsigned integers (bit-strings)</a></li>
<li><a href="#sec-signed-integers">7.1.6.3. Signed Integers</a></li>
<li><a href="#sec-dynamically-sized-integers">7.1.6.4. Dynamically-sized bit-strings</a></li>
<li><a href="#sec-arbitrary-precision-integers">7.1.6.5. Arbitrary-precision integers</a></li>
<li><a href="#_integer_literal_types">7.1.6.6. Integer literal types</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-derived-types">7.2. Derived types</a>
<ul class="sectlevel3">
<li><a href="#sec-enum-types">7.2.1. Enumeration types</a></li>
<li><a href="#sec-header-types">7.2.2. Header types</a></li>
<li><a href="#sec-header-stacks">7.2.3. Header stacks</a></li>
<li><a href="#sec-header-unions">7.2.4. Header unions</a></li>
<li><a href="#sec-struct-types">7.2.5. Struct types</a></li>
<li><a href="#sec-tuple-types">7.2.6. Tuple types</a></li>
<li><a href="#sec-list-types">7.2.7. List types</a></li>
<li><a href="#sec-type-nesting">7.2.8. Type nesting rules</a></li>
<li><a href="#sec-synth-types">7.2.9. Synthesized data types</a>
<ul class="sectlevel4">
<li><a href="#sec-set-types">7.2.9.1. Set types</a></li>
<li><a href="#sec-function-type">7.2.9.2. Function types</a></li>
</ul>
</li>
<li><a href="#sec_extern">7.2.10. Extern types</a>
<ul class="sectlevel4">
<li><a href="#_extern_functions">7.2.10.1. Extern functions</a></li>
<li><a href="#sec-extern-objects">7.2.10.2. Extern objects</a>
<ul class="sectlevel5">
<li><a href="#sec-abstract-methods">7.2.10.2.1. Abstract methods</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-type-spec">7.2.11. Type specialization</a></li>
<li><a href="#sec-parser-control-types">7.2.12. Parser and control blocks types</a>
<ul class="sectlevel4">
<li><a href="#_parser_type_declarations">7.2.12.1. Parser type declarations</a></li>
<li><a href="#_control_type_declarations">7.2.12.2. Control type declarations</a></li>
</ul>
</li>
<li><a href="#sec-pkg-types">7.2.13. Package types</a></li>
<li><a href="#sec-dont-care-types">7.2.14. Don&#8217;t care types</a></li>
</ul>
</li>
<li><a href="#sec-default-values">7.3. Default values</a></li>
<li><a href="#sec-numeric-values">7.4. Numeric types</a></li>
<li><a href="#sec-typedef">7.5. typedef</a></li>
<li><a href="#sec-newtype">7.6. Introducing new types</a></li>
</ul>
</li>
<li><a href="#sec-exprs">8. Expressions</a>
<ul class="sectlevel2">
<li><a href="#sec-expr-eval-order">8.1. Expression evaluation order</a></li>
<li><a href="#sec-error-exprs">8.2. Operations on <code>error</code> types</a></li>
<li><a href="#sec-enum-exprs">8.3. Operations on <code>enum</code> types</a></li>
<li><a href="#sec-match-kind-exprs">8.4. Operations on <code>match_kind</code> types</a></li>
<li><a href="#sec-bool-exprs">8.5. Expressions on Booleans</a>
<ul class="sectlevel3">
<li><a href="#_conditional_operator">8.5.1. Conditional operator</a></li>
</ul>
</li>
<li><a href="#sec-bit-ops">8.6. Operations on fixed-width bit types (unsigned integers)</a></li>
<li><a href="#sec-int-ops">8.7. Operations on fixed-width signed integers</a></li>
<li><a href="#sec-varint-ops">8.8. Operations on arbitrary-precision integers</a></li>
<li><a href="#_concatenation_and_shifts">8.9. Concatenation and shifts</a>
<ul class="sectlevel3">
<li><a href="#sec-concatenation">8.9.1. Concatenation</a></li>
<li><a href="#_a_note_about_shifts">8.9.2. A note about shifts</a></li>
</ul>
</li>
<li><a href="#sec-varbit-string">8.10. Operations on variable-size bit types</a></li>
<li><a href="#sec-casts">8.11. Casts</a>
<ul class="sectlevel3">
<li><a href="#_explicit_casts">8.11.1. Explicit casts</a></li>
<li><a href="#sec-implicit-casts">8.11.2. Implicit casts</a></li>
<li><a href="#sec-illegal-arith">8.11.3. Illegal arithmetic expressions</a></li>
</ul>
</li>
<li><a href="#sec-tuple-exprs">8.12. Operations on tuple expressions</a></li>
<li><a href="#sec-structure-expressions">8.13. Operations on structure-valued expressions</a></li>
<li><a href="#sec-list-exprs">8.14. Operations on lists</a></li>
<li><a href="#sec-set-exprs">8.15. Operations on sets</a>
<ul class="sectlevel3">
<li><a href="#sec-singleton-set">8.15.1. Singleton sets</a></li>
<li><a href="#sec-universal-set">8.15.2. The universal set</a></li>
<li><a href="#sec-cubes">8.15.3. Masks</a></li>
<li><a href="#sec-ranges">8.15.4. Ranges</a></li>
<li><a href="#sec-tuples-of-sets">8.15.5. Products</a></li>
</ul>
</li>
<li><a href="#sec-ops-on-structs">8.16. Operations on struct types</a></li>
<li><a href="#sec-ops-on-hdrs">8.17. Operations on headers</a></li>
<li><a href="#sec-expr-hs">8.18. Operations on header stacks</a>
<ul class="sectlevel3">
<li><a href="#sec-hs-init">8.18.1. Header stack expressions</a></li>
</ul>
</li>
<li><a href="#sec-expr-hu">8.19. Operations on header unions</a></li>
<li><a href="#sec-invocations">8.20. Method invocations and function calls</a></li>
<li><a href="#sec-constructor">8.21. Constructor invocations</a></li>
<li><a href="#sec-extern-operations">8.22. Operations on <code>extern</code> objects</a></li>
<li><a href="#sec-newtype-operations">8.23. Operations on types introduced by <code>type</code></a></li>
<li><a href="#sec-type-variable-operations">8.24. Operations on types that are type variables</a></li>
<li><a href="#sec-uninitialized-values-and-writing-invalid-headers">8.25. Reading uninitialized values and writing fields of invalid headers</a></li>
<li><a href="#sec-initializing-with-default-values">8.26. Initializing with default values</a></li>
</ul>
</li>
<li><a href="#sec-minsizeinbits">9. Compile-time size determination</a></li>
<li><a href="#sec-functions">10. Function declarations</a></li>
<li><a href="#sec-consts-and-vars">11. Constants and variable declarations</a>
<ul class="sectlevel2">
<li><a href="#sec-constants">11.1. Constants</a></li>
<li><a href="#sec-variables">11.2. Variables</a></li>
<li><a href="#sec-instantiations">11.3. Instantiations</a>
<ul class="sectlevel3">
<li><a href="#sec-instantiating-abstract-methods">11.3.1. Instantiating objects with abstract methods</a></li>
<li><a href="#_restrictions_on_top_level_instantiations">11.3.2. Restrictions on top-level instantiations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-stmts">12. Statements</a>
<ul class="sectlevel2">
<li><a href="#sec-assignment">12.1. Assignment statement</a></li>
<li><a href="#sec-empty-stmt">12.2. Empty statement</a></li>
<li><a href="#sec-block-stmt">12.3. Block statement</a></li>
<li><a href="#sec-return-stmt">12.4. Return statement</a></li>
<li><a href="#sec-exit-stmt">12.5. Exit statement</a></li>
<li><a href="#sec-cond-stmt">12.6. Conditional statement</a></li>
<li><a href="#sec-switch-stmt">12.7. Switch statement</a>
<ul class="sectlevel3">
<li><a href="#_switch_statement_with_action_run_expression">12.7.1. Switch statement with <code>action_run</code> expression</a></li>
<li><a href="#_switch_statement_with_integer_or_enumerated_type_expression">12.7.2. Switch statement with integer or enumerated type expression</a></li>
<li><a href="#_notes_common_to_all_switch_statements">12.7.3. Notes common to all switch statements</a></li>
</ul>
</li>
<li><a href="#sec-loop-stmt">12.8. Loop statement</a></li>
</ul>
</li>
<li><a href="#sec-packet-parsing">13. Packet parsing</a>
<ul class="sectlevel2">
<li><a href="#sec-parser-states">13.1. Parser states</a></li>
<li><a href="#sec-parser-decl">13.2. Parser declarations</a></li>
<li><a href="#sec-parser-abstract-machine">13.3. The Parser abstract machine</a></li>
<li><a href="#sec-parser-state-stmt">13.4. Parser states</a></li>
<li><a href="#sec-transition">13.5. Transition statements</a></li>
<li><a href="#sec-select">13.6. Select expressions</a></li>
<li><a href="#sec-verify">13.7. verify</a></li>
<li><a href="#sec-packet-data-extraction">13.8. Data extraction</a>
<ul class="sectlevel3">
<li><a href="#sec-packet-extract-one">13.8.1. Fixed-width extraction</a></li>
<li><a href="#sec-packet-extract-two">13.8.2. Variable-width extraction</a></li>
<li><a href="#sec-packet-lookahead">13.8.3. Lookahead</a></li>
<li><a href="#sec-skip-bits">13.8.4. Skipping bits</a></li>
</ul>
</li>
<li><a href="#sec-parse-header-stacks">13.9. Header stacks</a></li>
<li><a href="#sec-invoke-subparser">13.10. Sub-parsers</a></li>
<li><a href="#sec-value-set">13.11. Parser Value Sets</a></li>
</ul>
</li>
<li><a href="#sec-control">14. Control blocks</a>
<ul class="sectlevel2">
<li><a href="#sec-actions">14.1. Actions</a>
<ul class="sectlevel3">
<li><a href="#sec-invoke-actions">14.1.1. Invoking actions</a></li>
</ul>
</li>
<li><a href="#sec-tables">14.2. Tables</a>
<ul class="sectlevel3">
<li><a href="#sec-table-props">14.2.1. Table properties</a>
<ul class="sectlevel4">
<li><a href="#sec-table-keys">14.2.1.1. Keys</a></li>
<li><a href="#sec-table-action-list">14.2.1.2. Actions</a></li>
<li><a href="#sec-default-action">14.2.1.3. Default action</a></li>
<li><a href="#sec-entries">14.2.1.4. Entries</a>
<ul class="sectlevel5">
<li><a href="#sec-entry-priorities">14.2.1.4.1. Entry priorities</a></li>
</ul>
</li>
<li><a href="#sec-size-table-property">14.2.1.5. Size</a></li>
<li><a href="#sec-additional-table-properties">14.2.1.6. Additional properties</a></li>
</ul>
</li>
<li><a href="#sec-invoke-mau">14.2.2. Match-action unit invocation</a></li>
<li><a href="#sec-mau-semantics">14.2.3. Match-action unit execution semantics</a></li>
</ul>
</li>
<li><a href="#sec-mau-abstract-mach">14.3. The Match-Action Pipeline Abstract Machine</a></li>
<li><a href="#sec-invoke-controls">14.4. Invoking controls</a></li>
</ul>
</li>
<li><a href="#sec-parameterization">15. Parameterization</a>
<ul class="sectlevel2">
<li><a href="#sec-direct-invocation">15.1. Direct type invocation</a></li>
</ul>
</li>
<li><a href="#sec-deparse">16. Deparsing</a>
<ul class="sectlevel2">
<li><a href="#sec-deparse-insert">16.1. Data insertion into packets</a></li>
</ul>
</li>
<li><a href="#sec-arch-desc">17. Architecture description</a>
<ul class="sectlevel2">
<li><a href="#sec-arch-desc-example">17.1. Example architecture description</a></li>
<li><a href="#sec-target-instantiation">17.2. Example architecture program</a></li>
<li><a href="#sec-pkt-filter">17.3. A Packet Filter Model</a></li>
</ul>
</li>
<li><a href="#sec-p4-abstract-mach">18. P4 abstract machine: Evaluation</a>
<ul class="sectlevel2">
<li><a href="#sec-compile-time-known">18.1. Compile-time known and local compile-time known values</a></li>
<li><a href="#sec-ct-eval">18.2. Compile-time Evaluation</a></li>
<li><a href="#sec-cp-names">18.3. Control plane names</a>
<ul class="sectlevel3">
<li><a href="#_computing_control_plane_names">18.3.1. Computing control-plane names</a>
<ul class="sectlevel4">
<li><a href="#sec-cp-value-set">18.3.1.1. Value sets</a></li>
<li><a href="#sec-cp-tables">18.3.1.2. Tables</a></li>
<li><a href="#sec-cp-keys">18.3.1.3. Keys</a></li>
<li><a href="#sec-cp-actions">18.3.1.4. Actions</a></li>
<li><a href="#sec-cp-instances">18.3.1.5. Instances</a></li>
</ul>
</li>
<li><a href="#sec-name-annotations">18.3.2. Annotations controlling naming</a></li>
<li><a href="#_recommendations">18.3.3. Recommendations</a></li>
</ul>
</li>
<li><a href="#sec-dynamic-eval">18.4. Dynamic evaluation</a>
<ul class="sectlevel3">
<li><a href="#sec-concurrency">18.4.1. Concurrency model</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-static-assert">19. Static assertions</a></li>
<li><a href="#sec-annotations">20. Annotations</a>
<ul class="sectlevel2">
<li><a href="#_bodies_of_unstructured_annotations">20.1. Bodies of Unstructured Annotations</a></li>
<li><a href="#_bodies_of_structured_annotations">20.2. Bodies of Structured Annotations</a>
<ul class="sectlevel3">
<li><a href="#_structured_annotation_examples">20.2.1. Structured Annotation Examples</a></li>
</ul>
</li>
<li><a href="#_predefined_annotations">20.3. Predefined annotations</a>
<ul class="sectlevel3">
<li><a href="#sec-optional-parameter-annotations">20.3.1. Optional parameter annotations</a></li>
<li><a href="#sec-table-action-anno">20.3.2. Annotations on the table action list</a></li>
<li><a href="#sec-control-plane-api-annotations">20.3.3. Control-plane API annotations</a>
<ul class="sectlevel4">
<li><a href="#_restrictions">20.3.3.1. Restrictions</a></li>
</ul>
</li>
<li><a href="#_concurrency_control_annotations">20.3.4. Concurrency control annotations</a></li>
<li><a href="#sec-value-set-annotations">20.3.5. Value set annotations</a></li>
<li><a href="#sec-extern-annotations">20.3.6. Extern function/method annotations</a></li>
<li><a href="#sec-deprecated-anno">20.3.7. Deprecated annotation</a></li>
<li><a href="#sec-nowarn-anno">20.3.8. No warnings annotation</a></li>
</ul>
</li>
<li><a href="#_target_specific_annotations">20.4. Target-specific annotations</a></li>
</ul>
</li>
<li><a href="#sec-revision-history">Appendix A: Revision History</a>
<ul class="sectlevel2">
<li><a href="#_summary_of_changes_made_in_unreleased_version">A.1. Summary of changes made in unreleased version</a></li>
<li><a href="#_summary_of_changes_made_in_version_1_2_5_released_october_11_2024">A.2. Summary of changes made in version 1.2.5, released October 11, 2024</a></li>
<li><a href="#_summary_of_changes_made_in_version_1_2_4released_may_15_2023">A.3. Summary of changes made in version 1.2.4,released May 15, 2023</a></li>
<li><a href="#_summary_of_changes_made_in_version_1_2_3_released_july_11_2022">A.4. Summary of changes made in version 1.2.3, released July 11, 2022.</a></li>
<li><a href="#_summary_of_changes_made_in_version_1_2_2_released_may_17_2021">A.5. Summary of changes made in version 1.2.2, released May 17, 2021</a></li>
<li><a href="#_summary_of_changes_made_in_version_1_2_1_released_june_11_2020">A.6. Summary of changes made in version 1.2.1, released June 11, 2020</a></li>
<li><a href="#_summary_of_changes_made_in_version_1_2_0_released_october_14_2019">A.7. Summary of changes made in version 1.2.0, released October 14, 2019</a></li>
<li><a href="#_summary_of_changes_made_in_version_1_1_0_released_november_26_2017">A.8. Summary of changes made in version 1.1.0, released November 26, 2017.</a></li>
<li><a href="#_initial_version_1_0_0_released_may_17_2017">A.9. Initial version 1.0.0, released May 17, 2017</a></li>
</ul>
</li>
<li><a href="#sec-p4-keywords">Appendix B: P4 reserved keywords</a></li>
<li><a href="#sec-p4-reserved-annotations">Appendix C: P4 reserved annotations</a></li>
<li><a href="#sec-p4-core-lib">Appendix D: P4 core library</a></li>
<li><a href="#sec-checksums">Appendix E: Checksums</a></li>
<li><a href="#sec-calling-restrictions">Appendix F: Restrictions on compile time and run time calls</a></li>
<li><a href="#sec-grammar">Appendix G: P4 grammar</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<div class="title">Abstract</div>
<blockquote>
P4 is a language for programming the data plane of network
devices. This document provides a precise definition of the P4<sub>16</sub>
language, which is the 2016 revision of the P4 language
(<a href="http://p4.org" class="bare">http://p4.org</a>). The target audience for this document includes
developers who want to write compilers, simulators, IDEs, and
debuggers for P4 programs. This document may also be of interest to P4
programmers who are interested in understanding the syntax and
semantics of the language at a deeper level.
</blockquote>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect1">
<h2 id="sec-scope">1. Scope</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This specification document defines the structure and interpretation
of programs in the P4<sub>16</sub> language. It defines the syntax, semantic
rules, and requirements for conformant implementations of the
language.</p>
</div>
<div class="paragraph">
<p>It does not define:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mechanisms by which P4 programs are compiled, loaded, and executed
on packet-processing systems,</p>
</li>
<li>
<p>Mechanisms by which data are received by one packet-processing
system and delivered to another system,</p>
</li>
<li>
<p>Mechanisms by which the control plane manages the match-action
tables and other stateful objects defined by P4 programs,</p>
</li>
<li>
<p>The size or complexity of P4 programs,</p>
</li>
<li>
<p>The minimal requirements of packet-processing systems that are
capable of providing a conformant implementation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is understood that some implementations may be unable to implement
the behavior defined here in all cases, or may provide options to
eliminate some safety guarantees in exchange for better performance or
handling larger programs.  They should document where they deviate
from this specification.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_terms_definitions_and_symbols">2. Terms, definitions, and symbols</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Throughout this document, the following terms will be used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Architecture</strong>: A set of P4-programmable components and the data
plane interfaces between them.</p>
</li>
<li>
<p><strong>Control plane</strong>: A class of algorithms and the corresponding input
and output data that are concerned with the provisioning and
configuration of the data plane.</p>
</li>
<li>
<p><strong>Data plane</strong>: A class of algorithms that describe transformations
on packets by packet-processing systems.</p>
</li>
<li>
<p><strong>Metadata</strong>: Intermediate data generated during execution of a P4
program.</p>
</li>
<li>
<p><strong>Packet</strong>: A network packet is a formatted unit of data carried by
a packet-switched network.</p>
</li>
<li>
<p><strong>Packet header</strong>: Formatted data at the beginning of a packet. A
given packet may contain a sequence of packet headers representing
different network protocols.</p>
</li>
<li>
<p><strong>Packet payload</strong>: Packet data that follows the packet headers.</p>
</li>
<li>
<p><strong>Packet-processing system</strong>: A data-processing system designed
for processing network packets. In general, packet-processing
 systems implement control plane and data plane algorithms.</p>
</li>
<li>
<p><strong>Target</strong>: A packet-processing system capable of executing a P4
program.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All terms defined explicitly in this document should not be understood
to refer implicitly to similar terms defined elsewhere. Conversely, any terms not
defined explicitly in this document should be interpreted according to
generally recognizable sources---e.g., IETF RFCs.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview">3. Overview</h2>
<div class="sectionbody">
<div id="fig-prgswitch" class="imageblock">
<div class="content">
<img src="resources/figs/prgswitch.png" alt="prgswitch">
</div>
<div class="title">Figure 1. Traditional switches vs. programmable switches.</div>
</div>
<div class="paragraph">
<p>P4 is a language for expressing how packets are processed by the data
plane of a programmable forwarding element such as a hardware or
software switch, network interface card, router, or network
appliance. The name P4 comes from the original paper that introduced
the language, "Programming Protocol-independent Packet Processors,"
<a href="https://arxiv.org/pdf/1312.1719.pdf" class="bare">https://arxiv.org/pdf/1312.1719.pdf</a>. While P4 was initially designed
for programming switches, its scope has been broadened to cover a
large variety of devices. In the rest of this document we use the
generic term <em>target</em> for all such devices.</p>
</div>
<div class="paragraph">
<p>Many targets implement both a control plane and a data plane. P4 is
designed to specify only the data plane functionality of the
target. P4 programs also partially define the interface by which the
control plane and the data-plane communicate, but P4 cannot be used to
describe the control-plane functionality of the target. In the rest of
this document, when we talk about P4 as "programming a target", we
mean "programming the data plane of a target".</p>
</div>
<div class="paragraph">
<p>As a concrete example of a target, <a href="#fig-prgswitch">Figure 1</a> illustrates
the difference between a traditional fixed-function switch and a
P4-programmable switch. In a traditional switch the manufacturer
defines the data-plane functionality. The control-plane controls the
data plane by managing entries in tables (e.g. routing tables),
configuring specialized objects (e.g. meters), and by processing
control-packets (e.g. routing protocol packets) or asynchronous
events, such as link state changes or learning notifications.</p>
</div>
<div class="paragraph">
<p>A P4-programmable switch differs from a traditional switch in two
essential ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The data plane functionality is not fixed in advance but is defined
by a P4 program. The data plane is configured at initialization
time to implement the functionality described by the P4 program
(shown by the long red arrow) and has no built-in knowledge of
existing network protocols.</p>
</li>
<li>
<p>The control plane communicates with the data plane using the same
channels as in a fixed-function device, but the set of tables and
other objects in the data plane are no longer fixed, since they are
defined by a P4 program. The P4 compiler generates the API that the
control plane uses to communicate with the data plane.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hence, P4 can be said to be protocol independent, but it enables
programmers to express a rich set of protocols and other data plane
behaviors.</p>
</div>
<div id="fig-p4prg" class="imageblock">
<div class="content">
<img src="resources/figs/p4prg.png" alt="p4prg">
</div>
<div class="title">Figure 2. Programming a target with P4.</div>
</div>
<div class="paragraph">
<p>The core abstractions provided by the P4 language are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Header types</strong> describe the format (the set of fields and
their sizes) of each header within a packet.</p>
</li>
<li>
<p><strong>Parsers</strong> describe the permitted sequences of headers within
received packets, how to identify those header sequences, and the
headers and fields to extract from packets.</p>
</li>
<li>
<p><strong>Tables</strong> associate user-defined keys with actions. P4 tables
generalize traditional switch tables; they can be used to implement
routing tables, flow lookup tables, access-control lists, and other
user-defined table types, including complex multi-variable decisions.</p>
</li>
<li>
<p><strong>Actions</strong> are code fragments that describe how packet header
fields and metadata are manipulated. Actions can include data, which
is supplied by the control-plane at runtime.</p>
</li>
<li>
<p><strong>Match-action units</strong> perform the following sequence of operations:</p>
<div class="ulist">
<ul>
<li>
<p>Construct lookup keys from packet fields or computed metadata,</p>
</li>
<li>
<p>Perform table lookup using the constructed key, choosing an action
(including the associated data) to execute, and</p>
</li>
<li>
<p>Finally, execute the selected action.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Control flow</strong> expresses an imperative program that describes
packet-processing on a target, including the data-dependent sequence
of match-action unit invocations. Deparsing (packet reassembly) can
also be performed using a control flow.</p>
</li>
<li>
<p><strong>Extern objects</strong> are architecture-specific constructs that can be
manipulated by P4 programs through well-defined APIs, but whose
internal behavior is hard-wired (e.g., checksum units) and hence not
programmable using P4.</p>
</li>
<li>
<p><strong>User-defined metadata</strong>: user-defined data structures associated
with each packet.</p>
</li>
<li>
<p><strong>Intrinsic metadata</strong>: metadata provided by the architecture
associated with each packet---e.g., the input port where a packet
has been received.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#fig-p4prg">Figure 2</a> shows a typical tool workflow when programming a
target using P4.</p>
</div>
<div class="paragraph">
<p>Target manufacturers provide the hardware or software implementation
framework, an architecture definition, and a P4 compiler for that
target. P4 programmers write programs for a specific architecture,
which defines a set of P4-programmable components on the target as
well as their external data plane interfaces.</p>
</div>
<div class="paragraph">
<p>Compiling a set of P4 programs produces two artifacts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a data plane configuration that implements the forwarding logic
described in the input program and</p>
</li>
<li>
<p>an API for managing the state of the data plane objects from the
control plane</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>P4 is a domain-specific language that is designed to be implementable
on a large variety of targets including programmable network interface
cards, FPGAs, software switches, and hardware ASICs. As such, the
language is restricted to constructs that can be efficiently
implemented on all of these platforms.</p>
</div>
<div class="paragraph">
<p>Assuming a fixed cost for table lookup operations and interactions
with extern objects, all P4 programs (i.e., parsers and controls)
execute a constant number of operations for each byte of an input
packet received and analyzed. Although parsers may contain loops,
provided some header is extracted on each cycle, the packet itself
provides a bound on the total execution of the parser. In other words,
under these assumptions, the computational complexity of a P4 program
is linear in the total size of all headers, and never depends on the
size of the state accumulated while processing data (e.g., the number
of flows, or the total number of packets processed). These guarantees
are necessary (but not sufficient) for enabling fast packet processing
across a variety of targets.</p>
</div>
<div class="paragraph">
<p><em>P4 conformance</em> of a target is defined as follows: if a specific
target T supports only a subset of the P4 programming language, say
P4<sup>T</sup>, programs written in P4<sup>T</sup> executed on the target should provide
the exact same behavior as is described in this document. Note that P4
conformant targets can provide arbitrary P4 language extensions and <code>extern</code>
elements.</p>
</div>
<div class="sect2">
<h3 id="_benefits_of_p4">3.1. Benefits of P4</h3>
<div class="paragraph">
<p>Compared to state-of-the-art packet-processing systems (e.g., based on
writing microcode on top of custom hardware), P4 provides a number of
significant advantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Flexibility</strong>: P4 makes many packet-forwarding policies
expressible as programs, in contrast to traditional switches, which
expose fixed-function forwarding engines to their users.</p>
</li>
<li>
<p><strong>Expressiveness</strong>: P4 can express sophisticated,
hardware-independent packet processing algorithms using solely
general-purpose operations and table look-ups. Such programs are
portable across hardware targets that implement the same
architectures (assuming sufficient resources are available).</p>
</li>
<li>
<p><strong>Resource mapping and management</strong>: P4 programs describe storage
resources abstractly (e.g., IPv4 source address); compilers map such
user-defined fields to available hardware resources and manage
low-level details such as allocation and scheduling.</p>
</li>
<li>
<p><strong>Software engineering</strong>: P4 programs provide important benefits
such as type checking, information hiding, and software reuse.</p>
</li>
<li>
<p><strong>Component libraries</strong>: Component libraries supplied by manufacturers
can be used to wrap hardware-specific functions into portable
high-level P4 constructs.</p>
</li>
<li>
<p><strong>Decoupling hardware and software evolution</strong>: Target manufacturers
may use abstract architectures to further decouple the evolution of
low-level architectural details from high-level processing.</p>
</li>
<li>
<p><strong>Debugging</strong>: Manufacturers can provide software models of an
architecture to aid in the development and debugging of P4 programs.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_p4_language_evolution_comparison_to_previous_versions_p4_v1_0v1_1">3.2. P4 language evolution: comparison to previous versions (P4 v1.0/v1.1)</h3>
<div id="fig-p4transition" class="imageblock">
<div class="content">
<img src="resources/figs/p4transition.png" alt="p4transition">
</div>
<div class="title">Figure 3. Evolution of the language between versions P4<sub>14</sub> (versions 1.0 and 1.1) and P4<sub>16</sub>.</div>
</div>
<div class="paragraph">
<p>Compared to P4<sub>14</sub>, the earlier version of the language, P4<sub>16</sub> makes
a number of significant, backwards-incompatible changes to the syntax
and semantics of the language. The evolution from the previous version
(P4<sub>14</sub>) to the current one (P4<sub>16</sub>) is depicted in
<a href="#fig-p4transition">Figure 3</a>. In particular, a large number of language
features have been eliminated from the language and moved into
libraries including counters, checksum units, meters, etc.</p>
</div>
<div class="paragraph">
<p>Hence, the language has been transformed from a complex language (more than 70
keywords) into a relatively small core language (less than 40 keywords, shown in
<a href="#sec-p4-keywords">Appendix B</a>) accompanied by a library of fundamental
constructs that are needed for writing most P4.</p>
</div>
<div class="paragraph">
<p>The v1.1 version of P4 introduced a language construct called <code>extern</code> that
can be used to describe library elements. Many constructs defined in the
v1.1 language specification will thus be transformed into such
library elements (including constructs that have been eliminated
from the language, such as counters and meters). Some of these <code>extern</code> objects
are expected to be standardized, and they will be in the scope of a
future document describing a standard library of P4 elements. In
this document we provide several examples of <code>extern</code> constructs.
P4<sub>16</sub> also introduces and repurposes some v1.1 language
constructs for describing the programmable parts of an
architecture. These language constructs are: <code>parser</code>, <code>state</code>, <code>control</code>, and <code>package</code>.</p>
</div>
<div class="paragraph">
<p>One important goal of the P4<sub>16</sub> language revision is to provide a
<strong>stable</strong> language definition. In other words, we strive to ensure that
all programs written in P4<sub>16</sub> will remain syntactically correct and
behave identically when treated as programs for future versions of the
language. Moreover, if some future version of the language requires
breaking backwards compatibility, we will seek to provide an easy path
for migrating P4<sub>16</sub> programs to the new version.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-arch">4. Architecture Model</h2>
<div class="sectionbody">
<div id="fig-p4interface" class="imageblock">
<div class="content">
<img src="resources/figs/p4interface.png" alt="p4interface">
</div>
<div class="title">Figure 4. P4 program interfaces.</div>
</div>
<div class="paragraph">
<p>The <em>P4 architecture</em> identifies the P4-programmable blocks (e.g.,
parser, ingress control flow, egress control flow, deparser, etc.) and their
data plane interfaces.</p>
</div>
<div class="paragraph">
<p>The P4 architecture can be thought of as a contract between the
program and the target.
Each manufacturer must therefore
provide both a P4 compiler as well as an accompanying
architecture definition for their target. (We expect that P4 compilers
can share a common front-end that handles all architectures). The architecture
definition does not have to expose the entire programmable surface of
the data plane---a manufacturer may even choose to provide multiple
definitions for the same hardware device, each with different
capabilities (e.g., with or without multicast support).</p>
</div>
<div class="paragraph">
<p><a href="#fig-p4interface">Figure 4</a> illustrates the data plane interfaces between P4-programmable
blocks. It shows a target that has two programmable blocks (#1 and #2).
Each block is programmed through a separate fragment of P4 code. The
target interfaces with the P4 program through a set of control
registers or signals. Input controls provide information to P4
programs (e.g., the input port that a packet was received from), while
output controls can be written to by P4 programs to influence the
target behavior (e.g., the output port where a packet has to be
directed). Control registers/signals are represented in P4 as
<em>intrinsic metadata</em>.
P4 programs can also store and manipulate data pertaining to each
packet as <em>user-defined metadata</em>.</p>
</div>
<div class="paragraph">
<p>The behavior of a P4 program can be fully described in terms of
transformations that map vectors of bits to vectors of bits. To actually
process a packet, the architecture
model interprets the bits that the P4 program writes to intrinsic metadata.
For example, to cause a packet to
be forwarded on a specific output port, a P4 program may need to write
the index of an output port into a dedicated control register. Similarly,
to cause a packet to be dropped, a P4 program may need to set a
"drop" bit into another dedicated control register. Note that the details of
how intrinsic metadata are interpreted is architecture-specific.</p>
</div>
<div id="fig-p4checksum" class="imageblock text-center">
<div class="content">
<img src="resources/figs/p4checksum.png" alt="p4checksum" width="350">
</div>
<div class="title">Figure 5. P4 program invoking the services of a fixed-function object.</div>
</div>
<div class="paragraph">
<p>P4 programs can invoke services implemented by extern objects and functions provided by the architecture.
<a href="#fig-p4checksum">Figure 5</a> depicts a P4 program invoking the services of a
built-in checksum computation unit on a target. The implementation of the checksum
unit is not specified in P4, but its interface is. In general, the interface for
an extern object describes each operation it provides, as well as their parameter and return types.</p>
</div>
<div class="paragraph">
<p>In general, P4 programs are not expected to be portable across
different architectures. For example, executing a P4 program that
broadcasts packets by writing into a custom control register
will not function correctly on a target that does not have the control
register. However, P4 programs written for a given architecture should
be portable across all targets that faithfully implement the
corresponding model, provided there are sufficient resources.</p>
</div>
<div class="sect2">
<h3 id="sec-p4-std-arch">4.1. Standard architectures</h3>
<div class="paragraph">
<p>We expect that the P4 community will evolve a small set of standard architecture
models pertaining to specific verticals. Wide adoption of such standard
architectures will promote portability of P4 programs across different targets.
However, defining these
standard architectures is outside of the scope of this document.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-dp-interfaces">4.2. Data plane interfaces</h3>
<div class="paragraph">
<p>To describe a functional block that can be programmed in P4, the
architecture includes a type declaration that specifies the interfaces
between the block and the other components in the architecture.
For example, the architecture might contain a declaration such as the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> MatchActionPipe<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span> inputPort<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">inout</span> H parsedHeaders<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">out</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span> outputPort<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This type declaration describes a block named <code>MatchActionPipe</code>
that can be programmed using a data-dependent sequence of match-action
unit invocations and other imperative constructs (indicated by the <code>control</code>
keyword).  The interface between the <code>MatchActionPipe</code> block and
the other components of the architecture can be read off from this declaration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first parameter is a 4-bit value named <code>inputPort.</code> The
direction <code>in</code> indicates that this parameter is an input that
cannot be modified.</p>
</li>
<li>
<p>The second parameter is an object of type <code>H</code> named <code>parsedHeaders</code>,
where <code>H</code> is a type variable representing the headers that will
be defined later by the P4 programmer.
The direction <code>inout</code> indicates that this parameter is
both an input and an output.</p>
</li>
<li>
<p>The third parameter is a 4-bit value named <code>outputPort</code>. The
direction <code>out</code> indicates that this parameter is an output
whose value is undefined initially but can be modified.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sec-external-units">4.3. Extern objects and functions</h3>
<div class="paragraph">
<p>P4 programs can also interact with objects and functions provided by the architecture.
Such objects are described using the <code>extern</code> construct, which
describes the interfaces that such objects expose to the data-plane.</p>
</div>
<div class="paragraph">
<p>An <code>extern</code> object describes a set of methods that are implemented
by an object, but not the implementation of these methods (i.e., it is similar
to an abstract class in an object-oriented language). For example,
the following construct could be used to describe the operations offered by an
incremental checksum unit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> Checksum16 <span style="color: #24292f;background-color: #f6f8fa">{</span>
    Checksum16<span style="color: #24292f;background-color: #f6f8fa">();</span>              <span style="color: #6e7781">// constructor
</span>    <span style="color: #953800">void</span> clear<span style="color: #24292f;background-color: #f6f8fa">();</span>              <span style="color: #6e7781">// prepare unit for computation
</span>    <span style="color: #953800">void</span> update<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// add data to checksum
</span>    <span style="color: #953800">void</span> remove<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// remove data from existing checksum
</span>    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> get<span style="color: #24292f;background-color: #f6f8fa">();</span> <span style="color: #6e7781">// get the checksum for the data added since last clear
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-vss-example">5. Example: A very simple switch</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As an example to illustrate the features of architectures, consider
implementing a very simple switch in P4. We will first describe the
architecture of the switch and then write a complete P4 program
that specifies the data plane behavior of the switch. This example
demonstrates many important features of the P4 programming language.</p>
</div>
<div id="fig-vssarch" class="imageblock">
<div class="content">
<img src="resources/figs/vssarch.png" alt="vssarch">
</div>
<div class="title">Figure 6. The Very Simple Switch (VSS) architecture.</div>
</div>
<div class="paragraph">
<p>We call our architecture the "Very Simple Switch" (VSS).
<a href="#fig-vssarch">Figure 6</a> is a diagram of this architecture. There is nothing inherently
special about VSS---it is just a pedagogical example that
illustrates how programmable switches can be described and programmed
in P4. VSS has a number of fixed-function blocks (shown in cyan in our
example), whose behavior is described in <a href="#sec_vssarch">Section 5.2</a>. The
white blocks are programmable using P4.</p>
</div>
<div class="paragraph">
<p>VSS receives packets through one of 8 input Ethernet ports, through a
recirculation channel, or from a port connected directly to the
CPU. VSS has one single parser, feeding into a single match-action
pipeline, which feeds into a single deparser. After exiting the
deparser, packets are emitted through one of 8 output Ethernet ports
or one of 3 "special" ports:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Packets sent to the "CPU port" are sent to the control plane</p>
</li>
<li>
<p>Packets sent to the "Drop port" are discarded</p>
</li>
<li>
<p>Packets sent to the "Recirculate port" are re-injected in the switch
through a special input port</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The white blocks in the figure are programmable, and the user must
provide a corresponding P4 program to specify the behavior of each
such block. The red arrows indicate the flow of user-defined data.  The
cyan blocks are fixed-function components. The green arrows are data plane
interfaces used to convey information between the fixed-function
blocks and the programmable blocks---exposed in the P4 program as
intrinsic metadata.</p>
</div>
<div class="sect2">
<h3 id="sec-vss-arch">5.1. Very Simple Switch Architecture</h3>
<div class="paragraph">
<p>The following P4 program provides a declaration of VSS in P4, as it
would be provided by the VSS manufacturer. The declaration contains
several type declarations, constants, and finally declarations for the
three programmable blocks; the code uses syntax highlighting. The
programmable blocks are described by their types; the implementation
of these blocks has to be provided by the switch programmer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// File "very_simple_switch_model.p4"
// Very Simple Switch P4 declaration
// core library needed for packet_in and packet_out definitions
</span><span style="color: #6e7781"># include</span> <span style="color: #0550ae">&lt;</span>core<span style="color: #0550ae">.</span>p4<span style="color: #0550ae">&gt;</span>
<span style="color: #6e7781">/* Various constants and structure declarations */</span>
<span style="color: #6e7781">/* ports are represented using 4-bit values */</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span> PortId<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #6e7781">/* only 8 ports are "real" */</span>
<span style="color: #cf222e">const</span> PortId REAL_PORT_COUNT <span style="color: #0550ae">=</span> <span style="color: #0550ae">4w8</span><span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// 4w8 is the number 8 in 4 bits
</span><span style="color: #6e7781">/* metadata accompanying an input packet */</span>
<span style="color: #cf222e">struct</span> InControl <span style="color: #24292f;background-color: #f6f8fa">{</span>
    PortId inputPort<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #6e7781">/* special input port values */</span>
<span style="color: #cf222e">const</span> PortId RECIRCULATE_IN_PORT <span style="color: #0550ae">=</span> <span style="color: #0550ae">0xD</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">const</span> PortId CPU_IN_PORT <span style="color: #0550ae">=</span> <span style="color: #0550ae">0xE</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #6e7781">/* metadata that must be computed for outgoing packets */</span>
<span style="color: #cf222e">struct</span> OutControl <span style="color: #24292f;background-color: #f6f8fa">{</span>
    PortId outputPort<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #6e7781">/* special output port values for outgoing packet */</span>
<span style="color: #cf222e">const</span> PortId DROP_PORT <span style="color: #0550ae">=</span> <span style="color: #0550ae">0xF</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">const</span> PortId CPU_OUT_PORT <span style="color: #0550ae">=</span> <span style="color: #0550ae">0xE</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">const</span> PortId RECIRCULATE_OUT_PORT <span style="color: #0550ae">=</span> <span style="color: #0550ae">0xD</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #6e7781">/* Prototypes for all programmable blocks */</span>
<span style="color: #6e7781">/**
 * Programmable parser.
 * @param &lt;H&gt; type of headers; defined by user
 * @param b input packet
 * @param parsedHeaders headers constructed by parser
 */</span>
<span style="color: #cf222e">parser</span> Parser<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span>
                 <span style="color: #cf222e">out</span> H parsedHeaders<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #6e7781">/**
 * Match-action pipeline
 * @param &lt;H&gt; type of input and output headers
 * @param headers headers received from the parser and sent to the deparser
 * @param parseError error that may have surfaced during parsing
 * @param inCtrl information from architecture, accompanying input packet
 * @param outCtrl information for architecture, accompanying output packet
 */</span>
<span style="color: #cf222e">control</span> Pipe<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> H headers<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">in</span> <span style="color: #953800">error</span> parseError<span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #6e7781">// parser error
</span>                <span style="color: #cf222e">in</span> InControl inCtrl<span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #6e7781">// input port
</span>                <span style="color: #cf222e">out</span> OutControl outCtrl<span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// output port
</span><span style="color: #6e7781">/**
 * VSS deparser.
 * @param &lt;H&gt; type of headers; defined by user
 * @param b output packet
 * @param outputHeaders headers for output packet
 */</span>
<span style="color: #cf222e">control</span> Deparser<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> H outputHeaders<span style="color: #24292f;background-color: #f6f8fa">,</span>
                    <span style="color: #cf222e">packet_out</span> b<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #6e7781">/**
 * Top-level package declaration - must be instantiated by user.
 * The arguments to the package indicate blocks that
 * must be instantiated by the user.
 * @param &lt;H&gt; user-defined type of the headers processed.
 */</span>
<span style="color: #cf222e">package</span> VSS<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>Parser<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span> p<span style="color: #24292f;background-color: #f6f8fa">,</span>
               Pipe<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span> map<span style="color: #24292f;background-color: #f6f8fa">,</span>
               Deparser<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span> d<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #6e7781">// Architecture-specific objects that can be instantiated
// Checksum unit
</span><span style="color: #cf222e">extern</span> Checksum16 <span style="color: #24292f;background-color: #f6f8fa">{</span>
    Checksum16<span style="color: #24292f;background-color: #f6f8fa">();</span>              <span style="color: #6e7781">// constructor
</span>    <span style="color: #953800">void</span> clear<span style="color: #24292f;background-color: #f6f8fa">();</span>              <span style="color: #6e7781">// prepare unit for computation
</span>    <span style="color: #953800">void</span> update<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// add data to checksum
</span>    <span style="color: #953800">void</span> remove<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// remove data from existing checksum
</span>    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> get<span style="color: #24292f;background-color: #f6f8fa">();</span> <span style="color: #6e7781">// get the checksum for the data added since last clear
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let us describe some of these elements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The included file <code>core.p4</code> is described in more detail in
<a href="#sec-p4-core-lib">Appendix D</a>. It defines some standard
data-types and error codes.</p>
</li>
<li>
<p><code>bit&lt;4&gt;</code> is the type of bit-strings with 4 bits.</p>
</li>
<li>
<p>The syntax <code>4w0xF</code> indicates the value 15 represented using 4
bits. An alternative notation is <code>4w15</code>. In many circumstances
the width modifier can be omitted, writing just <code>15</code>.</p>
</li>
<li>
<p><code>error</code> is a built-in P4 type for holding error codes</p>
</li>
<li>
<p>Next follows the declaration of a parser:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">parser</span> Parser<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> H parsedHeaders<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This declaration describes the interface for a parser, but not yet its
implementation, which will be provided by
the programmer. The parser reads its input from a <code>packet_in</code>, which is
a pre-defined P4 extern object that represents an incoming
packet, declared in the <code>core.p4</code> library. The parser writes its
output (the <code>out</code> keyword) into the <code>parsedHeaders</code>
argument. The type of this argument is <code>H</code>, yet unknown---it will
also be provided by the programmer.</p>
</div>
</li>
<li>
<p>The declaration</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> Pipe<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> H headers<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">in</span> <span style="color: #953800">error</span> parseError<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">in</span> InControl inCtrl<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">out</span> OutControl outCtrl<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>describes the interface of a Match-Action pipeline named <code>Pipe</code>.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The pipeline receives three inputs: the headers <code>headers</code>, a parser
error <code>parseError</code>, and the <code>inCtrl</code> control data.
<a href="#fig-vssarch">Figure 6</a> indicates the different sources of these pieces of
information. The pipeline writes its outputs into <code>outCtrl</code>, and
it must update in place the headers to be consumed by the deparser.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The top-level package is called <code>VSS</code>; in order to program a
VSS, the user will have to instantiate a package of this type (shown
in the next section). The top-level package declaration also depends
on a type variable H:</p>
<div class="openblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">package</span> VSS<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>A type variable indicates a type yet unknown that must be provided by
the user at a later time. In this case <code>H</code> is the type of the set
of headers that the user program will be processing; the parser will
produce the parsed representation of these headers, and the
match-action pipeline will update the input headers in place to
produce the output headers.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>package VSS</code> declaration has three complex parameters, of
types <code>Parser</code>, <code>Pipe</code>, and <code>Deparser</code> respectively; which are
exactly the declarations we have just described. In order to program
the target one has to supply values for these parameters.</p>
</li>
<li>
<p>In this program the <code>inCtrl</code> and <code>outCtrl</code> structures
represent control registers. The content of the headers structure is
stored in general-purpose registers.</p>
</li>
<li>
<p>The <code>extern Checksum16</code> declaration describes an extern object
whose services can be invoked to compute checksums.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sec_vssarch">5.2. Very Simple Switch Architecture Description</h3>
<div class="paragraph">
<p>In order to fully understand VSS&#8217;s behavior and write meaningful P4
programs for it, and for implementing a control plane, we also need a
full behavioral description of the fixed-function blocks. This section
can be seen as a simple example illustrating all the details that have
to be handled when writing an architecture description. The P4
language is not intended to cover the description of all such
functional blocks---the language can only describe the interfaces
between programmable blocks and the architecture. For the current program,
this interface is given by the <code>Parser</code>, <code>Pipe</code>, and <code>Deparser</code>
declarations. In practice we expect that the complete description of the architecture
will be provided as an executable program and/or diagrams and text; in
this document we will provide informal descriptions in English.</p>
</div>
<div class="sect3">
<h4 id="_arbiter_block">5.2.1. Arbiter block</h4>
<div class="paragraph">
<p>The input arbiter block performs the following functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It receives packets from one of the physical input Ethernet ports,
from the control plane, or from the input recirculation port.</p>
</li>
<li>
<p>For packets received from Ethernet ports, the block computes the
Ethernet trailer checksum and verifies it. If the checksum does not
match, the packet is discarded. If the checksum does match, it is
removed from the packet payload.</p>
</li>
<li>
<p>Receiving a packet involves running an arbitration algorithm if
multiple packets are available.</p>
</li>
<li>
<p>If the arbiter block is busy processing a previous packet and no
queue space is available, input ports may drop arriving packets,
without indicating the fact that the packets were dropped in any
way.</p>
</li>
<li>
<p>After receiving a packet, the arbiter block sets the <code>inCtrl.inputPort</code>
value that is an input to the match-action pipeline with the identity of the input
port where the packet originated. Physical Ethernet ports are
numbered 0 to 7, while the input recirculation port has a number 13
and the CPU port has the number 14.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_parser_runtime_block">5.2.2. Parser runtime block</h4>
<div class="paragraph">
<p>The parser runtime block works in concert with the parser. It provides
an error code to the match-action pipeline, based on the parser
actions, and it provides information about the packet payload (e.g.,
the size of the remaining payload data) to the demux block. As soon as
a packet&#8217;s processing is completed by the parser, the match-action
pipeline is invoked with the associated metadata as inputs (packet
headers and user-defined metadata).</p>
</div>
</div>
<div class="sect3">
<h4 id="_demux_block">5.2.3. Demux block</h4>
<div class="paragraph">
<p>The core functionality of the demux block is to receive the headers
for the outgoing packet from the deparser and the packet payload from
the parser, to assemble them into a new packet and to send the result
to the correct output port. The output port is specified by the value
of <code>outCtrl.ouputPort</code>, which is set by the match-action pipeline.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sending the packet to the drop port causes the packet to disappear.</p>
</li>
<li>
<p>Sending the packet to an output Ethernet port numbered between 0 and
7 causes it to be emitted on the corresponding physical
interface. The packet may be placed in a queue if the output
interface is already busy emitting another packet. When the packet is
emitted, the physical interface computes a correct Ethernet checksum
trailer and appends it to the packet.</p>
</li>
<li>
<p>Sending a packet to the output CPU port causes the packet to be
transferred to the control plane. In this case, the packet that is
sent to the CPU is the <strong>original input packet</strong>, and not the packet
received from the deparser---the latter packet is discarded.</p>
</li>
<li>
<p>Sending the packet to the output recirculation port causes it to
appear at the input recirculation port. Recirculation is useful when
packet processing cannot be completed in a single pass.</p>
</li>
<li>
<p>If the <code>outputPort</code> has an illegal value (e.g., 9), the packet
is dropped.</p>
</li>
<li>
<p>Finally, if the demux unit is busy processing a previous packet and there is
no capacity to queue the packet coming from the deparser, <strong>the
demux unit may drop the packet</strong>, irrespective of the output port indicated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please note that some of the behaviors of the demux block may be
unexpected---we have highlighted them in bold. We are not specifying
here several important behaviors related to queue size, arbitration,
and timing, which also influence the packet processing.</p>
</div>
<div class="paragraph">
<p>The arrow shown from the parser runtime to the demux block represents
an additional information flow from the parser to the demux: the
packet being processed as well as the offset within the packet where
parsing ended (i.e., the start of the packet payload).</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-vss-extern">5.2.4. Available extern blocks</h4>
<div class="paragraph">
<p>The VSS architecture provides an incremental checksum extern block,
called <code>Checksum16</code>. The checksum unit has a constructor and four
methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>clear()</code>: prepares the unit for a new computation</p>
</li>
<li>
<p><code>update&lt;T&gt;(in T data)</code>: add some data to be checksummed. The
data must be either a bit-string, a header-typed value, or a <code>struct</code>
containing such values. The fields in the header/struct
are concatenated in the order they appear in the type declaration.</p>
</li>
<li>
<p><code>get()</code>: returns the 16-bit one&#8217;s complement checksum. When
this function is invoked the checksum must have received an integral
number of bytes of data.</p>
</li>
<li>
<p><code>remove&lt;T&gt;(in T data)</code>: assuming that <code>data</code>
was used for computing the current checksum, <code>data</code> is removed
from the checksum.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-vss-all">5.3. A complete Very Simple Switch program</h3>
<div class="paragraph">
<p>Here we provide a complete P4 program that implements basic forwarding for
IPv4 packets on the VSS architecture. This program does not utilize all of the
features provided by the architecture---e.g., recirculation---but it does use
preprocessor <code>#include</code> directives (see <a href="#sec-preprocessor">Section 6.2</a>).</p>
</div>
<div id="fig-vssmau" class="imageblock">
<div class="content">
<img src="resources/figs/vssmau.png" alt="vssmau">
</div>
<div class="title">Figure 7. Diagram of the match-action pipeline expressed by the VSS P4 program.</div>
</div>
<div class="paragraph">
<p>The parser attempts to recognize an Ethernet header followed by an IPv4 header.
If either of these headers are missing, parsing terminates with an
error. Otherwise it extracts the information from these headers into
a <code>Parsed_packet</code> structure. The match-action pipeline is
shown in <a href="#fig-vssmau">Figure 7</a>; it comprises four match-action units
(represented by the P4 <code>table</code> keyword):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If any parser error has occurred, the packet is dropped (i.e., by assigning <code>outputPort</code>
to <code>DROP_PORT</code>)</p>
</li>
<li>
<p>The first table uses the IPv4 destination address to determine the <code>outputPort</code>
and the IPv4 address of the next hop. If this lookup fails, the packet is dropped.
The table also decrements the IPv4 <code>ttl</code> value.</p>
</li>
<li>
<p>The second table checks the <code>ttl</code> value: if the <code>ttl</code> becomes 0, the
packet is sent to the control plane through the CPU port.</p>
</li>
<li>
<p>The third table uses the IPv4 address of the next hop (which was computed by
the first table) to determine the Ethernet address of the next hop.</p>
</li>
<li>
<p>Finally, the last table uses the <code>outputPort</code> to identify the
source Ethernet address of the current switch, which is set in the
outgoing packet.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The deparser constructs the outgoing packet by reassembling the Ethernet and
IPv4 headers as computed by the pipeline.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// Include P4 core library
</span><span style="color: #6e7781"># include</span> <span style="color: #0550ae">&lt;</span>core<span style="color: #0550ae">.</span>p4<span style="color: #0550ae">&gt;</span>

<span style="color: #6e7781">// Include very simple switch architecture declarations
</span><span style="color: #6e7781"># include</span> <span style="color: #0a3069">"very_simple_switch_model.p4"</span>

<span style="color: #6e7781">// This program processes packets comprising an Ethernet and an IPv4
// header, and it forwards packets using the destination IP address
</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">48</span><span style="color: #0550ae">&gt;</span>  EthernetAddress<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span>  IPv4Address<span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #6e7781">// Standard Ethernet header
</span><span style="color: #cf222e">header</span> <span style="color: #953800">Ethernet_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    EthernetAddress dstAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
    EthernetAddress srcAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span>         etherType<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// IPv4 header (without options)
</span><span style="color: #cf222e">header</span> <span style="color: #953800">IPv4_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span>       version<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span>       ihl<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>       diffserv<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span>      totalLen<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span>      identification<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">3</span><span style="color: #0550ae">&gt;</span>       flags<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">13</span><span style="color: #0550ae">&gt;</span>      fragOffset<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>       ttl<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>       protocol<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span>      hdrChecksum<span style="color: #24292f;background-color: #f6f8fa">;</span>
    IPv4Address  srcAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
    IPv4Address  dstAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// Structure of parsed headers
</span><span style="color: #cf222e">struct</span> Parsed_packet <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">Ethernet_h</span> ethernet<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">IPv4_h</span>     ip<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// Parser section
</span>
<span style="color: #6e7781">// User-defined errors that may be signaled during parsing
</span><span style="color: #953800">error</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    IPv4OptionsNotSupported<span style="color: #24292f;background-color: #f6f8fa">,</span>
    IPv4IncorrectVersion<span style="color: #24292f;background-color: #f6f8fa">,</span>
    IPv4ChecksumError
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">parser</span> TopParser<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> Parsed_packet p<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    Checksum16<span style="color: #24292f;background-color: #f6f8fa">()</span> ck<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// instantiate checksum unit
</span>
    <span style="color: #cf222e">state</span> start <span style="color: #24292f;background-color: #f6f8fa">{</span>
        b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ethernet<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>etherType<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #0550ae">0x0800</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_ipv4<span style="color: #24292f;background-color: #f6f8fa">;</span>
            <span style="color: #6e7781">// no default rule: all other packets rejected
</span>        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>

    <span style="color: #cf222e">state</span> parse_ipv4 <span style="color: #24292f;background-color: #f6f8fa">{</span>
        b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ip<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #953800">verify</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ip<span style="color: #0550ae">.</span>version <span style="color: #0550ae">==</span> <span style="color: #0550ae">4w4</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">error</span><span style="color: #0550ae">.</span>IPv4IncorrectVersion<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #953800">verify</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ip<span style="color: #0550ae">.</span>ihl <span style="color: #0550ae">==</span> <span style="color: #0550ae">4w5</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">error</span><span style="color: #0550ae">.</span>IPv4OptionsNotSupported<span style="color: #24292f;background-color: #f6f8fa">);</span>
        ck<span style="color: #0550ae">.</span>clear<span style="color: #24292f;background-color: #f6f8fa">();</span>
        ck<span style="color: #0550ae">.</span>update<span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ip<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #6e7781">// Verify that packet checksum is zero
</span>        <span style="color: #953800">verify</span><span style="color: #24292f;background-color: #f6f8fa">(</span>ck<span style="color: #0550ae">.</span>get<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #0550ae">==</span> <span style="color: #0550ae">16w0</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">error</span><span style="color: #0550ae">.</span>IPv4ChecksumError<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #cf222e">transition</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// Match-action pipeline section
</span>
<span style="color: #cf222e">control</span> TopPipe<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> Parsed_packet headers<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">in</span> <span style="color: #953800">error</span> parseError<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #6e7781">// parser error
</span>                <span style="color: #cf222e">in</span> InControl inCtrl<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #6e7781">// input port
</span>                <span style="color: #cf222e">out</span> OutControl outCtrl<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
     IPv4Address nextHop<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// local variable
</span>
     <span style="color: #6e7781">/**
      * Indicates that a packet is dropped by setting the
      * output port to the DROP_PORT
      */</span>
      <span style="color: #cf222e">action</span> Drop_action<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
          outCtrl<span style="color: #0550ae">.</span>outputPort <span style="color: #0550ae">=</span> DROP_PORT<span style="color: #24292f;background-color: #f6f8fa">;</span>
      <span style="color: #24292f;background-color: #f6f8fa">}</span>

     <span style="color: #6e7781">/**
      * Set the next hop and the output port.
      * Decrements ipv4 ttl field.
      * @param ipv4_dest ipv4 address of next hop
      * @param port output port
      */</span>
      <span style="color: #cf222e">action</span> Set_nhop<span style="color: #24292f;background-color: #f6f8fa">(</span>IPv4Address ipv4_dest<span style="color: #24292f;background-color: #f6f8fa">,</span> PortId port<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
          nextHop <span style="color: #0550ae">=</span> ipv4_dest<span style="color: #24292f;background-color: #f6f8fa">;</span>
          headers<span style="color: #0550ae">.</span>ip<span style="color: #0550ae">.</span>ttl <span style="color: #0550ae">=</span> headers<span style="color: #0550ae">.</span>ip<span style="color: #0550ae">.</span>ttl <span style="color: #0550ae">-</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
          outCtrl<span style="color: #0550ae">.</span>outputPort <span style="color: #0550ae">=</span> port<span style="color: #24292f;background-color: #f6f8fa">;</span>
      <span style="color: #24292f;background-color: #f6f8fa">}</span>

     <span style="color: #6e7781">/**
      * Computes address of next IPv4 hop and output port
      * based on the IPv4 destination of the current packet.
      * Decrements packet IPv4 TTL.
      * @param nextHop IPv4 address of next hop
      */</span>
     <span style="color: #cf222e">table</span> ipv4_match <span style="color: #24292f;background-color: #f6f8fa">{</span>
         <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> headers<span style="color: #0550ae">.</span>ip<span style="color: #0550ae">.</span>dstAddr<span style="color: #24292f;background-color: #f6f8fa">:</span> lpm<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>  <span style="color: #6e7781">// longest-prefix match
</span>         <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
              Drop_action<span style="color: #24292f;background-color: #f6f8fa">;</span>
              Set_nhop<span style="color: #24292f;background-color: #f6f8fa">;</span>
         <span style="color: #24292f;background-color: #f6f8fa">}</span>
         <span style="color: #cf222e">size</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">1024</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
         <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> Drop_action<span style="color: #24292f;background-color: #f6f8fa">;</span>
     <span style="color: #24292f;background-color: #f6f8fa">}</span>

     <span style="color: #6e7781">/**
      * Send the packet to the CPU port
      */</span>
      <span style="color: #cf222e">action</span> Send_to_cpu<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
          outCtrl<span style="color: #0550ae">.</span>outputPort <span style="color: #0550ae">=</span> CPU_OUT_PORT<span style="color: #24292f;background-color: #f6f8fa">;</span>
      <span style="color: #24292f;background-color: #f6f8fa">}</span>

     <span style="color: #6e7781">/**
      * Check packet TTL and send to CPU if expired.
      */</span>
     <span style="color: #cf222e">table</span> check_ttl <span style="color: #24292f;background-color: #f6f8fa">{</span>
         <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> headers<span style="color: #0550ae">.</span>ip<span style="color: #0550ae">.</span>ttl<span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
         <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> Send_to_cpu<span style="color: #24292f;background-color: #f6f8fa">;</span> NoAction<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
         <span style="color: #cf222e">const</span> <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> NoAction<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// defined in core.p4
</span>     <span style="color: #24292f;background-color: #f6f8fa">}</span>

     <span style="color: #6e7781">/**
      * Set the destination MAC address of the packet
      * @param dmac destination MAC address.
      */</span>
      <span style="color: #cf222e">action</span> Set_dmac<span style="color: #24292f;background-color: #f6f8fa">(</span>EthernetAddress dmac<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
          headers<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>dstAddr <span style="color: #0550ae">=</span> dmac<span style="color: #24292f;background-color: #f6f8fa">;</span>
      <span style="color: #24292f;background-color: #f6f8fa">}</span>

     <span style="color: #6e7781">/**
      * Set the destination Ethernet address of the packet
      * based on the next hop IP address.
      * @param nextHop IPv4 address of next hop.
      */</span>
      <span style="color: #cf222e">table</span> dmac <span style="color: #24292f;background-color: #f6f8fa">{</span>
          <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> nextHop<span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
          <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
               Drop_action<span style="color: #24292f;background-color: #f6f8fa">;</span>
               Set_dmac<span style="color: #24292f;background-color: #f6f8fa">;</span>
          <span style="color: #24292f;background-color: #f6f8fa">}</span>
          <span style="color: #cf222e">size</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">1024</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
          <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> Drop_action<span style="color: #24292f;background-color: #f6f8fa">;</span>
      <span style="color: #24292f;background-color: #f6f8fa">}</span>

      <span style="color: #6e7781">/**
       * Set the source MAC address.
       * @param smac: source MAC address to use
       */</span>
       <span style="color: #cf222e">action</span> Set_smac<span style="color: #24292f;background-color: #f6f8fa">(</span>EthernetAddress smac<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
           headers<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>srcAddr <span style="color: #0550ae">=</span> smac<span style="color: #24292f;background-color: #f6f8fa">;</span>
       <span style="color: #24292f;background-color: #f6f8fa">}</span>

      <span style="color: #6e7781">/**
       * Set the source mac address based on the output port.
       */</span>
      <span style="color: #cf222e">table</span> smac <span style="color: #24292f;background-color: #f6f8fa">{</span>
           <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> outCtrl<span style="color: #0550ae">.</span>outputPort<span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
           <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
                Drop_action<span style="color: #24292f;background-color: #f6f8fa">;</span>
                Set_smac<span style="color: #24292f;background-color: #f6f8fa">;</span>
          <span style="color: #24292f;background-color: #f6f8fa">}</span>
          <span style="color: #cf222e">size</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">16</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
          <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> Drop_action<span style="color: #24292f;background-color: #f6f8fa">;</span>
      <span style="color: #24292f;background-color: #f6f8fa">}</span>

      <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
          <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>parseError <span style="color: #0550ae">!=</span> <span style="color: #953800">error</span><span style="color: #0550ae">.</span>NoError<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
              Drop_action<span style="color: #24292f;background-color: #f6f8fa">();</span>  <span style="color: #6e7781">// invoke drop directly
</span>              <span style="color: #cf222e">return</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
          <span style="color: #24292f;background-color: #f6f8fa">}</span>

          ipv4_match<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span> <span style="color: #6e7781">// Match result will go into nextHop
</span>          <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>outCtrl<span style="color: #0550ae">.</span>outputPort <span style="color: #0550ae">==</span> DROP_PORT<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">return</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

          check_ttl<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
          <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>outCtrl<span style="color: #0550ae">.</span>outputPort <span style="color: #0550ae">==</span> CPU_OUT_PORT<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">return</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

          dmac<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
          <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>outCtrl<span style="color: #0550ae">.</span>outputPort <span style="color: #0550ae">==</span> DROP_PORT<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">return</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

          smac<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// deparser section
</span><span style="color: #cf222e">control</span> TopDeparser<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> Parsed_packet p<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">packet_out</span> b<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    Checksum16<span style="color: #24292f;background-color: #f6f8fa">()</span> ck<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        b<span style="color: #0550ae">.</span>emit<span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ethernet<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ip<span style="color: #0550ae">.</span><span style="color: #953800">isValid</span><span style="color: #24292f;background-color: #f6f8fa">())</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            ck<span style="color: #0550ae">.</span>clear<span style="color: #24292f;background-color: #f6f8fa">();</span>              <span style="color: #6e7781">// prepare checksum unit
</span>            p<span style="color: #0550ae">.</span>ip<span style="color: #0550ae">.</span>hdrChecksum <span style="color: #0550ae">=</span> <span style="color: #0550ae">16w0</span><span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// clear checksum
</span>            ck<span style="color: #0550ae">.</span>update<span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ip<span style="color: #24292f;background-color: #f6f8fa">);</span>         <span style="color: #6e7781">// compute new checksum.
</span>            p<span style="color: #0550ae">.</span>ip<span style="color: #0550ae">.</span>hdrChecksum <span style="color: #0550ae">=</span> ck<span style="color: #0550ae">.</span>get<span style="color: #24292f;background-color: #f6f8fa">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
        b<span style="color: #0550ae">.</span>emit<span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ip<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// Instantiate the top-level VSS package
</span>VSS<span style="color: #24292f;background-color: #f6f8fa">(</span>TopParser<span style="color: #24292f;background-color: #f6f8fa">(),</span>
    TopPipe<span style="color: #24292f;background-color: #f6f8fa">(),</span>
    TopDeparser<span style="color: #24292f;background-color: #f6f8fa">())</span> main<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-p4-lang-def">6. P4 language definition</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The P4 language can be viewed as having several distinct components,
which we describe separately:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The core language, comprising of types, variables, scoping,
declarations, statements, expressions, etc. We start by describing
this part of the language.</p>
</li>
<li>
<p>A sub-language for expressing parsers, based on state machines
(<a href="#sec-packet-parsing">Chapter 13</a>).</p>
</li>
<li>
<p>A sub-language for expressing computations using match-action units, based on
traditional imperative control-flow (<a href="#sec-control">Chapter 14</a>).</p>
</li>
<li>
<p>A sub-language for describing architectures (<a href="#sec-arch-desc">Chapter 17</a>).</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="sec-syntax">6.1. Syntax and semantics</h3>
<div class="sect3">
<h4 id="sec-grammar-intro">6.1.1. Grammar</h4>
<div class="paragraph">
<p>The complete grammar of P4<sub>16</sub> is given in <a href="#sec-grammar">Appendix G</a>,
using Yacc/Bison grammar description language. This text is based on
the same grammar. We adopt several standard conventions when we provide
excerpts from the grammar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>UPPERCASE</code> symbols denote terminals in the grammar.</p>
</li>
<li>
<p>Excerpts from the grammar are given in BNF notation as follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">p4program
    : /* empty */
    | p4program declaration
    | p4program ";"  /* empty declaration */
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pseudo-code (mostly used for describing the semantics of
various P4 constructs) are shown with fixed-size fonts as in the
following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">ParserModel.verify(bool condition, error err) {
    if (condition == false) {
        ParserModel.parserError = err;
        goto reject;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_semantics_and_the_p4_abstract_machines">6.1.2. Semantics and the P4 abstract machines</h4>
<div class="paragraph">
<p>We describe the semantics of P4 in terms of abstract machines executing
traditional imperative code. There is an abstract machine for each P4
sub-language (parser, control). The abstract machines are described in
this text in pseudo-code and English.</p>
</div>
<div class="paragraph">
<p>P4 compilers are free to reorganize the code they generate in any way as long as
the externally visible behaviors of the P4 programs are preserved as
described by this specification where externally visible behavior is defined as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The input/output behavior of all P4 blocks, and</p>
</li>
<li>
<p>The state maintained by extern blocks.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-preprocessor">6.2. Preprocessing</h3>
<div class="paragraph">
<p>To aid composition of programs from multiple source files P4
compilers should support the following subset of the C preprocessor
functionality:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>#define</code> for defining macros (without arguments)</p>
</li>
<li>
<p><code>#undef</code></p>
</li>
<li>
<p><code>#if #else #endif #ifdef #ifndef #elif</code></p>
</li>
<li>
<p><code>#include</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The preprocessor should also remove the sequence backslash newline (ASCII codes 92, 10)
to facilitate splitting content across multiple lines when convenient for formatting.</p>
</div>
<div class="paragraph">
<p>Additional C preprocessor capabilities may be supported, but
are not guaranteed---e.g., macros with arguments.  Similar to C, <code>#include</code>
can specify a file name either within double quotes or within <code>&lt;&gt;</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781"># include</span> <span style="color: #0550ae">&lt;</span>system_file<span style="color: #0550ae">&gt;</span>
<span style="color: #6e7781"># include</span> <span style="color: #0a3069">"user_file"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The difference between the two forms is the order in which the
preprocessor searches for header files when the path is incompletely
specified.</p>
</div>
<div class="paragraph">
<p>P4 compilers should correctly handle <code>#line</code> directives
that may be generated during preprocessing.  This functionality allows
P4 programs to be built from multiple source files, potentially
produced by different programmers at different times:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the P4 core library, defined in this document,</p>
</li>
<li>
<p>the architecture, defining data plane interfaces and extern blocks,</p>
</li>
<li>
<p>user-defined libraries of useful components (e.g. standard
protocol header definitions), and</p>
</li>
<li>
<p>the P4 programs that specify the behavior of each programmable block.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_p4_core_library">6.3. P4 core library</h3>
<div class="paragraph">
<p>The P4 language specification defines a core library that includes
several common programming constructs. A
description of the core library is provided in
<a href="#sec-p4-core-lib">Appendix D</a>. All P4 programs must include the core
library. Including the core library is done with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781"># include</span> <span style="color: #0550ae">&lt;</span>core<span style="color: #0550ae">.</span>p4<span style="color: #0550ae">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-lexical">6.4. Lexical constructs</h3>
<div class="paragraph">
<p>All P4 keywords use only ASCII characters. All P4 identifiers must use
only ASCII characters. P4 compilers should handle correctly strings
containing 8-bit characters in comments and string literals.
P4 is case-sensitive.
Whitespace characters, including newlines are treated as token
separators. Indentation is free-form; however, P4 has C-like block
constructs, and all our examples use C-style indentation. Tab
characters are treated as spaces.</p>
</div>
<div class="paragraph">
<p>The lexer recognizes the following kinds of terminals:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>IDENTIFIER</code>: start with a letter or underscore, and contain
letters, digits and underscores</p>
</li>
<li>
<p><code>TYPE_IDENTIFIER</code>: identifier that denotes a type name</p>
</li>
<li>
<p><code>INTEGER</code>: integer literals</p>
</li>
<li>
<p><code>DONTCARE</code>: a single underscore</p>
</li>
<li>
<p>Keywords such as <code>RETURN</code>. By convention, each keyword terminal corresponds to a
language keyword with the same spelling but using lowercase. For
example, the <code>RETURN</code> terminal corresponds to the <code>return</code>
keyword.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="sec-identifiers">6.4.1. Identifiers</h4>
<div class="paragraph">
<p>P4 identifiers may contain only letters, numbers, and the underscore
character <code>_</code>, and must start with a letter or
underscore. The special identifier consisting of a single underscore <code>_</code>
is reserved to indicate a "don&#8217;t care" value; its
type may vary depending on the context. Certain keywords (e.g., <code>apply</code>)
can be used as identifiers if the context makes it unambiguous.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">nonTypeName
    : IDENTIFIER
    | APPLY
    | KEY
    | ACTIONS
    | STATE
    | ENTRIES
    | TYPE
    | PRIORITY
    ;

name
    : nonTypeName
    | TYPE_IDENTIFIER
    ;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-comments">6.4.2. Comments</h4>
<div class="paragraph">
<p>P4 supports several kinds of comments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Single-line comments, introduced by <code>//</code> and spanning to the end of line,</p>
</li>
<li>
<p>Multi-line comments, enclosed between <code>/*</code> and <code>*/</code></p>
</li>
<li>
<p>Nested multi-line comments are not supported.</p>
</li>
<li>
<p>Javadoc-style comments, starting with <code>/**</code> and ending with <code>*/</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Use of Javadoc-style comments is strongly encouraged for the tables and actions
that are used to synthesize the interface with the control-plane.</p>
</div>
<div class="paragraph">
<p>P4 treats comments as token separators and no comments are allowed within a
token---e.g. <code>bi/**/t</code> is parsed as two tokens, <code>bi</code> and <code>t</code>, and
not as a single token <code>bit</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-literals">6.4.3. Literal constants</h4>
<div class="sect4">
<h5 id="sec-Boolean-literals">6.4.3.1. Boolean literals</h5>
<div class="paragraph">
<p>There are two Boolean literal constants: <code>true</code> and <code>false</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-integer-literals">6.4.3.2. Integer literals</h5>
<div class="paragraph">
<p>Integer literals are non-negative arbitrary-precision integers.
By default, literals are represented in base 10. The following prefixes
must be employed to specify the base explicitly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>0x</code> or <code>0X</code> indicates base 16 (hexadecimal)</p>
</li>
<li>
<p><code>0o</code> or <code>0O</code> indicates base 8 (octal)</p>
</li>
<li>
<p><code>0d</code> or <code>0D</code> indicates base 10 (decimal)</p>
</li>
<li>
<p><code>0b</code> or <code>0B</code> indicates base 2</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The width of a numeric literal in bits can be specified by an unsigned
number prefix consisting of a number of bits and a signedness
indicator:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>w</code> indicates unsigned numbers</p>
</li>
<li>
<p><code>s</code> indicates signed numbers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that a leading zero by itself does not indicate an
octal (base 8) constant.  The underscore character is considered a
digit within number literals but is ignored when computing the
value of the parsed number. This allows long constant numbers to be
more easily read by grouping digits together. The underscore cannot be
used in the width specification or as the first character of an
integer literal. No comments or whitespaces are allowed within a
literal. Here are some examples of numeric literals:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">32w255</span>         <span style="color: #6e7781">// a 32-bit unsigned number with value 255
</span><span style="color: #0550ae">32w0d255</span>       <span style="color: #6e7781">// same value as above
</span><span style="color: #0550ae">32w0xFF</span>        <span style="color: #6e7781">// same value as above
</span><span style="color: #0550ae">32s0xFF</span>        <span style="color: #6e7781">// a 32-bit signed number with value 255
</span><span style="color: #0550ae">8w0b10101010</span>   <span style="color: #6e7781">// an 8-bit unsigned number with value 0xAA
</span><span style="color: #0550ae">8w0b_1010_1010</span> <span style="color: #6e7781">// same value as above
</span><span style="color: #0550ae">8w170</span>          <span style="color: #6e7781">// same value as above
</span><span style="color: #0550ae">8s0b1010_1010</span>  <span style="color: #6e7781">// an 8-bit signed number with value -86
</span><span style="color: #0550ae">16w0377</span>        <span style="color: #6e7781">// 16-bit unsigned number with value 377 (not 255!)
</span><span style="color: #0550ae">16w0o377</span>       <span style="color: #6e7781">// 16-bit unsigned number with value 255 (base 8)</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sec-string-literals">6.4.3.3. String literals</h5>
<div class="paragraph">
<p>String literals are specified as an arbitrary sequence of 8-bit
characters, enclosed within double quote characters <code>"</code> (ASCII code
34). Strings start with a double quote character and extend to the
first double quote sign which is not immediately preceded by an odd
number of backslash characters (ASCII code 92). P4 does not make any
validity checks on strings (i.e., it does not check that strings
represent legal UTF-8 encodings).</p>
</div>
<div class="paragraph">
<p>Since P4 does not provide any operations on strings,
string literals are generally passed unchanged through the P4 compiler to
other third-party tools or compiler-backends, including the
terminating quotes. These tools can define their own handling of
escape sequences (e.g., how to specify Unicode characters, or handle
unprintable ASCII characters).</p>
</div>
<div class="paragraph">
<p>Here are 3 examples of string literals:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0a3069">"simple string"</span>
<span style="color: #0a3069">"string \" with \" embedded \" quotes"</span>
<span style="color: #0a3069">"string with embedded
line terminator"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-trailing-commas">6.4.4. Optional trailing commas</h4>
<div class="paragraph">
<p>The P4 grammar allows several kinds of comma-separated lists to end in
an optional comma.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">optTrailingComma
    : /* empty */
    | ","
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, the following declarations are both legal, and
have the same meaning:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> E <span style="color: #24292f;background-color: #f6f8fa">{</span>
     a<span style="color: #24292f;background-color: #f6f8fa">,</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> c
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">enum</span> E <span style="color: #24292f;background-color: #f6f8fa">{</span>
     a<span style="color: #24292f;background-color: #f6f8fa">,</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> c<span style="color: #24292f;background-color: #f6f8fa">,</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is particularly useful in combination with preprocessor
directives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> E <span style="color: #24292f;background-color: #f6f8fa">{</span>
<span style="color: #6e7781">#if</span> SUPPORT_A
    a<span style="color: #24292f;background-color: #f6f8fa">,</span>
<span style="color: #6e7781">#endif</span>
    b<span style="color: #24292f;background-color: #f6f8fa">,</span>
    c<span style="color: #24292f;background-color: #f6f8fa">,</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-naming-conventions">6.5. Naming conventions</h3>
<div class="paragraph">
<p>P4 provides a rich assortment of types. Base types include bit-strings, numbers, and errors.
There are also built-in types for
representing constructs such as parsers, pipelines, actions, and
tables. Users can
construct new types based on these: structures, enumerations, headers,
header stacks, header unions, etc.</p>
</div>
<div class="paragraph">
<p>In this document we adopt the following conventions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Built-in types are written with lowercase characters---e.g., <code>int&lt;20&gt;</code>,</p>
</li>
<li>
<p>User-defined types are capitalized---e.g., <code>IPv4Address</code>,</p>
</li>
<li>
<p>Type variables are always uppercase---e.g., <code>parser P&lt;H, IH&gt;()</code>,</p>
</li>
<li>
<p>Variables are uncapitalized--- e.g., <code>ipv4header</code>,</p>
</li>
<li>
<p>Constants are written with uppercase characters---e.g., <code>CPU_PORT</code>, and</p>
</li>
<li>
<p>Errors and enumerations are written in camel-case--- e.g. <code>PacketTooShort</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sec-p4-prog-structure">6.6. P4 programs</h3>
<div class="paragraph">
<p>A P4 program is a list of declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">p4program
    : /* empty */
    | p4program declaration
    | p4program ";"  /* empty declaration */
    ;

declaration
    : constantDeclaration
    | externDeclaration
    | actionDeclaration
    | parserDeclaration
    | typeDeclaration
    | controlDeclaration
    | instantiation
    | errorDeclaration
    | matchKindDeclaration
    | functionDeclaration
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An empty declarations is indicated with a single semicolon. (Allowing empty
declarations accommodates the
habits of C/C++ and Java programmers---e.g., certain constructs, like <code>struct</code>,
do not require a terminating semicolon).</p>
</div>
<div class="sect3">
<h4 id="sec-scopes">6.6.1. Scopes</h4>
<div class="paragraph">
<p>Some P4 constructs act as namespaces that create local scopes for names including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Derived type declarations (<code>struct</code>, <code>header</code>, <code>header_union</code>, <code>enum</code>),
which introduce local scopes for field names,</p>
</li>
<li>
<p>Block statements, which introduce local lexically-enclosed scopes,</p>
</li>
<li>
<p><code>parser</code>, <code>table</code>, <code>action</code>, and <code>control</code> blocks, which
introduce local scopes</p>
</li>
<li>
<p>Declarations with type variables, which introduce a new scope for those
variables. For example, in the following <code>extern</code> declaration,
the scope of the type variable <code>H</code> extends to the end of the
declaration:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> E<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #6e7781">// scope of H ends here.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The order of declarations is important; with the exception of parser
states, all uses of a symbol must follow the symbol&#8217;s
declaration. (This is a departure from P4<sub>14</sub>, which
allows declarations in any order. This requirement significantly simplifies the implementation of
compilers for P4, allowing compilers to use additional information
about declared identifiers to resolve ambiguities.)</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-stateful-elems">6.6.2. Stateful elements</h4>
<div class="paragraph">
<p>Most P4 constructs are stateless: given some inputs they produce a
result that solely depends on these inputs. There are only two stateful constructs
that may retain information across packets:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>table</code>s: Tables are read-only for the data plane, but their
entries can be modified by the control-plane,</p>
</li>
<li>
<p><code>extern</code> objects: many objects have state that can be read and
written by the control plane and data plane. All constructs from the P4<sub>14</sub> language
version that encapsulate state (e.g., counters, meters, registers) are
represented using <code>extern</code> objects in P4<sub>16</sub>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In P4 all stateful elements must be explicitly allocated at
compilation-time through the process called "instantiation".</p>
</div>
<div class="paragraph">
<p>In addition, <code>parser</code>s, <code>control</code> blocks, and <code>package</code>s
may contain stateful element instantiations. Thus, they are also
treated as stateful elements, even if they appear to contain no state,
and must be instantiated before they can be used. However, although
they are stateful, <code>table</code>s do not need to be instantiated
explicitly---declaring a <code>table</code> also creates an instance of
it. This convention is designed to support the common case, since most
tables are used just once. To have finer-grained control over when
a <code>table</code> is instantiated, a programmer can declare it within
a <code>control</code>.</p>
</div>
<div class="paragraph">
<p>Recall the example in <a href="#sec-vss-all">Section 5.3</a>: <code>TopParser</code>, <code>TopPipe</code>, <code>TopDeparser</code>, <code>Checksum16</code>,
and <code>Switch</code> are types. There are two instances of <code>Checksum16</code>, one in <code>TopParser</code> and
one in <code>TopDeparser</code>, both called <code>ck</code>. The <code>TopParser</code>, <code>TopDeparser</code>, <code>TopPipe</code>,
and <code>Switch</code> are instantiated at the end of the program, in the
declaration of the <code>main</code> instance object, which is an instance of
the <code>Switch</code> type (a <code>package</code>).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-lvalues">6.7. L-values</h3>
<div class="paragraph">
<p>L-values are expressions that may appear on the left side of an
assignment operation or as arguments corresponding to <code>out</code> and <code>inout</code>
function parameters. An l-value represents a storage reference.  The
following expressions are legal l-values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">prefixedNonTypeName
    : nonTypeName
    | dotPrefix nonTypeName
    ;

lvalue
    : prefixedNonTypeName
    | THIS
    | lvalue "." member
    | lvalue "[" expression "]"
    | lvalue "[" expression ":" expression "]"
    | "(" lvalue ")"
    ;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Identifiers of a base or derived type.</p>
</li>
<li>
<p>Structure, header, and header union field member access operations
(using the dot notation).</p>
</li>
<li>
<p>References to elements within header stacks (see
<a href="#sec-expr-hs">Section 8.18</a>): indexing, and references to <code>last</code> and <code>next</code>.</p>
</li>
<li>
<p>The result of a bit-slice operator <code>[m:l]</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following is a legal l-value: <code>headers.stack[4].field</code>.  Note
that method and function calls cannot return l-values.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-calling-convention">6.8. Calling convention: call by copy in/copy out</h3>
<div class="paragraph">
<p>P4 provides multiple constructs for writing modular programs: extern
methods, parsers, controls, actions. All these constructs behave
similarly to procedures in standard general-purpose programming languages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>They have named and typed parameters.</p>
</li>
<li>
<p>They introduce a new local scope for parameters and local variables.</p>
</li>
<li>
<p>They allow arguments to be passed by binding them to their
parameters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Invocations are executed using copy-in/copy-out semantics.</p>
</div>
<div class="paragraph">
<p>Each parameter may be labeled with a direction:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>in</code> parameters are read-only. It is an error to use an <code>in</code>
parameter on the left-hand side of an assignment or to
pass it to a callee as a non-<code>in</code> argument. <code>in</code> parameters
are initialized by copying the value of the corresponding
argument when the invocation is executed.</p>
</li>
<li>
<p><code>out</code> parameters are, with a few exceptions listed below,
uninitialized and are treated as l-values
(See <a href="#sec-lvalues">Section 6.7</a>) within the body of the method or function.
An argument passed as an <code>out</code>
parameter must be an l-value; after the execution of the
call, the value of the parameter is copied to the corresponding storage location
for that l-value.</p>
</li>
<li>
<p><code>inout</code> parameters behave like a combination of <code>in</code> and <code>out</code> parameters simultaneously:
On entry the value of the arguments is copied to the parameters.  On return the
value of the parameters is copied back to the arguments.  In consequence, an argument
passed as an <code>inout</code> parameter must be an l-value.</p>
</li>
<li>
<p>The meaning of parameters with no direction depends upon the kind of
entity the parameter is for:</p>
<div class="ulist">
<ul>
<li>
<p>For anything other than an action, e.g. a control, parser, or
function, a directionless parameter means that the value supplied
as an argument in a call must be a compile-time known value
(see <a href="#sec-compile-time-known">Section 18.1</a>).</p>
</li>
<li>
<p>For an action, a directionless parameter indicates that it is
"action data".  See <a href="#sec-actions">Section 14.1</a> for the meaning of
action data, but its meaning includes the following possibilities:</p>
<div class="ulist">
<ul>
<li>
<p>The parameter&#8217;s value is provided in the P4 program.  In this
case, the parameter behaves as if the direction were <code>in</code>.  Such
an argument expression need not be a compile-time known value.</p>
</li>
<li>
<p>The parameter&#8217;s value is provided by the control plane software
when an entry is added to a table that uses that action.  See
<a href="#sec-actions">Section 14.1</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>A directionless parameter of extern object type is passed by reference.</p>
</div>
<div class="paragraph">
<p>Direction <code>out</code> parameters are always initialized at the beginning of
execution of the portion of the program that has the <code>out</code> parameters,
e.g. <code>control</code>, <code>parser</code>, <code>action</code>, function, etc.  This
initialization is not performed for parameters with any direction that
is not <code>out</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a direction <code>out</code> parameter is of type <code>header</code> or
<code>header_union</code>, it is set to "invalid".</p>
</li>
<li>
<p>If a direction <code>out</code> parameter is of type header stack, all elements
of the header stack are set to "invalid", and its <code>nextIndex</code> field
is initialized to 0 (see <a href="#sec-expr-hs">Section 8.18</a>).</p>
</li>
<li>
<p>If a direction <code>out</code> parameter is a compound type, e.g. a struct or
tuple, other than one of the types listed above, then apply these
rules recursively to its members.</p>
</li>
<li>
<p>If a direction <code>out</code> parameter has any other type, e.g. <code>bit&lt;W&gt;</code>, an
implementation need not initialize it to any predictable value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, if a direction <code>out</code> parameter has type <code>s2_t</code> named <code>p</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> <span style="color: #953800">h1_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> f1<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> f2<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">struct</span> <span style="color: #953800">s1_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">h1_t</span> h1a<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">3</span><span style="color: #0550ae">&gt;</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">7</span><span style="color: #0550ae">&gt;</span> b<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">struct</span> <span style="color: #953800">s2_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">h1_t</span> h1b<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">s1_t</span> s1<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">5</span><span style="color: #0550ae">&gt;</span> c<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>then at the beginning of execution of the part of the program that has
the <code>out</code> parameter <code>p</code>, it must be initialized so that <code>p.h1b</code> and
and <code>p.s1.h1a</code> are invalid.  No other parts of <code>p</code> are required to be
initialized.</p>
</div>
<div class="paragraph">
<p>Arguments are evaluated from left to right prior to the invocation of the
function itself. The order of evaluation is important when the
expression supplied for an argument can have side-effects. Consider
the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> <span style="color: #953800">void</span> f<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> <span style="color: #953800">bit</span> x<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> <span style="color: #953800">bit</span> y<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">extern</span> <span style="color: #953800">bit</span> g<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> <span style="color: #953800">bit</span> z<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #953800">bit</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>
f<span style="color: #24292f;background-color: #f6f8fa">(</span>a<span style="color: #24292f;background-color: #f6f8fa">,</span> g<span style="color: #24292f;background-color: #f6f8fa">(</span>a<span style="color: #24292f;background-color: #f6f8fa">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the evaluation of <code>g</code> may mutate its argument <code>a</code>, so the
compiler has to ensure that the value passed to <code>f</code> for its first
parameter is not changed by the evaluation of the second argument. The
semantics for evaluating a function call is given by the following
algorithm (implementations can be different as long as they provide
the same result):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Arguments are evaluated from left to right as they appear in the
function call expression.</p>
</li>
<li>
<p>If a parameter has a default value and no corresponding argument is
supplied, the default value is used as an argument.</p>
</li>
<li>
<p>For each <code>out</code> and <code>inout</code> argument the corresponding
l-value is saved (so it cannot be changed by the evaluation of
the following arguments). This is important if the argument
contains indexing operations into a header stack.</p>
</li>
<li>
<p>The value of each argument is saved into a temporary.</p>
</li>
<li>
<p>The function is invoked with the temporaries as arguments. We are
guaranteed that the temporaries that are passed as arguments are
never aliased to each other, so this "generated" function call
can be implemented using call-by-reference if supported by the
architecture.</p>
</li>
<li>
<p>On function return, the temporaries that correspond to <code>out</code>
or <code>inout</code> arguments are copied in order from left to right
into the l-values saved in Step 3.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>According to this algorithm, the previous function call is equivalent
to the following sequence of statements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">bit</span> tmp1 <span style="color: #0550ae">=</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>     <span style="color: #6e7781">// evaluate a; save result
</span><span style="color: #953800">bit</span> tmp2 <span style="color: #0550ae">=</span> g<span style="color: #24292f;background-color: #f6f8fa">(</span>a<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// evaluate g(a); save result; modifies a
</span>f<span style="color: #24292f;background-color: #f6f8fa">(</span>tmp1<span style="color: #24292f;background-color: #f6f8fa">,</span> tmp2<span style="color: #24292f;background-color: #f6f8fa">);</span>    <span style="color: #6e7781">// evaluate f; modifies tmp1
</span>a <span style="color: #0550ae">=</span> tmp1<span style="color: #24292f;background-color: #f6f8fa">;</span>         <span style="color: #6e7781">// copy inout result back into a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To see why Step 3 in the above algorithm is important, consider the following
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> H <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #953800">bit</span> z<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
H<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">]</span> s<span style="color: #24292f;background-color: #f6f8fa">;</span>
f<span style="color: #24292f;background-color: #f6f8fa">(</span>s<span style="color: #24292f;background-color: #f6f8fa">[</span>a<span style="color: #24292f;background-color: #f6f8fa">]</span><span style="color: #0550ae">.</span>z<span style="color: #24292f;background-color: #f6f8fa">,</span> g<span style="color: #24292f;background-color: #f6f8fa">(</span>a<span style="color: #24292f;background-color: #f6f8fa">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The evaluation of this call is equivalent to the following sequence of
statements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">bit</span> tmp1 <span style="color: #0550ae">=</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>          <span style="color: #6e7781">// save the value of a
</span><span style="color: #953800">bit</span> tmp2 <span style="color: #0550ae">=</span> s<span style="color: #24292f;background-color: #f6f8fa">[</span>tmp1<span style="color: #24292f;background-color: #f6f8fa">]</span><span style="color: #0550ae">.</span>z<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// evaluate first argument
</span><span style="color: #953800">bit</span> tmp3 <span style="color: #0550ae">=</span> g<span style="color: #24292f;background-color: #f6f8fa">(</span>a<span style="color: #24292f;background-color: #f6f8fa">);</span>       <span style="color: #6e7781">// evaluate second argument; modifies a
</span>f<span style="color: #24292f;background-color: #f6f8fa">(</span>tmp2<span style="color: #24292f;background-color: #f6f8fa">,</span> tmp3<span style="color: #24292f;background-color: #f6f8fa">);</span>         <span style="color: #6e7781">// evaluate f; modifies tmp2
</span>s<span style="color: #24292f;background-color: #f6f8fa">[</span>tmp1<span style="color: #24292f;background-color: #f6f8fa">]</span><span style="color: #0550ae">.</span>z <span style="color: #0550ae">=</span> tmp2<span style="color: #24292f;background-color: #f6f8fa">;</span>      <span style="color: #6e7781">// copy inout result back; dest is not s[a].z</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When used as arguments, <code>extern</code> objects can only be passed as
directionless parameters---e.g., see the packet argument in the
very simple switch example.</p>
</div>
<div class="sect3">
<h4 id="sec-calling-convention-justification">6.8.1. Justification</h4>
<div class="paragraph">
<p>The main reason for using copy-in/copy-out semantics (instead of the more common
call-by-reference semantics) is for controlling the side-effects of <code>extern</code>
functions and methods. <code>extern</code> methods and functions
are the main mechanism by which a P4 program communicates with its
environment. With copy-in/copy-out semantics <code>extern</code> functions
cannot hold references to P4 program objects; this enables the
compiler to limit the side-effects that <code>extern</code> functions may
have on the P4 program both in space (they can only affect <code>out</code>
parameters) and in time (side-effects can only occur at function call
time).</p>
</div>
<div class="paragraph">
<p>In general, <code>extern</code> functions are arbitrarily powerful: they can store
information in global storage, spawn separate threads, "collude" with
each other to share information --- but they cannot access any
variable in a P4 program. With copy-in/copy-out semantics the compiler
can still reason about P4 programs that invoke <code>extern</code>
functions.</p>
</div>
<div class="paragraph">
<p>There are additional benefits of using copy-in copy-out semantics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It enables P4 to be compiled for architectures that do not support
references (e.g., where all data is allocated to named
registers. Such architectures may require indices into header stacks that appear
in a program to be compile-time known values.)</p>
</li>
<li>
<p>It simplifies some compiler analyses, since function parameters can
never alias to each other within the function body.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">parameterList
    : /* empty */
    | nonEmptyParameterList
    ;

nonEmptyParameterList
    : parameter
    | nonEmptyParameterList "," parameter
    ;

parameter
    : optAnnotations direction typeRef name
    | optAnnotations direction typeRef name "=" expression
    ;

direction
    : IN
    | OUT
    | INOUT
    | /* empty */
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Following is a summary of the constraints imposed by the parameter
directions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When used as arguments, extern objects can only be passed as
directionless parameters.</p>
</li>
<li>
<p>All constructor parameters are evaluated at compilation-time, and in
consequence they must all be directionless (they cannot be <code>in</code>,
<code>out</code>, or <code>inout</code>); this applies to <code>package</code>, <code>control</code>, <code>parser</code>,
and <code>extern</code> objects. Expressions for these parameters must be supplied
at compile-time, and they must evaluate to compile-time known values.
See <a href="#sec-parameterization">Chapter 15</a> for further details.</p>
</li>
<li>
<p>For actions all directionless parameters must be at the end of the
parameter list.  When an action appears in a <code>table</code>'s <code>actions</code>
list, only the parameters with a direction must be bound.
See <a href="#sec-actions">Section 14.1</a> for further details.</p>
</li>
<li>
<p>Actions can also be explicitly invoked using function call syntax,
either from a control block or from another action. In this case,
values for all action parameters must be supplied explicitly,
including values for the directionless parameters. The directionless
parameters in this case behave like <code>in</code> parameters.
See <a href="#sec-invoke-actions">Section 14.1.1</a> for further details.</p>
</li>
<li>
<p>Default expressions are only allowed for 'in' or direction-less
parameters, and the expressions supplied as defaults must be
compile-time known values.</p>
</li>
<li>
<p>If parameters with default values do not appear at the
end of the list of parameters, invocations that use
the default values must use named arguments, as in the following
example:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> <span style="color: #953800">void</span> f<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span> a<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">3</span><span style="color: #0550ae">&gt;</span> b <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">5</span><span style="color: #0550ae">&gt;</span> c<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #953800">void</span> g<span style="color: #24292f;background-color: #f6f8fa">()</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
  f<span style="color: #24292f;background-color: #f6f8fa">(</span>a <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span> b <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">,</span> c <span style="color: #0550ae">=</span> <span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// ok
</span>  f<span style="color: #24292f;background-color: #f6f8fa">(</span>a <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span> c <span style="color: #0550ae">=</span> <span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// ok, equivalent to the previous call, b uses default value
</span>  f<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">);</span>       <span style="color: #6e7781">// ok, equivalent to the previous call
</span>  <span style="color: #6e7781">// f(1, 3); // illegal, since the parameter b is not the last in the list
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-optional-parameters">6.8.2. Optional parameters</h4>
<div class="paragraph">
<p>A parameter that is annotated with the <code>@optional</code> annotation is
optional: the user may omit the value for that parameter in an
invocation.  Optional parameters can only appear for arguments of:
packages, parser types, control types, extern functions, extern methods, and extern object
constructors.  Optional parameters cannot have default values.  If a
procedure-like construct has both optional parameters and default values then it
can only be called using named arguments.  It is recommended, but not
mandatory, for all optional parameters to be at the end of a parameter
list.</p>
</div>
<div class="paragraph">
<p>The implementation of such objects is not expressed in P4, so the
meaning and implementation of optional parameters should be specified
by the target architecture.  For example, we can imagine a two-stage
switch architecture where the second stage is optional. This could be
declared as a package with an optional parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">package</span> pipeline<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">package</span> <span style="color: #cf222e">switch</span><span style="color: #24292f;background-color: #f6f8fa">(</span>pipeline first<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">@optional</span> pipeline second<span style="color: #24292f;background-color: #f6f8fa">);</span>

pipeline<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* arguments omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)</span> ingress<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">switch</span><span style="color: #24292f;background-color: #f6f8fa">(</span>ingress<span style="color: #24292f;background-color: #f6f8fa">)</span> main<span style="color: #24292f;background-color: #f6f8fa">;</span>   <span style="color: #6e7781">// a switch with a single-stage pipeline</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the target architecture could implement the elided optional argument using an empty pipeline.</p>
</div>
<div class="paragraph">
<p>The following example shows optional parameters and parameters with
default values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> <span style="color: #953800">void</span> h<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> a<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> <span style="color: #953800">bool</span> b <span style="color: #0550ae">=</span> true<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// default value
</span>
<span style="color: #6e7781">// function calls
</span>h<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// same as h(10, true);
</span>h<span style="color: #24292f;background-color: #f6f8fa">(</span>a <span style="color: #0550ae">=</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// same as h(10, true);
</span>h<span style="color: #24292f;background-color: #f6f8fa">(</span>a <span style="color: #0550ae">=</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">,</span> b <span style="color: #0550ae">=</span> true<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">struct</span> Empty <span style="color: #24292f;background-color: #f6f8fa">{}</span>
<span style="color: #cf222e">control</span> nothing<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> Empty h<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">inout</span> Empty m<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">parser</span> parserProto<span style="color: #0550ae">&lt;</span>H<span style="color: #24292f;background-color: #f6f8fa">,</span> M<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> p<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> H h<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">inout</span> M m<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">control</span> controlProto<span style="color: #0550ae">&lt;</span>H<span style="color: #24292f;background-color: #f6f8fa">,</span> M<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> H h<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">inout</span> M m<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">package</span> pack<span style="color: #0550ae">&lt;</span>HP<span style="color: #24292f;background-color: #f6f8fa">,</span> MP<span style="color: #24292f;background-color: #f6f8fa">,</span> HC<span style="color: #24292f;background-color: #f6f8fa">,</span> MC<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>
    <span style="color: #0550ae">@optional</span> parserProto<span style="color: #0550ae">&lt;</span>HP<span style="color: #24292f;background-color: #f6f8fa">,</span> MP<span style="color: #0550ae">&gt;</span> <span style="color: #0550ae">_</span><span style="color: #cf222e">parser</span><span style="color: #24292f;background-color: #f6f8fa">,</span>  <span style="color: #6e7781">// optional parameter
</span>                             controlProto<span style="color: #0550ae">&lt;</span>HC<span style="color: #24292f;background-color: #f6f8fa">,</span> MC<span style="color: #0550ae">&gt;</span> <span style="color: #0550ae">_</span><span style="color: #cf222e">control</span> <span style="color: #0550ae">=</span> nothing<span style="color: #24292f;background-color: #f6f8fa">());</span> <span style="color: #6e7781">// default parameter value
</span>
pack<span style="color: #24292f;background-color: #f6f8fa">()</span> main<span style="color: #24292f;background-color: #f6f8fa">;</span>   <span style="color: #6e7781">// No value for _parser, _control is an instance of nothing()</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-name-resolution">6.9. Name resolution</h3>
<div class="paragraph">
<p>P4 objects that introduce namespaces are organized in a hierarchical
fashion. There is a top-level unnamed namespace containing all
top-level declarations.</p>
</div>
<div class="paragraph">
<p>Identifiers prefixed with a dot are always resolved in the top-level
namespace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">const</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> x <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">control</span> c<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #953800">int</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> x <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
       x <span style="color: #0550ae">=</span> x <span style="color: #0550ae">+</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">int</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)</span><span style="color: #0550ae">.</span>x<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// x is the int&lt;32&gt; local variable,
</span>                             <span style="color: #6e7781">// .x is the top-level bit&lt;32&gt; variable
</span>   <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>References to resolve an identifier are attempted inside-out, starting
with the current scope and proceeding to all lexically enclosing
scopes. The compiler may provide a warning if multiple resolutions are
possible for the same name (name shadowing).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">const</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span> x <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">control</span> p<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">const</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> x <span style="color: #0550ae">=</span> <span style="color: #0550ae">8</span><span style="color: #24292f;background-color: #f6f8fa">;</span>    <span style="color: #6e7781">// x declaration shadows global x
</span>    <span style="color: #cf222e">const</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span> y <span style="color: #0550ae">=</span> <span style="color: #0550ae">.</span>x<span style="color: #24292f;background-color: #f6f8fa">;</span>   <span style="color: #6e7781">// reference to top-level x
</span>    <span style="color: #cf222e">const</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> z <span style="color: #0550ae">=</span> x<span style="color: #24292f;background-color: #f6f8fa">;</span>    <span style="color: #6e7781">// reference to p's local x
</span>    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-name-visibility">6.10. Visibility</h3>
<div class="paragraph">
<p>Identifiers defined in the top-level namespace are globally
visible. Declarations within a <code>parser</code> or <code>control</code> are
private and cannot be referred to from outside of the enclosing <code>parser</code>
or <code>control</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-p4-type">7. P4 data types</h2>
<div class="sectionbody">
<div class="paragraph">
<p>P4<sub>16</sub> is a statically-typed language. Programs that do not pass
the type checker are considered invalid and rejected by the
compiler. P4 provides a number of base types as well as type operators that
construct derived types. Some values can be converted to a different type using
casts. However, to make user intents clear, implicit casts are only allowed in
a few circumstances and the range of casts available is intentionally
restricted.</p>
</div>
<div class="sect2">
<h3 id="sec-base-types">7.1. Base types</h3>
<div class="paragraph">
<p>P4 supports the following built-in base types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>void</code> type, which has no values and can be used only in a few
restricted circumstances.</p>
</li>
<li>
<p>The <code>error</code> type, which is used to convey errors in a
target-independent, compiler-managed way.</p>
</li>
<li>
<p>The <code>string</code> type, which can be used with compile-time known
values of type string.</p>
</li>
<li>
<p>The <code>match_kind</code> type, which is used for describing the implementation of
table lookups,</p>
</li>
<li>
<p><code>bool</code>, which represents Boolean values</p>
</li>
<li>
<p><code>int</code>, which represents arbitrary-sized integer values</p>
</li>
<li>
<p>Bit-strings of fixed width, denoted by <code>bit&lt;&gt;</code></p>
</li>
<li>
<p>Fixed-width signed integers represented using two&#8217;s complement <code>int&lt;&gt;</code></p>
</li>
<li>
<p>Bit-strings of dynamically-computed width with a fixed maximum width <code>varbit&lt;&gt;</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">baseType
    : BOOL
    | MATCH_KIND
    | ERROR
    | BIT
    | STRING
    | INT
    | BIT "&lt;" INTEGER "&gt;"
    | INT "&lt;" INTEGER "&gt;"
    | VARBIT "&lt;" INTEGER "&gt;"
    | BIT "&lt;" "(" expression ")" "&gt;"
    | INT "&lt;" "(" expression ")" "&gt;"
    | VARBIT "&lt;" "(" expression ")" "&gt;"
    ;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_the_void_type">7.1.1. The void type</h4>
<div class="paragraph">
<p>The void type is written <code>void</code>. It contains no values. It is
not included in the production rule <code>baseType</code> as it can only appear in few
restricted places in P4 programs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_error_type">7.1.2. The error type</h4>
<div class="paragraph">
<p>The error type contains opaque distinct values that can be used to signal
errors. It is written as <code>error</code>. New elements of the error type
are defined with the syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">errorDeclaration
    : ERROR "{" identifierList "}"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>All elements of the <code>error</code> type are inserted into the <code>error</code>
namespace, irrespective of the place where an error is
defined. <code>error</code> is similar to an enumeration (<code>enum</code>)
type in other languages. A program can contain multiple <code>error</code> declarations, which
the compiler will merge together. It is an error to declare the same
identifier multiple times. Expressions of type <code>error</code> are
described in <a href="#sec-error-exprs">Section 8.2</a>.</p>
</div>
<div class="paragraph">
<p>For example, the following declaration creates two elements of the <code>error</code>
type (these errors are declared in the P4 core library):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">error</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> ParseError<span style="color: #24292f;background-color: #f6f8fa">,</span> PacketTooShort <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The underlying representation of errors is target-dependent.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-match-kind-type">7.1.3. The match kind type</h4>
<div class="paragraph">
<p>The <code>match_kind</code> type is very similar to the <code>error</code> type and
is used to declare a set of distinct names that may be
used in a table&#8217;s key property (described in <a href="#sec-table-props">Section 14.2.1</a>).
All identifiers are inserted into the
top-level namespace.
It is an error to declare the same <code>match_kind</code>
identifier multiple times.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">matchKindDeclaration
    : MATCH_KIND "{" identifierList optTrailingComma "}"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The P4 core library contains the following match_kind declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">match_kind</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   exact<span style="color: #24292f;background-color: #f6f8fa">,</span>
   ternary<span style="color: #24292f;background-color: #f6f8fa">,</span>
   lpm
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Architectures may support additional <code>match_kind</code>s. The
declaration of new <code>match_kind</code>s can only occur within model
description files; P4 programmers cannot declare new match kinds.</p>
</div>
<div class="paragraph">
<p>Operations on values of type <code>match_kind</code> are described in
<a href="#sec-match-kind-exprs">Section 8.4</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-bool-type">7.1.4. The Boolean type</h4>
<div class="paragraph">
<p>The Boolean type <code>bool</code> contains just two values, <code>false</code> and <code>true</code>.
Boolean values are not integers or bit-strings.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-string-type">7.1.5. Strings</h4>
<div class="paragraph">
<p>The type <code>string</code> represents strings.  There are no operations on
string values; one cannot declare variables with a <code>string</code> type.
Parameters with type <code>string</code> can be only directionless (see
<a href="#sec-calling-convention">Section 6.8</a>).
P4 does not support string manipulation
in the dataplane; the <code>string</code> type is only allowed for describing
compile-time known values (i.e., string literals, as discussed in
Section <a href="#sec-string-literals">Section 6.4.3.3</a>). Even so, the string type is useful,
for example, in giving the type signature for extern functions such as
the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> <span style="color: #953800">void</span> log<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">string</span> message<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As another example, the following annotation indicates that the specified
name should be used for a given table in the generated control-plane API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@name</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"acl"</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">table</span> t1 <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-integers">7.1.6. Integers (signed and unsigned)</h4>
<div class="paragraph">
<p>P4 supports arbitrary-size integer values. The typing rules for the
integer types are chosen according to the following principles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Inspired by C</strong>: Typing of integers is modeled after the
well-defined parts of C, expanded to cope with arbitrary fixed-width
integers. In particular, the type of the result of an expression
only depends on the expression operands, and not on how the result
of the expression is consumed.</p>
</li>
<li>
<p><strong>No undefined behaviors</strong>: P4 attempts to avoid many of C&#8217;s
behaviors, which include the size of an integer (int), the results produced
on overflow, and the results produced for some input combinations
(e.g., shifts with negative amounts, overflows on signed numbers,
etc.). P4 computations on integer types have no
undefined behaviors.</p>
</li>
<li>
<p><strong>Least surprise</strong>: The P4 typing rules are chosen to behave as
closely as possible to traditional well-behaved C programs.</p>
</li>
<li>
<p><strong>Forbid rather than surprise</strong>: Rather than provide surprising or
undefined results (e.g., in C comparisons between signed and
unsigned integers), we have chosen to forbid expressions with
ambiguous interpretations. For example, P4 does not allow binary
operations that combine signed and unsigned integers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The priority of arithmetic operations is identical to C---e.g.,
multiplication binds tighter than addition.</p>
</div>
<div class="sect4">
<h5 id="_portability">7.1.6.1. Portability</h5>
<div class="paragraph">
<p>No P4 target can support all possible types and operations. For
example, the type <code>bit&lt;23132312&gt;</code> is legal in P4, but
it is highly unlikely to be supported on any target in practice. Hence,
each target can impose restrictions on the types it can support. Such
restrictions may include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The maximum width supported</p>
</li>
<li>
<p>Alignment and padding constraints (e.g., arithmetic may only be
supported on widths which are an integral number of bytes).</p>
</li>
<li>
<p>Constraints on some operands (e.g., some architectures may only
support multiplications by small values, or shifts with small
values).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The documentation supplied with a target should clearly specify restrictions, and
target-specific compilers should provide clear error messages when
such restrictions are encountered. An architecture may reject a
well-typed P4 program and still be conformant to the P4 spec. However,
if an architecture accepts a P4 program as valid, the runtime program
behavior should match this specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-unsigned-integers">7.1.6.2. Unsigned integers (bit-strings)</h5>
<div class="paragraph">
<p>An unsigned integer (which we also call a "bit-string") has an
arbitrary width, expressed in bits. A bit-string of width <code>W</code> is
declared as: <code>bit&lt;W&gt;</code>. <code>W</code> must be an expression that evaluates to a
local compile-time known value (see <a href="#sec-compile-time-known">Section 18.1</a>) that is a
non-negative integer.  When using an expression for
the size, the expression must be parenthesized.
Bitstrings with width 0 are
allowed; they have no actual bits, and can only have the value 0.  See
<a href="#sec-uninitialized-values-and-writing-invalid-headers">Section 8.25</a> for additional details.
Note that <code>bit&lt;W&gt;</code> type refers to both cases of <code>bit&lt;W&gt;</code>
and <code>bit&lt;(expression)&gt;</code> where the width is a compile-time known value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">const</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> x <span style="color: #0550ae">=</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">;</span>   <span style="color: #6e7781">// 32-bit constant with value 10.
</span><span style="color: #cf222e">const</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>x <span style="color: #0550ae">+</span> <span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">)</span><span style="color: #0550ae">&gt;</span> y <span style="color: #0550ae">=</span> <span style="color: #0550ae">15</span><span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// 12-bit constant with value 15.
</span>                            <span style="color: #6e7781">// expression for width must use ()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Bits within a bit-string are numbered from <code>0</code> to <code>W-1</code>. Bit <code>0</code>
is the least significant, and bit <code>W-1</code> is the most significant.</p>
</div>
<div class="paragraph">
<p>For example, the type <code>bit&lt;128&gt;</code> denotes the type of bit-string
values with 128 bits numbered from 0 to 127, where bit 127 is the most
significant.</p>
</div>
<div class="paragraph">
<p>The type <code>bit</code> is a shorthand for <code>bit&lt;1&gt;</code>.</p>
</div>
<div class="paragraph">
<p>P4 architectures may impose additional constraints on bit types: for
example, they may limit the maximum size, or they may only support
some arithmetic operations on certain sizes (e.g., 16-, 32-, and 64-
bit values).</p>
</div>
<div class="paragraph">
<p>All operations that can be performed on unsigned integers are
described in <a href="#sec-bit-ops">Section 8.6</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-signed-integers">7.1.6.3. Signed Integers</h5>
<div class="paragraph">
<p>Signed integers are represented using two&#8217;s complement. An integer
with <code>W</code> bits is declared as: <code>int&lt;W&gt;</code>. <code>W</code> must be an expression that
evaluates to a local compile-time known (see Section
<a href="#sec-compile-time-known">Section 18.1</a>) value that is a non-negative integer.  Note
that <code>int&lt;W&gt;</code> type refers to both cases of <code>int&lt;W&gt;</code> and
<code>int&lt;(expression)&gt;</code> where the width is a local compile-time known
value.</p>
</div>
<div class="paragraph">
<p>Bits within an integer are numbered from <code>0</code> to <code>W-1</code>. Bit <code>0</code>
is the least significant, and bit <code>W-1</code> is the sign bit.</p>
</div>
<div class="paragraph">
<p>For example, the type <code>int&lt;64&gt;</code> describes the type of integers
represented using exactly 64 bits with bits numbered from 0 to 63,
where bit 63 is the most significant (sign) bit.</p>
</div>
<div class="paragraph">
<p>P4 architectures may impose additional constraints on signed types:
for example, they may limit the maximum size, or they may only support
some arithmetic operations on certain sizes (e.g., 16-, 32-, and 64-
bit values).</p>
</div>
<div class="paragraph">
<p>All operations that can be performed on signed integers are described
in <a href="#sec-bit-ops">Section 8.6</a>.</p>
</div>
<div class="paragraph">
<p>A signed integer with width 1 can only have two legal values: 0 and -1.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-dynamically-sized-integers">7.1.6.4. Dynamically-sized bit-strings</h5>
<div class="paragraph">
<p>Some network protocols use fields whose size is only known at runtime
(e.g., IPv4 options). To support restricted manipulations of such
values, P4 provides a special bit-string type whose size is set at
runtime, called a <code>varbit</code>.</p>
</div>
<div class="paragraph">
<p>The type <code>varbit&lt;W&gt;</code> denotes a bit-string with a width of at most <code>W</code>
bits, where <code>W</code> is a local compile-time known value (see Section
<a href="#sec-compile-time-known">Section 18.1</a>) that is a non-negative integer.  For
example, the type <code>varbit&lt;120&gt;</code> denotes the type of bit-string values
that may have between 0 and 120 bits. Most operations that are
applicable to fixed-size bit-strings (unsigned numbers) <strong>cannot</strong> be
performed on dynamically sized bit-strings.  Note that <code>varbit&lt;W&gt;</code>
type refers to both cases of <code>varbit&lt;W&gt;</code> and <code>varbit&lt;(expression)&gt;</code>
where the width is a compile-time known value.</p>
</div>
<div class="paragraph">
<p>P4 architectures may impose additional constraints on varbit types:
for example, they may limit the maximum size, or they may require <code>varbit</code>
values to always contain an integer number of bytes at runtime.</p>
</div>
<div class="paragraph">
<p>All operations that can be performed on varbits are described in
<a href="#sec-varbit-string">Section 8.10</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-arbitrary-precision-integers">7.1.6.5. Arbitrary-precision integers</h5>
<div class="paragraph">
<p>The arbitrary-precision data type describes integers with an unlimited
precision. This type is written as <code>int</code>.</p>
</div>
<div class="paragraph">
<p>This type is reserved for integer literals and expressions that
involve only literals. No P4 runtime value can have an <code>int</code>
type; at compile time the compiler will convert all int values that
have a runtime component to fixed-width types, according to the rules
described below.</p>
</div>
<div class="paragraph">
<p>All operations that can be performed on arbitrary-precision integers
are described in <a href="#sec-varint-ops">Section 8.8</a>.  The following example
shows three constant definitions whose values are arbitrary-precision
integers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">const</span> <span style="color: #953800">int</span> a <span style="color: #0550ae">=</span> <span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">const</span> <span style="color: #953800">int</span> b <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span> <span style="color: #0550ae">*</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">const</span> <span style="color: #953800">int</span> c <span style="color: #0550ae">=</span> b <span style="color: #0550ae">-</span> a <span style="color: #0550ae">+</span> <span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Parameters with type <code>int</code> are not supported for actions.  Parameters
with type <code>int</code> for other callable entities of a program,
e.g. controls, parsers, or functions, must be directionless,
indicating that all calls must provide a compile-time known value as
an argument for such a parameter.  See
<a href="#sec-calling-convention">Section 6.8</a> for more details on directionless
parameters.</p>
</div>
</div>
<div class="sect4">
<h5 id="_integer_literal_types">7.1.6.6. Integer literal types</h5>
<div class="paragraph">
<p>The types of integer literals are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An integer with no type prefix has type <code>int</code>.</p>
</li>
<li>
<p>A non-negative integer prefixed with an integer width <code>W</code> and the
character <code>w</code> has type <code>bit&lt;W&gt;</code>.</p>
</li>
<li>
<p>An integer prefixed with an integer width <code>W</code> and the character <code>s</code>
has type <code>int&lt;W&gt;</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The table below shows several examples of integer literals and their
types. For additional examples of literals see <a href="#sec-literals">Section 6.4.3</a>.</p>
</div>
<table class="tableblock frame-all grid-all center" style="width: 70%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-right valign-top">Literal</th>
<th class="tableblock halign-left valign-top">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type is <code>int</code>, value is 10</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>8w10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type is <code>bit&lt;8&gt;</code>, value is 10</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>8s10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type is <code>int&lt;8&gt;</code>, value is 10</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>2s3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type is <code>int&lt;2&gt;</code>, value is -1 (last 2 bits), overflow warning</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>1w10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type is <code>bit&lt;1&gt;</code>, value is 0 (last bit), overflow warning</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>1s1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type is <code>int&lt;1&gt;</code>, value is -1, overflow warning</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-derived-types">7.2. Derived types</h3>
<div class="paragraph">
<p>P4 provides a number of type constructors that can be used to derive
additional types including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>enum</code></p>
</li>
<li>
<p><code>header</code></p>
</li>
<li>
<p>header stacks</p>
</li>
<li>
<p><code>struct</code></p>
</li>
<li>
<p><code>header_union</code></p>
</li>
<li>
<p><code>tuple</code></p>
</li>
<li>
<p>type specialization</p>
</li>
<li>
<p><code>extern</code></p>
</li>
<li>
<p><code>parser</code></p>
</li>
<li>
<p><code>control</code></p>
</li>
<li>
<p><code>package</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The types <code>header</code>, <code>header_union</code>, <code>enum</code>, <code>struct</code>, <code>extern</code>, <code>parser</code>, <code>control</code>,
and <code>package</code> can only be used in type declarations, where they
introduce a new name for the type. The type can subsequently be
referred to using this identifier.</p>
</div>
<div class="paragraph">
<p>Other types cannot be declared, but are synthesized by the compiler
internally to represent the type of certain language constructs. These
types are described in <a href="#sec-synth-types">Section 7.2.9</a>: set types and
function types. For example, the programmer cannot declare a variable
with type "set", but she can write an expression whose value evaluates
to a <code>set</code> type. These types are used during type-checking.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">typeDeclaration
    : derivedTypeDeclaration
    | typedefDeclaration ";"
    | parserTypeDeclaration ";"
    | controlTypeDeclaration ";"
    | packageTypeDeclaration ";"
    ;

derivedTypeDeclaration
    : headerTypeDeclaration
    | headerUnionDeclaration
    | structTypeDeclaration
    | enumDeclaration
    ;

typeRef
    : baseType
    | typeName
    | specializedType
    | headerStackType
    | p4listType
    | tupleType
    ;

namedType
    : typeName
    | specializedType
    ;

prefixedType
    : TYPE_IDENTIFIER
    | dotPrefix TYPE_IDENTIFIER
    ;

typeName
    : prefixedType
    ;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="sec-enum-types">7.2.1. Enumeration types</h4>
<div class="paragraph">
<p>An enumeration type is defined using the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">enumDeclaration
    : optAnnotations ENUM name "{" identifierList optTrailingComma "}"
    | optAnnotations ENUM typeRef name "{"
      specifiedIdentifierList optTrailingComma "}"
    ;

identifierList
    : name
    | identifierList "," name
    ;

specifiedIdentifierList
    : specifiedIdentifier
    | specifiedIdentifierList "," specifiedIdentifier
    ;

specifiedIdentifier
    : name "=" initializer
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, the declaration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> Suits <span style="color: #24292f;background-color: #f6f8fa">{</span> Clubs<span style="color: #24292f;background-color: #f6f8fa">,</span> Diamonds<span style="color: #24292f;background-color: #f6f8fa">,</span> Hearths<span style="color: #24292f;background-color: #f6f8fa">,</span> Spades <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>introduces a new enumeration type, which contains four
elements---e.g., <code>Suits.Clubs</code>. An <code>enum</code> declaration
introduces a new identifier in the current scope for naming the
created type along with its distinct elements.
The underlying representation of the <code>Suits</code> enum is not
specified, so their "size" in bits is not specified (it is
target-specific).</p>
</div>
<div class="paragraph">
<p>It is also possible to specify an <code>enum</code> with an underlying representation.
These are sometimes called serializable <code>enum</code>s, because headers are
allowed to have fields with such <code>enum</code> types. This requires the programmer provide both the fixed-width unsigned (or signed) integer type and
an associated integer value for each symbolic entry in the enumeration.
The symbol <code>typeRef</code> in the grammar above must be one of the following types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an unsigned integer, i.e. <code>bit&lt;W&gt;</code> for some local compile-time known value <code>W</code>.</p>
</li>
<li>
<p>a signed integer, i.e. <code>int&lt;W&gt;</code> for some local compile-time known value <code>W</code>.</p>
</li>
<li>
<p>a type name declared via <code>typedef</code>, where the base type of that type is either
one of the types listed above, or another <code>typedef</code> name that meets these conditions.
For example, the declaration</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> EtherType <span style="color: #24292f;background-color: #f6f8fa">{</span>
  VLAN      <span style="color: #0550ae">=</span> <span style="color: #0550ae">0x8100</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  QINQ      <span style="color: #0550ae">=</span> <span style="color: #0550ae">0x9100</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  MPLS      <span style="color: #0550ae">=</span> <span style="color: #0550ae">0x8847</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  IPV4      <span style="color: #0550ae">=</span> <span style="color: #0550ae">0x0800</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  IPV6      <span style="color: #0550ae">=</span> <span style="color: #0550ae">0x86dd</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>introduces a new enumeration type, which contains five elements---e.g.,
<code>EtherType.IPV4</code>.  This <code>enum</code> declaration specifies the fixed-width unsigned integer representation
for each entry in the <code>enum</code> and provides an underlying type: <code>bit&lt;16&gt;</code>.
This kind of <code>enum</code> declaration can be thought of as declaring a new <code>bit&lt;16&gt;</code>
type, where variables or fields of this type are expected to be unsigned 16-bit
integer values, and the mapping of symbolic to numeric values defined by the
<code>enum</code> are also defined as a part of this declaration.  In this way,
an <code>enum</code> with an underlying type can be thought of as being a type derived
from the underlying type carrying equality, assignment, and casts to/from the
underlying type.</p>
</div>
<div class="paragraph">
<p>Compiler implementations are expected to raise an error if the fixed-width integer representation
for an enumeration entry falls outside the representation range of the underlying type.</p>
</div>
<div class="paragraph">
<p>For example, the declaration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> FailingExample <span style="color: #24292f;background-color: #f6f8fa">{</span>
  first           <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  second          <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  third           <span style="color: #0550ae">=</span> <span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  unrepresentable <span style="color: #0550ae">=</span> <span style="color: #0550ae">300</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>would raise an error because <code>300</code>, the value associated with
<code>FailingExample.unrepresentable</code> cannot be represented as a <code>bit&lt;8&gt;</code> value.</p>
</div>
<div class="paragraph">
<p>The <code>initializer</code> expression must be a compile-time known value.</p>
</div>
<div class="paragraph">
<p>Annotations, represented by the non-terminal <code>optAnnotations</code>, are
described in <a href="#sec-annotations">Chapter 20</a>.</p>
</div>
<div class="paragraph">
<p>Operations on <code>enum</code> values are described in
<a href="#sec-enum-exprs">Section 8.3</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-header-types">7.2.2. Header types</h4>
<div class="paragraph">
<p>The declaration of a <code>header</code> type is given by the following
syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">headerTypeDeclaration
    : optAnnotations HEADER name optTypeParameters "{" structFieldList "}"
    ;

structFieldList
    : /* empty */
    | structFieldList structField
    ;

structField
    : optAnnotations typeRef name ";"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>where each <code>typeRef</code> is restricted to a bit-string type (fixed or
variable), a fixed-width signed integer type, a boolean type, or a struct that
itself contains other struct fields, nested arbitrarily, as long as all of the
"leaf" types are <code>bit&lt;W&gt;</code>, <code>int&lt;W&gt;</code>, a serializable <code>enum</code>, or a <code>bool</code>. If a
<code>bool</code> is used inside a P4 header, all implementations encode the <code>bool</code> as a
one bit long field, with the value <code>1</code> representing <code>true</code> and <code>0</code> representing <code>false</code>.
Field names have to be distinct.</p>
</div>
<div class="paragraph">
<p>A header declaration introduces a new identifier in the
current scope; the type can be referred to using this identifier. A header is
similar to a <code>struct</code> in C, containing all the specified fields. However, in
addition, a header also contains a hidden Boolean "validity" field. When the
"validity" bit is <code>true</code> we say that the "header is valid". When a local
variable with a header type is
declared, its "validity" bit is automatically set to <code>false</code>. The "validity"
bit can be manipulated by using the header methods <code>isValid()</code>, <code>setValid()</code>,
and <code>setInvalid()</code>, as described in <a href="#sec-ops-on-hdrs">Section 8.17</a>.</p>
</div>
<div class="paragraph">
<p>Note, nesting of headers is not supported. One reason is that it leads to
complications in defining the behavior of arbitrary sequences of <code>setValid</code>,
<code>setInvalid</code>, and <code>emit</code> operations. Consider an example where header <code>h1</code>
contains header <code>h2</code> as a member, both currently valid. A program executes
<code>h2.setInvalid()</code> followed by <code>packet.emit(h1)</code>. Should all fields of <code>h1</code>
be emitted, but skipping <code>h2</code>? Similarly, should <code>h1.setInvalid()</code>
invalidate all headers contained within <code>h1</code>, regardless of how deeply
they are nested?</p>
</div>
<div class="paragraph">
<p>Header types may be empty:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> <span style="color: #953800">Empty_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that an empty header still contains a validity bit.</p>
</div>
<div class="paragraph">
<p>When a struct is inside of a header, the order of the fields for the purposes
of <code>extract</code> and <code>emit</code> calls is the order of the fields as defined in the source code.
An example of a header including a struct is included below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> ipv6_addr <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> Addr0<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> Addr1<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> Addr2<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> Addr3<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">header</span> <span style="color: #953800">ipv6_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span>    version<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>    trafficClass<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">20</span><span style="color: #0550ae">&gt;</span>   flowLabel<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span>   payloadLen<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>    nextHdr<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>    hopLimit<span style="color: #24292f;background-color: #f6f8fa">;</span>
    ipv6_addr src<span style="color: #24292f;background-color: #f6f8fa">;</span>
    ipv6_addr dst<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Headers that do not contain any <code>varbit</code> field are "fixed size."
Headers containing <code>varbit</code> fields have "variable size." The size (in
bits) of a fixed-size header is simply the sum of the sizes of all
component fields (without counting the validity bit). There is no
padding or alignment of the header fields. Targets may impose
additional constraints on header types---e.g., restricting headers to
sizes that are an integer number of bytes.</p>
</div>
<div class="paragraph">
<p>For example, the following declaration describes a typical Ethernet
header:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> <span style="color: #953800">Ethernet_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">48</span><span style="color: #0550ae">&gt;</span> dstAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">48</span><span style="color: #0550ae">&gt;</span> srcAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> etherType<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following variable declaration uses the newly introduced type <code>Ethernet_h</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">Ethernet_h</span> ethernetHeader<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>P4&#8217;s parser language provides an <code>extract</code> method that can be used to
"fill in" the fields of a header from a network packet, as described
in <a href="#sec-packet-data-extraction">Section 13.8</a>. The successful execution of
an <code>extract</code> operation also sets the validity bit of the extracted
header to <code>true</code>.</p>
</div>
<div class="paragraph">
<p>Here is an example of an IPv4 header with variable-sized options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> <span style="color: #953800">IPv4_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span>       version<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span>       ihl<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>       diffserv<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span>      totalLen<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span>      identification<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">3</span><span style="color: #0550ae">&gt;</span>       flags<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">13</span><span style="color: #0550ae">&gt;</span>      fragOffset<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>       ttl<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>       protocol<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span>      hdrChecksum<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span>      srcAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span>      dstAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">varbit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">320</span><span style="color: #0550ae">&gt;</span>  options<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As demonstrated by a code example in <a href="#sec-packet-extract-two">Section 13.8.2</a>,
another way to support headers that contain
variable-length fields is to define two headers&#8201;&#8212;&#8201;one fixed length,
one containing a <code>varbit</code> field&#8201;&#8212;&#8201;and extract each part in separate
parsing steps.</p>
</div>
<div class="paragraph">
<p>Notice that the names <code>isValid</code>, <code>setValid</code>, <code>minSizeInBits</code>, etc. are all
valid header field names.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-header-stacks">7.2.3. Header stacks</h4>
<div class="paragraph">
<p>A header stack represents an array of headers or header unions. A header stack type is
defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">headerStackType
    : typeName "[" expression "]"
    | specializedType "[" expression "]"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>typeName</code> is the name of a header or header union type. For a
header stack <code>hs[n]</code>, the term <code>n</code> is the maximum defined size, and
must be a local compile-time known value that is a positive
integer. Nested header stacks are not supported. At runtime a stack
contains <code>n</code> values with type <code>typeName</code>, only some of which may be
valid. Expressions on header stacks are discussed in Section
<a href="#sec-expr-hs">Section 8.18</a>.</p>
</div>
<div class="paragraph">
<p>For example, the following declarations,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> <span style="color: #953800">Mpls_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">20</span><span style="color: #0550ae">&gt;</span> label<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">3</span><span style="color: #0550ae">&gt;</span>  tc<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span>     bos<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  ttl<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #953800">Mpls_h</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">]</span> mpls<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>introduce a header stack called <code>mpls</code> containing ten entries, each
of type <code>Mpls_h</code>.</p>
</div>
<div class="paragraph">
<p>Operations on header stacks are described in <a href="#sec-expr-hs">Section 8.18</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-header-unions">7.2.4. Header unions</h4>
<div class="paragraph">
<p>A header union represents an alternative containing at most one of several different
headers. Header unions can be used to represent "options" in protocols
like TCP and IP. They also provide hints to P4 compilers that only one
alternative will be present, allowing them to conserve storage resources.</p>
</div>
<div class="paragraph">
<p>A header union is defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">headerUnionDeclaration
    : optAnnotations HEADER_UNION name optTypeParameters "{" structFieldList "}"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This declaration introduces a new type with the specified name in the
current scope. Each element of the list of fields used to declare a
header union must be of header type. An empty list of fields is legal.
Field names have to be distinct.</p>
</div>
<div class="paragraph">
<p>As an example, the type <code>Ip_h</code> below represents the union of an IPv4
and IPv6 headers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header_union</span> <span style="color: #953800">IP_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #953800">IPv4_h</span> v4<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #953800">IPv6_h</span> v6<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A header union is not considered a type with fixed length.</p>
</div>
<div class="paragraph">
<p>Operation on header unions are described in <a href="#sec-expr-hu">Section 8.19</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-struct-types">7.2.5. Struct types</h4>
<div class="paragraph">
<p>P4 <code>struct</code> types are defined with the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">structTypeDeclaration
    : optAnnotations STRUCT name optTypeParameters "{" structFieldList "}"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This declaration introduces a new type with the specified name in the
current scope. Field names have to be distinct. An empty struct (with no fields) is legal. For example, the structure <code>Parsed_headers</code>
below contains the headers recognized by a simple parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> <span style="color: #953800">Tcp_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* fields omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">header</span> <span style="color: #953800">Udp_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* fields omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">struct</span> Parsed_headers <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">Ethernet_h</span> ethernet<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">Ip_h</span>       ip<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">Tcp_h</span>      tcp<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">Udp_h</span>      udp<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-tuple-types">7.2.6. Tuple types</h4>
<div class="paragraph">
<p>A tuple is similar to a <code>struct</code>, in that it holds multiple values.
The type of tuples with n component types <code>T1</code>,&#8230;&#8203;,<code>Tn</code> is written as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">tuple</span><span style="color: #0550ae">&lt;</span>T1<span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #6e7781">/* more fields omitted */</span><span style="color: #24292f;background-color: #f6f8fa">,</span>Tn<span style="color: #0550ae">&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">tupleType
    : TUPLE "&lt;" typeArgumentList "&gt;"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Operations that manipulate tuple types are described in
<a href="#sec-tuple-exprs">Section 8.12</a>.</p>
</div>
<div class="paragraph">
<p>The type <code>tuple&lt;&gt;</code> is a tuple type with no components.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-list-types">7.2.7. List types</h4>
<div class="paragraph">
<p>A list holds zero or more values, where every element must have the
same type.  The type of a list where all elements have type <code>T</code> is
written as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">list</span><span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">p4listType
    : LIST "&lt;" typeArg "&gt;"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Operations that manipulate list types are described in
<a href="#sec-list-exprs">Section 8.14</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-type-nesting">7.2.8. Type nesting rules</h4>
<div class="paragraph">
<p>The table below lists all types that may appear as members of headers,
header unions, structs, tuples, and lists.  Note that <code>int</code> by itself
(i.e. not as part of an <code>int&lt;N&gt;</code> type expression) means an
arbitrary-precision integer, without a width specified.</p>
</div>
<table class="tableblock frame-all grid-all stretch center">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Element type</th>
<th class="tableblock halign-center valign-top" colspan="5">Container kind</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">header</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">header_union</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">struct or tuple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">header stack</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bit&lt;W&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int&lt;W&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varbit&lt;W&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>string</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>error</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>match_kind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bool</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enumeration types</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed [1]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>header types</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>header stacks</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>header_unions</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>struct types</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed [2]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tuple types</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>list types</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>[1] An <code>enum</code> type used as a field in a <code>header</code> must specify a
underlying type and representation for <code>enum</code> elements.</p>
</div>
<div class="paragraph">
<p>[2] A <code>struct</code> or nested <code>struct</code> type that has the same properties,
used as a field in a <code>header</code> must contain only <code>bit&lt;W&gt;</code>, <code>int&lt;W&gt;</code>, a
serializable <code>enum</code>, or a <code>bool</code>.</p>
</div>
<div class="paragraph">
<p>Rationale: <code>int</code> does not have precise storage requirements,
unlike <code>bit&lt;&gt;</code> or <code>int&lt;&gt;</code> types. <code>match_kind</code>
values are not useful to store in a variable, as they
are only used to specify how to match fields in table search keys,
which are all declared at compile time. <code>void</code> is not useful as
part of another data structure.  Headers must have precisely defined
formats as sequences of bits in order for them to be parsed or
deparsed.</p>
</div>
<div class="paragraph">
<p>Note the two-argument <code>extract</code> method (see
<a href="#sec-packet-extract-two">Section 13.8.2</a>) on packets only supports a single <code>varbit</code>
field in a header.</p>
</div>
<div class="paragraph">
<p>The table below lists all types that may appear as base types in a
<code>typedef</code> or <code>type</code> declaration.</p>
</div>
<table class="tableblock frame-all grid-all center" style="width: 70%;">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Base type B</th>
<th class="tableblock halign-left valign-top"><code>typedef B &lt;name&gt;</code></th>
<th class="tableblock halign-left valign-top"><code>type B &lt;name&gt;</code></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bit&lt;W&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int&lt;W&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varbit&lt;W&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>string</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>error</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>match_kind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bool</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">enumeration types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">header types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">header stacks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">header unions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">struct types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tuple types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">list types</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a <code>typedef</code> name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed [3]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">a <code>type</code> name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>[3] <code>type B &lt;name&gt;</code> is allowed for a type name <code>B</code> defined via
<code>typedef X B</code> if <code>type X &lt;name&gt;</code> is allowed.</p>
</div>
<div class="paragraph">
<p>Rationale: So far, no clear motivation for allowing <code>typedef</code> for <code>void</code>
and <code>match_kind</code> was presented. Therefore, to be on the safe side this
is disallowed.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-synth-types">7.2.9. Synthesized data types</h4>
<div class="paragraph">
<p>For the purposes of type-checking the P4 compiler can synthesize some
type representations which cannot be directly expressed by
users. These are described in this section: set types and function
types.</p>
</div>
<div class="sect4">
<h5 id="sec-set-types">7.2.9.1. Set types</h5>
<div class="paragraph">
<p>The type <code>set&lt;T&gt;</code> describes <em>sets</em> of values of some type <code>T</code>. Set
types can only appear in restricted contexts in P4 programs. For
example, the range expression <code>8w5 .. 8w8</code> describes a set
containing the 8-bit numbers 5, 6, 7, and 8, so its type is <code>set&lt;bit&lt;8&gt;&gt;;</code>.
This expression can be used as a label in a <code>select</code> expression
(see <a href="#sec-select">Section 13.6</a>), matching any value in this range. Set
types cannot be named or declared by P4 programmers, they are only
synthesized by the compiler internally and used for
type-checking. Expressions with set types are described in
<a href="#sec-set-exprs">Section 8.15</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-function-type">7.2.9.2. Function types</h5>
<div class="paragraph">
<p>Function types are created by the P4 compiler internally to represent the types
of functions (explicit functions or extern functions) and methods during
type-checking.  We also call the type of a function its
signature. Libraries can contain functions and extern function declarations.</p>
</div>
<div class="paragraph">
<p>For example, consider the following declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> <span style="color: #953800">void</span> random<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">5</span><span style="color: #0550ae">&gt;</span> logRange<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> value<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> add<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> left<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> right<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #cf222e">return</span> left <span style="color: #0550ae">+</span> right<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These declarations describe two objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>random</code>, which has a function type, representing the following information:</p>
<div class="ulist">
<ul>
<li>
<p>the result type is <code>void</code></p>
</li>
<li>
<p>the function has two inputs</p>
</li>
<li>
<p>the first formal parameter has direction <code>in</code>, type <code>bit&lt;5&gt;</code>, and name <code>logRange</code></p>
</li>
<li>
<p>the second formal parameter has direction <code>out</code>, type <code>bit&lt;32&gt;</code>, and name <code>value</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>add</code>, also has a function type, representing the following information:</p>
<div class="ulist">
<ul>
<li>
<p>the result type is <code>bit&lt;32&gt;</code></p>
</li>
<li>
<p>the function has two inputs</p>
</li>
<li>
<p>both inputs have direction <code>in</code> and type <code>bit&lt;32&gt;</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec_extern">7.2.10. Extern types</h4>
<div class="paragraph">
<p>P4 supports extern object declarations and extern function declarations using the following syntax.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">externDeclaration
    : optAnnotations EXTERN nonTypeName optTypeParameters "{" methodPrototypes "}"
    | optAnnotations EXTERN functionPrototype ";"
    ;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_extern_functions">7.2.10.1. Extern functions</h5>
<div class="paragraph">
<p>An extern function declaration describes the name and type signature of the function,
but not its implementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">functionPrototype
    : typeOrVoid name optTypeParameters "(" parameterList ")"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For an example of an <code>extern</code> function declaration, see
<a href="#sec-function-type">Section 7.2.9.2</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-extern-objects">7.2.10.2. Extern objects</h5>
<div class="paragraph">
<p>An extern object declaration declares an object and all methods that
can be invoked to perform computations and to alter the state of the
object. Extern object declarations can also optionally declare
constructor methods; these must have the same name as the enclosing <code>extern</code>
type, no type parameters, and no return type.  Extern declarations may
only appear as allowed by the architecture model and may be specific
to a target.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">methodPrototypes
    : /* empty */
    | methodPrototypes methodPrototype
    ;

methodPrototype
    : optAnnotations functionPrototype ';'
    | optAnnotations TYPE_IDENTIFIER '(' parameterList ')' ';' //constructor
    | optAnnotations ABSTRACT functionPrototype ";"
    ;

typeOrVoid
    : typeRef
    | VOID
    | IDENTIFIER     // may be a type variable
    ;

optTypeParameters
    : /* empty */
    | typeParameters
    ;

typeParameters
    : "&lt;" typeParameterList "&gt;"
    ;

typeParameterList
    : name
    | typeParameterList "," name
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, the P4 core library introduces two extern objects <code>packet_in</code>
and <code>packet_out</code> used for manipulating packets
(see <a href="#sec-packet-data-extraction">Section 13.8</a> and <a href="#sec-deparse">Chapter 16</a>). Here
is an example showing how the methods of these objects can be invoked
on a packet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> <span style="color: #cf222e">packet_out</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">void</span> emit<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T hdr<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> d<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_out</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> Hdr h<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        b<span style="color: #0550ae">.</span>emit<span style="color: #24292f;background-color: #f6f8fa">(</span>h<span style="color: #0550ae">.</span>ipv4<span style="color: #24292f;background-color: #f6f8fa">);</span>       <span style="color: #6e7781">// write ipv4 header into output packet
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>                         <span style="color: #6e7781">// by calling emit method
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Functions and methods are the only P4 constructs that support
overloading: there can exist multiple methods with the same name in
the same scope.  When overloading is used, the compiler must be able to
disambiguate at compile-time which method or function is being called,
either by the number of arguments or by the names of the arguments,
when calls are specifying argument names.  Argument type information
is not used in disambiguating calls.</p>
</div>
<div class="paragraph">
<p>Notice that overloading of parsers, controls, or packages is not allowed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">parser</span> p<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> p<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> value<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #0550ae">...</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// The following will cause an error about a duplicate declaration
//parser p(packet_in p, out Headers headers) {
//   ...
//}</span></code></pre>
</div>
</div>
<div class="sect5">
<h6 id="sec-abstract-methods">7.2.10.2.1. Abstract methods</h6>
<div class="paragraph">
<p>Typical extern object methods are built-in, and are implemented by the
target architecture.  P4 programmers can only call such methods.</p>
</div>
<div class="paragraph">
<p>However, some types of extern objects may provide methods that can be
implemented by the P4 programmers.  Such methods are described with
the <code>abstract</code> keyword prior to the method definition.  Here is an
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> Balancer <span style="color: #24292f;background-color: #f6f8fa">{</span>
    Balancer<span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #6e7781">// get the number of active flows
</span>    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> getFlowCount<span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #6e7781">// return port index used for load-balancing
</span>    <span style="color: #6e7781">// @param address: IPv4 source address of flow
</span>    <span style="color: #cf222e">abstract</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span> on_new_flow<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> address<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When such an object is instantiated the user has to supply an
implementation of all the <code>abstract</code> methods (see <a href="#sec-instantiating-abstract-methods">Section 11.3.1</a>).</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-type-spec">7.2.11. Type specialization</h4>
<div class="paragraph">
<p>A generic type may be specialized by specifying arguments for its type
variables. In cases where the compiler can infer type arguments type
specialization is not necessary. When a type is specialized all its
type variables must be bound.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">specializedType
    : typeName "&lt;" typeArgumentList "&gt;"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, the following extern declaration describes a generic
block of registers, where the type of the elements stored in each
register is an arbitrary <code>T</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> Register<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    Register<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> <span style="color: #cf222e">size</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
    T read<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> index<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #953800">void</span> write<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> index<span style="color: #24292f;background-color: #f6f8fa">,</span> T value<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The type <code>T</code> has to be specified when instantiating a set of
registers, by specializing the Register type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">Register<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">128</span><span style="color: #24292f;background-color: #f6f8fa">)</span> registerBank<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The instantiation of <code>registerBank</code> is made using the <code>Register</code>
type specialized with the <code>bit&lt;32&gt;</code> bound to the <code>T</code> type argument.</p>
</div>
<div class="paragraph">
<p><code>struct</code>, <code>header</code>, <code>header_union</code> and header stack types can be
generic as well.  In order to use such a generic type it must be
specialized with appropriate type arguments.  For example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// generic structure type
</span><span style="color: #cf222e">struct</span> S<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    T field<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bool</span> valid<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">struct</span> G<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    S<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> s<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// specialize S by replacing 'T' with 'bit&lt;32&gt;'
</span><span style="color: #cf222e">const</span> S<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;</span> s <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> field <span style="color: #0550ae">=</span> <span style="color: #0550ae">32w0</span><span style="color: #24292f;background-color: #f6f8fa">,</span> valid <span style="color: #0550ae">=</span> false <span style="color: #24292f;background-color: #f6f8fa">};</span>
<span style="color: #6e7781">// Specialize G by replacing 'T' with 'bit&lt;32&gt;'
</span><span style="color: #cf222e">const</span> G<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;</span> g <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> s <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> field <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">,</span> valid <span style="color: #0550ae">=</span> false <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #24292f;background-color: #f6f8fa">};</span>

<span style="color: #6e7781">// generic header type
</span><span style="color: #cf222e">header</span> H<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    T field<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// Specialize H by replacing 'T' with 'bit&lt;8&gt;'
</span><span style="color: #cf222e">const</span> H<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;&gt;</span> h <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> field <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span> <span style="color: #24292f;background-color: #f6f8fa">};</span>
<span style="color: #6e7781">// Header stack produced from a specialization of a generic header type
</span>H<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">]</span> stack<span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #6e7781">// Generic header union
</span><span style="color: #cf222e">header_union</span> HU<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    H<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;</span> h32<span style="color: #24292f;background-color: #f6f8fa">;</span>
    H<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;&gt;</span>  h8<span style="color: #24292f;background-color: #f6f8fa">;</span>
    H<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span>       ht<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// Header union with a type obtained by specializing a generic header union type
</span>HU<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&gt;</span> hu<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-parser-control-types">7.2.12. Parser and control blocks types</h4>
<div class="paragraph">
<p>Parsers and control blocks types are similar to function types: they
describe the signature of parsers and control blocks. Such functions
have no return values. Declarations of parsers and control block types
in architectures may be generic
(i.e., have type parameters).</p>
</div>
<div class="paragraph">
<p>The types <code>parser</code>, <code>control</code>, and <code>package</code> cannot be used as
types of arguments for methods, parsers, controls, tables, or actions.
They <em>can</em> be used as types for the arguments passed to
constructors (see <a href="#sec-parameterization">Chapter 15</a>).</p>
</div>
<div class="sect4">
<h5 id="_parser_type_declarations">7.2.12.1. Parser type declarations</h5>
<div class="paragraph">
<p>A parser type declaration describes the signature of a parser. A
parser should have at least one argument of type <code>packet_in</code>,
representing the received packet that is processed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">parserTypeDeclaration
    : optAnnotations PARSER name optTypeParameters
      "(" parameterList ")"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, the following is a type declaration of a parser type
named <code>P</code> that is parameterized on a type variable <code>H</code>. That parser
receives as input a <code>packet_in</code> value <code>b</code> and produces two values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A value with a user-defined type <code>H</code></p>
</li>
<li>
<p>A value with a predefined type <code>Counters</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> Counters <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* Fields omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">parser</span> P<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span>
             <span style="color: #cf222e">out</span> H packetHeaders<span style="color: #24292f;background-color: #f6f8fa">,</span>
             <span style="color: #cf222e">out</span> Counters counters<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_control_type_declarations">7.2.12.2. Control type declarations</h5>
<div class="paragraph">
<p>A control type declaration describes the signature of a control block.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">controlTypeDeclaration
    : optAnnotations CONTROL name optTypeParameters
      "(" parameterList ")"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Control type declarations are similar to parser type
declarations.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-pkg-types">7.2.13. Package types</h4>
<div class="paragraph">
<p>A package type describes the signature of a package.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">packageTypeDeclaration
    : optAnnotations PACKAGE name optTypeParameters
      "(" parameterList ")"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>All parameters of a package are evaluated at compilation time, and in
consequence they must all be directionless (they cannot be <code>in</code>, <code>out</code>,
or <code>inout</code>). Otherwise package types are very similar to
parser type declarations. Packages can only be instantiated; there are
no runtime behaviors associated with them.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-dont-care-types">7.2.14. Don&#8217;t care types</h4>
<div class="paragraph">
<p>A don&#8217;t care (underscore, &#8220;_&#8221;) can be used in some circumstances as
a type.  It should be only used in a position where one could write a
bound type variable.  The
underscore can be used to reduce code complexity---when it is not
important what the type variable binds to (during type unification the
don&#8217;t care type can unify with any other type).  An example is given
<a href="#sec-arch-desc-example">Section 17.1</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-default-values">7.3. Default values</h3>
<div class="paragraph">
<p>Some P4 types define a "default value," which can be used to
automatically initialize values of that type.  The default values are
as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For <code>int</code>, <code>bit&lt;N&gt;</code> and <code>int&lt;N&gt;</code> types the default value is 0.</p>
</li>
<li>
<p>For <code>bool</code> the default value is <code>false</code>.</p>
</li>
<li>
<p>For <code>error</code> the default value is <code>error.NoError</code> (defined in core.p4)</p>
</li>
<li>
<p>For <code>string</code> the default value is the empty string <code>""</code></p>
</li>
<li>
<p>For <code>varbit&lt;N&gt;</code> the default value is a string of zero bits (there is currently
no P4 literal to represent such a value).</p>
</li>
<li>
<p>For <code>enum</code> values with an underlying type the default value is 0,
even if 0 is actually not one of the named values in the enum.</p>
</li>
<li>
<p>For <code>enum</code> values without an underlying type the default value is the
first value that appears in the <code>enum</code> type declaration.</p>
</li>
<li>
<p>For <code>header</code> types the default value is <code>invalid</code>.</p>
</li>
<li>
<p>For header stacks the default value is that all elements are invalid and the
<code>nextIndex</code> is 0.</p>
</li>
<li>
<p>For <code>header_union</code> values the default value is that all union elements are invalid.</p>
</li>
<li>
<p>For <code>struct</code> types the default value is a <code>struct</code> where each field has
the default value of the suitable field type&#8201;&#8212;&#8201;if all such default values are
defined.</p>
</li>
<li>
<p>For a <code>tuple</code> type the default value is a <code>tuple</code> where each field
has the default value of the suitable type&#8201;&#8212;&#8201;if all such default values
are defined.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that some types do not have default values, e.g., <code>match_kind</code>,
set types, function types, extern types, parser types, control types,
package types.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-numeric-values">7.4. Numeric types</h3>
<div class="paragraph">
<p>Many P4 operations are restrained to expressions that evaluate to numeric values.
Such expressions must have one of the following numeric types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>int</code> - an arbitrary-precision integer
(<a href="#sec-arbitrary-precision-integers">Section 7.1.6.5</a>)</p>
</li>
<li>
<p><code>bit&lt;W&gt;</code> - a <code>W</code>-bit unsigned integer where <code>W &gt;= 0</code>
(<a href="#sec-unsigned-integers">Section 7.1.6.2</a>)</p>
</li>
<li>
<p><code>int&lt;W&gt;</code> - a <code>W</code>-bit signed integer where <code>W &gt;= 1</code>
(<a href="#sec-signed-integers">Section 7.1.6.3</a>)</p>
</li>
<li>
<p>a serializable <code>enum</code> with an underlying type that is <code>bit&lt;W&gt;</code> or
<code>int&lt;W&gt;</code> (<a href="#sec-enum-types">Section 7.2.1</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sec-typedef">7.5. typedef</h3>
<div class="paragraph">
<p>A <code>typedef</code> declaration can be used to give an alternative name to
a type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">typedefDeclaration
    : optAnnotations TYPEDEF typeRef name ';'
    | optAnnotations TYPEDEF derivedTypeDeclaration name ';'
    ;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> u32<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #cf222e">struct</span> Point <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #953800">int</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> x<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #953800">int</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> y<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span> Pt<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">Empty_h</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">32</span><span style="color: #24292f;background-color: #f6f8fa">]</span> HeaderStack<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The two types are treated as synonyms, and all operations that can be
executed using the original type can be also executed using the newly
created type.</p>
</div>
<div class="paragraph">
<p>If <code>typedef</code> is used with a generic type the type must be specialized
with the suitable number of type arguments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> S<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   T field<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// typedef S X;  -- illegal: S does not have type arguments
</span><span style="color: #cf222e">typedef</span> S<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;</span> X<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// -- legal</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-newtype">7.6. Introducing new types</h3>
<div class="paragraph">
<p>Similarly to <code>typedef</code>, the keyword <code>type</code> can be used to introduce a
new type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">    | optAnnotations TYPE typeRef name</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">type</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> U32<span style="color: #24292f;background-color: #f6f8fa">;</span>
U32 x <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>U32<span style="color: #24292f;background-color: #f6f8fa">)</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>While similar to <code>typedef</code>, the <code>type</code> keyword introduces a new type
which is not a synonym with the original type: values of the
original type and the newly introduced type cannot be mixed in
expressions.</p>
</div>
<div class="paragraph">
<p>Currently the types that can be created by the <code>type</code> keyword are
restricted to one of: <code>bit&lt;&gt;</code>, <code>int&lt;&gt;</code>, <code>bool</code>, or types defined using
<code>type</code> from such types.</p>
</div>
<div class="paragraph">
<p>One important use of such types is in describing P4 values that need
to be exchanged with the control plane through communication channels
(e.g., through the control-plane API or through network packets sent
to the control plane).  For example, a P4 architecture may define a
type for the switch ports:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">type</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">9</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">PortId_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This declaration will prevent <code>PortId_t</code> values from being used in
arithmetic expressions without casts.  Moreover, this declaration may enable special
manipulation or such values by software that lies outside of the
datapath (e.g., a target-specific toolchain could include software
that automatically converts values of type <code>PortId_t</code> to a different
representation when exchanged with the control-plane software).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-exprs">8. Expressions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes all expressions that can be used in P4,
grouped by the type of value they produce.</p>
</div>
<div class="paragraph">
<p>The grammar production rule for general expressions is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">expression
    : INTEGER
    | DOTS                           // DOTS is ...
    | STRING_LITERAL
    | TRUE
    | FALSE
    | prefixedNonTypeName
    | expression '[' expression ']'
    | expression '[' expression ':' expression ']'
    | '{' expressionList optTrailingComma '}'
    | "{#}"
    | '{' kvList optTrailingComma '}'
    | "{" kvList "," DOTS optTrailingComma "}"
    | '(' expression ')'
    | '!' expression
    | '~' expression
    | '-' expression
    | '+' expression
    | typeName '.' member
    | ERROR '.' member
    | expression '.' member
    | expression '*' expression
    | expression '/' expression
    | expression '%' expression
    | expression '+' expression
    | expression '-' expression
    | expression '|+|' expression
    | expression '|-|' expression
    | expression SHL expression      // SHL is &lt;&lt;
    | expression '&gt;''&gt;' expression   // check that &gt;&gt; are contiguous
    | expression LE expression       // LE is &lt;=
    | expression GE expression       // GE is &gt;=
    | expression '&lt;' expression
    | expression '&gt;' expression
    | expression NE expression       // NE is !=
    | expression EQ expression       // EQ is ==
    | expression '&amp;' expression
    | expression '^' expression
    | expression '|' expression
    | expression PP expression       // PP is ++
    | expression AND expression      // AND is &amp;&amp;
    | expression OR expression       // OR is ||
    | expression '?' expression ':' expression
    | expression '&lt;' realTypeArgumentList '&gt;' '(' argumentList ')'
    | expression '(' argumentList ')'
    | namedType '(' argumentList ')'
    | '(' typeRef ')' expression
    ;

expressionList
    : /* empty */
    | expression
    | expressionList "," expression
    ;

member
    : name
    ;

argumentList
    : /* empty */
    | nonEmptyArgList
    ;

nonEmptyArgList
    : argument
    | nonEmptyArgList "," argument
    ;

argument
    : expression
    ;

typeArg
    : typeRef
    | nonTypeName
    | VOID
    | "_"
    ;

typeArgumentList
    : /* empty */
    | typeArg
    | typeArgumentList "," typeArg
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#sec-grammar">Appendix G</a> for the complete P4 grammar.</p>
</div>
<div class="paragraph">
<p>This grammar does not indicate the precedence of the various
operators.  The precedence mostly follows the C precedence
rules, with one change and some additions.  The precedence of
the bitwise operators <code>&amp;</code> <code>|</code> and <code>^</code> is higher than the precedence
of relation operators <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code>.  This is more natural given
the addition of a true boolean type in the type system, as bitwise
operators cannot be applied to boolean types.
Concatenation (<code>++</code>) has the same precedence as infix
addition. Bit-slicing <code>a[m:l]</code> has the same precedence as array
indexing (<code>a[i]</code>).</p>
</div>
<div class="paragraph">
<p>In addition to these expressions, P4 also supports <code>select</code> expressions (described
in <a href="#sec-select">Section 13.6</a>), which may be used only in parsers.</p>
</div>
<div class="sect2">
<h3 id="sec-expr-eval-order">8.1. Expression evaluation order</h3>
<div class="paragraph">
<p>Given a compound expression, the order in which sub-expressions are
evaluated is important when the sub-expressions have
side-effects. P4 expressions are evaluated as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Boolean operators <code>&amp;&amp;</code> and <code>||</code> use short-circuit evaluation---i.e.,
the second operand is only evaluated if necessary.</p>
</li>
<li>
<p>The conditional operator <code>e1 ? e2 : e3</code> evaluates <code>e1</code>, and then
either evaluates <code>e2</code> or <code>e3</code>.</p>
</li>
<li>
<p>All other expressions are evaluated left-to-right as they appear in
the source program.</p>
</li>
<li>
<p>Method and function calls are evaluated as described in
<a href="#sec-calling-convention">Section 6.8</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sec-error-exprs">8.2. Operations on <code>error</code> types</h3>
<div class="paragraph">
<p>Symbolic names declared by an <code>error</code> declaration belong to the <code>error</code>
namespace.  The <code>error</code> type only supports equality (<code>==</code>) and inequality (<code>!=</code>) comparisons.
The result of such a comparison is a Boolean value.</p>
</div>
<div class="paragraph">
<p>For example, the following operation tests for the occurrence of an
error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">error</span> errorFromParser<span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>errorFromParser <span style="color: #0550ae">!=</span> <span style="color: #953800">error</span><span style="color: #0550ae">.</span>NoError<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* code omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-enum-exprs">8.3. Operations on <code>enum</code> types</h3>
<div class="paragraph">
<p>Symbolic names declared by an enum belong to the namespace introduced by the enum declaration rather than the top-level namespace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> X <span style="color: #24292f;background-color: #f6f8fa">{</span> v1<span style="color: #24292f;background-color: #f6f8fa">,</span> v2<span style="color: #24292f;background-color: #f6f8fa">,</span> v3 <span style="color: #24292f;background-color: #f6f8fa">}</span>
X<span style="color: #0550ae">.</span>v1  <span style="color: #6e7781">// reference to v1
</span>v1    <span style="color: #6e7781">// error - v1 is not in the top-level namespace</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to errors, <code>enum</code> expressions without a specified underlying type only support equality (<code>==</code>)
and inequality (<code>!=</code>) comparisons. Expressions whose type is an <code>enum</code> without a specified underlying type
cannot be cast to or from any other type.</p>
</div>
<div class="paragraph">
<p>An <code>enum</code> may also specify an underlying type, such as the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> E <span style="color: #24292f;background-color: #f6f8fa">{</span>
  e1 <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  e2 <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  e3 <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>More than one symbolic value in an <code>enum</code> may map to the same fixed-width
integer value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> NonUnique <span style="color: #24292f;background-color: #f6f8fa">{</span>
  b1 <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  b2 <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span>  <span style="color: #6e7781">// Note, both b2 and b3 map to the same value.
</span>  b3 <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  b4 <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An <code>enum</code> with an underlying type also supports explicit casts to and from the
underlying type.  For instance, the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> x<span style="color: #24292f;background-color: #f6f8fa">;</span>
E a <span style="color: #0550ae">=</span> E<span style="color: #0550ae">.</span>e2<span style="color: #24292f;background-color: #f6f8fa">;</span>
E b<span style="color: #24292f;background-color: #f6f8fa">;</span>

x <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// sets x to 1
</span>b <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>E<span style="color: #24292f;background-color: #f6f8fa">)</span> x<span style="color: #24292f;background-color: #f6f8fa">;</span>      <span style="color: #6e7781">// sets b to E.e2</span></code></pre>
</div>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>casts <code>a</code> (which was initialized with <code>E.e2</code>) to a <code>bit&lt;8&gt;</code>, using the specified
fixed-width unsigned integer representation for <code>E.e2</code>, i.e. <code>1</code>.  The variable <code>b</code> is then set
to the symbolic value <code>E.e2</code>, which corresponds to the fixed-width unsigned integer value <code>1</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Because it is always safe to cast from an <code>enum</code> to its underlying fixed-width integer type,
implicit casting from an <code>enum</code> to its fixed-width (signed or unsigned) integer type is also supported (see <a href="#sec-implicit-casts">Section 8.11.2</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> x <span style="color: #0550ae">=</span> E<span style="color: #0550ae">.</span>e2<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// sets x to 1 (E.e2 is automatically casted to bit&lt;8&gt;)
</span>
E  a <span style="color: #0550ae">=</span> E<span style="color: #0550ae">.</span>e2
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> y <span style="color: #0550ae">=</span> a <span style="color: #0550ae">&lt;&lt;</span> <span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// sets y to 8 (a is automatically casted to bit&lt;8&gt; and then shifted)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Implicit casting from an underlying fixed-width type to an enum is <strong>not</strong> supported.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> E1 <span style="color: #24292f;background-color: #f6f8fa">{</span>
   e1 <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">,</span> e2 <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span> e3 <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">enum</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> E2 <span style="color: #24292f;background-color: #f6f8fa">{</span>
   e1 <span style="color: #0550ae">=</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">,</span> e2 <span style="color: #0550ae">=</span> <span style="color: #0550ae">11</span><span style="color: #24292f;background-color: #f6f8fa">,</span> e3 <span style="color: #0550ae">=</span> <span style="color: #0550ae">12</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
E1 a <span style="color: #0550ae">=</span> E1<span style="color: #0550ae">.</span>e1<span style="color: #24292f;background-color: #f6f8fa">;</span>
E2 b <span style="color: #0550ae">=</span> E2<span style="color: #0550ae">.</span>e2<span style="color: #24292f;background-color: #f6f8fa">;</span>

a <span style="color: #0550ae">=</span> b<span style="color: #24292f;background-color: #f6f8fa">;</span>      <span style="color: #6e7781">// Error: b is automatically casted to bit&lt;8&gt;,
</span>            <span style="color: #6e7781">// but bit&lt;8&gt; cannot be automatically casted to E1
</span>
a <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>E1<span style="color: #24292f;background-color: #f6f8fa">)</span> b<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// OK
</span>
a <span style="color: #0550ae">=</span> E1<span style="color: #0550ae">.</span>e1 <span style="color: #0550ae">+</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// Error: E.e1 is automatically casted to bit&lt;8&gt;,
</span>               <span style="color: #6e7781">// and the right-hand expression has
</span>               <span style="color: #6e7781">// the type bit&lt;8&gt;, which cannot be casted to E automatically.
</span>
a <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>E1<span style="color: #24292f;background-color: #f6f8fa">)(</span>E1<span style="color: #0550ae">.</span>e1 <span style="color: #0550ae">+</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// Final explicit casting makes the assignment legal
</span>
a <span style="color: #0550ae">=</span> E1<span style="color: #0550ae">.</span>e1 <span style="color: #0550ae">+</span> E1<span style="color: #0550ae">.</span>e2<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// Error: both arguments to the addition are automatically
</span>                   <span style="color: #6e7781">// casted to bit&lt;8&gt;. Thus the addition itself is legal, but
</span>                   <span style="color: #6e7781">// the assignment is not
</span>
a <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>E1<span style="color: #24292f;background-color: #f6f8fa">)(</span>E2<span style="color: #0550ae">.</span>e1 <span style="color: #0550ae">+</span> E2<span style="color: #0550ae">.</span>e2<span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">//  Final explicit casting makes the assignment legal</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A reasonable compiler might generate a warning in cases that involve multiple automatic casts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">E1     a <span style="color: #0550ae">=</span> E1<span style="color: #0550ae">.</span>e1<span style="color: #24292f;background-color: #f6f8fa">;</span>
E2     b <span style="color: #0550ae">=</span> E2<span style="color: #0550ae">.</span>e2<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> c<span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>a <span style="color: #0550ae">&gt;</span> b<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">// Potential warning: two automatic and different casts to bit&lt;8&gt;.
</span>   <span style="color: #6e7781">// code omitted
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>

c <span style="color: #0550ae">=</span> a <span style="color: #0550ae">+</span> b<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// Legal, but a warning would be reasonable</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that while it is always safe to cast from an <code>enum</code> to its fixed-width unsigned integer type,
and vice versa, there may be cases where casting a fixed-width unsigned integer value to
its related <code>enum</code> type produces an unnamed value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> x <span style="color: #0550ae">=</span> <span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
E e <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>E<span style="color: #24292f;background-color: #f6f8fa">)</span> x<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// sets e to an unnamed value</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>sets <code>e</code> to an unnamed value, since there is no symbol corresponding to the
fixed-width unsigned integer value <code>5</code>.</p>
</div>
<div class="paragraph">
<p>For example, in the following code, the <code>else</code> clause of the <code>if/else if/else</code>
block can be reached even though the matches on <code>x</code> are complete with respect
to the symbols defined in <code>MyPartialEnum_t</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">2</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">MyPartialEnum_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    VALUE_A <span style="color: #0550ae">=</span> <span style="color: #0550ae">2w0</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
    VALUE_B <span style="color: #0550ae">=</span> <span style="color: #0550ae">2w1</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
    VALUE_C <span style="color: #0550ae">=</span> <span style="color: #0550ae">2w2</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">2</span><span style="color: #0550ae">&gt;</span> y <span style="color: #0550ae">=</span> <span style="color: #0550ae">&lt;</span> some value <span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">MyPartialEnum_t</span> x <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">MyPartialEnum_t</span><span style="color: #24292f;background-color: #f6f8fa">)</span>y<span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>x <span style="color: #0550ae">==</span> <span style="color: #953800">MyPartialEnum_t</span><span style="color: #0550ae">.</span>VALUE_A<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">// some code here
</span><span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>x <span style="color: #0550ae">==</span> <span style="color: #953800">MyPartialEnum_t</span><span style="color: #0550ae">.</span>VALUE_B<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">// some code here
</span><span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>x <span style="color: #0550ae">==</span> <span style="color: #953800">MyPartialEnum_t</span><span style="color: #0550ae">.</span>VALUE_C<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">// some code here
</span><span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">// A P4 compiler MUST ASSUME that this branch can be executed
</span>    <span style="color: #6e7781">// some code here
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, if an enumeration is used as a field of a header, we would expect
the <code>transition select</code> to match <code>default</code> when the parsed integer value does
not match one of the symbolic values of <code>EtherType</code> in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> EtherType <span style="color: #24292f;background-color: #f6f8fa">{</span>
  VLAN      <span style="color: #0550ae">=</span> <span style="color: #0550ae">0x8100</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  IPV4      <span style="color: #0550ae">=</span> <span style="color: #0550ae">0x0800</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
  IPV6      <span style="color: #0550ae">=</span> <span style="color: #0550ae">0x86dd</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">header</span> ethernet <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">// Some fields omitted
</span>  EtherType etherType<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">parser</span> my_parser<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #cf222e">state</span> parse_ethernet <span style="color: #24292f;background-color: #f6f8fa">{</span>
    packet<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ethernet<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>etherType<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
      EtherType<span style="color: #0550ae">.</span>VLAN <span style="color: #24292f;background-color: #f6f8fa">:</span> parse_vlan<span style="color: #24292f;background-color: #f6f8fa">;</span>
      EtherType<span style="color: #0550ae">.</span>IPV4 <span style="color: #24292f;background-color: #f6f8fa">:</span> parse_ipv4<span style="color: #24292f;background-color: #f6f8fa">;</span>
      EtherType<span style="color: #0550ae">.</span>IPV6<span style="color: #24292f;background-color: #f6f8fa">:</span> parse_ipv6<span style="color: #24292f;background-color: #f6f8fa">;</span>
      <span style="color: #cf222e">default</span><span style="color: #24292f;background-color: #f6f8fa">:</span> reject<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Any variable with an <code>enum</code> type that contains an unnamed value (whether as the
result of a cast to an <code>enum</code> with an underlying type, parse into the field of
an <code>enum</code> with an underlying type, or simply the declaration of any <code>enum</code>
without a specified initial value) will not be equal to any of the values
defined for that type.  Such an unnamed value should still lead to predictable
behavior in cases where any legal value would match, e.g. it should match in
any of these situations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If used in a <code>select</code> expression, it should match <code>default</code> or <code>_</code>
in a key set expression.</p>
</li>
<li>
<p>If used as a key with <code>match_kind</code> <code>ternary</code> in a table, it should
match a table entry where the field has all bit positions "don&#8217;t care".</p>
</li>
<li>
<p>If used as a key with <code>match_kind</code> <code>lpm</code> in a table, it should match
a table entry where the field has a prefix length of 0.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that if an <code>enum</code> value lacking an underlying type appears in the
control-plane API, the compiler must select a suitable serialization data type
and representation.  For <code>enum</code> values with an underlying type and
representations, the compiler should use the specified underlying type as the
serialization data type and representation.</p>
</div>
<div class="paragraph">
<p>Additionally, the size of a serializable enum can be determined at
compile-time. However, the size of an enum without an
underlying type cannot be determined at compile-time (<a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-match-kind-exprs">8.4. Operations on <code>match_kind</code> types</h3>
<div class="paragraph">
<p>Values of type <code>match_kind</code> are similar to <code>enum</code> values.  They
support only assignment and comparisons for equality and inequality.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">match_kind</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> fuzzy <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">const</span> <span style="color: #953800">bool</span> same <span style="color: #0550ae">=</span> exact <span style="color: #0550ae">==</span> fuzzy<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// always 'false'</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-bool-exprs">8.5. Expressions on Booleans</h3>
<div class="paragraph">
<p>The following operations are provided on Boolean expressions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"And", denoted by <code>&amp;&amp;</code></p>
</li>
<li>
<p>"Or", denoted by <code>||</code></p>
</li>
<li>
<p>Negation, denoted by <code>!</code></p>
</li>
<li>
<p>Equality and inequality tests, denoted by <code>==</code> and <code>!=</code> respectively.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The precedence of these operators is similar to C and uses short-circuited
evaluation where relevant.</p>
</div>
<div class="paragraph">
<p>Additionally, the size of a boolean can be determined at
compile-time (<a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</div>
<div class="paragraph">
<p>P4 does not implicitly cast from bit-strings to Booleans or
vice versa. As a consequence, a program that is valid in a language like C such as,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>x<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #6e7781">/* body omitted */</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(where x has an integer type) must instead be written in P4 as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>x <span style="color: #0550ae">!=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #6e7781">/* body omitted */</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See the discussion on arbitrary-precision types and implicit casts
in <a href="#sec-implicit-casts">Section 8.11.2</a> for details on how the <code>0</code> in this
expression is evaluated.</p>
</div>
<div class="sect3">
<h4 id="_conditional_operator">8.5.1. Conditional operator</h4>
<div class="paragraph">
<p>A conditional expression of the form <code>e1 ? e2 : e3</code> behaves the
same as in languages like C. As described above, the expression <code>e1</code> is evaluated first,
and second either <code>e2</code> or <code>e3</code> is evaluated depending on the result.</p>
</div>
<div class="paragraph">
<p>The first sub-expression <code>e1</code> must have Boolean type
and the second and third sub-expressions must have the same type,
which cannot both be arbitrary-precision integers unless the condition
itself can be evaluated at compilation time. This restriction is
designed to ensure that the width of the result of the conditional
expression can be inferred statically at compile time.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-bit-ops">8.6. Operations on fixed-width bit types (unsigned integers)</h3>
<div class="paragraph">
<p>This section discusses all operations that can be performed on
expressions of type <code>bit&lt;W&gt;</code> for some width <code>W</code>, also known as
bit-strings.</p>
</div>
<div class="paragraph">
<p>Arithmetic operations "wrap around", similar to C operations on
unsigned values (i.e., representing a large value on W bits will only
keep the least-significant W bits of the value). In particular, P4
does not have arithmetic exceptions---the result of an arithmetic
operation is defined for all possible inputs.</p>
</div>
<div class="paragraph">
<p>P4 target architectures may optionally support saturating arithmetic. All saturating
operations are limited to a fixed range between a minimum and maximum value.
Saturating arithmetic has advantages, in particular when used as counters.
The result of a saturating counter max-ing out is much closer to the real
result than a counter that overflows and wraps around. According to Wikipedia
<a href="https://en.wikipedia.org/wiki/Saturation_arithmetic">Saturating Arithmetic</a>
is as numerically close to the true answer as possible;
for 8-bit binary signed arithmetic, when the correct answer is 130,
it is considerably less surprising to get an answer of 127 from saturating
arithmetic than to get an answer of 126 from modular arithmetic.
Likewise, for 8-bit binary unsigned arithmetic, when the correct answer is 258,
it is less surprising to get an answer of 255 from saturating arithmetic than
to get an answer of 2 from modular arithmetic.  At this time, P4 defines
saturating operations only for addition and subtraction. For an unsigned
integer with bit-width of <code>W</code>, the minimum value is <code>0</code> and the maximum value
is <code>2^W-1</code>.  The precedence of saturating addition and subtraction operations
is the same as for modular arithmetic addition and subtraction.</p>
</div>
<div class="paragraph">
<p>All binary operations except shifts and concatenation require both operands to
have the same exact type and width; supplying operands with different widths
produces an error at compile time. No implicit casts are inserted by the
compiler to equalize the widths. There are no other binary operations that
accept signed and unsigned values simultaneously besides shifts and
concatenation.  The following operations are provided on bit-string
expressions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Test for equality between bit-strings of the same width,
designated by <code>==</code>. The result is a Boolean value.</p>
</li>
<li>
<p>Test for inequality between bit-strings of the same width,
designated by <code>!=</code>. The result is a Boolean value.</p>
</li>
<li>
<p>Unsigned comparisons <code>&lt;,&gt;,&lt;=,&gt;=</code>. Both operands must have the
same width and the result is a Boolean value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each of the following operations produces a bit-string result when applied
to bit-strings of the same width:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Negation, denoted by unary <code>-</code>. The result is computed by
subtracting the value from 2<sup>W</sup>. The result is unsigned and
has the same width as the input. The semantics is the same as the
C negation of unsigned numbers.</p>
</li>
<li>
<p>Unary plus, denoted by <code>+</code>. This operation behaves like a no-op.</p>
</li>
<li>
<p>Addition, denoted by <code>+</code>. This operation is associative. The result is computed by
truncating the result of the addition to the width of the output
(similar to C).</p>
</li>
<li>
<p>Subtraction, denoted by <code>-</code>. The result is unsigned, and has the
same type as the operands. It is computed by adding the negation
of the second operand (similar to C).</p>
</li>
<li>
<p>Multiplication, denoted by <code>*</code>. The result has the same width as the operands
and is computed by truncating the result to the output&#8217;s width.
P4 architectures may impose additional restrictions --- e.g., they may only
allow multiplication by a non-negative integer power of two.</p>
</li>
<li>
<p>Bitwise "and" between two bit-strings of the same width, denoted by <code>&amp;</code>.</p>
</li>
<li>
<p>Bitwise "or" between two bit-strings of the same width, denoted by <code>|</code>.</p>
</li>
<li>
<p>Bitwise "complement" of a single bit-string, denoted by <code>~</code>.</p>
</li>
<li>
<p>Bitwise "xor" of two bit-strings of the same width, denoted by <code>^</code>.</p>
</li>
<li>
<p>Saturating addition, denoted by <code>|+|</code>.</p>
</li>
<li>
<p>Saturating subtraction, denoted by <code>|-|</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Bit-strings also support the following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Logical shift left and right by a non-negative integer value (which need not be
a compile-time known value), denoted by <code>&lt;&lt;</code> and <code>&gt;&gt;</code> respectively.
In a shift, the left operand is unsigned, and right operand must be either an
expression of type <code>bit&lt;S&gt;</code> or a non-negative integer value that is known at
compile time.  The result has the same type as the left operand.
Shifting by an amount greater than or equal to the width of the input
produces a result where all bits are zero.</p>
</li>
<li>
<p>Extraction of a set of contiguous bits, also known as a slice,
denoted by <code>[H:L]</code>, where <code>H</code> and <code>L</code> must be expressions that evaluate to
non-negative, local compile-time known values, and <code>H &gt;= L</code>. The types of <code>H</code> and <code>L</code>
(which do not need to be identical) must be numeric (<a href="#sec-numeric-values">Section 7.4</a>).
The result is a bit-string of width <code>H - L + 1</code>, including the bits numbered
from <code>L</code> (which becomes the least significant bit of the result) to <code>H</code> (the
most significant bit of the result) from the source operand. The conditions
<code>0 &lt;= L &lt;= H &lt; W</code> are checked statically (where <code>W</code> is
the length of the source bit-string). Note that both endpoints of
the extraction are inclusive. The bounds are required to be
local compile-time known values so that the width of the result can be computed at compile time. Slices are also l-values, which means that P4 supports assigning to a slice: <code>e[H:L] = x</code>.
The effect of this statement is to set bits <code>H</code> through <code>L</code> (inclusive of
both) of <code>e</code> to the bit-pattern represented by <code>x</code>, and leaves all other bits
of <code>e</code> unchanged.  A slice of an unsigned integer is an unsigned integer.</p>
</li>
<li>
<p>Concatenation of bit-strings and/or fixed-width signed integers, denoted by <code>++</code>.
The two operands must be either <code>bit&lt;W&gt;</code> or <code>int&lt;W&gt;</code>, and they can be of
different signedness and width.  The result has the same signedness as the
left operand and the width equal to the sum of the two operands' width.
In concatenation, the left operand is placed as the most significant bits.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, the size of a bit-string can be determined at
compile-time (<a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-int-ops">8.7. Operations on fixed-width signed integers</h3>
<div class="paragraph">
<p>This section discusses all operations that can be performed on expressions of type <code>int&lt;W&gt;</code>
for some <code>W</code>. Recall that the <code>int&lt;W&gt;</code> denotes signed <code>W</code>-bit integers,
represented using two&#8217;s complement.</p>
</div>
<div class="paragraph">
<p>In general, P4 arithmetic operations do not detect "underflow" or "overflow":
operations simply "wrap around", similar to C operations on unsigned values.
Hence, attempting to represent large values using <code>W</code> bits will only keep
the least-significant <code>W</code> bits of the value.</p>
</div>
<div class="paragraph">
<p>P4 supports saturating arithmetic (addition and subtraction) for signed
integers. Targets may optionally reject programs using saturating arithmetic.
For a signed integer with bit-width of <code>W</code>, the minimum value is
<code>-2^(W-1)</code> and the maximum value is <code>2^(W-1)-1</code>.</p>
</div>
<div class="paragraph">
<p>P4 also does not support arithmetic exceptions. The runtime result of an
arithmetic operation is defined for all combinations of input
arguments.</p>
</div>
<div class="paragraph">
<p>All binary operations except shifts and concatenation require both operands
to have the same exact type (signedness) and width and supplying operands
with different widths or signedness produces a compile-time error.
No implicit casts are inserted by the compiler to equalize the types.
Except for shifts and concatenation, P4 does not have any binary operations
that operate simultaneously on signed and unsigned values.</p>
</div>
<div class="paragraph">
<p>Note that bitwise operations on signed integers are well-defined, since the
representation is mandated to be two&#8217;s complement.</p>
</div>
<div class="paragraph">
<p>The <code>int&lt;W&gt;</code> datatype supports the following operations; all
binary operations require both operands to have the exact same
type. The result always has the same width as the left operand.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Negation, denoted by unary <code>-</code>.</p>
</li>
<li>
<p>Unary plus, denoted by <code>+</code>. This operation behaves like a no-op.</p>
</li>
<li>
<p>Addition, denoted by <code>+</code>.</p>
</li>
<li>
<p>Subtraction, denoted by <code>-</code>.</p>
</li>
<li>
<p>Comparison for equality and inequality, denoted <code>==</code> and <code>!=</code> respectively. These operations produce a
Boolean result.</p>
</li>
<li>
<p>Numeric comparisons, denoted by <code>&lt;,&lt;=,&gt;,</code> and <code>&gt;=</code>. These operations produce a Boolean result.</p>
</li>
<li>
<p>Multiplication, denoted by <code>*</code>. Result has the same width as the
operands. P4 architectures may impose additional restrictions---e.g., they may
only allow multiplication by a power of two.</p>
</li>
<li>
<p>Bitwise "and" between two bit-strings of the same width, denoted by <code>&amp;</code>.</p>
</li>
<li>
<p>Bitwise "or" between two bit-strings of the same width, denoted by <code>|</code>.</p>
</li>
<li>
<p>Bitwise "complement" of a single bit-string, denoted by <code>~</code>.</p>
</li>
<li>
<p>Bitwise "xor" of two bit-strings of the same width, denoted by <code>^</code>.</p>
</li>
<li>
<p>Saturating addition, denoted by <code>|+|</code>.</p>
</li>
<li>
<p>Saturating subtraction, denoted by <code>|-|</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>int&lt;W&gt;</code> datatype also support the following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Arithmetic shift left and right denoted by <code>&lt;&lt;</code> and <code>&gt;&gt;</code>.
The left operand is signed and the right operand must be either an
unsigned number of type <code>bit&lt;S&gt;</code> or a compile-time known value that is a non-negative integer.
The result has the same type as the left operand.
Shifting left produces the exact same bit pattern as a shift left
of an unsigned value.  Shift left can thus overflow,
when it leads to a change of the sign bit.
Shifting by an amount greater than the width of the input produces
a "correct" result:</p>
<div class="ulist">
<ul>
<li>
<p>all result bits are zero when shifting left</p>
</li>
<li>
<p>all result bits are zero when shifting a non-negative value right</p>
</li>
<li>
<p>all result bits are one when shifting a negative value right</p>
</li>
</ul>
</div>
</li>
<li>
<p>Extraction of a set of contiguous bits, also known as a slice,
denoted by <code>[H:L]</code>, where <code>H</code> and <code>L</code> must be expressions that evaluate to
non-negative, local compile-time known values, and <code>H &gt;= L</code> must be true.
The types of <code>H</code> and <code>L</code> (which do not need to be identical)
must be numeric (<a href="#sec-numeric-values">Section 7.4</a>).
The result is an unsigned bit-string of width <code>H - L + 1</code>, including the bits
numbered from <code>L</code> (which becomes the least significant bit of the result)
to <code>H</code> (the most significant bit of the result) from the source operand.
The conditions <code>0 &lt;= L &lt;= H &lt; W</code> are checked statically (where <code>W</code> is
the length of the source bit-string). Note that both endpoints of
the extraction are inclusive. The bounds are required to be values
that are known at compile time so that the width of the result can be
computed at compile time. Slices are also l-values, which means that P4
supports assigning to a slice: <code>e[H:L] = x</code>.
The effect of this statement is to set bits <code>H</code> through <code>L</code> of <code>e</code> to the
bit-pattern represented by <code>x</code>, and leaves all other bits of <code>e</code> unchanged.
A slice of a signed integer is treated as an unsigned integer.</p>
</li>
<li>
<p>Concatenation of bit-strings and/or fixed-width signed integers, denoted by <code>++</code>.
The two operands must be either <code>bit&lt;W&gt;</code> or <code>int&lt;W&gt;</code>, and they can be of different signedness and width.
The result has the same signedness as the left operand and the width equal to the sum of the two operands' width.
In concatenation, the left operand is placed as the most significant bits.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, the size of a fixed-width signed integer can be determined at
compile-time (<a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-varint-ops">8.8. Operations on arbitrary-precision integers</h3>
<div class="paragraph">
<p>The type <code>int</code> denotes arbitrary-precision integers. In P4, all
expressions of type <code>int</code> must be compile-time known values.  The type
<code>int</code> supports the following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Negation, denoted by unary <code>-</code></p>
</li>
<li>
<p>Unary plus, denoted by <code>+</code>. This operation behaves like a no-op.</p>
</li>
<li>
<p>Addition, denoted by <code>+</code>.</p>
</li>
<li>
<p>Subtraction, denoted by <code>-</code>.</p>
</li>
<li>
<p>Comparison for equality and inequality, denoted by <code>==</code> and <code>!=</code> respectively. These operations produce a
Boolean result.</p>
</li>
<li>
<p>Numeric comparisons <code>&lt;,&lt;=,&gt;</code>, and <code>&gt;=</code>. These operations produce a Boolean result.</p>
</li>
<li>
<p>Multiplication, denoted by <code>*</code>.</p>
</li>
<li>
<p>Truncating integer division between positive values, denoted by <code>/</code>.</p>
</li>
<li>
<p>Modulo between positive values, denoted by <code>%</code>.</p>
</li>
<li>
<p>Arithmetic shift left and right denoted by <code>&lt;&lt;</code> and <code>&gt;&gt;</code>. These operations produce an <code>int</code> result.
The right operand must be either an unsigned value of type <code>bit&lt;S&gt;</code> or a compile-time known value that is a non-negative integer.
The expression <code>a &lt;&lt; b</code> is equal to <span class="image"><img src="resources/figs/stem-e137740de79d029b9b56331088395037.png" alt="stem e137740de79d029b9b56331088395037" width="34" height="10"></span> while <code>a &gt;&gt; b</code>
is equal to <span class="image"><img src="resources/figs/stem-a8822a017b2f283d08e8ddf4ab6028ea.png" alt="stem a8822a017b2f283d08e8ddf4ab6028ea" width="37" height="11"></span>.</p>
</li>
<li>
<p>Bit slices, denoted by <code>[H:L]</code>, where <code>H</code> and <code>L</code> must be expressions   that evaluate to
non-negative, local compile-time known values, and <code>H &gt;= L</code> must be true.
The types of <code>H</code> and <code>L</code> (which do not need to be identical)
must be one of the following:</p>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>int</code> - an arbitrary-precision integer
(<a href="#sec-arbitrary-precision-integers">Section 7.1.6.5</a>)</p>
</li>
<li>
<p><code>bit&lt;W&gt;</code> - a <code>W</code>-bit unsigned integer where <code>W &gt;= 0</code>
(<a href="#sec-unsigned-integers">Section 7.1.6.2</a>)</p>
</li>
<li>
<p><code>int&lt;W&gt;</code> - a <code>W</code>-bit signed integer where <code>W &gt;= 1</code>
(<a href="#sec-signed-integers">Section 7.1.6.3</a>)</p>
</li>
<li>
<p>a serializable <code>enum</code> with an underlying type that is <code>bit&lt;W&gt;</code> or <code>int&lt;W&gt;</code>
(<a href="#sec-enum-types">Section 7.2.1</a>).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>The result is an unsigned bit-string of width <code>H - L + 1</code>, including the bits
numbered from <code>L</code> (which becomes the least significant bit of the result)
to <code>H</code> (the most significant bit of the result) from the source operand.
The conditions <code>0 &lt;= L &lt;= H</code> are checked statically. If necessary, the source
integer value that is sliced is automatically extended to have a width with <code>H</code>
bits. Note that both endpoints of
the extraction are inclusive. The bounds are required to be values
that are known at compile time so that the width of the result can be
computed at compile time. A slice of a negative or positive value is always
a positive value.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each operand that participates in any of these operation must have
type <code>int</code> (except shifts). Binary operations cannot
be used to combine values of type <code>int</code> with values of a fixed-width
type (except shifts). However, the compiler automatically inserts casts from <code>int</code>
to fixed-width types in certain situations---see <a href="#sec-casts">Section 8.11</a>.</p>
</div>
<div class="paragraph">
<p>All computations on <code>int</code> values are carried out without loss of
information. For example, multiplying two 1024-bit values may produce
a 2048-bit value (note that concrete representation of <code>int</code>
values is not specified). <code>int</code> values can be cast to <code>bit&lt;w&gt;</code>
and <code>int&lt;w&gt;</code> values. Casting an <code>int</code> value to a fixed-width
type will preserve the least-significant bits. If truncation causes
significant bits to be lost, the compiler should emit a warning.</p>
</div>
<div class="paragraph">
<p>Note: bitwise-operations (<code>|</code>, <code>&amp;</code>, <code>^</code>, <code>~</code>) are not
defined on expressions of type <code>int</code>. In addition, it is illegal
to apply division and modulo to negative values.</p>
</div>
<div class="paragraph">
<p>Note: saturating arithmetic is not supported for arbitrary-precision integers.</p>
</div>
</div>
<div class="sect2">
<h3 id="_concatenation_and_shifts">8.9. Concatenation and shifts</h3>
<div class="sect3">
<h4 id="sec-concatenation">8.9.1. Concatenation</h4>
<div class="paragraph">
<p>Concatenation is applied to two bit-strings (signed or unsigned).
It is denoted by the infix operator <code>++</code>.  The result is a bit-string
whose length is the sum of the lengths of the inputs where the most
significant bits are taken from the left operand; the sign of the
result is taken from the left operand.</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_note_about_shifts">8.9.2. A note about shifts</h4>
<div class="paragraph">
<p>The left operand of shifts can be any one out of unsigned bit-strings, signed bit-strings,
and arbitrary-precision integers, and the right operand of shifts must be either
an expression of type <code>bit&lt;S&gt;</code> or a compile-time known value that is a non-negative integer.
The result has the same type as the left operand.</p>
</div>
<div class="paragraph">
<p>Shifts on signed and unsigned bit-strings deserve a special discussion
for the following reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Right shift behaves differently for signed and unsigned
bit-strings: right shift for signed bit-strings is an arithmetic shift,
and for unsigned bit-strings is a logical shift.</p>
</li>
<li>
<p>Shifting with a negative amount does not have a clear semantics:
the P4 type system makes it illegal to shift with a negative amount.</p>
</li>
<li>
<p>Unlike C, shifting by an amount larger than or equal to the number of bits
has a well-defined result.</p>
</li>
<li>
<p>Finally, depending on the capabilities of the target, shifting may
require doing work which is exponential in the number of bits of the
right-hand-side operand.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consider the following examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> x<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> y<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> z <span style="color: #0550ae">=</span> y <span style="color: #0550ae">&lt;&lt;</span> x<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> w <span style="color: #0550ae">=</span> y <span style="color: #0550ae">&lt;&lt;</span> <span style="color: #0550ae">1024</span><span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As mentioned above, P4 gives a precise meaning shifting with an amount
larger than the size of the shifted value, unlike C.</p>
</div>
<div class="paragraph">
<p>P4 targets may impose additional restrictions on shift operations such
as forbidding shifts by non-constant expressions, or by expressions
whose width exceeds a certain bound.  For example, a target may forbid
shifting an 8-bit value by a non-constant value whose width is greater
than 3 bits.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-varbit-string">8.10. Operations on variable-size bit types</h3>
<div class="paragraph">
<p>To support parsing headers with variable-length fields, P4 offers a
type <code>varbit</code>. Each occurrence of the type <code>varbit</code> has a
statically-declared maximum width, as well as a dynamic width, which
must not exceed the static bound. Prior to initialization a
variable-size bit-string has an unknown dynamic width.</p>
</div>
<div class="paragraph">
<p>Variable-length bit-strings support a limited set of operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Assignment to another variable-sized bit-string. The target of the
assignment must have the same static width as the source. When
executed, the assignment sets the dynamic width of the target to the
dynamic width of the source.</p>
</li>
<li>
<p>Comparison for equality or inequality with another <code>varbit</code> field.
Two <code>varbit</code> fields can be compared only if they have the same type.
Two varbits are equal if they have the same dynamic width and all
the bits up to the dynamic width are the same.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following operations are <em>not</em> supported directly on a value of
type <code>varbit</code>, but instead on any type for which <code>extract</code> and <code>emit</code>
operations are supported (e.g. a value with type header) that may
contain a field of type <code>varbit</code>. They are mentioned here only to ease
finding this information in a section dedicated to type <code>varbit</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Parser extraction into a header containing a variable-sized
bit-string using the two-argument <code>extract</code> method of a <code>packet_in</code>
extern object (see <a href="#sec-packet-extract-two">Section 13.8.2</a>). This
operation sets the dynamic width of the field.</p>
</li>
<li>
<p>The <code>emit</code> method of a <code>packet_out</code> extern object can be performed
on a header and a few other types (see <a href="#sec-deparse">Chapter 16</a>) that
contain a field with type <code>varbit</code>. Such an <code>emit</code> method call
inserts a variable-sized bit-string with a known dynamic width into
the packet being constructed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, the maximum size of a variable-length bit-string can be determined at compile-time (<a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-casts">8.11. Casts</h3>
<div class="paragraph">
<p>P4 provides a limited set of casts between types. A cast is written
<code>(t) e</code>, where <code>t</code> is a type and <code>e</code> is an expression. Casts are only
permitted on base types and derived types introduced by <code>typedef</code>, <code>type</code>, and <code>enum</code>.
While this design is arguably more onerous for programmers, it has several benefits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It makes user intent unambiguous.</p>
</li>
<li>
<p>It makes the costs associated with converting numeric values
explicit. Implementing certain casts involves sign extensions,
and thus can require significant computational resources on some targets.</p>
</li>
<li>
<p>It reduces the number of cases that have to be considered in the P4
specification. Some targets may not support all casts.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_explicit_casts">8.11.1. Explicit casts</h4>
<div class="paragraph">
<p>The following casts are legal in P4:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bit&lt;1&gt;</code> &#x12d4; <code>bool</code>: converts the value <code>0</code> to <code>false</code>, the value <code>1</code> to <code>true</code>, and vice versa.</p>
</li>
<li>
<p><code>int</code> &#8594; <code>bool</code>: only if the <code>int</code> value is <code>0</code> (converted to <code>false</code>) or <code>1</code> (converted to <code>true</code>)</p>
</li>
<li>
<p><code>int&lt;W&gt;</code> &#8594; <code>bit&lt;W&gt;</code>: preserves all bits unchanged and reinterprets negative
values as positive values</p>
</li>
<li>
<p><code>bit&lt;W&gt;</code> &#8594; <code>int&lt;W&gt;</code>: preserves all bits unchanged and reinterprets values whose most-significant bit is <code>1</code> as negative values</p>
</li>
<li>
<p><code>bit&lt;W&gt;</code> &#8594; <code>bit&lt;X&gt;</code>: truncates the value if <code>W &gt; X</code>, and otherwise (i.e., if  <code>W &lt;= X</code>) pads the value with zero bits.</p>
</li>
<li>
<p><code>int&lt;W&gt;</code> &#8594; <code>int&lt;X&gt;</code>: truncates the value if <code>W &gt; X</code>, and otherwise (i.e., if <code>W &lt; X</code>) extends it with the sign bit.</p>
</li>
<li>
<p><code>bit&lt;W&gt;</code> &#8594; <code>int</code>: preserves the value unchanged but converts it to an unlimited-precision integer; the result is always non-negative</p>
</li>
<li>
<p><code>int&lt;W&gt;</code> &#8594; <code>int</code>: preserves the value unchanged but converts it to an unlimited-precision integer; the result may be negative</p>
</li>
<li>
<p><code>int</code> &#8594; <code>bit&lt;W&gt;</code>: converts the integer value into a sufficiently
large two&#8217;s complement bit string to avoid information loss,
and then truncates the result to <code>W</code> bits. The compiler should
emit a warning on overflow or on conversion of negative value.</p>
</li>
<li>
<p><code>int</code> &#8594; <code>int&lt;W&gt;</code>: converts the integer value into a
sufficiently-large two&#8217;s complement bit string to avoid information
loss, and then truncates the result to <code>W</code> bits. The compiler should
emit a warning on overflow.</p>
</li>
<li>
<p>casts between two types that are introduced by <code>typedef</code> and are equivalent to one of the above combinations.</p>
</li>
<li>
<p>casts between a typedef and the original type.</p>
</li>
<li>
<p>casts between a type introduced by <code>type</code> and the original type.</p>
</li>
<li>
<p>casts between an <code>enum</code> with an explicit type and its underlying type</p>
</li>
<li>
<p>casts of a key-value list to a struct type or a header type (see <a href="#sec-structure-expressions">Section 8.13</a>)</p>
</li>
<li>
<p>casts of a tuple expression to a header stack type</p>
</li>
<li>
<p>casts of an invalid expression <code>{#}</code> to a header or a header union type</p>
</li>
<li>
<p>casts where the destination type is the same as the source type
if the destination type appears in this list (this excludes
e.g., parsers or externs).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="sec-implicit-casts">8.11.2. Implicit casts</h4>
<div class="paragraph">
<p>To keep the language simple and avoid introducing hidden costs, P4
only implicitly casts from <code>int</code> to fixed-width types and from enums
with an underlying type to the underlying type. In particular,
applying a binary operation (except shifts and concatenation) to an expression of type <code>int</code> and an
expression with a fixed-width type will implicitly cast the <code>int</code>
expression to the type of the other expression. For enums with an underlying
type, it can be implicitly cast to its underlying type whenever appropriate,
including but not limited to in shifts, concatenation, bit slicing indexes,
header stack indexes as well as other unary and binary operations.</p>
</div>
<div class="paragraph">
<p>For example, given the following declarations,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> E <span style="color: #24292f;background-color: #f6f8fa">{</span>
   a <span style="color: #0550ae">=</span> <span style="color: #0550ae">5</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  x<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> y<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">int</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  z<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>the compiler will add implicit casts as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>x + 1</code> becomes <code>x + (bit&lt;8&gt;)1</code></p>
</li>
<li>
<p><code>z &lt; 0</code> becomes <code>z &lt; (int&lt;8&gt;)0</code></p>
</li>
<li>
<p><code>x | 0xFFF</code> becomes <code>x | (bit&lt;8&gt;)0xFFF</code>; overflow warning</p>
</li>
<li>
<p><code>x + E.a</code> becomes <code>x + (bit&lt;8&gt;)E.a</code></p>
</li>
<li>
<p><code>x &amp;&amp;&amp; 8</code> becomes <code>x &amp;&amp;&amp; (bit&lt;8&gt;)8</code></p>
</li>
<li>
<p><code>x &lt;&lt; 256</code> remains unchanged; <code>256</code> not implicitly cast to <code>8w0</code> in a shift; overflow warning</p>
</li>
<li>
<p><code>16w11 &lt;&lt; E.a</code> becomes <code>16w11 &lt;&lt; (bit&lt;8&gt;)E.a</code></p>
</li>
<li>
<p><code>x[E.a:0]</code> becomes <code>x[(bit&lt;8&gt;)E.a:0]</code></p>
</li>
<li>
<p><code>E.a ++ 8w0</code> becomes <code>(bit&lt;8&gt;)E.a ++ 8w0</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The compiler also adds implicit casts when types of different
expressions need to <code>match</code>; for example, as described in Section
<a href="#sec-select">Section 13.6</a>, since select labels are compared against the selected
expression, the compiler will insert implicit casts for the select
labels when they have <code>int</code> types.  Similarly, when assigning a
structure-valued expression to a structure or header, the compiler will
add implicit casts for <code>int</code> fields.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-illegal-arith">8.11.3. Illegal arithmetic expressions</h4>
<div class="paragraph">
<p>Many arithmetic expressions that would be allowed in other languages
are illegal in P4. To illustrate, consider the following declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  x<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> y<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">int</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  z<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The table below shows several expressions which are illegal because
they do not obey the P4 typing rules. For each expression we provide
several ways that the expression could be manually rewritten into a
legal expression. Note that for some expression there are several
legal alternatives, which may produce different results! The compiler
cannot guess the user intent, so P4 requires the user to disambiguate.</p>
</div>
<table class="tableblock frame-all grid-all stretch center">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 57.1428%;">
<col style="width: 28.5715%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-right valign-top">Expression</th>
<th class="tableblock halign-left valign-top">Why it is illegal</th>
<th class="tableblock halign-left valign-top">Alternatives</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>x + y</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Different widths</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(bit&lt;16&gt;)x + y</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x + (bit&lt;8&gt;)y</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>x + z</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Different signedness</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(int&lt;8&gt;)x + z</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x + (bit&lt;8&gt;)z</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>(int&lt;8&gt;)y</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cannot change both sign and width</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(int&lt;8&gt;)(bit&lt;8&gt;)y</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(int&lt;8&gt;)(int&lt;16&gt;)y</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>y + z</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Different widths and signs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(int&lt;8&gt;)(bit&lt;8&gt;)y + z</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>y + (bit&lt;16&gt;)(bit&lt;8&gt;)z</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(bit&lt;8&gt;)y + (bit&lt;8&gt;)z</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(int&lt;16&gt;)y + (int&lt;16&gt;)z</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>x &lt;&lt; z</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RHS of shift cannot be signed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x &lt;&lt; (bit&lt;8&gt;)z</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>x &lt; z</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Different signs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x &lt; (bit&lt;8&gt;)z</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(int&lt;8&gt;)x &lt; z</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>1 &lt;&lt; x</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either LHS should have a fixed width (bit shift),</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>32w1 &lt;&lt; x</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Or RHS must be compile-time known (int shift)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>~1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bitwise operation on int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>~32w1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock"><code>5 &amp; -3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bitwise operation on int</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>32w5 &amp; -3</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="sec-tuple-exprs">8.12. Operations on tuple expressions</h3>
<div class="paragraph">
<p>Tuples can be assigned to other tuples with the same type, passed as
arguments and returned from functions, and can be initialized with
tuple expressions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">tuple</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">bool</span><span style="color: #0550ae">&gt;</span> x <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">,</span> false <span style="color: #24292f;background-color: #f6f8fa">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The fields of a tuple can be accessed using array index syntax <code>x[0]</code>,
<code>x[1]</code>.  The indexes <strong>must</strong> be local compile-time known values, to enable
the type-checker to identify the field types statically.</p>
</div>
<div class="paragraph">
<p>Tuples can be compared for equality using <code>==</code> and <code>!=</code>; two tuples are
equal if and only if all their fields are respectively equal.</p>
</div>
<div class="paragraph">
<p>Currently tuple fields are not left-values, even if the tuple itself
is.  (I.e. a tuple can only be assigned monolithically, and the field
values cannot be changed individually.)  This restriction may be
lifted in a future version of the language.</p>
</div>
<div class="paragraph">
<p>A tuple expression is written using curly braces, with each element
separated by a comma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">expression ...
    | '{' expressionList '}'

expressionList
    : /* empty */
    | expression
    | expressionList "," expression
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The type of a tuple expression is a tuple type (<a href="#sec-tuple-types">Section 7.2.6</a>).
Tuple expressions can be assigned to expressions
of type <code>tuple</code>, <code>struct</code> or <code>header</code>, and can also be
passed as arguments to methods. Tuples may be nested. However, tuple
expressions are not l-values.</p>
</div>
<div class="paragraph">
<p>For example, the following program fragment uses a tuple expression to
pass several header fields simultaneously to a learning provider:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> LearningProvider<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    LearningProvider<span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #953800">void</span> learn<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

LearningProvider<span style="color: #0550ae">&lt;</span><span style="color: #cf222e">tuple</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">48</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">()</span> lp<span style="color: #24292f;background-color: #f6f8fa">;</span>

lp<span style="color: #0550ae">.</span>learn<span style="color: #24292f;background-color: #f6f8fa">(</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> hdr<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>srcAddr<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>src <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A tuple may be used to initialize a structure if the tuple has the same
number of elements as fields in the structure. The effect of such an
initializer is to assign the n<sup>th</sup> element of the tuple to the n<sup>th</sup>
field in the structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> S <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> b<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">const</span> S x <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">20</span> <span style="color: #24292f;background-color: #f6f8fa">};</span> <span style="color: #6e7781">//a = 10, b = 20</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A tuple expression can have an explicit structure or header type
specified, and then it is converted automatically to a
structure-valued expression (see <a href="#sec-structure-expressions">Section 8.13</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> S <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> b<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">extern</span> <span style="color: #953800">void</span> f<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span>

f<span style="color: #24292f;background-color: #f6f8fa">((</span>S<span style="color: #24292f;background-color: #f6f8fa">){</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">20</span> <span style="color: #24292f;background-color: #f6f8fa">});</span> <span style="color: #6e7781">// automatically converted to f((S){a = 10, b = 20});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tuple expressions can also be used to initialize variables whose type
is a <code>tuple</code> type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">tuple</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">bool</span><span style="color: #0550ae">&gt;</span> x <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">,</span> false <span style="color: #24292f;background-color: #f6f8fa">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The empty tuple expression has type <code>tuple&lt;&gt;</code> - a tuple with no components.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-structure-expressions">8.13. Operations on structure-valued expressions</h3>
<div class="paragraph">
<p>One can write expressions that evaluate to a structure or header.  The
syntax of these expressions is given by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">expression ...
    | '{' kvList '}'
    | '(' typeRef ')' expression
    ;

kvList
    : kvPair
    | kvList "," kvPair
    ;

kvPair
    : name "=" expression
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a structure-valued expression <code>typeRef</code> is the name of a <code>struct</code>
or <code>header</code> type.  The <code>typeRef</code> can be omitted if it can be inferred
from context, e.g., when initializing a variable with a <code>struct</code> type.
Structure-valued expressions that evaluate to a value of some <code>header</code>
type are always valid.</p>
</div>
<div class="paragraph">
<p>The following example shows a structure-valued expression used in an
equality comparison expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> S <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> b<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

S s<span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #6e7781">// Compare s with a structure-valued expression
</span><span style="color: #953800">bool</span> b <span style="color: #0550ae">=</span> s <span style="color: #0550ae">==</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>S<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> a <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span> b <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span> <span style="color: #24292f;background-color: #f6f8fa">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Structure-valued expressions can be used in the right-hand side of
assignments, in comparisons, in field selection expressions, and as
arguments to functions, method or actions.  Structure-valued
expressions are not left values.</p>
</div>
<div class="paragraph">
<p>Structure-valued expressions that do not have <code>...</code> as their last
element must provide a value for every member of the struct or header
type to which it evaluates, by mentioning each field name exactly
once.</p>
</div>
<div class="paragraph">
<p>Structure-valued expressions that have <code>...</code> as their last element are
allowed to give values to only a subset of the fields of the struct or
header type to which it evaluates.  Any field names not given a value
explicitly will be given their default value (see <a href="#sec-initializing-with-default-values">Section 8.26</a>).</p>
</div>
<div class="paragraph">
<p>The order of the fields of the <code>struct</code> or <code>header</code> type does not need
to match the order of the values of the structure-valued expression.</p>
</div>
<div class="paragraph">
<p>It is a compile-time error if a field name appears more than once in
the same structure-valued expression.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-list-exprs">8.14. Operations on lists</h3>
<div class="paragraph">
<p>The value of a list is written using curly braces, with each element
separated by a comma.  The left curly brace is preceded by a
<code>(list&lt;T&gt;)</code> where <code>T</code> is the list element type.  Such a value can be
passed as an argument, e.g. to extern constructor functions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> <span style="color: #953800">pair_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> b<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">extern</span> E <span style="color: #24292f;background-color: #f6f8fa">{</span>
    E<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">list</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">pair_t</span><span style="color: #0550ae">&gt;</span> data<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #953800">void</span> run<span style="color: #24292f;background-color: #f6f8fa">();</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">control</span> c<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    E<span style="color: #24292f;background-color: #f6f8fa">((</span><span style="color: #cf222e">list</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">pair_t</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{{</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">},</span> <span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #0550ae">4</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">}})</span> e<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        e<span style="color: #0550ae">.</span>run<span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, the size of a list can be determined at
compile-time (<a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-set-exprs">8.15. Operations on sets</h3>
<div class="paragraph">
<p>Some P4 expressions denote sets of values (<code>set&lt;T&gt;</code>, for some type <code>T</code>;
see <a href="#sec-set-types">Section 7.2.9.1</a>). These expressions can
appear only in a few contexts---parsers and table
entries. For example, the <code>select</code> expression
(<a href="#sec-select">Section 13.6</a>) has the following structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">select</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>expression<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   set1<span style="color: #24292f;background-color: #f6f8fa">:</span> state1<span style="color: #24292f;background-color: #f6f8fa">;</span>
   set2<span style="color: #24292f;background-color: #f6f8fa">:</span> state2<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #6e7781">// More labels omitted
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the expressions <code>set1, set2</code>, etc. evaluate to sets of values
and the <code>select</code> expression tests whether <code>expression</code> belongs to
the sets used as labels.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">keysetExpression
    : tupleKeysetExpression
    | simpleKeysetExpression
    ;

tupleKeysetExpression
    : "(" simpleKeysetExpression "," simpleExpressionList ")"
    | "(" reducedSimpleKeysetExpression ")"
    ;

simpleExpressionList
    : simpleKeysetExpression
    | simpleExpressionList "," simpleKeysetExpression
    ;

reducedSimpleKeysetExpression
    : expression "&amp;&amp;&amp;" expression
    | expression ".." expression
    | DEFAULT
    | "_"
    ;

simpleKeysetExpression
    : expression
    | expression "&amp;&amp;&amp;" expression
    | expression ".." expression
    | DEFAULT
    | "_"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The mask (<code>&amp;&amp;&amp;</code>) and range (<code>..</code>) operators have the same
precedence; the just above the <code>?:</code> operator.</p>
</div>
<div class="sect3">
<h4 id="sec-singleton-set">8.15.1. Singleton sets</h4>
<div class="paragraph">
<p>In a set context, expressions denote singleton sets. For example, in
the following program fragment,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">select</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>version<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #0550ae">4</span><span style="color: #24292f;background-color: #f6f8fa">:</span> continue<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The label <code>4</code> denotes the singleton set containing the <code>int</code> value <code>4</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-universal-set">8.15.2. The universal set</h4>
<div class="paragraph">
<p>In a set context, the expressions <code>default</code> or <code>_</code> denote the
universal set, which contains all possible values of a given type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">select</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>version<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #0550ae">4</span><span style="color: #24292f;background-color: #f6f8fa">:</span> continue<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #0550ae">_</span><span style="color: #24292f;background-color: #f6f8fa">:</span> reject<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-cubes">8.15.3. Masks</h4>
<div class="paragraph">
<p>The infix operator <code>&amp;&amp;&amp;</code> takes two arguments of the same numeric type (<a href="#sec-numeric-values">Section 7.4</a>),
and creates a value of the same type.
The right value is used as a
"mask", where each bit set to <code>0</code> in the mask indicates a "don&#8217;t care"
bit. More formally, the set denoted by <code>a &amp;&amp;&amp; b</code> is defined as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">a <span style="color: #0550ae">&amp;&amp;&amp;</span> b <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> c where a <span style="color: #0550ae">&amp;</span> b <span style="color: #0550ae">=</span> c <span style="color: #0550ae">&amp;</span> b <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">8w0x0A</span> <span style="color: #0550ae">&amp;&amp;&amp;</span> <span style="color: #0550ae">8w0x0F</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>denotes a set that contains 16 different <code>bit&lt;8&gt;</code> values, whose
bit-pattern is <code>XXXX1010</code>, where the value of an <code>X</code> can be
any bit. Note that there may be multiple ways to express a keyset
using a mask operator---e.g., <code>8w0xFA &amp;&amp;&amp; 8w0x0F</code> denotes the same
keyset as in the example above.</p>
</div>
<div class="paragraph">
<p>Similar to other binary operations,
the mask operator allows the compiler to automatically insert casts
to unify the argument types in certain situations (<a href="#sec-implicit-casts">Section 8.11.2</a>).</p>
</div>
<div class="paragraph">
<p>P4 architectures may impose additional restrictions on the expressions
on the left and right-hand side of a mask operator: for example, they
may require that either or both sub-expressions be compile-time known
values.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-ranges">8.15.4. Ranges</h4>
<div class="paragraph">
<p>The infix operator <code>..</code> takes two arguments of the same numeric type <code>T</code> (<a href="#sec-numeric-values">Section 7.4</a>),
and creates a value of
the type <code>set&lt;T&gt;</code>. The set contains all values numerically between the
first and the second, inclusively. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">4s5</span> <span style="color: #0550ae">..</span> <span style="color: #0550ae">4s8</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>denotes a set of 4 consecutive <code>int&lt;4&gt;</code> values <code>4s5, 4s6, 4s7</code>, and <code>4s8</code>.</p>
</div>
<div class="paragraph">
<p>Similar to other binary operations,
the range operator allows the compiler to automatically insert casts
to unify the argument types in certain situations (<a href="#sec-implicit-casts">Section 8.11.2</a>).</p>
</div>
<div class="paragraph">
<p>A range where the second value is smaller than the first one
represents an empty set.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-tuples-of-sets">8.15.5. Products</h4>
<div class="paragraph">
<p>Multiple sets can be combined using Cartesian product:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ihl<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>protocol<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
     <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">4w0x5</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">8w0x1</span><span style="color: #24292f;background-color: #f6f8fa">):</span> parse_icmp<span style="color: #24292f;background-color: #f6f8fa">;</span>
     <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">4w0x5</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">8w0x6</span><span style="color: #24292f;background-color: #f6f8fa">):</span> parse_tcp<span style="color: #24292f;background-color: #f6f8fa">;</span>
     <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">4w0x5</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">8w0x11</span><span style="color: #24292f;background-color: #f6f8fa">):</span> parse_udp<span style="color: #24292f;background-color: #f6f8fa">;</span>
     <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">_</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">_</span><span style="color: #24292f;background-color: #f6f8fa">):</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The type of a product of sets is a set of tuples.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-ops-on-structs">8.16. Operations on struct types</h3>
<div class="paragraph">
<p>The only operation defined on expressions whose type is a <code>struct</code> is
field access, written using dot (".") notation---e.g., <code>s.field</code>. If
<code>s</code> is an l-value, then <code>s.field</code> is also an l-value. P4 also allows
copying <code>struct</code>s using assignment when the source and target of the
assignment have the same type. Finally, <code>struct</code>s can be initialized
with a tuple expression, as discussed in <a href="#sec-tuple-exprs">Section 8.12</a>, or
with a structure-valued expression, as described in
<a href="#sec-structure-expressions">Section 8.13</a>.  Both of these cases must initialize all
fields of the structure. The size of a struct can be determined at
compile-time (<a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</div>
<div class="paragraph">
<p>Two structs can be compared for equality (<code>==</code>) or inequality (<code>!=</code>) only
if they have the same type and all of their fields can be recursively
compared for equality.  Two structures are equal if and only if all
their corresponding fields are equal.</p>
</div>
<div class="paragraph">
<p>The following example shows a structure initialized in several
different ways:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> S <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> b<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">const</span> S x <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">20</span> <span style="color: #24292f;background-color: #f6f8fa">};</span>             <span style="color: #6e7781">// tuple expression
</span><span style="color: #cf222e">const</span> S x <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> a <span style="color: #0550ae">=</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">,</span> b <span style="color: #0550ae">=</span> <span style="color: #0550ae">20</span> <span style="color: #24292f;background-color: #f6f8fa">};</span>     <span style="color: #6e7781">// structure-valued expression
</span><span style="color: #cf222e">const</span> S x <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>S<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> a <span style="color: #0550ae">=</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">,</span> b <span style="color: #0550ae">=</span> <span style="color: #0550ae">20</span> <span style="color: #24292f;background-color: #f6f8fa">};</span> <span style="color: #6e7781">// structure-valued expression</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#sec-uninitialized-values-and-writing-invalid-headers">Section 8.25</a>
for a description of the behavior if <code>struct</code> fields are read without
being initialized.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-ops-on-hdrs">8.17. Operations on headers</h3>
<div class="paragraph">
<p>Headers provide the same operations as <code>struct</code>s. Assignment between
headers also copies the "validity" header bit.</p>
</div>
<div class="paragraph">
<p>In addition, headers support the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The method <code>isValid()</code> returns the value of the "validity" bit
of the header.</p>
</li>
<li>
<p>The method <code>setValid()</code> sets the header&#8217;s validity bit to
"true". It can only be applied to an l-value.</p>
</li>
<li>
<p>The method <code>setInvalid()</code> sets the header&#8217;s validity bit to
"false". It can only be applied to an l-value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Similar to a <code>struct</code>, a header object can be initialized with a tuple
expression (see <a href="#sec-tuple-exprs">Section 8.12</a>) --- the tuple fields are assigned to the
header fields in the order they appear --- or with a structure-valued
expression (see <a href="#sec-ops-on-structs">Section 8.16</a>).  When initialized the header
automatically becomes valid:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> H <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> x<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> y<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
H h<span style="color: #24292f;background-color: #f6f8fa">;</span>
h <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">12</span> <span style="color: #24292f;background-color: #f6f8fa">};</span>  <span style="color: #6e7781">// This also makes the header h valid
</span>h <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> y <span style="color: #0550ae">=</span> <span style="color: #0550ae">12</span><span style="color: #24292f;background-color: #f6f8fa">,</span> x <span style="color: #0550ae">=</span> <span style="color: #0550ae">10</span> <span style="color: #24292f;background-color: #f6f8fa">};</span>  <span style="color: #6e7781">// Same effect as above</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Two headers can be compared for equality (<code>==</code>) or inequality (<code>!=</code>) only
if they have the same type.  Two headers are equal if and only if they
are both invalid, or they are both valid and all their corresponding
fields are equal.
Furthermore, the size of a header can be determined at
compile-time (<a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</div>
<div class="paragraph">
<p>The expression <code>{#}</code> represents an invalid header of some type, but it
can be any header or header union type.  A P4 compiler may require an
explicit cast on this expression in cases where it cannot determine
the particular header or header union type from the context.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">expression
    ...
    | "{#}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> H <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> x<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> y<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
H h<span style="color: #24292f;background-color: #f6f8fa">;</span>
h <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #0550ae">#</span><span style="color: #24292f;background-color: #f6f8fa">};</span>   <span style="color: #6e7781">// This make the header h become invalid
</span><span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>h <span style="color: #0550ae">==</span> <span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #0550ae">#</span><span style="color: #24292f;background-color: #f6f8fa">})</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>     <span style="color: #6e7781">// This is equivalent to the condition !h.isValid()
</span>    <span style="color: #6e7781">// ...
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>#</code> character cannot be misinterpreted as a preprocessor
directive, since it cannot be the first character on a line when it
occurs in the single lexical token <code>{#}</code>, which may not have
whitespace or any other characters between those shown.</p>
</div>
<div class="paragraph">
<p>See <a href="#sec-uninitialized-values-and-writing-invalid-headers">Section 8.25</a>
for a description of the behavior if header fields are read without
being initialized, or header fields are written to a currently invalid
header.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-expr-hs">8.18. Operations on header stacks</h3>
<div class="paragraph">
<p>A header stack is a fixed-size array of headers with the same
type. The valid elements of a header stack need not be contiguous. P4
provides a set of computations for manipulating header stacks. A
header stack <code>hs</code> of type <code>h[n]</code> can be understood in terms of
the following pseudocode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">// type declaration
struct hs_t {
  bit&lt;32&gt; nextIndex;
  bit&lt;32&gt; size;
  h[n] data;  // Ordinary array
}

// instance declaration and initialization
hs_t hs;
hs.nextIndex = 0;
hs.size = n;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Intuitively, a header stack can be thought of as a struct containing
an ordinary array of headers <code>hs</code> and a counter <code>nextIndex</code>
that can be used to simplify the construction of parsers for header
stacks, as discussed below. The <code>nextIndex</code> counter is initialized
to <code>0</code>.</p>
</div>
<div class="paragraph">
<p>Given a header stack value <code>hs</code> of size <code>n</code>, the following
expressions are legal:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hs[index]</code>: produces a reference to the header at the
specified position within the stack; if <code>hs</code> is an l-value,
the result is also an l-value. The header may be invalid. Some implementations may impose the constraint that the index expression must be a compile-time known value.
A P4 compiler must give an error if an index that is a compile-time known value is out of range.</p>
<div class="paragraph">
<p>Accessing a header stack <code>hs</code> with an index less than <code>0</code> or
greater than or equal to <code>hs.size</code> results in an undefined value.  See <a href="#sec-uninitialized-values-and-writing-invalid-headers">Section 8.25</a> for more
details.</p>
</div>
<div class="paragraph">
<p>The <code>index</code> is an expression that must be of numeric types (<a href="#sec-numeric-values">Section 7.4</a>).</p>
</div>
</li>
<li>
<p><code>hs.size</code>: produces a 32-bit unsigned integer that returns the
size of the header stack (a local compile-time known value).</p>
</li>
<li>
<p>assignment from a header stack <code>hs</code> into another stack requires
the stacks to have the same types and sizes. All components of <code>hs</code>
are copied, including its elements and their validity bits,
as well as <code>nextIndex</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To help programmers write parsers for header stacks, P4 also offers
computations that automatically advance through the stack as elements
are parsed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hs.next</code>: produces a reference to the element with index <code>hs.nextIndex</code>
in the stack. May only be used in a <code>parser</code>. If the stack&#8217;s <code>nextIndex</code>
counter is greater than or equal to <code>size</code>, then evaluating this
expression results in a transition to <code>reject</code> and
sets the error to <code>error.StackOutOfBounds</code>. If <code>hs</code> is an
l-value, then <code>hs.next</code> is also an l-value.</p>
</li>
<li>
<p><code>hs.last</code>: produces a reference to the element with index <code>hs.nextIndex - 1</code>
in the stack, if such an element exists. May only be used in a <code>parser</code>.
If the <code>nextIndex</code> counter is less than <code>1</code>,
or greater than <code>size</code>, then evaluating this expression results
in a transition to <code>reject</code> and sets the error to <code>error.StackOutOfBounds</code>.
Unlike <code>hs.next</code>, the resulting reference is never an l-value.</p>
</li>
<li>
<p><code>hs.lastIndex</code>: produces a 32-bit unsigned integer that encodes the index <code>hs.nextIndex - 1</code>.
May only be used in a <code>parser</code>. If the <code>nextIndex</code> counter is <code>0</code>, then
evaluating this expression produces an undefined value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, P4 offers the following computations that can be used to
manipulate the elements at the front and back of the stack:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>hs.push_front(int count)</code>: shifts <code>hs</code> "right" by <code>count</code>. The
first <code>count</code> elements become invalid. The last <code>count</code> elements in
the stack are discarded. The <code>hs.nextIndex</code> counter is incremented
by <code>count</code>. The <code>count</code> argument must be a compile-time known value
that is a positive integer. The return type is <code>void</code>.</p>
</li>
<li>
<p><code>hs.pop_front(int count)</code>: shifts <code>hs</code> "left" by <code>count</code>
(i.e., element with index <code>count</code> is copied in stack at index <code>0</code>).
The last <code>count</code> elements become invalid. The <code>hs.nextIndex</code>
counter is decremented by <code>count</code>. The <code>count</code> argument must
be a compile-time known value that is a positive integer. The return
type is <code>void</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following pseudocode defines the behavior of <code>push_front</code> and <code>pop_front</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">void push_front(int count) {
    for (int i = this.size-1; i &gt;= 0; i -= 1) {
        if (i &gt;= count) {
            this[i] = this[i-count];
        } else {
            this[i].setInvalid();
        }
    }
    this.nextIndex = this.nextIndex + count;
    if (this.nextIndex &gt; this.size) this.nextIndex = this.size;
    // Note: this.last, this.next, and this.lastIndex adjust with this.nextIndex
}

void pop_front(int count) {
    for (int i = 0; i &lt; this.size; i++) {
        if (i+count &lt; this.size) {
            this[i] = this[i+count];
        } else {
            this[i].setInvalid();
        }
    }
    if (this.nextIndex &gt;= count) {
        this.nextIndex = this.nextIndex - count;
    } else {
        this.nextIndex = 0;
    }
    // Note: this.last, this.next, and this.lastIndex adjust with this.nextIndex
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to structs and headers, the size of a header stack is a compile-time known value (Section <a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</div>
<div class="paragraph">
<p>Two header stacks can be compared for equality (<code>==</code>) or inequality (<code>!=</code>)
only if they have the same element type and the same length.  Two
stacks are equal if and only if all their corresponding elements are
equal.  Note that the <code>nextIndex</code> value is not used in the equality comparison.</p>
</div>
<div class="sect3">
<h4 id="sec-hs-init">8.18.1. Header stack expressions</h4>
<div class="paragraph">
<p>One can write expressions that evaluate to a header stack.  The
syntax of these expressions is given by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">expression ...
    | '{' expressionList '}'
    | '(' typeRef ')' expression
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>typeRef</code> is a header stack type.  The <code>typeRef</code> can be omitted if
it can be inferred from context, e.g., when initializing a variable
with a header stack type.  Each expression in the list must evaluate
to a header of the same type as the other stack elements.</p>
</div>
<div class="paragraph">
<p>Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> H<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> b<span style="color: #24292f;background-color: #f6f8fa">;</span>
    T t<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
H<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">]</span> s <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>H<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">]){</span> <span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">},</span> <span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">},</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>H<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">){</span><span style="color: #0550ae">#</span><span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #24292f;background-color: #f6f8fa">};</span>
<span style="color: #6e7781">// without an explicit cast
</span>H<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">]</span> s1 <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">},</span> <span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">},</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>H<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">){</span><span style="color: #0550ae">#</span><span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #24292f;background-color: #f6f8fa">};</span>
<span style="color: #6e7781">// using the default initializer
</span>H<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">]</span> s2 <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">},</span> <span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">},</span> <span style="color: #0550ae">...</span> <span style="color: #24292f;background-color: #f6f8fa">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The values of <code>s</code>, <code>s1</code>, and <code>s2</code> in the above example are identical.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-expr-hu">8.19. Operations on header unions</h3>
<div class="paragraph">
<p>A variable declared with a union type is initially invalid. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> H1 <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> f<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">header</span> H2 <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> g<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">header_union</span> U <span style="color: #24292f;background-color: #f6f8fa">{</span>
  H1 h1<span style="color: #24292f;background-color: #f6f8fa">;</span>
  H2 h2<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

U u<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// u invalid</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This also implies that each of the headers <code>h1</code> through <code>hn</code> contained
in a header union are also initially invalid. Unlike headers, a union
cannot be initialized. However, the validity of a header union can be
updated by assigning a valid header to one of its elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">U u<span style="color: #24292f;background-color: #f6f8fa">;</span>
H1 my_h1 <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">8w0</span> <span style="color: #24292f;background-color: #f6f8fa">};</span> <span style="color: #6e7781">// my_h1 is valid
</span>u<span style="color: #0550ae">.</span>h1 <span style="color: #0550ae">=</span> my_h1<span style="color: #24292f;background-color: #f6f8fa">;</span>       <span style="color: #6e7781">// u and u.h1 are both valid</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can also assign a tuple to an element of a header union,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">U u<span style="color: #24292f;background-color: #f6f8fa">;</span>
u<span style="color: #0550ae">.</span>h2 <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">16w1</span> <span style="color: #24292f;background-color: #f6f8fa">};</span>     <span style="color: #6e7781">// u and u.h2 are both valid</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>or set their validity bits directly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">U u<span style="color: #24292f;background-color: #f6f8fa">;</span>
u<span style="color: #0550ae">.</span>h1<span style="color: #0550ae">.</span><span style="color: #953800">setValid</span><span style="color: #24292f;background-color: #f6f8fa">();</span>     <span style="color: #6e7781">// u and u.h1 are both valid
</span>H1 my_h1 <span style="color: #0550ae">=</span> u<span style="color: #0550ae">.</span>h1<span style="color: #24292f;background-color: #f6f8fa">;</span>     <span style="color: #6e7781">// my_h1 is now valid, but contains an undefined value</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that reading an uninitialized header produces an undefined value,
even if the header is itself valid.</p>
</div>
<div class="paragraph">
<p>If <code>u</code> is an expression whose type is a header union <code>U</code> with fields
ranged over by <code>hi</code>, then the expression <code>u.hi</code> evaluates to a header,
and thus it can be used wherever a header expression is allowed.  If
<code>u</code> is a left-value, then <code>u.hi</code> is also a left-value.</p>
</div>
<div class="paragraph">
<p>The following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>u.hi.setValid():</code> sets the valid bit for header <code>hi</code> to <code>true</code> and
sets the valid bit for all other headers to <code>false</code>, which implies that
it is unspecified what value reading any member header of <code>u</code> will return.</p>
</li>
<li>
<p><code>u.hi.setInvalid()</code>: if the valid bit for any member header of <code>u</code>
is <code>true</code> then sets it to <code>false</code>, which implies that it is unspecified
what value reading any member header of <code>u</code> will return.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The assignment to a union field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">u<span style="color: #0550ae">.</span>hi <span style="color: #0550ae">=</span> e<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>has the following meaning:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if <code>e</code> is valid, then it is equivalent to:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">  u<span style="color: #0550ae">.</span>hi<span style="color: #0550ae">.</span><span style="color: #953800">setValid</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
  u<span style="color: #0550ae">.</span>hi <span style="color: #0550ae">=</span> e<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>if <code>e</code> is invalid, then it is equivalent to:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">  u<span style="color: #0550ae">.</span>hi<span style="color: #0550ae">.</span><span style="color: #953800">setInvalid</span><span style="color: #24292f;background-color: #f6f8fa">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Assignments between variables of the same type of header union are
permitted. The assignment <code>u1 = u2</code> copies the full state of header
union <code>u2</code> to <code>u1</code>. If <code>u2</code> is valid, then there is some header
<code>u2.hi</code> that is valid. The assignment behaves the same as <code>u1.hi = u2.hi</code>.
If <code>u2</code> is not valid, then <code>u1</code> becomes invalid (i.e. if any
header of <code>u1</code> was valid, it becomes invalid).</p>
</div>
<div class="paragraph">
<p><code>u.isValid()</code> returns true if any member of the header union <code>u</code> is
valid, otherwise it returns false.  <code>setValid()</code> and <code>setInvalid()</code>
methods are not defined for header unions.</p>
</div>
<div class="paragraph">
<p>Supplying an expression with a union type to <code>emit</code> simply emits the
single header that is valid, if any.</p>
</div>
<div class="paragraph">
<p>The following example shows how we can use header unions to represent
IPv4 and IPv6 headers uniformly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header_union</span> IP <span style="color: #24292f;background-color: #f6f8fa">{</span>
    IPv4 ipv4<span style="color: #24292f;background-color: #f6f8fa">;</span>
    IPv6 ipv6<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">struct</span> Parsed_packet <span style="color: #24292f;background-color: #f6f8fa">{</span>
   Ethernet ethernet<span style="color: #24292f;background-color: #f6f8fa">;</span>
   IP ip<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">parser</span> top<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> Parsed_packet p<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">state</span> start <span style="color: #24292f;background-color: #f6f8fa">{</span>
       b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ethernet<span style="color: #24292f;background-color: #f6f8fa">);</span>
       <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>etherType<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
           <span style="color: #0550ae">16w0x0800</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> parse_ipv4<span style="color: #24292f;background-color: #f6f8fa">;</span>
           <span style="color: #0550ae">16w0x86DD</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> parse_ipv6<span style="color: #24292f;background-color: #f6f8fa">;</span>
       <span style="color: #24292f;background-color: #f6f8fa">}</span>
   <span style="color: #24292f;background-color: #f6f8fa">}</span>
   <span style="color: #cf222e">state</span> parse_ipv4 <span style="color: #24292f;background-color: #f6f8fa">{</span>
       b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ip<span style="color: #0550ae">.</span>ipv4<span style="color: #24292f;background-color: #f6f8fa">);</span>
       <span style="color: #cf222e">transition</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #24292f;background-color: #f6f8fa">}</span>
   <span style="color: #cf222e">state</span> parse_ipv6 <span style="color: #24292f;background-color: #f6f8fa">{</span>
       b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ip<span style="color: #0550ae">.</span>ipv6<span style="color: #24292f;background-color: #f6f8fa">);</span>
       <span style="color: #cf222e">transition</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As another example, we can also use unions to parse (selected) TCP
options:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> <span style="color: #953800">Tcp_option_end_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> kind<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">header</span> <span style="color: #953800">Tcp_option_nop_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> kind<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">header</span> <span style="color: #953800">Tcp_option_ss_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  kind<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> maxSegmentSize<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">header</span> <span style="color: #953800">Tcp_option_s_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  kind<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">24</span><span style="color: #0550ae">&gt;</span> scale<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">header</span> <span style="color: #953800">Tcp_option_sack_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>         kind<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>         length<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">varbit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">256</span><span style="color: #0550ae">&gt;</span>    sack<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">header_union</span> <span style="color: #953800">Tcp_option_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">Tcp_option_end_h</span>  end<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">Tcp_option_nop_h</span>  nop<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">Tcp_option_ss_h</span>   ss<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">Tcp_option_s_h</span>    s<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">Tcp_option_sack_h</span> sack<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">typedef</span> <span style="color: #953800">Tcp_option_h</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">]</span> Tcp_option_stack<span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">struct</span> Tcp_option_sack_top <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> kind<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> length<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">parser</span> Tcp_option_parser<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> Tcp_option_stack vec<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">state</span> start <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>b<span style="color: #0550ae">.</span>lookahead<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">())</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #0550ae">8w0x0</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> parse_tcp_option_end<span style="color: #24292f;background-color: #f6f8fa">;</span>
            <span style="color: #0550ae">8w0x1</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> parse_tcp_option_nop<span style="color: #24292f;background-color: #f6f8fa">;</span>
            <span style="color: #0550ae">8w0x2</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> parse_tcp_option_ss<span style="color: #24292f;background-color: #f6f8fa">;</span>
            <span style="color: #0550ae">8w0x3</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> parse_tcp_option_s<span style="color: #24292f;background-color: #f6f8fa">;</span>
            <span style="color: #0550ae">8w0x5</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> parse_tcp_option_sack<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">state</span> parse_tcp_option_end <span style="color: #24292f;background-color: #f6f8fa">{</span>
        b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>vec<span style="color: #0550ae">.</span>next<span style="color: #0550ae">.</span>end<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #cf222e">transition</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">state</span> parse_tcp_option_nop <span style="color: #24292f;background-color: #f6f8fa">{</span>
         b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>vec<span style="color: #0550ae">.</span>next<span style="color: #0550ae">.</span>nop<span style="color: #24292f;background-color: #f6f8fa">);</span>
         <span style="color: #cf222e">transition</span> start<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">state</span> parse_tcp_option_ss <span style="color: #24292f;background-color: #f6f8fa">{</span>
         b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>vec<span style="color: #0550ae">.</span>next<span style="color: #0550ae">.</span>ss<span style="color: #24292f;background-color: #f6f8fa">);</span>
         <span style="color: #cf222e">transition</span> start<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">state</span> parse_tcp_option_s <span style="color: #24292f;background-color: #f6f8fa">{</span>
         b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>vec<span style="color: #0550ae">.</span>next<span style="color: #0550ae">.</span>s<span style="color: #24292f;background-color: #f6f8fa">);</span>
         <span style="color: #cf222e">transition</span> start<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">state</span> parse_tcp_option_sack <span style="color: #24292f;background-color: #f6f8fa">{</span>
         <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> n <span style="color: #0550ae">=</span> b<span style="color: #0550ae">.</span>lookahead<span style="color: #0550ae">&lt;</span>Tcp_option_sack_top<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">()</span><span style="color: #0550ae">.</span>length<span style="color: #24292f;background-color: #f6f8fa">;</span>
         <span style="color: #6e7781">// n is the total length of the TCP SACK option in bytes.
</span>         <span style="color: #6e7781">// The length of the varbit field 'sack' of the
</span>         <span style="color: #6e7781">// Tcp_option_sack_h header is thus n-2 bytes.
</span>         b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>vec<span style="color: #0550ae">.</span>next<span style="color: #0550ae">.</span>sack<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">8</span> <span style="color: #0550ae">*</span> n <span style="color: #0550ae">-</span> <span style="color: #0550ae">16</span><span style="color: #24292f;background-color: #f6f8fa">));</span>
         <span style="color: #cf222e">transition</span> start<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to headers, the size of a header union is a local compile-time known value (Section <a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</div>
<div class="paragraph">
<p>The expression <code>{#}</code> represents an invalid header union of some type,
but it can be any header or header union type.  A P4 compiler may require an
explicit cast on this expression in cases where it cannot determine
the particular header or header union type from the context.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header_union</span> HU <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">...</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
HU h <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>HU<span style="color: #24292f;background-color: #f6f8fa">){</span><span style="color: #0550ae">#</span><span style="color: #24292f;background-color: #f6f8fa">};</span>  <span style="color: #6e7781">// invalid header union; same as an uninitialized header union.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Two header unions can be compared for equality (<code>==</code>) or inequality (<code>!=</code>)
if they have the same type.  The unions are equal if and only if all
their corresponding fields are equal (i.e., either all fields are
invalid in both unions, or in both unions the same field is valid, and
the values of the valid fields are equal as headers).</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-invocations">8.20. Method invocations and function calls</h3>
<div class="paragraph">
<p>Method invocations and function calls can be invoked using the
following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">expression
    : ...
    | expression '&lt;' realTypeArgumentList '&gt;' '(' argumentList ')'
    | expression '(' argumentList ')'

argumentList
    : /* empty */
    | nonEmptyArgList
    ;

nonEmptyArgList
    : argument
    | nonEmptyArgList "," argument
    ;

argument
    : expression  /* positional argument */
    | name "=" expression  /* named argument */
    | "_"
    | name "=" "_"
    ;

realTypeArgumentList
    : realTypeArg
    | realTypeArgumentList "," typeArg
    ;

realTypeArg
    : typeRef
    | VOID
    | "_"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A function call or method invocation can optionally specify for each
argument the corresponding parameter name.  It is illegal to use names
only for some arguments: either all or no arguments must specify
the parameter name.  Function arguments are evaluated in the order
they appear, left to right, before the function invocation takes place.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> <span style="color: #953800">void</span> f<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> x<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> y<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> xa <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> ya<span style="color: #24292f;background-color: #f6f8fa">;</span>
f<span style="color: #24292f;background-color: #f6f8fa">(</span>xa<span style="color: #24292f;background-color: #f6f8fa">,</span> ya<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// match arguments by position
</span>f<span style="color: #24292f;background-color: #f6f8fa">(</span>x <span style="color: #0550ae">=</span> xa<span style="color: #24292f;background-color: #f6f8fa">,</span> y <span style="color: #0550ae">=</span> ya<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// match arguments by name
</span>f<span style="color: #24292f;background-color: #f6f8fa">(</span>y <span style="color: #0550ae">=</span> ya<span style="color: #24292f;background-color: #f6f8fa">,</span> x <span style="color: #0550ae">=</span> xa<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// match arguments by name in any order
//f(x = xa);  -- error: enough arguments
//f(x = xa, x = ya);  -- error: argument specified twice
//f(x = xa, ya);  -- error: some arguments specified by name
//f(z = xa, w = yz);  -- error: no parameter named z or w
//f(x = xa, y = 0);  -- error: y must be a left-value</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The calling convention is copy-in/copy-out (<a href="#sec-calling-convention">Section 6.8</a>).  For generic functions the type arguments
can be explicitly specified in the function call. The compiler only
inserts implicit casts for direction <code>in</code> arguments to methods or
functions as described in <a href="#sec-casts">Section 8.11</a>.  The types for all
other arguments must match the parameter types exactly.</p>
</div>
<div class="paragraph">
<p>The result returned by a function call is discarded when the function
call is used as a statement.</p>
</div>
<div class="paragraph">
<p>The "don&#8217;t care" identifier (<code>_</code>) can only be used for an <code>out</code>
function/method argument, when the value of returned in that argument
is ignored by subsequent computations.  When used in generic functions
or methods, the compiler may reject the program if it is unable to
infer a type for the don&#8217;t care argument.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-constructor">8.21. Constructor invocations</h3>
<div class="paragraph">
<p>Several P4 constructs denote resources that are allocated at
compilation time:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>extern</code> objects</p>
</li>
<li>
<p><code>parser</code>s</p>
</li>
<li>
<p><code>control</code> blocks</p>
</li>
<li>
<p><code>package</code>s</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Allocation of such objects can be performed in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using constructor invocations, which are expressions that return an
object of the corresponding type.</p>
</li>
<li>
<p>Using instantiations, described in <a href="#sec-instantiations">Section 11.3</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The syntax for a constructor invocation is similar to a function call;
constructors can also be called using named arguments.
Constructors are evaluated entirely at compilation time (see <a href="#sec-p4-abstract-mach">Chapter 18</a>). In consequence, all constructor arguments
must also be expressions that can be evaluated at compilation time.
When performing type inference and overload resolution, constructor
invocations are treated similar to methods or functions.</p>
</div>
<div class="paragraph">
<p>The following example shows a constructor invocation for setting the
target-dependent implementation property of a table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> ActionProfile <span style="color: #24292f;background-color: #f6f8fa">{</span>
    ActionProfile<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> <span style="color: #cf222e">size</span><span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// constructor
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">table</span> tbl <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    implementation <span style="color: #0550ae">=</span> ActionProfile<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1024</span><span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// constructor invocation
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-extern-operations">8.22. Operations on <code>extern</code> objects</h3>
<div class="paragraph">
<p>The only operations that can be performed on <code>extern</code> objects are the
following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Instantiating an extern object using a constructor invocation, as described in
<a href="#sec-constructor">Section 8.21</a>.</p>
</li>
<li>
<p>Invoking a method of an extern object instance using a method call expression, as
described in <a href="#sec-invocations">Section 8.20</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controls, parsers, packages, and extern constructors can have
parameters of type <code>extern</code> only if they are directionless parameters.
Extern object instances can thus be used as arguments in the
construction of such objects.</p>
</div>
<div class="paragraph">
<p>No other operations are available on extern objects, e.g., equality
comparison is not defined.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-newtype-operations">8.23. Operations on types introduced by <code>type</code></h3>
<div class="paragraph">
<p>Values with a type introduced by the <code>type</code> keyword provide only a few operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>assignment to left-values of the same type</p>
</li>
<li>
<p>comparisons for equality and inequality if the original type supported such comparisons</p>
</li>
<li>
<p>casts to and from the original type</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">type</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> U32<span style="color: #24292f;background-color: #f6f8fa">;</span>
U32 x <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>U32<span style="color: #24292f;background-color: #f6f8fa">)</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// cast needed
</span>U32 y <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>U32<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">((</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)</span>x <span style="color: #0550ae">+</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// casts needed for arithmetic
</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> z <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bool</span> b0 <span style="color: #0550ae">=</span> x <span style="color: #0550ae">==</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>U32<span style="color: #24292f;background-color: #f6f8fa">)</span>z<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// cast needed
</span><span style="color: #953800">bool</span> b1 <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)</span>x <span style="color: #0550ae">==</span> z<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// cast needed
</span><span style="color: #953800">bool</span> b2 <span style="color: #0550ae">=</span> x <span style="color: #0550ae">==</span> y<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// no cast needed</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-type-variable-operations">8.24. Operations on types that are type variables</h3>
<div class="paragraph">
<p>Because functions, methods, control, and parsers can be generic,
they offer the possibility of declaring values with types that
are type variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> C<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        T x<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// the type of x is T, a type variable
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The type of such objects is not known until the control is
instantiated with specific type arguments.</p>
</div>
<div class="paragraph">
<p>Currently the only operations that are available for such values are
assignment (explicit through <code>=</code>, or implicit, through argument passing).
This behavior is similar to languages such as Java, and different from
languages such as C++.</p>
</div>
<div class="paragraph">
<p>A future version of P4 may introduce a notion of <em>type constraints</em>
which would enable more operations on such values.  Because of this
limitation, such values are currently of limited utility.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-uninitialized-values-and-writing-invalid-headers">8.25. Reading uninitialized values and writing fields of invalid headers</h3>
<div class="paragraph">
<p>As mentioned in Section <a href="#sec-expr-hs">Section 8.18</a>, any reference to an element of
a header stack <code>hs[index]</code> where <code>index</code> is a compile-time known value
must give an error at compile time if the value of the index is out of
range.  That section also defines the run time behavior of the
expressions <code>hs.next</code> and <code>hs.last</code>, and the behaviors specified there
take precedence over anything in this section for those expressions.</p>
</div>
<div class="paragraph">
<p>All mentions of header stack elements in this section only apply for
expressions <code>hs[index]</code> where <code>index</code> is not a compile-time known
value.  A P4 implementation may elect not to support expressions of
the form <code>hs[index]</code> where <code>index</code> is not a compile-time known
value. However, it does support such expressions, the implementation
should conform to the behaviors specified in this section.</p>
</div>
<div class="paragraph">
<p>The result of reading a value in any of the situations below is that
some unspecified value will be used for that field.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>reading a field from a header that is currently invalid.</p>
</li>
<li>
<p>reading a field from a header that is currently valid, but the field
has not been initialized since the header was last made valid.</p>
</li>
<li>
<p>reading any other value that has not been initialized, e.g. a field
from a <code>struct</code>, any uninitialized variable inside of an <code>action</code> or
<code>control</code>, or an <code>out</code> parameter of a <code>control</code> or <code>action</code> you have
called, which was not assigned a value during the execution of that
<code>control</code> or <code>action</code> (this list of examples is not intended to be exhaustive).</p>
</li>
<li>
<p>reading a field of a header that is an element of a header stack,
where the index is out of range for the header stack.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Calling the <code>isValid()</code> method on an element of a header stack, where
the index is out of range, returns an undefined boolean value, i.e.,
it is either <code>true</code> or <code>false</code>, but the specification does not require
one or the other, nor that a consistent value is returned across
multiple such calls.  Assigning an out-of-range header stack element
to another header variable <code>h</code> leads to a state where <code>h</code> is undefined
in all of its field values, and its validity is also undefined.</p>
</div>
<div class="paragraph">
<p>Where a header is mentioned, it may be a member of a <code>header_union</code>,
an element in a header stack, or a normal header.  This unspecified
value could differ from one such read to another.</p>
</div>
<div class="paragraph">
<p>For an uninitialized field or variable with a type of <code>enum</code> or
<code>error</code>, the unspecified value that is read might not be equal to any
of the values defined for that type.  Such an unspecified value should
still lead to predictable behavior in cases where any legal value
would match, e.g. it should match in any of these situations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If used in a <code>select</code> expression, it should match <code>default</code> or <code>_</code>
in a key set expression.</p>
</li>
<li>
<p>If used as a key with <code>match_kind</code> <code>ternary</code> in a table, it should
match a table entry where the field has all bit positions "don&#8217;t care".</p>
</li>
<li>
<p>If used as a key with <code>match_kind</code> <code>lpm</code> in a table, it should match
a table entry where the field has a prefix length of 0.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Consider a situation where a <code>header_union</code> <code>u1</code> has member headers
<code>u1.h1</code> and <code>u1.h2</code>, and at a given point in the program&#8217;s execution
<code>u1.h1</code> is valid and <code>u1.h2</code> is invalid.  If a write is attempted to a
field of the invalid member header <code>u1.h2</code>, then any or all of the
fields of the valid member header <code>u1.h1</code> may change as a result.
Such a write must not change the validity of any member headers of
<code>u1</code>, nor any other state that is currently defined in the system,
whether it is defined state in header fields or anywhere else.</p>
</div>
<div class="paragraph">
<p>If any of these kinds of writes are performed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a write to a field in a currently invalid header, either a regular
header or an element of a header stack with an index that is in
range, and that header is not part of a <code>header_union</code></p>
</li>
<li>
<p>a write to a field in an element of a header stack, where the index
is out of range</p>
</li>
<li>
<p>a method call of <code>setValid()</code> or <code>setInvalid()</code> on an element of a
header stack, where the index is out of range</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>then that write must not change any state that is currently defined in
the system, neither in header fields nor anywhere else.  In
particular, if an invalid header is involved in the write, it must
remain invalid.</p>
</div>
<div class="paragraph">
<p>Any writes to fields in a currently invalid header, or to header stack
elements where the index is out of range, are allowed to modify state
whose values are not defined, e.g. the values of fields in headers
that are currently invalid.</p>
</div>
<div class="paragraph">
<p>For a top level <code>parser</code> or <code>control</code> in an architecture, it is up to
that architecture to specify whether parameters with
direction <code>in</code> or <code>inout</code> are initialized when the control is called,
and under what conditions they are initialized, and if so, what their
values will be.</p>
</div>
<div class="paragraph">
<p>Since P4 allows empty tuples and structs, one can construct types
whose values carry no "useful" information, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> Empty <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #cf222e">tuple</span><span style="color: #0550ae">&lt;&gt;</span> t<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We call the following "empty" types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>bitstrings with 0 width</p>
</li>
<li>
<p>varbits with 0 width</p>
</li>
<li>
<p>empty tuples (<code>tuple&lt;&gt;</code>)</p>
</li>
<li>
<p>stacks with 0 size</p>
</li>
<li>
<p>structs with no fields</p>
</li>
<li>
<p>a tuple having all fields of an empty type</p>
</li>
<li>
<p>a struct having all fields of an empty type</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Values with empty types carry no useful information.  In particular,
they do not have to be explicitly initialized to have a legal value.</p>
</div>
<div class="paragraph">
<p>(Header types with no fields always have a validity bit.)</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-initializing-with-default-values">8.26. Initializing with default values</h3>
<div class="paragraph">
<p>A left-value can be initialized automatically with a default value of the
suitable type using the syntax <code>...</code> (see <a href="#sec-default-values">Section 7.3</a>).  A value
of type <code>struct</code>, <code>header</code>, or <code>tuple</code> can also be initialized using a mix of
explicit values and default values by using the notation <code>...</code> in a tuple
expression initializer; in this case all fields not explicitly
initialized are initialized with default values.  When initializing a <code>struct</code>,
<code>header</code>, and <code>tuple</code> with a value containing partially default values
using the <code>...</code> notation the three dots must appear last in the initializer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> S <span style="color: #24292f;background-color: #f6f8fa">{</span>
     <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> b32<span style="color: #24292f;background-color: #f6f8fa">;</span>
     <span style="color: #953800">bool</span> b<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">enum</span> <span style="color: #953800">int</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> N0 <span style="color: #24292f;background-color: #f6f8fa">{</span>
   one <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
   zero <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
   two <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">enum</span> N1 <span style="color: #24292f;background-color: #f6f8fa">{</span>
     A<span style="color: #24292f;background-color: #f6f8fa">,</span> B<span style="color: #24292f;background-color: #f6f8fa">,</span> C<span style="color: #24292f;background-color: #f6f8fa">,</span> F
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">struct</span> T <span style="color: #24292f;background-color: #f6f8fa">{</span>
    S s<span style="color: #24292f;background-color: #f6f8fa">;</span>
    N0 n0<span style="color: #24292f;background-color: #f6f8fa">;</span>
    N1 n1<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">header</span> H <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> f1<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> f2<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

N0 n0 <span style="color: #0550ae">=</span> <span style="color: #0550ae">...</span><span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// initialize n0 with the default value 0
</span>N1 n1 <span style="color: #0550ae">=</span> <span style="color: #0550ae">...</span><span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// initialize n1 with the default value N1.A
</span>S s0 <span style="color: #0550ae">=</span> <span style="color: #0550ae">...</span><span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// initialize s0 with the default value { 0, false }
</span>S s1 <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">...</span> <span style="color: #24292f;background-color: #f6f8fa">};</span>  <span style="color: #6e7781">// initialize s1 with the value { 1, false }
</span>S s2 <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> b <span style="color: #0550ae">=</span> true<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">...</span> <span style="color: #24292f;background-color: #f6f8fa">};</span> <span style="color: #6e7781">// initialize s2 with the value { 0, true }
</span>T t0 <span style="color: #0550ae">=</span> <span style="color: #0550ae">...</span><span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// initialize t0 with the value { { 0, false }, 0, N1.A }
</span>T t1 <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> s <span style="color: #0550ae">=</span> <span style="color: #0550ae">...</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">...</span> <span style="color: #24292f;background-color: #f6f8fa">};</span> <span style="color: #6e7781">// initialize t1 with the value { { 0, false }, 0, N1.A }
</span>T t2 <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> s <span style="color: #0550ae">=</span> <span style="color: #0550ae">...</span> <span style="color: #24292f;background-color: #f6f8fa">};</span> <span style="color: #6e7781">// error: no initializer specified for fields n0 and n1
</span><span style="color: #cf222e">tuple</span><span style="color: #0550ae">&lt;</span>N0<span style="color: #24292f;background-color: #f6f8fa">,</span> N1<span style="color: #0550ae">&gt;</span> p <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">...</span> <span style="color: #24292f;background-color: #f6f8fa">};</span> <span style="color: #6e7781">// initialize p with default value { 0, N1.A }
</span>T t3 <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">...</span><span style="color: #24292f;background-color: #f6f8fa">,</span> n0 <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">};</span> <span style="color: #6e7781">// error: ... must be last
</span>H h1 <span style="color: #0550ae">=</span> <span style="color: #0550ae">...</span><span style="color: #24292f;background-color: #f6f8fa">;</span>   <span style="color: #6e7781">// initialize h1 with a header that is invalid
</span>H h2 <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> f2<span style="color: #0550ae">=</span><span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">...</span> <span style="color: #24292f;background-color: #f6f8fa">};</span>   <span style="color: #6e7781">// initialize h2 with a header that is valid, field f1 0,
</span>                        <span style="color: #6e7781">// field f2 5
</span>H h3 <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">...</span> <span style="color: #24292f;background-color: #f6f8fa">};</span>  <span style="color: #6e7781">// initialize h3 with a header that is valid, field f1 0, field f2 0</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-minsizeinbits">9. Compile-time size determination</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The method calls <code>minSizeInBits</code>, <code>minSizeInBytes</code>, <code>maxSizeInBits</code>,
and <code>maxSizeInBytes</code> can be applied to certain expressions. These
method calls return the minimum (or maximum) size in bits (or bytes) required to
store the expression. Thus, the result type of these methods has type
<code>int</code>. Except in certain situations involving type variables,
discussed below, these method calls produce local compile-time known
values; otherwise they produce compile-time known values. None of
these methods evaluate the expression that is the receiver of the
method call, so it may be invalid (e.g., an out-of-bounds header stack
access).</p>
</div>
<div class="paragraph">
<p>The method <code>minSizeInBytes</code> returns the result of
<code>minSizeInBits</code> rounded up to the next whole number of bytes.
In other words, for any expression <code>e</code>,
<code>e.minSizeInBytes()</code> is equal to <code>(e.minSizeInBits() + 7) &gt;&gt; 3</code>.</p>
</div>
<div class="paragraph">
<p>The method <code>maxSizeInBytes</code> always returns the result of
<code>maxSizeInBits</code> rounded up to the next whole number of bytes.
In other words, for any expression <code>e</code>,
<code>e.maxSizeInBytes()</code> is equal to <code>(e.maxSizeInBits() + 7) &gt;&gt; 3</code>.</p>
</div>
<div class="paragraph">
<p>The definition of <code>e.minSizeInBits()</code> and <code>e.maxSizeInBits()</code> is given
recursively on the type of <code>e</code> as described in the following table:</p>
</div>
<table class="tableblock frame-all grid-all center" style="width: 90%;">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 41.6666%;">
<col style="width: 41.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-center valign-top">minSizeInBits</th>
<th class="tableblock halign-center valign-top">maxSizeInBits</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bit&lt;N&gt;</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int&lt;N&gt;</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bool</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enum bit&lt;N&gt;</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enum int&lt;N&gt;</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tuple</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">foreach field(tuple) sum of <code>field.minSizeInBits()</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">foreach field(tuple) sum of <code>field.maxSizeInBits()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varbit&lt;N&gt;</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>struct</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">foreach field(struct) sum of <code>field.minSizeInBits()</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">foreach field(struct) sum of <code>field.maxSizeInBits()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>header</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">foreach field(header) sum of <code>field.minSizeInBits()</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">foreach field(header) sum of <code>field.maxSizeInBits()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>H[N]</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>N * H.minSizeInBits()</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>N * H.maxSizeInBits()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>header_union</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">max(foreach field(header_union) <code>field.minSizeInBits()</code>)</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">max(foreach field(header_union) <code>field.maxSizeInBits()</code>)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The methods can also be applied to type name expressions <code>e</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if the type of <code>e</code> is a type introduced by <code>type</code>, the result
is the application of the method to the underlying type</p>
</li>
<li>
<p>if <code>e</code> is the name of a type (e.g., introduced by a <code>typedef</code> declaration),
where the type given a name is one of the above,
then the result is obtained by applying the method to the underlying type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These methods are defined for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>all serializable types</p>
</li>
<li>
<p>for a type that does not contain <code>varbit</code> fields, both methods return the same result</p>
</li>
<li>
<p>for a type that does contain <code>varbit</code> fields, <code>maxSizeInBits</code> is the worst-case size
of the serialized representation of the data and <code>minSizeInBits</code> is the "best" case.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Every other case is undefined and will produce a compile-time
error. In particular, cases involving type variables produce a
compile-time error.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-functions">10. Function declarations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Functions can only be declared at the top level and all parameters must have a direction.
P4 functions are modeled after functions as found in most other programming languages,
but the language does not permit recursive functions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">functionDeclaration
    : annotations functionPrototype blockStatement
    | functionPrototype blockStatement
    ;

functionPrototype
    : typeOrVoid name optTypeParameters "(" parameterList ")"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of a function that returns the maximum of two 32-bit values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> max<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> left<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> right<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>left <span style="color: #0550ae">&gt;</span> right<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #0550ae">?</span> left <span style="color: #24292f;background-color: #f6f8fa">:</span> right<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A function returns a value using the <code>return</code> statement.  A function
with a return type of <code>void</code> can simply use the <code>return</code> statement with no
arguments.  A function with a non-void return type must return a value
of the suitable type on all possible execution paths.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-consts-and-vars">11. Constants and variable declarations</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="sec-constants">11.1. Constants</h3>
<div class="paragraph">
<p>Constant values are defined with the syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">constantDeclaration
    : optAnnotations CONST typeRef name "=" initializer ";"
    ;

initializer
    : expression
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Such a declaration introduces a constant whose value has the specified type. The
following are all legal constant declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">const</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> COUNTER <span style="color: #0550ae">=</span> <span style="color: #0550ae">32w0x0</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">struct</span> Version <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> major<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> minor<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">const</span> Version version <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">32w0</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">32w0</span> <span style="color: #24292f;background-color: #f6f8fa">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>initializer</code> expression must be a local compile-time known value.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-variables">11.2. Variables</h3>
<div class="paragraph">
<p>Local variables are declared with a type, a name, and an optional
initializer (as well as an optional annotation):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">variableDeclaration
    : annotations typeRef name optInitializer ";"
    | typeRef name optInitializer ";"
    ;

optInitializer
    : /* empty */
    | "=" initializer
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Variable declarations without an initializer are uninitialized (except for
headers and other header-related types, which are initialized to invalid in the
same way as described for direction <code>out</code> parameters in <a href="#sec-calling-convention">Section 6.8</a>). The language places few restrictions on
the types of the variables: most P4 types that can be written
explicitly can be used (e.g., base types, <code>struct</code>, <code>header</code>,
header stack, <code>tuple</code>). However, it is impossible to declare variables with type <code>int</code>,
or with types that are only synthesized by the compiler (e.g., <code>set</code>)
In addition, variables of type  <code>parser</code>, <code>control</code>, <code>package</code>,
or <code>extern</code> types must be declared using instantiations (see <a href="#sec-instantiations">Section 11.3</a>).</p>
</div>
<div class="paragraph">
<p>Reading the value of a variable that has not been initialized yields
an undefined result. The compiler should attempt to detect and emit a warning in such situations.</p>
</div>
<div class="paragraph">
<p>Variables declarations can appear in the following locations within a P4
program:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In a block statement,</p>
</li>
<li>
<p>In a <code>parser</code> state,</p>
</li>
<li>
<p>In an <code>action</code> body,</p>
</li>
<li>
<p>In a <code>control</code> block&#8217;s <code>apply</code> sub-block,</p>
</li>
<li>
<p>In the list of local declarations in a <code>parser</code>, and</p>
</li>
<li>
<p>In the list of local declarations in a <code>control</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Variables have local scope, and behave like stack-allocated variables
in languages such as C. The value of a variable is never preserved
from one invocation of its enclosing block to the next. In particular,
variables cannot be used to maintain state between different network packets.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-instantiations">11.3. Instantiations</h3>
<div class="paragraph">
<p>Instantiations are similar to variable declarations,
but are reserved for the types with constructors
(<code>extern</code> objects, <code>control</code> blocks, <code>parser</code>s, and <code>package</code>s):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">instantiation
    : typeRef '(' argumentList ')' name ';'
    | annotations typeRef '(' argumentList ')' name ';'
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An instantiation is written as a constructor invocation followed by a name.
Instantiations are always executed at compilation time (Section <a href="#sec-compile-time-known">Section 18.1</a>).
The effect is to allocate an object with the specified name,
and to bind it to the result of the constructor invocation.
Note that instantiation arguments can be specified by name.</p>
</div>
<div class="paragraph">
<p>For example, a hypothetical bank of counter
objects can be instantiated as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// from target library
</span><span style="color: #cf222e">enum</span> CounterType <span style="color: #24292f;background-color: #f6f8fa">{</span>
   Packets<span style="color: #24292f;background-color: #f6f8fa">,</span>
   Bytes<span style="color: #24292f;background-color: #f6f8fa">,</span>
   Both
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">extern</span> Counter <span style="color: #24292f;background-color: #f6f8fa">{</span>
    Counter<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> <span style="color: #cf222e">size</span><span style="color: #24292f;background-color: #f6f8fa">,</span> CounterType <span style="color: #cf222e">type</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #953800">void</span> increment<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> index<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #6e7781">// user program
</span><span style="color: #cf222e">control</span> c<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    Counter<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">32w1024</span><span style="color: #24292f;background-color: #f6f8fa">,</span> CounterType<span style="color: #0550ae">.</span>Both<span style="color: #24292f;background-color: #f6f8fa">)</span> ctr<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// instantiation
</span>    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="sec-instantiating-abstract-methods">11.3.1. Instantiating objects with abstract methods</h4>
<div class="paragraph">
<p>When instantiating an extern type that has <code>abstract</code> methods users
have to supply implementations for all such methods.  This is done using object initializers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">lvalue:
    ...
    | THIS

expression:
    ...
    | THIS

instantiation:
      ...
      | annotations typeRef "(" argumentList ")" name "=" objInitializer ";"
      | typeRef "(" argumentList ")" name "=" objInitializer ";"

objInitializer
    : "{" objDeclarations "}"
    ;

objDeclarations
    : /* empty */
    | objDeclarations objDeclaration
    ;

objDeclaration
    : functionDeclaration
    | instantiation
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The abstract methods can only use the supplied arguments or refer to
values that are in the top-level scope.  When calling another method
of the same instance the <code>this</code> keyword is used to indicate the
current object instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// Instantiate a balancer
</span>Balancer<span style="color: #24292f;background-color: #f6f8fa">()</span> b <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>  <span style="color: #6e7781">// provide an implementation for the abstract methods
</span>    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span> on_new_flow<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> address<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #6e7781">// uses the address and the number of flows to balance the load
</span>        <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> count <span style="color: #0550ae">=</span> <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>getFlowCount<span style="color: #24292f;background-color: #f6f8fa">();</span>  <span style="color: #6e7781">// call method of the same instance
</span>        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>address <span style="color: #0550ae">+</span> count<span style="color: #24292f;background-color: #f6f8fa">)[</span><span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">];</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Abstract methods may be invoked by users explicitly, or they may be
invoked by the target architecture.  The architectural description has
to specify when the abstract methods are invoked and what the meaning
of their arguments and return values is; target architectures may
impose additional constraints on abstract methods.</p>
</div>
</div>
<div class="sect3">
<h4 id="_restrictions_on_top_level_instantiations">11.3.2. Restrictions on top-level instantiations</h4>
<div class="paragraph">
<p>A P4 program may not instantiate controls and parsers in the top-level package.
This restriction is designed to ensure that most state resides in
the architecture itself, or is local to a <code>parser</code> or <code>control</code>.
For example, the following program is not valid:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// Program
</span><span style="color: #cf222e">control</span> c<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
c<span style="color: #24292f;background-color: #f6f8fa">()</span> c1<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// illegal top-level instantiation</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>because control <code>c1</code> is instantiated at the top-level. Note that top-level declarations of
constants and instantiations of extern objects are permitted.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-stmts">12. Statements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Every statement in P4 except block statements must end with a semicolon.
Statements can appear in several places:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Within <code>parser</code> states</p>
</li>
<li>
<p>Within a <code>control</code> block</p>
</li>
<li>
<p>Within an <code>action</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are restrictions for the kinds of statements that can appear in
each of these places. For example, <code>return</code>s are not supported in
parsers, and <code>switch</code> statements are only supported in control
blocks. We present here the most general case, for control blocks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">statement
    : assignmentOrMethodCallStatement
    | conditionalStatement
    | emptyStatement
    | blockStatement
    | exitStatement
    | returnStatement
    | switchStatement
    | loopStatement
    ;

assignmentOrMethodCallStatement
    : lvalue "(" argumentList ")" ";"
    | lvalue "&lt;" typeArgumentList "&gt;" "(" argumentList ")" ";"
    | lvalue "="  expression ";"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition, parsers support a <code>transition</code> statement (<a href="#sec-transition">Section 13.5</a>).</p>
</div>
<div class="sect2">
<h3 id="sec-assignment">12.1. Assignment statement</h3>
<div class="paragraph">
<p>An assignment, written with the <code>=</code> sign, first evaluates its left
sub-expression to an l-value, then evaluates its right sub-expression
to a value, and finally copies the value into the l-value. Derived
types (e.g. <code>struct</code>s) are copied recursively, and all components
of <code>header</code>s are copied, including "validity" bits. Assignment is
not defined for <code>extern</code> values.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-empty-stmt">12.2. Empty statement</h3>
<div class="paragraph">
<p>The empty statement, written <code>;</code> is a no-op.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">emptyStatement
    : ";"
    ;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-block-stmt">12.3. Block statement</h3>
<div class="paragraph">
<p>A block statement is denoted by curly braces. It contains a sequence
of statements and declarations, which are executed sequentially. The
declarations (e.g., variables and constants) within a block statement
are only visible within the block.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">blockStatement
    : optAnnotations "{" statOrDeclList "}"
    ;

statOrDeclList
    : /* empty */
    | statOrDeclList statementOrDeclaration
    ;

statementOrDeclaration
    : variableDeclaration
    | constantDeclaration
    | statement
    ;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-return-stmt">12.4. Return statement</h3>
<div class="paragraph">
<p>The <code>return</code> statement immediately terminates the execution of the
<code>action</code>, <code>function</code> or <code>control</code> containing it. <code>return</code> statements
are not allowed within parsers.  <code>return</code> statements followed by an
expression are only allowed within functions that return values; in
this case the type of the expression must match the return type of the
function.  Any copy-out behavior due to direction <code>out</code> or <code>inout</code>
parameters of the enclosing <code>action</code>, <code>function</code>, or <code>control</code> are
still performed after the execution of the <code>return</code> statement.  See
<a href="#sec-calling-convention">Section 6.8</a> for details on copy-out behavior.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">returnStatement
    : RETURN ";"
    | RETURN expression ";"
    ;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-exit-stmt">12.5. Exit statement</h3>
<div class="paragraph">
<p>The <code>exit</code> statement immediately terminates the execution of all
the blocks currently executing: the current <code>action</code> (if invoked
within an <code>action</code>), the current <code>control</code>, and all its
callers. <code>exit</code> statements are not allowed within parsers or
functions.</p>
</div>
<div class="paragraph">
<p>Any copy-out behavior due to direction <code>out</code> or <code>inout</code> parameters of
the enclosing <code>action</code> or <code>control</code>, and all of its callers, are still
performed after the execution of the <code>exit</code> statement.  See <a href="#sec-calling-convention">Section 6.8</a> for details on copy-out behavior.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">exitStatement
    : EXIT ";"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are some expressions whose evaluation might cause an <code>exit</code>
statement to be executed.  Examples include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>table.apply().action_run</code>, which can only appear as the expression
of a <code>switch</code> statement (see <a href="#sec-switch-stmt">Section 12.7</a>), and when
it appears there, it must be the entire expression.</p>
</li>
<li>
<p>Any expression containing <code>table.apply().hit</code> or
<code>table.apply().miss</code> (see <a href="#sec-invoke-mau">Section 14.2.2</a>), which can be
part of arbitrarily complex expressions in many places of a P4
program, such as:</p>
<div class="ulist">
<ul>
<li>
<p>the expression in an <code>if</code> statement.</p>
</li>
<li>
<p>the expression <code>e1</code> in a conditional expression <code>e1 ? e2 : e3</code>.</p>
</li>
<li>
<p>in an assignment statement, in the left and/or right hand sides.</p>
</li>
<li>
<p>an argument passed to a function or method call.</p>
</li>
<li>
<p>an expression to calculate a table key (see <a href="#sec-mau-semantics">Section 14.2.3</a>).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This list is not intended to be exhaustive.</p>
</div>
<div class="paragraph">
<p>If applying the table causes an action to be executed, which in turn
causes an <code>exit</code> statement to be executed, then evaluation of the
expression ends immediately, and the rest of the current expression or
statement does not complete its execution.  See <a href="#sec-expr-eval-order">Section 8.1</a> for the order of evaluation of the parts of an
expression.  For the examples listed above, it also means the
following behavior after the expression evaluation is interrupted.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For a <code>switch</code> statement, if <code>table.apply()</code> exits, then none of the
blocks in the <code>switch</code> statement are executed.</p>
</li>
<li>
<p>If <code>table.apply().hit</code> or <code>table.apply().miss</code> cause an exit during
the evaluation of an expression:</p>
<div class="ulist">
<ul>
<li>
<p>If it is the expression of an <code>if</code> statement, then neither the
'then' nor 'else' branches of the <code>if</code> statement are executed.</p>
</li>
<li>
<p>If it is the expression <code>e1</code> in a conditional expression <code>e1 ? e2 : e3</code>,
then neither expression <code>e2</code> nor <code>e3</code> are evaluated.</p>
</li>
<li>
<p>If the expression is the right hand side of an assignment
statement, or part of the calculation of the L-value on the left
hand side (e.g. the index expression of a header stack reference),
then no assignment occurs.</p>
</li>
<li>
<p>If the expression is an argument passed to a function or method
call, then the function/method call does not occur.</p>
</li>
<li>
<p>If the expression is a table key, then the table is not applied.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sec-cond-stmt">12.6. Conditional statement</h3>
<div class="paragraph">
<p>The conditional statement uses standard syntax and semantics familiar from many programming languages.</p>
</div>
<div class="paragraph">
<p>However, the condition expression in P4 is required to be a Boolean
(and not an integer).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">conditionalStatement
    : IF "(" expression ")" statement
    | IF "(" expression ")" statement ELSE statement
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When several <code>if</code> statements are nested, the <code>else</code> applies to the
innermost <code>if</code> statement that does not have an <code>else</code> statement.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-switch-stmt">12.7. Switch statement</h3>
<div class="paragraph">
<p>The <code>switch</code> statement can only be used within <code>control</code> blocks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">switchStatement
    : SWITCH "(" expression ")" "{" switchCases "}"
    ;

switchCases
    : /* empty */
    | switchCases switchCase
    ;

switchCase
    : switchLabel ":" blockStatement
    | switchLabel ":"  // fall-through
    ;

switchLabel
    : DEFAULT
    | nonBraceExpression
    ;

nonBraceExpression
    : INTEGER
    | STRING_LITERAL
    | TRUE
    | FALSE
    | THIS
    | prefixedNonTypeName
    | nonBraceExpression "[" expression "]"
    | nonBraceExpression "[" expression ":" expression "]"
    | "(" expression ")"
    | "!" expression %prec PREFIX
    | "~" expression %prec PREFIX
    | "-" expression %prec PREFIX
    | "+" expression %prec PREFIX
    | typeName "." member
    | ERROR "." member
    | nonBraceExpression "." member
    | nonBraceExpression "*" expression
    | nonBraceExpression "/" expression
    | nonBraceExpression "%" expression
    | nonBraceExpression "+" expression
    | nonBraceExpression "-" expression
    | nonBraceExpression "|+|" expression
    | nonBraceExpression "|-|" expression
    | nonBraceExpression "&lt;&lt;" expression
    | nonBraceExpression "&gt;&gt;" expression
    | nonBraceExpression "&lt;=" expression
    | nonBraceExpression "&gt;=" expression
    | nonBraceExpression "&lt;" expression
    | nonBraceExpression "&gt;" expression
    | nonBraceExpression "!=" expression
    | nonBraceExpression "==" expression
    | nonBraceExpression "&amp;" expression
    | nonBraceExpression "^" expression
    | nonBraceExpression "|" expression
    | nonBraceExpression "++" expression
    | nonBraceExpression "&amp;&amp;" expression
    | nonBraceExpression "||" expression
    | nonBraceExpression "?" expression ":" expression
    | nonBraceExpression "&lt;" realTypeArgumentList "&gt;" "(" argumentList ")"
    | nonBraceExpression "(" argumentList ")"
    | namedType "(" argumentList ")"
    | "(" typeRef ")" expression
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>nonBraceExpression</code> is the same as <code>expression</code> as defined in
<a href="#sec-exprs">Chapter 8</a>, except it does not include any cases that can
begin with a left brace <code>{</code> character, to avoid syntactic ambiguity
with a block statement.</p>
</div>
<div class="paragraph">
<p>There are two kinds of <code>switch</code> expressions allowed, described
separately in the following two subsections.</p>
</div>
<div class="sect3">
<h4 id="_switch_statement_with_action_run_expression">12.7.1. Switch statement with <code>action_run</code> expression</h4>
<div class="paragraph">
<p>For this variant of <code>switch</code> statement, the expression must be of the
form <code>t.apply().action_run</code>, where <code>t</code> is the name of a table (see
<a href="#sec-invoke-mau">Section 14.2.2</a>).  All switch labels must be names of
actions of the table <code>t</code>, or <code>default</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">switch</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>t<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">()</span><span style="color: #0550ae">.</span>action_run<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   action1<span style="color: #24292f;background-color: #f6f8fa">:</span>          <span style="color: #6e7781">// fall-through to action2:
</span>   action2<span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
   action3<span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>  <span style="color: #6e7781">// no fall-through from action2 to action3 labels
</span>   <span style="color: #cf222e">default</span><span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>default</code> label of the <code>switch</code> statement is used to
match on the kind of action executed, no matter whether there was a
table hit or miss. The <code>default</code> label does not indicate that the
table missed and the <code>default_action</code> was executed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_switch_statement_with_integer_or_enumerated_type_expression">12.7.2. Switch statement with integer or enumerated type expression</h4>
<div class="paragraph">
<p>For this variant of <code>switch</code> statement, the expression must evaluate
to a result with one of these types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bit&lt;W&gt;</code></p>
</li>
<li>
<p><code>int&lt;W&gt;</code></p>
</li>
<li>
<p><code>enum</code>, either with or without an underlying representation specified</p>
</li>
<li>
<p><code>error</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All switch labels must be expressions with compile-time known values,
and must have a type that can be implicitly cast to the type of the
<code>switch</code> expression (see <a href="#sec-implicit-casts">Section 8.11.2</a>).  Switch
labels must not begin with a left brace character <code>{</code>, to avoid
ambiguity with a block statement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// Assume the expression hdr.ethernet.etherType has type bit&lt;16&gt;.
</span><span style="color: #cf222e">switch</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>etherType<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #0550ae">0x86dd</span><span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
   <span style="color: #0550ae">0x0800</span><span style="color: #24292f;background-color: #f6f8fa">:</span>          <span style="color: #6e7781">// fall-through to the next body
</span>   <span style="color: #0550ae">0x0802</span><span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
   <span style="color: #0550ae">0xcafe</span><span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
   <span style="color: #cf222e">default</span><span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notes_common_to_all_switch_statements">12.7.3. Notes common to all switch statements</h4>
<div class="paragraph">
<p>It is a compile-time error if two labels of a <code>switch</code> statement equal
each other.  The switch label values need not include all possible
values of the switch expression.  It is optional to have a <code>switch</code>
case with the <code>default</code> label, but if one is present, it must be the
last one in the <code>switch</code> statement.</p>
</div>
<div class="paragraph">
<p>If a switch label is not followed by a block statement, it falls
through to the next label. However, if a block statement is present,
it does not fall through. Note that this is different from C-style
<code>switch</code> statements, where a <code>break</code> is needed to prevent
fall-through.  If the last switch label is not followed by a block
statement, the behavior is the same as if the last switch label were
followed by an empty block statement <code>{ }</code>.</p>
</div>
<div class="paragraph">
<p>When a <code>switch</code> statement is executed, first the switch expression is
evaluated, and any side effects from evaluating this expression are
visible to any <code>switch</code> case that is executed.  Among switch labels
that are not <code>default</code>, at most one of them can equal the value of the
switch expression. If one is equal, that switch case is executed.</p>
</div>
<div class="paragraph">
<p>If no labels are equal to the <code>switch</code> expression, then:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if there is a <code>default</code> label, the case with the <code>default</code> label is
executed.</p>
</li>
<li>
<p>if there is no <code>default</code> label, then no switch case is executed, and
execution continues after the end of the <code>switch</code> statement, with no
side effects (except any that were caused by evaluating the <code>switch</code>
expression).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See "Implementing generalized P4_16 switch statements"
for possible techniques that one might
use to implement generalized switch statements.<sup class="footnote" id="_footnote_GeneralizedSwitchStatements">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-loop-stmt">12.8. Loop statement</h3>
<div class="paragraph">
<p>A <code>loop</code> statement executes a statement zero or more times, based on a
condition or a range or collection.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">loopStatement
    : optAnnotations FOR "(" optForInitStatements ";" expression ";"
      optForUpdateStatements ")" statement
    | optAnnotations FOR "(" typeRef name IN forCollectionExpr ")" statement
    ;

forInitStatement
    : optAnnotations typeRef name optInitializer
    | lvalue "(" argumentList ")"
    | lvalue "&lt;" typeArgumentList "&gt;" "(" argumentList ")"
    | lvalue "=" expression
    ;

forUpdateStatement
    : lvalue "(" argumentList ")"
    | lvalue "&lt;" typeArgumentList "&gt;" "(" argumentList ")"
    | lvalue "=" expression
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The basic 3-clause <code>for</code> statement is similar to a C for statement.  The init statements
will be executed prior to executing the loop.  The condition will be evaluated before
each iteration, to determine if the loop should exit.  If the condition is false, the loop
will exit without executing any statements from the loop body or update.
The update statements will be executed after the loop body and before evaluating the
condition again for the next iteration.</p>
</div>
<div class="paragraph">
<p>The <code>for</code>-<code>in</code> statement executes the body once for each value in a range or each
element in a list expression or header stack.  The list or range expression itself
will only be evaluated once, before the first iteration of the loop.  All side effects
in the list or range expression will occur before the first iteration of the loop body.</p>
</div>
<div class="paragraph">
<p>A <code>break;</code> statement may be executed in a loop body to immediately exit the loop,
without executing the rest of the body or the update statements.</p>
</div>
<div class="paragraph">
<p>A <code>continue;</code> statement may be executed in a loop body to skip the rest of the current
loop body, executing the update statements and then evaluating the condition to
either execute the loop body again, or terminate the loop.</p>
</div>
<div class="paragraph">
<p>The scope of any declaration in a for statement is limited to the for statement and its body.</p>
</div>
<div class="paragraph">
<p>&gt;&gt;&gt;&gt;&gt;&gt;&gt; upstream/main:p4-16/spec/P4-16-spec.mdk</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-packet-parsing">13. Packet parsing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes the P4 constructs specific to parsing network packets.</p>
</div>
<div class="sect2">
<h3 id="sec-parser-states">13.1. Parser states</h3>
<div id="fig-parserstatemachine" class="imageblock text-center">
<div class="content">
<img src="resources/figs/parserstatemachine.png" alt="parserstatemachine" width="150">
</div>
<div class="title">Figure 8. Parser FSM structure.</div>
</div>
<div class="paragraph">
<p>A P4 parser describes a state machine with one start state and two
final states. The start state is always named <code>start</code>.  The two
final states are named <code>accept</code> (indicating successful parsing)
and <code>reject</code> (indicating a parsing failure). The <code>start</code> state
is part of the parser, while the <code>accept</code> and <code>reject</code> states
are distinct from the states provided by the programmer and are logically outside of the parser.  <a href="#fig-parserstatemachine">Figure 8</a>
illustrates the general structure of a parser state machine.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-parser-decl">13.2. Parser declarations</h3>
<div class="paragraph">
<p>A parser declaration comprises a name, a list of parameters, an
optional list of constructor parameters, local elements, and parser
states (as well as optional annotations).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">parserTypeDeclaration
    : optAnnotations PARSER name optTypeParameters
      "(" parameterList ")"
    ;

parserDeclaration
    : parserTypeDeclaration optConstructorParameters
      "{" parserLocalElements parserStates "}"
    ;

parserLocalElements
    : /* empty */
    | parserLocalElements parserLocalElement
    ;

parserStates
    : parserState
    | parserStates parserState
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a description of <code>optConstructorParameters</code>, which are useful for
building parameterized parsers, see <a href="#sec-parameterization">Chapter 15</a>.</p>
</div>
<div class="paragraph">
<p>Unlike parser type declarations, parser declarations may not be
generic---e.g., the following declaration is illegal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">parser</span> P<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> H data<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hence, used in the context of a <code>parserDeclaration</code> the production
rule <code>parserTypeDeclaration</code> should not yield type parameters.</p>
</div>
<div class="paragraph">
<p>At least one state, named <code>start</code>, must be present in any <code>parser</code>.
A parser may not define two states with the same name.
It is also illegal for a parser to give explicit definitions for
the <code>accept</code> and <code>reject</code> states---those
states are logically distinct from the states defined by the programmer.</p>
</div>
<div class="paragraph">
<p>State declarations are described below. Preceding the parser states, a <code>parser</code>
may also contain a list of local elements. These can be constants,
variables, or instantiations of objects that may be used within the
parser. Such objects may be instantiations of <code>extern</code> objects, or
other <code>parser</code>s that may be invoked as subroutines. However, it is illegal to
instantiate a <code>control</code> block within a <code>parser</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">parserLocalElement
    : constantDeclaration
    | instantiation
    | variableDeclaration
    | valueSetDeclaration
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The states and local elements are all in the same namespace, thus the
following example will produce an error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// erroneous example
</span><span style="color: #cf222e">parser</span> p<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span> t<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">state</span> start <span style="color: #24292f;background-color: #f6f8fa">{</span>
       t <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
       <span style="color: #cf222e">transition</span> t<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">state</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>  <span style="color: #6e7781">// error: name t is duplicated
</span>       <span style="color: #cf222e">transition</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For an example containing a complete declaration of a parser see
<a href="#sec-vss-all">Section 5.3</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-parser-abstract-machine">13.3. The Parser abstract machine</h3>
<div class="paragraph">
<p>The semantics of a P4 parser can be formulated in terms of an abstract
machine that manipulates a <code>ParserModel</code> data structure. This section describes
this abstract machine in pseudo-code.</p>
</div>
<div class="paragraph">
<p>A parser starts execution in the <code>start</code> state and ends execution
when one of the <code>reject</code> or <code>accept</code> states has been reached.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">ParserModel {
    error       parseError;
    onPacketArrival(packet p) {
        ParserModel.parseError = error.NoError;
        goto start;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An architecture must specify the behavior when the <code>accept</code>
and <code>reject</code> states are reached. For example, an architecture may
specify that all packets reaching the <code>reject</code> state are dropped
without further processing. Alternatively, it may specify that
such packets are passed to the next block after the
parser, with intrinsic metadata indicating that the parser reached
the <code>reject</code> state, along with the error recorded.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-parser-state-stmt">13.4. Parser states</h3>
<div class="paragraph">
<p>A parser state is declared with the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">parserState
    : optAnnotations STATE name
      "{" parserStatements transitionStatement "}"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each state has a name and a body. The body consists of a sequence of
statements that describe the processing performed when the parser
transitions to that state, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Local variable declarations,</p>
</li>
<li>
<p>Assignment statements,</p>
</li>
<li>
<p>Method calls, which serve several purposes:</p>
<div class="ulist">
<ul>
<li>
<p>Invoking functions (e.g., using <code>verify</code> to check the validity of data already parsed), and</p>
</li>
<li>
<p>Invoking methods (e.g., extracting data out of packets or computing checksums) and other parsers (see <a href="#sec-invoke-subparser">Section 13.10</a>), and</p>
</li>
</ul>
</div>
</li>
<li>
<p>Conditional statements,</p>
</li>
<li>
<p>Transitions to other states (discussed in <a href="#sec-transition">Section 13.5</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The syntax for parser statements is given by the following grammar rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">parserStatements
    : /* empty */
    | parserStatements parserStatement
    ;

parserStatement
    : assignmentOrMethodCallStatement
    | directApplication
    | emptyStatement
    | variableDeclaration
    | constantDeclaration
    | parserBlockStatement
    | conditionalStatement
    ;

parserBlockStatement
    : optAnnotations "{" parserStatements "}"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Architectures may place restrictions on the expressions and statements
that can be used in a parser---e.g., they may forbid the use of
operations such as multiplication or place restrictions on the number
of local variables that may be used.</p>
</div>
<div class="paragraph">
<p>In terms of the <code>ParserModel</code>, the sequence of statements in a state
are executed sequentially.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-transition">13.5. Transition statements</h3>
<div class="paragraph">
<p>The last statement in a parser state is an optional <code>transition</code>
statement, which transfers control to another state, possibly <code>accept</code>
or <code>reject</code>. A <code>transition</code> statements is written using the
following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">transitionStatement
    : /* empty */
    | TRANSITION stateExpression
    ;

stateExpression
    : name ";"
    | selectExpression
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The execution of the transition statement causes <code>stateExpression</code>
to be evaluated, and transfers control to the resulting state.</p>
</div>
<div class="paragraph">
<p>In terms of the <code>ParserModel</code>, the semantics of a <code>transition</code>
statement can be formalized as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">goto eval<span style="color: #24292f;background-color: #f6f8fa">(</span>stateExpression<span style="color: #24292f;background-color: #f6f8fa">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, this statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">transition</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>terminates execution of the current parser and transitions immediately to
the <code>accept</code> state.</p>
</div>
<div class="paragraph">
<p>If the body of a state block does not end with a <code>transition</code>
statement, the implied statement is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">transition</span> reject<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-select">13.6. Select expressions</h3>
<div class="paragraph">
<p>A <code>select</code> expression evaluates to a state. The syntax for a <code>select</code>
expression is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">selectExpression
    : SELECT "(" expressionList ")" "{" selectCaseList "}"
    ;

selectCaseList
    : /* empty */
    | selectCaseList selectCase
    ;

selectCase
    : keysetExpression ":" name ";"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each expression in the <code>expressionList</code> must have a type of <code>bit&lt;W&gt;</code>,
<code>int&lt;W&gt;</code>, <code>bool</code>, <code>enum</code>, serializable <code>enum</code>, or a <code>tuple</code> type with
fields of one of the above types.</p>
</div>
<div class="paragraph">
<p>In a <code>select</code> expression, if the <code>expressionList</code> has type <code>tuple&lt;T&gt;</code>,
then each <code>keysetExpression</code> must have type <code>set&lt;tuple&lt;T&gt;&gt;</code>.  In
particular, if a set is specified as a range or mask expression, the
endpoints of the range and mask expression are implicitly cast to type
<code>T</code> using the standard rules for casts.</p>
</div>
<div class="paragraph">
<p>In terms of the <code>ParserModel</code>, the meaning of a select expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>e<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    ks<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">]:</span> s<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">];</span>
    ks<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">]:</span> s<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">];</span>
    <span style="color: #6e7781">/* more labels omitted */</span>
    ks<span style="color: #24292f;background-color: #f6f8fa">[</span>n<span style="color: #0550ae">-</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">]:</span> s<span style="color: #24292f;background-color: #f6f8fa">[</span>n<span style="color: #0550ae">-</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">];</span>
    <span style="color: #0550ae">_</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> sd<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// ks[n-1] is default
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>is defined in pseudo-code as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">key = eval(e);
for (int i=0; i &lt; n; i++) {
    keyset = eval(ks[i]);
    if (keyset.contains(key)) return s[i];
}
verify(false, error.NoMatch);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some targets may require that all keyset expressions in a select
expression be compile-time known values. Keysets are evaluated in
order, from top to bottom as implied by the pseudo-code above; the
first keyset that includes the value in the <code>select</code> argument
provides the result state. If no label matches, the execution triggers
a runtime error with the standard error code <code>error.NoMatch</code>.</p>
</div>
<div class="paragraph">
<p>Note that this implies that all cases after a <code>default</code> or <code>_</code>
label are unreachable; the compiler should emit a warning if it detects unreachable cases.
This constitutes an important difference between <code>select</code>
expressions and the <code>switch</code> statements found in many programming languages since the keysets of
a <code>select</code> expression may "overlap".</p>
</div>
<div class="paragraph">
<p>The typical way to use a <code>select</code> expression is to compare the value
of a recently-extracted header field against a set of values, as in
the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> <span style="color: #953800">IPv4_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> protocol<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">/* more fields omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">struct</span> P <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #953800">IPv4_h</span> ipv4<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">/* more fields omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
P headers<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">select</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>headers<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>protocol<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #0550ae">8w6</span>  <span style="color: #24292f;background-color: #f6f8fa">:</span> parse_tcp<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #0550ae">8w17</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> parse_udp<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #0550ae">_</span>    <span style="color: #24292f;background-color: #f6f8fa">:</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, to detect TCP reserved ports (&lt; 1024) one could write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">select</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>tcp<span style="color: #0550ae">.</span>port<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #0550ae">16w0</span> <span style="color: #0550ae">&amp;&amp;&amp;</span> <span style="color: #0550ae">16w0xFC00</span><span style="color: #24292f;background-color: #f6f8fa">:</span> well_known_port<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #0550ae">_</span><span style="color: #24292f;background-color: #f6f8fa">:</span> other_port<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The expression <code>16w0 &amp;&amp;&amp; 16w0xFC00</code> describes the set of 16-bit
values whose most significant six bits are zero.</p>
</div>
<div class="paragraph">
<p>Some targets may support parser value sets; see <a href="#sec-value-set">Section 13.11</a>. Given
a type <code>T</code> for the type parameter of the value set, the type of the value set
is <code>set&lt;T&gt;</code>. The type of the value set must match to the type of all other
<code>keysetExpression</code>s in the same <code>select</code> expression. If there is a mismatch, the
compiler must raise an error. The type of the values in the set must be either
bit&lt;&gt;, int&lt;&gt;, tuple, struct, or serializable <code>enum</code>.</p>
</div>
<div class="paragraph">
<p>For example, to allow the control plane API to specify TCP reserved ports at
runtime, one could write:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> <span style="color: #953800">vsk_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #0550ae">@match</span><span style="color: #24292f;background-color: #f6f8fa">(</span>ternary<span style="color: #24292f;background-color: #f6f8fa">)</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> port<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">value_set</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">vsk_t</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">4</span><span style="color: #24292f;background-color: #f6f8fa">)</span> pvs<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">select</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>tcp<span style="color: #0550ae">.</span>port<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    pvs<span style="color: #24292f;background-color: #f6f8fa">:</span> runtime_defined_port<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #0550ae">_</span><span style="color: #24292f;background-color: #f6f8fa">:</span> other_port<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example allows the runtime API to populate up to 4 different
<code>keysetExpression</code>s in the <code>value_set</code>. If the <code>value_set</code> takes a struct
as type parameter, the runtime API can use the struct field names to
name the objects in the value set. The match type of the struct field is
specified with the <code>@match</code> annotation. If the <code>@match</code> annotation is not
specified on a struct field, by default it is assumed to be <code>@match(exact)</code>.
A single non-exact field must be placed into a struct by itself, with the
desired <code>@match</code> annotation.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-verify">13.7. verify</h3>
<div class="paragraph">
<p>The <code>verify</code> statement provides a simple form of error
handling. <code>verify</code> can only be invoked within a parser; it is used
syntactically as if it were a function with the following signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> <span style="color: #953800">void</span> <span style="color: #953800">verify</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bool</span> condition<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> <span style="color: #953800">error</span> err<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the first argument is <code>true</code>, then executing the statement
has no side-effect. However, if the first argument is <code>false</code>, it causes
an immediate transition to <code>reject</code>, which causes
immediate parsing termination; at the same time, the <code>parserError</code>
associated with the parser is set to the value of the second argument.</p>
</div>
<div class="paragraph">
<p>In terms of the <code>ParserModel</code> the semantics of a <code>verify</code>
statement is given by:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">ParserModel.verify(bool condition, error err) {
    if (condition == false) {
        ParserModel.parserError = err;
        goto reject;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-packet-data-extraction">13.8. Data extraction</h3>
<div class="paragraph">
<p>The P4 core library contains the following declaration of a built-in <code>extern</code>
type called <code>packet_in</code> that represents incoming network
packets. The <code>packet_in</code> extern is special: it cannot be
instantiated by the user explicitly. Instead, the architecture
supplies a separate instance for each <code>packet_in</code> argument to
a <code>parser</code> instantiation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> <span style="color: #cf222e">packet_in</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">void</span> <span style="color: #953800">extract</span><span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">out</span> T headerLvalue<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #953800">void</span> <span style="color: #953800">extract</span><span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">out</span> T variableSizeHeader<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> varFieldSizeBits<span style="color: #24292f;background-color: #f6f8fa">);</span>
    T lookahead<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> length<span style="color: #24292f;background-color: #f6f8fa">();</span>  <span style="color: #6e7781">// This method may be unavailable in some architectures
</span>    <span style="color: #953800">void</span> advance<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> bits<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To extract data from a packet represented by an argument <code>b</code> with
type <code>packet_in</code>, a parser invokes the <code>extract</code> methods of <code>b</code>.
There are two variants of the <code>extract</code> method: a one-argument
variant for extracting fixed-size headers, and a two-argument variant
for extracting variable-sized headers. Because these operations can
cause runtime verification failures (see below), these methods can
only be executed within parsers.</p>
</div>
<div class="paragraph">
<p>When extracting data into a bit-string or integer, the first packet
bit is extracted to the most significant bit of the integer.</p>
</div>
<div class="paragraph">
<p>Some targets may perform cut-through packet processing, i.e., they may
start processing a packet before its length is known (i.e., before all
bytes have been received). On such a target calls to the <code>packet_in.length()</code>
method cannot be implemented. Attempts to call this method should be
flagged as errors (either at compilation time by the compiler
back-end, or when attempting to load the compiled P4 program onto a
target that does not support this method).</p>
</div>
<div class="paragraph">
<p>In terms of the <code>ParserModel</code>, the semantics of <code>packet_in</code>
can be captured using the following abstract model of packets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">packet_in {
    unsigned nextBitIndex;
    byte[] data;
    unsigned lengthInBits;
    void initialize(byte[] data) {
        this.data = data;
        this.nextBitIndex = 0;
        this.lengthInBits = data.sizeInBytes * 8;
    }
    bit&lt;32&gt; length() { return this.lengthInBits / 8; }
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="sec-packet-extract-one">13.8.1. Fixed-width extraction</h4>
<div class="paragraph">
<p>The single-argument <code>extract</code> method handles fixed-width headers,
and is declared in P4 as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">void</span> <span style="color: #953800">extract</span><span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">out</span> T headerLeftValue<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The expression <code>headerLeftValue</code> must evaluate to an l-value (see
<a href="#sec-lvalues">Section 6.7</a>) of type <code>header</code> with a fixed width. If
this method executes successfully, on completion the <code>headerLvalue</code>
is filled with data from the packet and its validity bit is set to <code>true</code>. This
method may fail in various ways---e.g., if there are not
enough bits left in the packet to fill the specified header.</p>
</div>
<div class="paragraph">
<p>For example, the following program fragment extracts an Ethernet header:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> Result <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #953800">Ethernet_h</span> ethernet<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">/* more fields omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">parser</span> P<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> Result r<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">state</span> start <span style="color: #24292f;background-color: #f6f8fa">{</span>
        b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>r<span style="color: #0550ae">.</span>ethernet<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In terms of the <code>ParserModel</code>, the semantics of the
single-argument <code>extract</code> is given in terms of the following
pseudo-code method, using data from the <code>packet</code> class defined
above. We use the special <code>valid$</code> identifier to indicate the
hidden valid bit of a header, <code>isNext$</code> to indicate that the
l-value was obtained using <code>next</code>, and <code>nextIndex$</code> to
indicate the corresponding header or header union stack properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">void packet_in.extract&lt;T&gt;(out T headerLValue) {
   bitsToExtract = sizeofInBits(headerLValue);
   lastBitNeeded = this.nextBitIndex + bitsToExtract;
   ParserModel.verify(this.lengthInBits &gt;= lastBitNeeded, error.PacketTooShort);
   headerLValue = this.data.extractBits(this.nextBitIndex, bitsToExtract);
   headerLValue.valid$ = true;
   if headerLValue.isNext$ {
     verify(headerLValue.nextIndex$ &lt; headerLValue.size, error.StackOutOfBounds);
     headerLValue.nextIndex$ = headerLValue.nextIndex$ + 1;
   }
   this.nextBitIndex += bitsToExtract;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-packet-extract-two">13.8.2. Variable-width extraction</h4>
<div class="paragraph">
<p>The two-argument <code>extract</code> handles variable-width headers, and is declared in P4 as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">void</span> <span style="color: #953800">extract</span><span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">out</span> T headerLvalue<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> variableFieldSize<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The expression <code>headerLvalue</code> must be an l-value representing a
header that contains <strong>exactly one</strong> <code>varbit</code> field. The expression <code>variableFieldSize</code>
must evaluate to a <code>bit&lt;32&gt;</code> value that indicates the number of
bits to be extracted into the unique <code>varbit</code> field of the header
(i.e., this size is not the size of the complete header, just the <code>varbit</code> field).</p>
</div>
<div class="paragraph">
<p>In terms of the <code>ParserModel</code>, the semantics of the two-argument <code>extract</code>
is captured by the following pseudo-code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">void packet_in.extract&lt;T&gt;(out T headerLvalue,
                          in bit&lt;32&gt; variableFieldSize) {
   // targets are allowed to include the following line, but need not
   // verify(variableFieldSize[2:0] == 0, error.ParserInvalidArgument);
   bitsToExtract = sizeOfFixedPart(headerLvalue) + variableFieldSize;
   lastBitNeeded = this.nextBitIndex + bitsToExtract;
   ParserModel.verify(this.lengthInBits &gt;= lastBitNeeded, error.PacketTooShort);
   ParserModel.verify(bitsToExtract &lt;= headerLvalue.maxSize, error.HeaderTooShort);
   headerLvalue = this.data.extractBits(this.nextBitIndex, bitsToExtract);
   headerLvalue.varbitField.size = variableFieldSize;
   headerLvalue.valid$ = true;
   if headerLValue.isNext$ {
     verify(headerLValue.nextIndex$ &lt; headerLValue.size, error.StackOutOfBounds);
     headerLValue.nextIndex$ = headerLValue.nextIndex$ + 1;
   }
   this.nextBitIndex += bitsToExtract;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows one way to parse IPv4 options---by
splitting the IPv4 header into two separate headers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// IPv4 header without options
</span><span style="color: #cf222e">header</span> <span style="color: #953800">IPv4_no_options_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span>   version<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span>   ihl<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>   diffserv<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span>  totalLen<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span>  identification<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">3</span><span style="color: #0550ae">&gt;</span>   flags<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">13</span><span style="color: #0550ae">&gt;</span>  fragOffset<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>   ttl<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>   protocol<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span>  hdrChecksum<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span>  srcAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span>  dstAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">header</span> <span style="color: #953800">IPv4_options_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #953800">varbit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">320</span><span style="color: #0550ae">&gt;</span> options<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">struct</span> Parsed_headers <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">// Some fields omitted
</span>    <span style="color: #953800">IPv4_no_options_h</span> ipv4<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">IPv4_options_h</span>    ipv4options<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #953800">error</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> InvalidIPv4Header <span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">parser</span> Top<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> Parsed_headers headers<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #6e7781">// Some states omitted
</span>
   <span style="color: #cf222e">state</span> parse_ipv4 <span style="color: #24292f;background-color: #f6f8fa">{</span>
       b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>headers<span style="color: #0550ae">.</span>ipv4<span style="color: #24292f;background-color: #f6f8fa">);</span>
       <span style="color: #953800">verify</span><span style="color: #24292f;background-color: #f6f8fa">(</span>headers<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ihl <span style="color: #0550ae">&gt;=</span> <span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">error</span><span style="color: #0550ae">.</span>InvalidIPv4Header<span style="color: #24292f;background-color: #f6f8fa">);</span>
       <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>headers<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ihl<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
           <span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">:</span> dispatch_on_protocol<span style="color: #24292f;background-color: #f6f8fa">;</span>
           <span style="color: #0550ae">_</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_ipv4_options<span style="color: #24292f;background-color: #f6f8fa">;</span>
       <span style="color: #24292f;background-color: #f6f8fa">}</span>
   <span style="color: #24292f;background-color: #f6f8fa">}</span>

   <span style="color: #cf222e">state</span> parse_ipv4_options <span style="color: #24292f;background-color: #f6f8fa">{</span>
       <span style="color: #6e7781">// use information in the ipv4 header to compute the number of bits to extract
</span>       b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>headers<span style="color: #0550ae">.</span>ipv4options<span style="color: #24292f;background-color: #f6f8fa">,</span>
                 <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)(((</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)</span>headers<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ihl <span style="color: #0550ae">-</span> <span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #0550ae">*</span> <span style="color: #0550ae">32</span><span style="color: #24292f;background-color: #f6f8fa">));</span>
       <span style="color: #cf222e">transition</span> dispatch_on_protocol<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-packet-lookahead">13.8.3. Lookahead</h4>
<div class="paragraph">
<p>The <code>lookahead</code> method provided by the <code>packet_in</code> packet abstraction
evaluates to a set of bits from the input packet without advancing the
<code>nextBitIndex</code> pointer. Similar to <code>extract</code>, it will transition to
<code>reject</code> and set the error if there are not enough bits in the packet.
When <code>lookahead</code> returns a value that contains headers (e.g., a header
type, or a struct containing headers), the headers values in the
returned result are always valid (otherwise <code>lookahead</code> must have
transitioned to the <code>reject</code> state).</p>
</div>
<div class="paragraph">
<p>The <code>lookahead</code> method can be invoked as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">b<span style="color: #0550ae">.</span>lookahead<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>T</code> must be a type with fixed width. In case of success the
result of the evaluation of <code>lookahead</code> returns a value of type <code>T</code>.</p>
</div>
<div class="paragraph">
<p>In terms of the <code>ParserModel</code>, the semantics of <code>lookahead</code> is
given by the following pseudocode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">T packet_in.lookahead&lt;T&gt;() {
   bitsToExtract = sizeof(T);
   lastBitNeeded = this.nextBitIndex + bitsToExtract;
   ParserModel.verify(this.lengthInBits &gt;= lastBitNeeded, error.PacketTooShort);
   T tmp = this.data.extractBits(this.nextBitIndex, bitsToExtract);
   return tmp;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The TCP options example from <a href="#sec-expr-hu">Section 8.19</a> also illustrates how <code>lookahead</code> can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">state</span> start <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>b<span style="color: #0550ae">.</span>lookahead<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">())</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_tcp_option_end<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_tcp_option_nop<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_tcp_option_ss<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_tcp_option_s<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_tcp_option_sack<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// Some states omitted
</span>
<span style="color: #cf222e">state</span> parse_tcp_option_sack <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> n <span style="color: #0550ae">=</span> b<span style="color: #0550ae">.</span>lookahead<span style="color: #0550ae">&lt;</span>Tcp_option_sack_top<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">()</span><span style="color: #0550ae">.</span>length<span style="color: #24292f;background-color: #f6f8fa">;</span>
    b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>vec<span style="color: #0550ae">.</span>next<span style="color: #0550ae">.</span>sack<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">8</span> <span style="color: #0550ae">*</span> n <span style="color: #0550ae">-</span> <span style="color: #0550ae">16</span><span style="color: #24292f;background-color: #f6f8fa">));</span>
    <span style="color: #cf222e">transition</span> start<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-skip-bits">13.8.4. Skipping bits</h4>
<div class="paragraph">
<p>P4 provides two ways to skip over bits in an input packet without
assigning them to a header:</p>
</div>
<div class="paragraph">
<p>One way is to <code>extract</code> to the underscore identifier, explicitly
specifying the type of the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">_</span><span style="color: #24292f;background-color: #f6f8fa">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another way is to use the <code>advance</code> method of the packet when the
number of bits to skip is known.</p>
</div>
<div class="paragraph">
<p>In terms of the <code>ParserModel</code>, the meaning of <code>advance</code> is
given in pseudocode as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">void packet_in.advance(bit&lt;32&gt; bits) {
   // targets are allowed to include the following line, but need not
   // verify(bits[2:0] == 0, error.ParserInvalidArgument);
   lastBitNeeded = this.nextBitIndex + bits;
   ParserModel.verify(this.lengthInBits &gt;= lastBitNeeded, error.PacketTooShort);
   this.nextBitIndex += bits;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-parse-header-stacks">13.9. Header stacks</h3>
<div class="paragraph">
<p>A header stack has two properties, <code>next</code> and <code>last</code>, which
can be used in parsing. Consider the following declaration, which
defines a stack for representing the headers of a packet with at most
ten MPLS headers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> <span style="color: #953800">Mpls_h</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">20</span><span style="color: #0550ae">&gt;</span> label<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">3</span><span style="color: #0550ae">&gt;</span>  tc<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span>     bos<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  ttl<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #953800">Mpls_h</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">]</span> mpls<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The expression <code>mpls.next</code> represents an l-value of type <code>Mpls_h</code>
that references an element in the <code>mpls</code>
stack. Initially, <code>mpls.next</code> refers to the first element of
stack. It is automatically advanced on each successful call to <code>extract</code>.
The <code>mpls.last</code> property refers to the element
immediately preceding <code>next</code> if such an element exists. Attempting
to access <code>mpls.next</code> element when the stack&#8217;s <code>nextIndex</code>
counter is greater than or equal to <code>size</code> causes a transition to <code>reject</code>
and sets the error to <code>error.StackOutOfBounds</code>. Likewise,
attempting to access <code>mpls.last</code> when the <code>nextIndex</code> counter
is equal to <code>0</code> causes a transition to <code>reject</code> and
sets the error to <code>error.StackOutOfBounds</code>.</p>
</div>
<div class="paragraph">
<p>The following example shows a simplified parser for MPLS processing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> Pkthdr <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #953800">Ethernet_h</span> ethernet<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #953800">Mpls_h</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">]</span> mpls<span style="color: #24292f;background-color: #f6f8fa">;</span>
   <span style="color: #6e7781">// other headers omitted
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">parser</span> P<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> Pkthdr p<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">state</span> start <span style="color: #24292f;background-color: #f6f8fa">{</span>
        b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ethernet<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>etherType<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
           <span style="color: #0550ae">0x8847</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_mpls<span style="color: #24292f;background-color: #f6f8fa">;</span>
           <span style="color: #0550ae">0x0800</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_ipv4<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">state</span> parse_mpls <span style="color: #24292f;background-color: #f6f8fa">{</span>
         b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>mpls<span style="color: #0550ae">.</span>next<span style="color: #24292f;background-color: #f6f8fa">);</span>
         <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>mpls<span style="color: #0550ae">.</span>last<span style="color: #0550ae">.</span>bos<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_mpls<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// This creates a loop
</span>            <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_ipv4<span style="color: #24292f;background-color: #f6f8fa">;</span>
         <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #6e7781">// other states omitted
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-invoke-subparser">13.10. Sub-parsers</h3>
<div class="paragraph">
<p>P4 allows parsers to invoke the services of other parsers, similar to
subroutines. To invoke the services of another parser, the sub-parser
must be first instantiated; the services of an instance are invoked by
calling it using its <code>apply</code> method.</p>
</div>
<div class="paragraph">
<p>The following example shows a sub-parser invocation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">parser</span> callee<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> packet<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> IPv4 ipv4<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">parser</span> caller<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> packet<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> Headers h<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
     callee<span style="color: #24292f;background-color: #f6f8fa">()</span> subparser<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// instance of callee
</span>     <span style="color: #cf222e">state</span> subroutine <span style="color: #24292f;background-color: #f6f8fa">{</span>
          subparser<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">(</span>packet<span style="color: #24292f;background-color: #f6f8fa">,</span> h<span style="color: #0550ae">.</span>ipv4<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// invoke sub-parser
</span>          <span style="color: #cf222e">transition</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// accept if sub-parser ends in accept state
</span>     <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The semantics of a sub-parser invocation can be described as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The state invoking the sub-parser is split into two half-states at
the parser invocation statement.</p>
</li>
<li>
<p>The top half includes a transition to the sub-parser <code>start</code>
state.</p>
</li>
<li>
<p>The sub-parser&#8217;s <code>accept</code> state is identified with the bottom
half of the current state</p>
</li>
<li>
<p>The sub-parser&#8217;s <code>reject</code> state is identified with the reject
state of the current parser.</p>
</li>
</ul>
</div>
<div id="fig-subparser" class="imageblock text-center">
<div class="content">
<img src="resources/figs/subparser.png" alt="subparser" width="400">
</div>
<div class="title">Figure 9. Semantics of invoking a sub-parser:  top: original program, bottom: equivalent program.</div>
</div>
<div class="paragraph">
<p><a href="#fig-subparser">Figure 9</a> shows a diagram of this process.</p>
</div>
<div class="paragraph">
<p>Note that since P4 requires definitions to precede uses, it is impossible to
create recursive (or mutually recursive) parsers.</p>
</div>
<div class="paragraph">
<p>When a parser is instantiated, local instantiations of stateful
objects are evaluated recursively. That is, each instantiation of a
parser has a unique set of local parser value sets, extern objects,
inner parser instances, etc. Thus, in general, invoking a parser
instance twice is not the same as invoking two copies of the same
parser instance. Note however that local variables do not persist
across invocations of the parser. This semantics also applies to
direct invocation (see <a href="#sec-direct-invocation">Section 15.1</a>).</p>
</div>
<div class="paragraph">
<p>Architectures may impose (static or dynamic) constraints on the
number of parser states that can be traversed for processing each
packet. For example, a compiler for a specific target may reject
parsers containing loops that cannot be unrolled at compilation time
or that may contain cycles that do not advance the cursor.
If a parser aborts execution dynamically because it exceeded
the time budget allocated for parsing, the parser should transition to
<code>reject</code> and set
the standard error <code>error.ParserTimeout</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-value-set">13.11. Parser Value Sets</h3>
<div class="paragraph">
<p>In some cases, the values that determine the transition from one parser state
to another need to be determined at run time. MPLS is one example where the
value of the MPLS label field is used to determine what headers follow the MPLS
tag and this mapping may change dynamically at run time. To support this
functionality, P4 supports the notion of a Parser Value Set. This is a named
set of values with a run time API to add and remove values from the set.</p>
</div>
<div class="paragraph">
<p>Value sets are declared locally within a parser. They should be declared before
being referenced in parser <code>keysetExpression</code> and can be used as a label in a
select expression.</p>
</div>
<div class="paragraph">
<p>The syntax for declaring value sets is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">valueSetDeclaration
  : optAnnotations
      VALUESET "&lt;" baseType "&gt;" "(" expression ")" name ";"
  | optAnnotations
      VALUESET "&lt;" tupleType "&gt;" "(" expression ")" name ";"
  | optAnnotations
      VALUESET "&lt;" typeName "&gt;" "(" expression ")" name ";"
  ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Parser Value Sets support a <code>size</code> argument to provide hints to the compiler to
reserve hardware resources to implement the value set. For example, this parser
value set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">value_set</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">4</span><span style="color: #24292f;background-color: #f6f8fa">)</span> pvs<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>creates a value_set of size 4 with entries of type <code>bit&lt;16&gt;</code>.</p>
</div>
<div class="paragraph">
<p>The semantics of the <code>size</code> argument is similar to the <code>size</code> property of a
table. If a value set has a <code>size</code> argument with value <code>N</code>, it is recommended
that a compiler should choose a data plane implementation that is capable of
storing <code>N</code> value set entries. See "Size property of P4 tables and parser value
sets" <sup class="footnote" id="_footnote_P4SizeProperty">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> for further discussion on the implementation of parser
value set size.</p>
</div>
<div class="paragraph">
<p>The value set is populated by the control plane by methods specified
in the P4Runtime specification.<sup class="footnote" id="_footnote_P4RuntimeAPI">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-control">14. Control blocks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>P4 parsers are responsible for extracting bits from a packet into
headers. These headers (and other metadata) can be manipulated and transformed within <code>control</code>
blocks. The body of a control block
resembles a traditional imperative program. Within the body of a control block,
match-action units can be invoked to perform data
transformations. Match-action units are represented in P4 by
constructs called <code>tables</code>.</p>
</div>
<div class="paragraph">
<p>Syntactically, a <code>control</code> block is declared with a name,
parameters, optional type parameters, and a sequence of declarations
of constants, variables, <code>action</code>s, <code>table</code>s, and other
instantiations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">controlDeclaration
    : controlTypeDeclaration optConstructorParameters
      /* controlTypeDeclaration cannot contain type parameters */
      "{" controlLocalDeclarations APPLY controlBody "}"
    ;

controlLocalDeclarations
    : /* empty */
    | controlLocalDeclarations controlLocalDeclaration
    ;

controlLocalDeclaration
    : constantDeclaration
    | actionDeclaration
    | tableDeclaration
    | instantiation
    | variableDeclaration
    ;

controlBody
    : blockStatement
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is illegal to instantiate a <code>parser</code> within a <code>control</code>
block.
For a description of the <code>optConstructorParameters</code>, which
can be used to build parameterized control blocks, see <a href="#sec-parameterization">Chapter 15</a>.</p>
</div>
<div class="paragraph">
<p>Unlike control type declarations, control declarations may not be
generic---e.g., the following declaration is illegal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> C<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> H data<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* Body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>P4 does not support exceptional control-flow within a <code>control</code>
block.
The only statement which
has a non-local effect on control flow is <code>exit</code>, which causes
execution of the enclosing control block to immediately terminate.
That is, there is no equivalent of the <code>verify</code> statement
or the <code>reject</code> state from parsers. Hence, all error handling must
be performed explicitly by the programmer.</p>
</div>
<div class="paragraph">
<p>The rest of this section describes the core components of a <code>control</code> block,
starting with actions.</p>
</div>
<div class="sect2">
<h3 id="sec-actions">14.1. Actions</h3>
<div id="fig-actions" class="imageblock text-center">
<div class="content">
<img src="resources/figs/actions.png" alt="actions" width="400">
</div>
<div class="title">Figure 10. Actions contain code and data. The code is in the P4 program, while the data is provided in the table entries, typically populated by the control plane. Other parameters are bound by the data plane.</div>
</div>
<div class="paragraph">
<p>Actions are code fragments that can read and write the data being
processed. Actions may contain data values that can be written by the
control plane and read by the data plane. Actions are the main
construct by which the control plane can dynamically influence the
behavior of the data plane. <a href="#fig-actions">Figure 10</a> shows the abstract
model of an <code>action</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">actionDeclaration
    : optAnnotations ACTION name "(" parameterList ")" blockStatement
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Syntactically actions resemble functions with no return
value. Actions may be declared within a control block; in this case
they can only be used within instances of that control block.</p>
</div>
<div class="paragraph">
<p>The following example shows an action declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">action</span> Forward_a<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">out</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">9</span><span style="color: #0550ae">&gt;</span> outputPort<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">9</span><span style="color: #0550ae">&gt;</span> port<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    outputPort <span style="color: #0550ae">=</span> port<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Action parameters may not have <code>extern</code> types. Action parameters that
have no direction (e.g., <code>port</code> in the previous example) indicate
"action data." All such parameters must appear at the end of the
parameter list. When used in a match-action table (see
<a href="#sec-table-action-list">Section 14.2.1.2</a>), these parameters will be provided by the
table entries (e.g., as specified by the control plane, the
<code>default_action</code> table property, or the <code>entries</code> table
property).</p>
</div>
<div class="paragraph">
<p>The body of an action consists of a sequence of statements and
declarations.  No <code>table</code>, <code>control</code>, or <code>parser</code> applications can
appear within actions.</p>
</div>
<div class="paragraph">
<p>Some targets may impose additional restrictions on action
bodies---e.g., only allowing straight-line code, with no conditional
statements or expressions.</p>
</div>
<div class="sect3">
<h4 id="sec-invoke-actions">14.1.1. Invoking actions</h4>
<div class="paragraph">
<p>Actions can be executed in two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implicitly: by tables during match-action processing.</p>
</li>
<li>
<p>Explicitly: either from a <code>control</code> block or from another <code>action</code>.
In either case, the values for all action parameters
must be supplied explicitly, including values for the directionless
parameters. In this case, the directionless parameters behave like <code>in</code>
parameters.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-tables">14.2. Tables</h3>
<div id="fig-maudataflow" class="imageblock text-center">
<div class="content">
<img src="resources/figs/maudataflow.png" alt="maudataflow" width="500">
</div>
<div class="title">Figure 11. Match-Action Unit Dataflow.</div>
</div>
<div class="paragraph">
<p>A <code>table</code> describes a match-action unit. The
structure of a match-action unit is shown in
<a href="#fig-maudataflow">Figure 11</a>. Processing a packet using a match-action table executes the
following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Key construction.</p>
</li>
<li>
<p>Key lookup in a lookup table (the "match" step). The result of key
lookup is an "action".</p>
</li>
<li>
<p>Action execution (the "action step") over the input data, resulting
in mutations of the data.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A <code>table</code> declaration introduces a table instance. To obtain
multiple instances of a table, it must be declared within a control
block that is itself instantiated multiple times.</p>
</div>
<div class="paragraph">
<p>The look-up table is a finite map whose contents are manipulated
asynchronously (read/write) by the target control plane, through a
separate control-plane API (see <a href="#fig-maudataflow">Figure 11</a>). Note that
the term "table" is overloaded: it can refer to the P4 <code>table</code>
objects that appear in P4 programs, as well as the internal look-up
tables used in targets. We will use the term "match-action unit" when
necessary to disambiguate.</p>
</div>
<div class="paragraph">
<p>Syntactically a table is defined in terms of a set of key-value
properties. Some of these properties are "standard" properties, but
the set of properties can be extended by target-specific compilers as
needed. Note duplicated properties are invalid and the compiler should
reject them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">tableDeclaration
    : optAnnotations TABLE name "{" tablePropertyList "}"
    ;

tablePropertyList
    : tableProperty
    | tablePropertyList tableProperty
    ;

tableProperty
    : KEY '=' '{' keyElementList '}'
    | ACTIONS '=' '{' actionList '}'
    | optAnnotations optCONST ENTRIES '=' '{' entriesList '}'
    | optAnnotations optCONST nonTableKwName '=' initializer ';'
    ;

nonTableKwName
   : IDENTIFIER
   | TYPE_IDENTIFIER
   | APPLY
   | STATE
   | TYPE
   | PRIORITY
   ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The standard table properties include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>key</code>: An expression that describes how the key used for look-up
is computed.</p>
</li>
<li>
<p><code>actions</code>: A list of all actions that may be found in the table.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, the tables may optionally define the following properties,</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>default_action</code>: an action to execute when the lookup in the
lookup table fails to find a match for the key used.</p>
</li>
<li>
<p><code>size</code>: an integer specifying the desired size of the table.</p>
</li>
<li>
<p><code>entries</code>: entries that are initially added to a table when the P4
program is loaded, some or all of which may be unchangeable by the
control plane software.</p>
</li>
<li>
<p><code>largest_priority_wins</code> - Only useful for some tables with the
<code>entries</code> property.  See <a href="#sec-entries">Section 14.2.1.4</a> for details.</p>
</li>
<li>
<p><code>priority_delta</code> - Only useful for some tables with the <code>entries</code>
property.  See <a href="#sec-entries">Section 14.2.1.4</a> for details.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The compiler must set the <code>default_action</code> to <code>NoAction</code> (and also
insert it into the list of <code>actions</code>) for tables that do not define
the <code>default_action</code> property.  Hence, all tables can be thought of
as having a <code>default_action</code> property, either implicitly or
explicitly.</p>
</div>
<div class="paragraph">
<p>In addition, tables may contain architecture-specific properties (see
<a href="#sec-additional-table-properties">Section 14.2.1.6</a>).</p>
</div>
<div class="paragraph">
<p>A property marked as <code>const</code> cannot be changed dynamically by the
control plane. The <code>key</code>, <code>actions</code>, and <code>size</code> properties cannot be
modified so the <code>const</code> keyword is not needed for these.</p>
</div>
<div class="sect3">
<h4 id="sec-table-props">14.2.1. Table properties</h4>
<div class="sect4">
<h5 id="sec-table-keys">14.2.1.1. Keys</h5>
<div class="paragraph">
<p>The <code>key</code> is a table property which specifies the data-plane values
that should be used to look up an entry. A key is a list of pairs of
the form <code>(e : m)</code>, where <code>e</code> is an expression that describes the data
to be matched in the table, and <code>m</code> is a <code>match_kind</code> that describes
the algorithm used to perform the lookup (see Section
<a href="#sec-match-kind-type">Section 7.1.3</a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">keyElementList
    : /* empty */
    | keyElementList keyElement
    ;

keyElement
    : expression ":" name optAnnotations ";"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, consider the following program fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>table Fwd {
    key = {
       ipv4header.dstAddress : ternary;
       ipv4header.version    : exact;
    }
    // more fields omitted
}</pre>
</div>
</div>
<div class="paragraph">
<p>Here the key comprises two fields from the <code>ipv4header</code>
header: <code>dstAddress</code> and <code>version</code>. The <code>match_kind</code> elements
serve three purposes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>They specify the algorithm used to match data-plane values against
the entries in the table at runtime.</p>
</li>
<li>
<p>They are used to synthesize the control-plane API that is used to
populate the table.</p>
</li>
<li>
<p>They are used by the compiler back-end to allocate resources for the
implementation of the table.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The P4 core library contains three predefined <code>match_kind</code> identifiers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">match_kind</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
   exact<span style="color: #24292f;background-color: #f6f8fa">,</span>
   ternary<span style="color: #24292f;background-color: #f6f8fa">,</span>
   lpm
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These identifiers correspond to the P4<sub>14</sub> match kinds with the same
names. The semantics of these match kinds is actually not needed to
describe the behavior of the P4 abstract machine; how they are used
influences only the control-plane API and the implementation of
the look-up table. From the point of view of the P4 program, a look-up
table is an abstract finite map that is given a key and produces as a
result either an action or a "miss" indication, as described in
<a href="#sec-mau-semantics">Section 14.2.3</a>.</p>
</div>
<div class="paragraph">
<p>The expected meaning of these values is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an <code>exact</code> match kind on a key field means that the value of the
field in the table specifies exactly the value the lookup key field
must have in order to match.  This is applicable for all legal key
fields whose types support equality comparisons.</p>
</li>
<li>
<p>a <code>ternary</code> match kind on a key field means that the field in the
table specifies a set of values for the key field using a value and
a mask. The meaning of the <code>(value, mask)</code> pair is similar to the P4
mask expressions, as described in <a href="#sec-cubes">Section 8.15.3</a>: a key field
<code>k</code> matches the table entry when <code>k &amp; mask == value &amp; mask</code>.</p>
</li>
<li>
<p>a <code>lpm</code> (longest prefix match) match kind on a key field is a
specific type of <code>ternary</code> match where the mask is required to have
a form in binary that is a contiguous set of 1 bits followed by a
contiguous set of 0 bits.  Masks with more 1 bits have automatically
higher priorities.  A mask with all bits 0 is legal.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some table entries, in particular the ones with at least one <code>ternary</code>
field, also require a priority value.  A priority is a numeric value
which is used to break ties when a particular key belongs to multiple
sets.  When table entries are specified in the P4 program the
priorities are generated by the compiler; when entries are specified
by the control-plane, the priority may need to be explicitly
specified.  Entries with higher priority are matched first.  This
specification does not mandate whether "higher" priorities are
represented by higher or lower numeric values; this choice is left to
the target implementation.</p>
</div>
<div class="paragraph">
<p>An example specifying entries for a table is given in <a href="#sec-entries">Section 14.2.1.4</a>.</p>
</div>
<div class="paragraph">
<p>If a table has no <code>key</code> property, or if the value of its <code>key</code>
property is the empty tuple, i.e. <code>key = {}</code>, then it contains no
look-up table, just a default action---i.e., the associated lookup
table is always the empty map.</p>
</div>
<div class="paragraph">
<p>Each key element can have an optional <code>@name</code> annotation which is
used to synthesize the control-plane-visible name for the key field.</p>
</div>
<div class="paragraph">
<p>Note some implementations might only support a limited number of keys or
a limited combinations of match_kind for the keys. The implementation
should reject those cases with an error message in this case.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-table-action-list">14.2.1.2. Actions</h5>
<div class="paragraph">
<p>A table must declare all possible actions that may appear within the
associated lookup table or in the default action. This is done with
the <code>actions</code> property; the value of this property is always an <code>actionList</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">actionList
    : /* empty */
    | actionList optAnnotations actionRef ";"
    ;

actionRef
    : prefixedNonTypeName
    | prefixedNonTypeName "(" argumentList ")"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To illustrate, recall the example Very Simple Switch program in
<a href="#sec-vss-all">Section 5.3</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">action</span> Drop_action<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  outCtrl<span style="color: #0550ae">.</span>outputPort <span style="color: #0550ae">=</span> DROP_PORT<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">action</span> Rewrite_smac<span style="color: #24292f;background-color: #f6f8fa">(</span>EthernetAddress sourceMac<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  headers<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>srcAddr <span style="color: #0550ae">=</span> sourceMac<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">table</span> smac <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> outCtrl<span style="color: #0550ae">.</span>outputPort <span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        Drop_action<span style="color: #24292f;background-color: #f6f8fa">;</span>
        Rewrite_smac<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The entries in the <code>smac</code> <code>table</code> may contain two different actions: <code>Drop_action</code> and <code>Rewrite_mac</code>.</p>
</li>
<li>
<p>The <code>Rewrite_smac</code> action has one parameter, <code>sourceMac</code>, which in this case will be provided by the control plane.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each action in the list of actions for a table must have a distinct
name---e.g., the following program fragment is illegal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">action</span> a<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{}</span>
<span style="color: #cf222e">control</span> c<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">action</span> a<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{}</span>
    <span style="color: #6e7781">// Illegal table: two actions with the same name
</span>    <span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #0550ae">.</span>a<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each action parameter that has a direction (<code>in</code>, <code>inout</code>, or <code>out</code>)
must be bound in the <code>actions</code> list specification; conversely, no
directionless parameters may be bound in the list. The expressions
supplied as arguments to an <code>action</code> are not evaluated until the
action is invoked. Applying tables, whether directly via an expression
like <code>table1.apply().hit</code>, or indirectly, are forbidden in the
expressions supplied as action arguments.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">action</span> a<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> x<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> z<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">action</span> b<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> x<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> data<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
       <span style="color: #6e7781">// a; -- illegal, x parameter must be bound
</span>       a<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// binding a's parameter x to 5
</span>       b<span style="color: #24292f;background-color: #f6f8fa">(</span>z<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// binding b's parameter x to z
</span>       <span style="color: #6e7781">// b(z, 3); -- illegal, cannot bind directionless data parameter
</span>       <span style="color: #6e7781">// b(); -- illegal, x parameter must be bound
</span>       <span style="color: #6e7781">// a(table2.apply().hit ? 5 : 3); -- illegal, cannot apply a table here
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sec-default-action">14.2.1.3. Default action</h5>
<div class="paragraph">
<p>The default action for a table is an action that is invoked
automatically by the match-action unit whenever the lookup table does
not find a match for the supplied key.</p>
</div>
<div class="paragraph">
<p>If present, the <code>default_action</code> property <em>must</em> appear after the <code>action</code>
property. It may be declared as <code>const</code>, indicating that it cannot
be changed dynamically by the control-plane. The <code>default action</code>
<em>must</em> be one of the actions that appear in the actions list. In
particular, the expressions passed as <code>in</code>, <code>out</code>, or <code>inout</code>
parameters must be syntactically identical to the expressions used in
one of the elements of the <code>actions</code> list.</p>
</div>
<div class="paragraph">
<p>For example, in the above <code>table</code> we could set the default action
as follows (marking it also as constant):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">const</span> <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> Rewrite_smac<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">48w0xAA_BB_CC_DD_EE_FF</span><span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the specified default action must supply arguments for the
control-plane-bound parameters (i.e., the directionless parameters),
since the action is synthesized at compilation time. The expressions
supplied as arguments for parameters with a direction (<code>in</code>, <code>inout</code>,
or <code>out</code>) are evaluated when the action is invoked while the
expressions supplied as arguments for directionless parameters are
evaluated at compile time.</p>
</div>
<div class="paragraph">
<p>Continuing the example from the previous section, the following are several legal
and illegal specifications of default actions for the <code>table t</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">  <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> a<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// OK - no control-plane parameters
</span>  <span style="color: #6e7781">// default_action = a(z); -- illegal, a's x parameter is already bound to 5
</span>  <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> b<span style="color: #24292f;background-color: #f6f8fa">(</span>z<span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #0550ae">8w8</span><span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// OK - bind b's data parameter to 8w8
</span>  <span style="color: #6e7781">// default_action = b(z); -- illegal, b's data parameter is not bound
</span>  <span style="color: #6e7781">// default_action = b(x, 3); -- illegal: x parameter of b bound to x instead of z</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sec-entries">14.2.1.4. Entries</h5>
<div class="paragraph">
<p>While table entries are typically installed by the control plane,
tables may also be initialized at compile time with a set of entries.</p>
</div>
<div class="paragraph">
<p>Declaring these entries with <code>const entries</code>
is useful in situations where tables are
used to implement fixed algorithms---defining table entries statically
enables expressing these algorithms directly in P4,
which allows the compiler to infer how the table is actually used and
potentially make better allocation decisions for targets with limited
resources.</p>
</div>
<div class="paragraph">
<p>Declaring entries with <code>entries</code> (without the <code>const</code> qualifier)
enables one to specify a mix of some immutable entries that are always
in the table, and some mutable entries that the control plane is
allowed to later change or remove.</p>
</div>
<div class="paragraph">
<p>Entries declared in the P4 source are installed in the
table when the program is loaded onto the target. Entries cannot be
specified for a table with no key (see <a href="#sec-table-keys">Section 14.2.1.1</a>).</p>
</div>
<div class="paragraph">
<p>Table entries are defined using the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">tableProperty
 : optAnnotations optCONST ENTRIES '=' '{' entriesList '}'
 ;

entriesList
    : /* empty */
    | entriesList entry
    ;

optCONST
    : /* empty */
    | CONST
    ;

entryPriority
 : PRIORITY '=' INTEGER ":"
 | PRIORITY '=' '(' expression ')' ":"
 ;

entry
    : optCONST entryPriority keysetExpression ':' actionRef optAnnotations ';'
    | optCONST keysetExpression ':' actionRef optAnnotations ';'
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Table entries defined using <code>const entries</code> are immutable---i.e., they
can only be read by the control plane.  The control plane is not
allowed to remove or modify any entries defined within <code>const
entries</code>, nor is it allowed to add entries to such a table.
It is allowed for individual entries to have the <code>const</code> keyword
before them, but this is redundant when the entries are declared using
<code>const entries</code>.</p>
</div>
<div class="paragraph">
<p>Table entries defined using <code>entries</code> (without a <code>const</code> qualifier
before it) may have <code>const</code> before them, or not, independently for
each entry.  Entries with <code>const</code> before them may not be modified or
removed by the control plane.  Entries without <code>const</code> may be modified
or removed by the control plane.  It is permitted for the control
plane to add entries to such a table (subject to table capacity
limitations), unlike tables declared with <code>const entries</code>.</p>
</div>
<div class="paragraph">
<p>Whether the control plane is allowed to modify a table&#8217;s default
action at run time is determined by the table&#8217;s <code>default_action</code> table
property (see <a href="#sec-default-action">Section 14.2.1.3</a>), independently of whether
the control plane is allowed to modify the entries of the table.</p>
</div>
<div class="paragraph">
<p>The <code>keysetExpression</code> component of an entry is a tuple that must
provide a field for each key in the table keys (see <a href="#sec-table-props">Section 14.2.1</a>). The table key type must match the type of the
element of the set. The <code>actionRef</code> component must be an action which
appears in the table actions list (and must not have the
<code>@defaultonly</code> annotation), with all its arguments bound.</p>
</div>
<div class="paragraph">
<p>If no entry priorities are specified in the source code, and
if the runtime API requires a priority for the entries of a
table---e.g. when using the P4 Runtime API, tables with at least one
<code>ternary</code> search key field---then the entries are matched in program
order, stopping at the first matching entry. Architectures should
define the significance of entry order (if any) for other kinds of
tables.</p>
</div>
<div class="paragraph">
<p>Depending on the <code>match_kind</code> of the keys, key set expressions may define
one or multiple entries. The compiler will synthesize the correct number of
entries to be installed in the table. Target constraints may further restrict
the ability of synthesizing entries. For example, if the number of synthesized
entries exceeds the table size, the compiler implementation may choose to issue
a warning or an error, depending on target capabilities.</p>
</div>
<div class="paragraph">
<p>To illustrate, consider the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> hdr <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  e<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> t<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  l<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  r<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">1</span><span style="color: #0550ae">&gt;</span>  v<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">struct</span> <span style="color: #953800">Header_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    hdr h<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">struct</span> <span style="color: #953800">Meta_t</span> <span style="color: #24292f;background-color: #f6f8fa">{}</span>

<span style="color: #cf222e">control</span> ingress<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> <span style="color: #953800">Header_t</span> h<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">inout</span> <span style="color: #953800">Meta_t</span> m<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> <span style="color: #953800">standard_metadata_t</span> standard_meta<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>

    <span style="color: #cf222e">action</span> a<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> standard_meta<span style="color: #0550ae">.</span>egress_spec <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">action</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">9</span><span style="color: #0550ae">&gt;</span> x<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> standard_meta<span style="color: #0550ae">.</span>egress_spec <span style="color: #0550ae">=</span> x<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>

    <span style="color: #cf222e">table</span> t_exact_ternary <span style="color: #24292f;background-color: #f6f8fa">{</span>

  	<span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            h<span style="color: #0550ae">.</span>h<span style="color: #0550ae">.</span>e <span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span>
            h<span style="color: #0550ae">.</span>h<span style="color: #0550ae">.</span>t <span style="color: #24292f;background-color: #f6f8fa">:</span> ternary<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>

	<span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            a<span style="color: #24292f;background-color: #f6f8fa">;</span>
            a_params<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>

	<span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>

        <span style="color: #cf222e">const</span> <span style="color: #cf222e">entries</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0x01</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">0x1111</span> <span style="color: #0550ae">&amp;&amp;&amp;</span> <span style="color: #0550ae">0xF</span>   <span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0x02</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">0x1181</span>           <span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0x03</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">0x1111</span> <span style="color: #0550ae">&amp;&amp;&amp;</span> <span style="color: #0550ae">0xF000</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0x04</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">0x1211</span> <span style="color: #0550ae">&amp;&amp;&amp;</span> <span style="color: #0550ae">0x02F0</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">4</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0x04</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">0x1311</span> <span style="color: #0550ae">&amp;&amp;&amp;</span> <span style="color: #0550ae">0x02F0</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0x06</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">_</span>                <span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">6</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #0550ae">_</span>                         <span style="color: #24292f;background-color: #f6f8fa">:</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we define a set of 7 entries, all of which invoke
action <code>a_params</code> except for the final entry which
invokes action <code>a</code>. Once the program is loaded, these entries are
installed in the table in the order they are enumerated in the
program.</p>
</div>
<div class="sect5">
<h6 id="sec-entry-priorities">14.2.1.4.1. Entry priorities</h6>
<div class="paragraph">
<p>If a table has fields where their <code>match_kind</code>s are all <code>exact</code> or
<code>lpm</code>, there is no reason to assign numeric priorities to its entries.
If they are all <code>exact</code>, duplicate keys are not allowed, and thus
every lookup key can match at most one entry, so there is no need for
a tiebreaker.  If there is an <code>lpm</code> field, the priority of the entry
corresponds to the length of the prefix, i.e. if a lookup key matches
multiple prefixes, the longest prefix is always the winner.</p>
</div>
<div class="paragraph">
<p>For tables with other <code>match_kind</code> values, e.g. at least one <code>ternary</code>
field, in general it is possible to install multiple entries such that
the same lookup key can match the key of multiple entries installed
into the table at the same time.  Control plane APIs such as P4Runtime
API <sup class="footnoteref">[<a class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup> and TDI <sup class="footnote" id="_footnote_TDI">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup> require control plane software to
provide a numeric priority with each entry added to such a table.
This enables the data plane to determine which of several matching
entries is the "winner", i.e. the one entry whose action is invoked.</p>
</div>
<div class="paragraph">
<p>Unfortunately there are two commonly used, but different, ways of
interpreting numeric priority values.</p>
</div>
<div class="paragraph">
<p>The P4Runtime API requires numeric priorities to be positive integers,
i.e. 1 or larger, and defines that entries with larger priorities must
win over entries with smaller priorities.  We will call this
convention <code>largest_priority_wins</code>.</p>
</div>
<div class="paragraph">
<p>TDI requires numeric priorities to be non-negative integers, i.e. 0 or
larger, and defines that entries with smaller priorities must win over
entries with larger priorities.  We will call this convention
<code>smallest_priority_wins</code>.</p>
</div>
<div class="paragraph">
<p>We wish to support either of these conventions when developers specify
priorities for initial table entries in the program.  Thus there is a
table property <code>largest_priority_wins</code>.  If explicitly specified for a
table, its value must be boolean.  If <code>true</code>, then the priority values
use the <code>largest_priority_wins</code> convention.  If <code>false</code>, then the
priority values use the <code>smallest_priority_wins</code> convention.  If the
table property is not present at all, then the default convention is
<code>true</code>, corresponding to <code>largest_priority_wins</code>.</p>
</div>
<div class="paragraph">
<p>We also wish to support developers that want the convenience of
predictable entry priority values automatically selected by the
compiler, without having to write them in the program, plus the
ability to specify entry priorities explicitly, if they wish.</p>
</div>
<div class="paragraph">
<p>In some cases, developers may wish the initial priority values to have
"gaps" between their values, to leave room for possible later
insertion of new entries between two initial entries.  They can
achieve this by explicitly specifying all priority values, of course,
but as a convenience we define the table property <code>priority_delta</code> to
be a positive integer value, with a default value of 1 if not
specified for a table, to use as a default difference between the
priorities of consecutive entries.</p>
</div>
<div class="paragraph">
<p>There are two steps that occur at compile time for a table with the
<code>entries</code> property involving entry priorities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Determine the value of the priority of every entry in the <code>entries</code>
list.</p>
</li>
<li>
<p>Issue any errors or warnings that are appropriate for these priority
values.  Warnings may be suppressed via an appropriate <code>@noWarn</code>
annotation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These steps are performed independently for each table with the
<code>entries</code> property, and each is described in more detail below.</p>
</div>
<div class="paragraph">
<p>In general, if the developer specifies a priority value for an entry,
that is the value that will be used.</p>
</div>
<div class="paragraph">
<p>If the developer does not specify priority values for any entry, then
the compiler calculates priority values for every entry as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">// For this pseudocode, table entries in the `entries` list are
// numbered 0 through n-1, 0 being the first to appear in order in the
// source code.  Their priority values are named prio[0] through
// prio[n-1].
int p = 1;
if (largest_priority_wins == true) {
    for (int j = n-1; j &gt;= 0; j -= 1) {
        prio[j] = p;
        p += priority_delta;
    }
} else {
    for (int j = 0; j &lt; n; j += 1) {
        prio[j] = p;
        p += priority_delta;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the developer specifies priority values for at least one entry,
then in order to simplify the rules for determining priorities of
entries without one in the source code, the first entry <em>must</em> have a
priority value explicitly provided.  The priorities of entries that do
not have one in the source code (if any) are determined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">// Same conventions here as in the previous block of pseudocode above.
// If entry j has a priority value specified in the source code,
// prio_specified[j] is true, otherwise it is false.
assert(prio_specified[0]);  // compile time error if prio_specified[0] is false
p = prio[0];
for (int j = 1; j &lt; n; j += 1) {
    if (prio_specified[j]) {
        p = prio[j];
    } else {
        if (largest_priority_wins == true) {
            p -= priority_delta;
        } else {
            p += priority_delta;
        }
        prio[j] = p;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the end of the first step: determining entry priorities.</p>
</div>
<div class="paragraph">
<p>The priorities determined in this way are the values used when the P4
program is first loaded into a device.  Afterwards, the priorities may
only change by means provided by the control plane API in use.</p>
</div>
<div class="paragraph">
<p>In the second step, the compiler issues errors for out of range
priority values, and/or warnings for certain combinations of entry
priorities that might be unintended by the developer, unless the
developer explicitly disables those warnings.</p>
</div>
<div class="paragraph">
<p>If any priority values are negative, or larger than the maximum
supported value, that is a compile time error.</p>
</div>
<div class="paragraph">
<p>If the annotation <code>@noWarn("duplicate_priorities")</code> is <em>not</em> used on
the <code>entries</code> table property, then the compiler issues a warning if
any two entries for the same table have equal priority values.  Both
P4Runtime and TDI leave it unspecified which entry is the winner if a
lookup key matches multiple keys that all have the same priority,
hence a warning is useful to less experienced developers that are
unfamiliar with this unspecified behavior.</p>
</div>
<div class="paragraph">
<p>If the annotation <code>@noWarn("duplicate_priorities")</code> is used on the
<code>entries</code> table property, then no warnings of this type are ever
issued by the compiler.  Using equal priority values for multiple
entries in the same table is sometimes useful in reducing the number
of hardware updates required when adding entries to such a table.</p>
</div>
<div class="paragraph">
<p>If the annotation <code>@noWarn("entries_out_of_priority_order")</code> is <em>not</em>
used on the <code>entries</code> table property, then the compiler issues a
warning if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If <code>largest_priority_wins</code> is <code>true</code> for the table, and there is any
pair of consecutive entries where <code>prio[j] &lt; prio[j+1]</code>, then a
warning is issued for that pair of entries.</p>
</li>
<li>
<p>If <code>largest_priority_wins</code> is <code>false</code> for the table, and there is any
pair of consecutive entries where <code>prio[j] &gt; prio[j+1]</code>, then a
warning is issued for that pair of entries.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This warning is useful to developers that want the order that entries
appear in the source code to match the relative priority of entries in
the target device.</p>
</div>
<div class="paragraph">
<p>If the annotation <code>@noWarn("entries_out_of_priority_order")</code> is used
on the <code>entries</code> table property, then no warnings of this type are
ever issued by the compiler for this table.  This option is provided
for developers who explicitly choose to specify entries in an order
that does not match their relative priority order.</p>
</div>
<div class="paragraph">
<p>The following example is the same as the first example in <a href="#sec-entries">Section 14.2.1.4</a>, except for the definition of table <code>t_exact_ternary</code>
shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">table</span> t_exact_ternary <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        h<span style="color: #0550ae">.</span>h<span style="color: #0550ae">.</span>e <span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span>
        h<span style="color: #0550ae">.</span>h<span style="color: #0550ae">.</span>t <span style="color: #24292f;background-color: #f6f8fa">:</span> ternary<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>

    <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        a<span style="color: #24292f;background-color: #f6f8fa">;</span>
        a_params<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>

    <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span>

    largest_priority_wins <span style="color: #0550ae">=</span> false<span style="color: #24292f;background-color: #f6f8fa">;</span>
    priority_delta <span style="color: #0550ae">=</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #0550ae">@noWarn</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"duplicate_priorities"</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
    <span style="color: #cf222e">entries</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">const</span> priority<span style="color: #0550ae">=</span><span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0x01</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">0x1111</span> <span style="color: #0550ae">&amp;&amp;&amp;</span> <span style="color: #0550ae">0xF</span>   <span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
                           <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0x02</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">0x1181</span>           <span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// priority=20
</span>                           <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0x03</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">0x1000</span> <span style="color: #0550ae">&amp;&amp;&amp;</span> <span style="color: #0550ae">0xF000</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// priority=30
</span>        <span style="color: #cf222e">const</span>              <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0x04</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">0x0210</span> <span style="color: #0550ae">&amp;&amp;&amp;</span> <span style="color: #0550ae">0x02F0</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">4</span><span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// priority=40
</span>              priority<span style="color: #0550ae">=</span><span style="color: #0550ae">40</span><span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0x04</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">0x0010</span> <span style="color: #0550ae">&amp;&amp;&amp;</span> <span style="color: #0550ae">0x02F0</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
                           <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0x06</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">_</span>                <span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> a_params<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">6</span><span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// priority=50
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The entries that do not have an explicit priority specified will be
assigned the priority values shown in the comments, because
<code>priority_delta</code> is 10, and because of those entries that do have
priority values specified.</p>
</div>
<div class="paragraph">
<p>Normally this program would cause a warning about multiple entries
with the same priority of 40, but those warnings will be suppressed
because of the <code>@noWarn("duplicate_priorities")</code> annotation.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sec-size-table-property">14.2.1.5. Size</h5>
<div class="paragraph">
<p>The <code>size</code> is an optional property of a table.  When present, its
value must always be a compile-time known value that is an integer. The <code>size</code> property
is specified in units of number of table entries.</p>
</div>
<div class="paragraph">
<p>If a table is specified with a <code>size</code> property of value <code>N</code>, it is
recommended that a compiler should choose a data plane implementation
that is capable of storing <code>N</code> table entries.  This does not guarantee
that an <em>arbitrary</em> set of <code>N</code> entries can always be inserted in such
a table, only that there is <em>some</em> set of <code>N</code> entries that can be
inserted.  For example, attempts to add some combinations of <code>N</code>
entries may fail because the compiler selected a hash table with
<code>O(1)</code> guaranteed search time.  See "Size property of P4 tables and
parser value sets" <sup class="footnoteref">[<a class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> for further discussion on some P4
table implementations and what they are able to guarantee.</p>
</div>
<div class="paragraph">
<p>If a P4 implementation must dimension table resources at compile time,
they may treat it as an error if they encounter a table with no <code>size</code>
property.</p>
</div>
<div class="paragraph">
<p>Some P4 implementations may be able to dynamically dimension table
resources at run time.  If a <code>size</code> value is specified in the P4
program, it is recommended that such an implementation uses the <code>size</code>
value as the initial capacity of the table.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-additional-table-properties">14.2.1.6. Additional properties</h5>
<div class="paragraph">
<p>A <code>table</code> declaration defines its essential control and data plane
interfaces---i.e., keys and actions. However, the best way to
implement a table may actually depend on the nature of the entries
that will be installed at runtime (for example, tables could be
dense or sparse, could be implemented as hash-tables, associative
memories, tries, etc.) In addition, some architectures may support extra table
properties whose semantics lies outside the scope of this
specification. For example, in architectures where table resources are
statically allocated, programmers may be required to define a <code>size</code>
table property, which can be used by the compiler back-end
to allocate storage resources. However, these architecture-specific
properties may not change the semantics of table lookups, which always
produce either a <code>hit</code> and an action or a <code>miss</code>---they can
only change how those results are interpreted on the state of the data
plane. This restriction is needed to ensure that it is possible to
reason about the behavior of tables during compilation.</p>
</div>
<div class="paragraph">
<p>As another example, an <code>implementation</code> property could be used to
pass additional information to the compiler back-end. The value of
this property could be an instance of an <code>extern</code> block chosen
from a suitable library of components. For example, the core
functionality of the P4<sub>14</sub> table <code>action_profile</code> constructs
could be implemented on architectures that support this feature using
a construct such as the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> ActionProfile <span style="color: #24292f;background-color: #f6f8fa">{</span>
   ActionProfile<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> <span style="color: #cf222e">size</span><span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// number of distinct actions expected
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">size</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">1024</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    implementation <span style="color: #0550ae">=</span> ActionProfile<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">32</span><span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// constructor invocation
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the action profile might be used to optimize for the case where
the table has a large number of entries, but the actions associated
with those entries are expected to range over a small number of
distinct values. Introducing a layer of indirection enables sharing
identical entries, which can significantly reduce the table&#8217;s storage
requirements.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-invoke-mau">14.2.2. Match-action unit invocation</h4>
<div class="paragraph">
<p>A <code>table</code> can be invoked by calling its <code>apply</code>
method. Calling an apply method on a table instance returns a value
with a <code>struct</code> type with three fields. This structure is
synthesized by the compiler automatically. For each <code>table T</code>, the
compiler synthesizes an <code>enum</code> and a <code>struct</code>, shown in
pseudo-P4:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">enum action_list(T) {
   // one field for each action in the actions list of table T
}
struct apply_result(T) {
    bool hit;
    bool miss;
    action_list(T) action_run;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The evaluation of the <code>apply</code> method sets the <code>hit</code> field to <code>true</code>
and the field <code>miss</code> to <code>false</code> if a match is found in the lookup-table;
if a match is not found <code>hit</code> is set to <code>false</code> and <code>miss</code> to <code>true</code>.
These bits can be used to drive the execution of the control-flow in the
control block that invoked the table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ipv4_match<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">()</span><span style="color: #0550ae">.</span>hit<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">// there was a hit
</span><span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">// there was a miss
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ipv4_host<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">()</span><span style="color: #0550ae">.</span>miss<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    ipv4_lpm<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span> <span style="color: #6e7781">// Look up the route only if host table missed
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>action_run</code> field indicates which kind of action was executed
(irrespective of whether it was a hit or a miss). It can be used in a
switch statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">switch</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>dmac<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">()</span><span style="color: #0550ae">.</span>action_run<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    Drop_action<span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #cf222e">return</span><span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-mau-semantics">14.2.3. Match-action unit execution semantics</h4>
<div class="paragraph">
<p>The semantics of a table invocation statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">m<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>is given by the following pseudocode (see also <a href="#fig-maudataflow">Figure 11</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">apply_result(m) m.apply() {
    apply_result(m) result;

    var lookupKey = m.buildKey(m.key); // using key block
    action RA = m.table.lookup(lookupKey);
    if (RA == null) {      // miss in lookup table
       result.hit = false;
       RA = m.default_action;  // use default action
    }
    else {
       result.hit = true;
    }
    result.miss = !result.hit;
    result.action_run = action_type(RA);
    evaluate_and_copy_in_RA_args(RA);
    execute(RA);
    copy_out_RA_args(RA);
    return result;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The behavior of the <code>buildKey</code> call in the pseudocode above is to
evaluate each key expression in the order they appear in the table key
definition.  The behavior must be the same as if the result of
evaluating each key expression is assigned to a fresh temporary
variable, before starting the evaluation of the following key
expression.  For example, this P4 table definition and apply call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> f1 <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> a<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">inout</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> b<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    b <span style="color: #0550ae">=</span> a <span style="color: #0550ae">+</span> <span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">return</span> a <span style="color: #0550ae">&gt;&gt;</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> x<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> y<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">table</span> t1 <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        y <span style="color: #0550ae">&amp;</span> <span style="color: #0550ae">0x7</span>  <span style="color: #24292f;background-color: #f6f8fa">:</span> exact <span style="color: #0550ae">@name</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"masked_y"</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
        f1<span style="color: #24292f;background-color: #f6f8fa">(</span>x<span style="color: #24292f;background-color: #f6f8fa">,</span> y<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> exact <span style="color: #0550ae">@name</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"f1"</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
        y        <span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #6e7781">// ... rest of table properties defined here, not relevant to example
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">// assign values to x and y here, not relevant to example
</span>    t1<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>is equivalent in behavior to the following table definition and apply
call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// same definition of f1, x, and y as before, so they are not repeated here
</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> tmp_1<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> tmp_2<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> tmp_3<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">table</span> t1 <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        tmp_1 <span style="color: #24292f;background-color: #f6f8fa">:</span> exact <span style="color: #0550ae">@name</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"masked_y"</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
        tmp_2 <span style="color: #24292f;background-color: #f6f8fa">:</span> exact <span style="color: #0550ae">@name</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"f1"</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
        tmp_3 <span style="color: #24292f;background-color: #f6f8fa">:</span> exact <span style="color: #0550ae">@name</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"y"</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #6e7781">// ... rest of table properties defined here, not relevant to example
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">// assign values to x and y here, not relevant to example
</span>    tmp_1 <span style="color: #0550ae">=</span> y <span style="color: #0550ae">&amp;</span> <span style="color: #0550ae">0x7</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    tmp_2 <span style="color: #0550ae">=</span> f1<span style="color: #24292f;background-color: #f6f8fa">(</span>x<span style="color: #24292f;background-color: #f6f8fa">,</span> y<span style="color: #24292f;background-color: #f6f8fa">);</span>
    tmp_3 <span style="color: #0550ae">=</span> y<span style="color: #24292f;background-color: #f6f8fa">;</span>
    t1<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the second code example above is given in order to specify
the behavior of the first one.  An implementation is free to choose
any technique that achieves this behavior.<sup class="footnote" id="_footnote_MostP4ProgramsDontDoThis">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-mau-abstract-mach">14.3. The Match-Action Pipeline Abstract Machine</h3>
<div class="paragraph">
<p>We can describe the computational model of a match-action pipeline,
embodied by a control block: the body of the control block is
executed, similarly to the execution of a traditional imperative
program:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At runtime, statements within a block are executed in the order
they appear in the control block.</p>
</li>
<li>
<p>Execution of the <code>return</code> statement causes immediate termination
of the execution of the current <code>control</code> block, and a return to
the caller.</p>
</li>
<li>
<p>Execution of the <code>exit</code> statement causes the immediate
termination of the execution of the current <code>control</code> block and
of all the enclosing caller <code>control</code> blocks.</p>
</li>
<li>
<p>Applying a <code>table</code> executes the corresponding
match-action unit, as described above.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sec-invoke-controls">14.4. Invoking controls</h3>
<div class="paragraph">
<p>P4 allows controls to invoke the services of other controls, similar
to subroutines. To invoke the services of another control, it must be
first instantiated; the services of an instance are invoked by calling
it using its <code>apply</code> method.</p>
</div>
<div class="paragraph">
<p>The following example shows a control invocation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> Callee<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> IPv4 ipv4<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> Caller<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> Headers h<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
     Callee<span style="color: #24292f;background-color: #f6f8fa">()</span> instance<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// instance of callee
</span>     <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
          instance<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">(</span>h<span style="color: #0550ae">.</span>ipv4<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// invoke control
</span>     <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As with parsers, when a control is instantiated, local instantiations
of stateful objects are evaluated recursively. That is, each
instantiation of a control has a unique set of local tables, extern
objects, inner control instances, etc. Thus, in general, invoking a
control instance twice is not the same as invoking two copies of the
same control instance. Note however, that local variables do not
persist across invocations of the control. This semantics also applies
to direct invocation (see <a href="#sec-direct-invocation">Section 15.1</a>).</p>
</div>
<div class="paragraph">
<p>When a control is instantiated, all its local declarations of stateful
instantiations are evaluated recursively.  Each instantiation of a
control will have a unique set of local tables, extern objects, and
inner control instances.  Thus, invoking a control instance twice is
different from invoking two control instances each once, where the
former accesses the same local stateful constructs while the latter
access two different copies.</p>
</div>
<div class="paragraph">
<p>The exactly-once evaluation only applies to local stateful instantiations. For local variable declarations,
whether in the <code>apply</code> block or out, and whether with initializers or not, they are always evaluated
when a control instance is invoked. That is, local variables in a control never persist across invocations. For variables
declared outside the <code>apply</code> block, they are evaluated at the beginning of execution.</p>
</div>
<div class="paragraph">
<p>All the behavior above also applies to direct invocation (see <a href="#sec-direct-invocation">Section 15.1</a>).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-parameterization">15. Parameterization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to support libraries of useful P4 components, both <code>parser</code>s
and <code>control</code> blocks can be additionally parameterized through the
use of constructor parameters.</p>
</div>
<div class="paragraph">
<p>Consider again the parser declaration syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">parserDeclaration
    : parserTypeDeclaration optConstructorParameters
      "{" parserLocalElements parserStates "}"
    ;

optConstructorParameters
    : /* empty */
    | "(" parameterList ")"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>From this grammar fragment we infer that a <code>parser</code> declaration
may have two sets of parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The runtime parser parameters (<code>parameterList</code>)</p>
</li>
<li>
<p>Optional parser constructor parameters
(<code>optConstructorParameters</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Constructor parameters must be directionless (i.e., they cannot
be <code>in</code>, <code>out</code>, or <code>inout</code>) and where the parser is
instantiated, it must be possible to fully evaluate the expressions
supplied for these parameters at compilation time.</p>
</div>
<div class="paragraph">
<p>Consider the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">parser</span> GenericParser<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> Packet_header p<span style="color: #24292f;background-color: #f6f8fa">)</span>
                    <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bool</span> udpSupport<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>   <span style="color: #6e7781">// constructor parameters
</span>    <span style="color: #cf222e">state</span> start <span style="color: #24292f;background-color: #f6f8fa">{</span>
        b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ethernet<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>etherType<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #0550ae">16w0x0800</span><span style="color: #24292f;background-color: #f6f8fa">:</span> ipv4<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">state</span> ipv4 <span style="color: #24292f;background-color: #f6f8fa">{</span>
        b<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ipv4<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>protocol<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
           <span style="color: #0550ae">6</span><span style="color: #24292f;background-color: #f6f8fa">:</span> tcp<span style="color: #24292f;background-color: #f6f8fa">;</span>
           <span style="color: #0550ae">17</span><span style="color: #24292f;background-color: #f6f8fa">:</span> tryudp<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">state</span> tryudp <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>udpSupport<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            false<span style="color: #24292f;background-color: #f6f8fa">:</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span>
            true <span style="color: #24292f;background-color: #f6f8fa">:</span> udp<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">state</span> udp <span style="color: #24292f;background-color: #f6f8fa">{</span>
         <span style="color: #6e7781">// body omitted
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When instantiating the <code>GenericParser</code> it is necessary to supply a value for
the <code>udpSupport</code> parameter, as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// topParser is a GenericParser where udpSupport = false
</span>GenericParser<span style="color: #24292f;background-color: #f6f8fa">(</span>false<span style="color: #24292f;background-color: #f6f8fa">)</span> topParser<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="sec-direct-invocation">15.1. Direct type invocation</h3>
<div class="paragraph">
<p>Controls and parsers are often instantiated exactly once.  As a light
syntactic sugar, control and parser declarations with no constructor
parameters may be applied directly, as if they were an instance.  This
has the effect of creating and applying a local instance of that type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> Callee<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">control</span> Caller<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        Callee<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* arguments omitted */</span><span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// Callee is treated as an instance
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The definition of <code>Caller</code> is equivalent to the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> Caller<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #0550ae">@name</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"Callee"</span><span style="color: #24292f;background-color: #f6f8fa">)</span> Callee<span style="color: #24292f;background-color: #f6f8fa">()</span> Callee_inst<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// local instance of Callee
</span>    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        Callee_inst<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* arguments omitted */</span><span style="color: #24292f;background-color: #f6f8fa">);</span>         <span style="color: #6e7781">// Callee_inst is applied
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">directApplication
    : typeName "." APPLY "(" argumentList ")" ";"
    | specializedType "." APPLY "(" argumentList ")" ";"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This feature is intended to streamline the common case where a type is
instantiated exactly once.</p>
</div>
<div class="paragraph">
<p>The second production in the grammar allows direct calls for generic
controls or parsers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> Callee<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">control</span> Caller<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #6e7781">// Callee&lt;bit&lt;32&gt;&gt; is treated as an instance
</span>        Callee<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* arguments omitted */</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For completeness, the behavior of directly invoking the same type more
than once is defined as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Direct type invocation in different scopes will result in different
local instances with different fully-qualified control names.</p>
</li>
<li>
<p>In the same scope, direct type invocation will result in a different
local instance per invocation---however, instances of the same type
will share the same global name, via the <code>@name</code> annotation.  If
the type contains controllable entities, then invoking it directly
more than once in the same scope is illegal, because it will produce
multiple controllable entities with the same fully-qualified control
name.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="#sec-name-annotations">Section 18.3.2</a> for details of <code>@name</code>
annotations.</p>
</div>
<div class="paragraph">
<p>No direct invocation is possible for controls or parsers that require
constructor arguments.  These need to be instantiated before they are
invoked.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-deparse">16. Deparsing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The inverse of parsing is deparsing, or packet construction. P4 does
not provide a separate language for packet deparsing; deparsing is
done in a <code>control</code> block that has at least one parameter of type <code>packet_out</code>.</p>
</div>
<div class="paragraph">
<p>For example, the following code sequence writes first an Ethernet
header and then an IPv4 header into a <code>packet_out</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> TopDeparser<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> Parsed_packet p<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">packet_out</span> b<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        b<span style="color: #0550ae">.</span>emit<span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ethernet<span style="color: #24292f;background-color: #f6f8fa">);</span>
        b<span style="color: #0550ae">.</span>emit<span style="color: #24292f;background-color: #f6f8fa">(</span>p<span style="color: #0550ae">.</span>ip<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Emitting a header appends the header to the <code>packet_out</code> only if
the header is valid. Emitting a header stack will emit all elements of
the stack in order of increasing indices.</p>
</div>
<div class="sect2">
<h3 id="sec-deparse-insert">16.1. Data insertion into packets</h3>
<div class="paragraph">
<p>The <code>packet_out</code> datatype is defined in the P4 core library, and
reproduced below. It provides a method for appending data to an
output packet called <code>emit</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> <span style="color: #cf222e">packet_out</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">void</span> emit<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>emit</code> method supports appending the data contained in a
header, header stack, <code>struct</code>, or header union to the output packet.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When applied to a header, <code>emit</code> appends the data in the header to
the packet if it is valid and otherwise behaves like a no-op.</p>
</li>
<li>
<p>When applied to a header stack, <code>emit</code> recursively invokes itself to
each element of the stack.</p>
</li>
<li>
<p>When applied to a <code>struct</code> or header union, <code>emit</code> recursively
invokes itself to each field.  Note, a <code>struct</code> must not contain
a field of type <code>error</code> or  <code>enum</code> because these types cannot be serialized.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is illegal to invoke <code>emit</code> on an expression whose type is a base type,
<code>enum</code>, or <code>error</code>.</p>
</div>
<div class="paragraph">
<p>We can define the meaning of the <code>emit</code> method in pseudocode as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4pseudo">packet_out {
    byte[] data;
    unsigned lengthInBits;
    void initializeForWriting() {
        this.data.clear();
        this.lengthInBits = 0;
    }
    /// Append data to the packet. Type T must be a header, header
    /// stack, header union, or struct formed recursively from those types
    void emit&lt;T&gt;(T data) {
        if (isHeader(T))
            if(data.valid$) {
                this.data.append(data);
                this.lengthInBits += data.lengthInBits;
            }
        else if (isHeaderStack(T))
            for (e : data)
                 emit(e);
        else if (isHeaderUnion(T) || isStruct(T))
            for (f : data.fields$)
                 emit(e.f)
        // Other cases for T are illegal
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we use the special <code>valid$</code> identifier to indicate the hidden
valid bit of headers and <code>fields$</code> to indicate the list of fields
for a struct or header union. We also use standard <code>for-each</code> notation to
iterate through the elements of a stack <code>(e : data)</code> and list of
fields for header unions and structs <code>(f : data.fields$)</code>.  The
iteration order for a struct is the order those fields appear in the
type declaration.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-arch-desc">17. Architecture description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The architecture description must be provided by the target
manufacturer in the form of a library P4 source file that contains at
least one declaration for a <code>package</code>; this <code>package</code> must be
instantiated by the user to construct a program for a target. For an
example see the Very Simple Switch declaration from <a href="#sec-vss-arch">Section 5.1</a>.</p>
</div>
<div class="paragraph">
<p>The architecture description file may pre-define data types,
constants, helper package implementations, and errors. It must also
declare the types of all the programmable blocks that will appear in
the final target: <code>parser</code>s and <code>control</code> blocks. The
programmable blocks may optionally be grouped together in packages,
which can be nested.</p>
</div>
<div class="paragraph">
<p>Since some of the target components may manipulate user-defined types,
which are unknown at the target declaration time, these are described
using type variables, which must be used parametrically in the
program---i.e., type variables are checked similar to Java generics,
not C++ templates.</p>
</div>
<div class="sect2">
<h3 id="sec-arch-desc-example">17.1. Example architecture description</h3>
<div id="fig-switcharch" class="imageblock text-center">
<div class="content">
<img src="resources/figs/switcharch.png" alt="switcharch" width="500">
</div>
<div class="title">Figure 12. Fragment of example switch architecture.</div>
</div>
<div class="paragraph">
<p>The following example describes a switch by using two packages, each
containing a parser, a match-action pipeline, and a deparser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">parser</span> Parser<span style="color: #0550ae">&lt;</span>IH<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> IH parsedHeaders<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #6e7781">// ingress match-action pipeline
</span><span style="color: #cf222e">control</span> IPipe<span style="color: #0550ae">&lt;</span>T<span style="color: #24292f;background-color: #f6f8fa">,</span> IH<span style="color: #24292f;background-color: #f6f8fa">,</span> OH<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> IH inputHeaders<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">in</span> InControl inCtrl<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">out</span> OH outputHeaders<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">out</span> T toEgress<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">out</span> OutControl outCtrl<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #6e7781">// egress match-action pipeline
</span><span style="color: #cf222e">control</span> EPipe<span style="color: #0550ae">&lt;</span>T<span style="color: #24292f;background-color: #f6f8fa">,</span> IH<span style="color: #24292f;background-color: #f6f8fa">,</span> OH<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> IH inputHeaders<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">in</span> InControl inCtrl<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">in</span> T fromIngress<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">out</span> OH outputHeaders<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">out</span> OutControl outCtrl<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">control</span> Deparser<span style="color: #0550ae">&lt;</span>OH<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> OH outputHeaders<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">packet_out</span> b<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">package</span> Ingress<span style="color: #0550ae">&lt;</span>T<span style="color: #24292f;background-color: #f6f8fa">,</span> IH<span style="color: #24292f;background-color: #f6f8fa">,</span> OH<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>Parser<span style="color: #0550ae">&lt;</span>IH<span style="color: #0550ae">&gt;</span> p<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           IPipe<span style="color: #0550ae">&lt;</span>T<span style="color: #24292f;background-color: #f6f8fa">,</span> IH<span style="color: #24292f;background-color: #f6f8fa">,</span> OH<span style="color: #0550ae">&gt;</span> map<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           Deparser<span style="color: #0550ae">&lt;</span>OH<span style="color: #0550ae">&gt;</span> d<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">package</span> Egress<span style="color: #0550ae">&lt;</span>T<span style="color: #24292f;background-color: #f6f8fa">,</span> IH<span style="color: #24292f;background-color: #f6f8fa">,</span> OH<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>Parser<span style="color: #0550ae">&lt;</span>IH<span style="color: #0550ae">&gt;</span> p<span style="color: #24292f;background-color: #f6f8fa">,</span>
                          EPipe<span style="color: #0550ae">&lt;</span>T<span style="color: #24292f;background-color: #f6f8fa">,</span> IH<span style="color: #24292f;background-color: #f6f8fa">,</span> OH<span style="color: #0550ae">&gt;</span> map<span style="color: #24292f;background-color: #f6f8fa">,</span>
                          Deparser<span style="color: #0550ae">&lt;</span>OH<span style="color: #0550ae">&gt;</span> d<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">package</span> Switch<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>Ingress<span style="color: #0550ae">&lt;</span>T<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">_</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">_</span><span style="color: #0550ae">&gt;</span> ingress<span style="color: #24292f;background-color: #f6f8fa">,</span> Egress<span style="color: #0550ae">&lt;</span>T<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">_</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">_</span><span style="color: #0550ae">&gt;</span> egress<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Just from these declarations, even without reading a precise
description of the target, the programmer can infer some useful
information about the architecture of the described switch, as shown
in <a href="#fig-switcharch">Figure 12</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The switch contains two separate <code>package</code>s <code>Ingress</code> and <code>Egress</code>.</p>
</li>
<li>
<p>The <code>Parser</code>, <code>IPipe</code>, and <code>Deparser</code> in the <code>Ingress</code> package
are chained together in order. In addition, the <code>Ingress.IPipe</code> block has an
input of type <code>Ingress.IH</code>, which is an output of the <code>Ingress.Parser</code>.</p>
</li>
<li>
<p>Similarly, the <code>Parser</code>, <code>EPipe</code>, and <code>Deparser</code> are
chained in the <code>Egress</code> package.</p>
</li>
<li>
<p>The <code>Ingress.IPipe</code> is connected to the <code>Egress.EPipe</code>, because the
first outputs a value of type <code>T</code>, which is an input to the
second. Note that the occurrences of the type variable <code>T</code> are
instantiated with the same type in <code>Switch</code>. In contrast,
the <code>Ingress</code> type <code>IH</code> and the <code>Egress</code> type <code>IH</code> may be
different. To force them to be the same, we could instead
declare <code>IH</code> and <code>OH</code> at the switch level:
<code>package Switch&lt;T,IH,OH&gt;(Ingress&lt;T, IH, OH&gt; ingress, Egress&lt;T, IH, OH&gt; egress)</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Hence, this architecture models a target switch that contains two
separate channels between the ingress and egress pipeline:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A channel that can pass data directly via its argument of type
<code>T</code>. On a software target with shared memory between ingress and
egress this could be implemented by passing directly a pointer; on
an architecture without shared memory presumably the compiler will
need to automatically synthesize serialization code.</p>
</li>
<li>
<p>A channel that can pass data indirectly using a parser and deparser
that serializes data into a packet and back.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sec-target-instantiation">17.2. Example architecture program</h3>
<div class="paragraph">
<p>To construct a program for the architecture, the P4 program must
instantiate a top-level <code>package</code> by passing values for all its
arguments creating a variable called <code>main</code> in the top-level
namespace. The types of the arguments must match the types of the
parameters---after a suitable substitution of the type variables. The
type substitution can be expressed directly, using type
specialization, or can be inferred by a compiler, using a unification
algorithm like Hindley-Milner.</p>
</div>
<div class="paragraph">
<p>For example, given the following type declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">parser</span> Prs<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> T result<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">control</span> Pipe<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">package</span> Switch<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>Prs<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> p<span style="color: #24292f;background-color: #f6f8fa">,</span> Pipe<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> map<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and the following declarations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">parser</span> P<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> index<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> Pipe1<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> data<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> Pipe2<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> data<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following is a legal declaration for the top-level target:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">Switch<span style="color: #24292f;background-color: #f6f8fa">(</span>P<span style="color: #24292f;background-color: #f6f8fa">(),</span> Pipe1<span style="color: #24292f;background-color: #f6f8fa">())</span> main<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And the following is illegal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">Switch<span style="color: #24292f;background-color: #f6f8fa">(</span>P<span style="color: #24292f;background-color: #f6f8fa">(),</span> Pipe2<span style="color: #24292f;background-color: #f6f8fa">())</span> main<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The latter declaration is incorrect because the parser <code>P</code>
requires <code>T</code> to be <code>bit&lt;32&gt;</code>, while <code>Pipe2</code> requires <code>T</code>
to be <code>bit&lt;8&gt;</code>.</p>
</div>
<div class="paragraph">
<p>The user can also explicitly specify values for the type variables
(otherwise the compiler has to infer values for these type variables):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">Switch<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>P<span style="color: #24292f;background-color: #f6f8fa">(),</span> Pipe1<span style="color: #24292f;background-color: #f6f8fa">())</span> main<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-pkt-filter">17.3. A Packet Filter Model</h3>
<div id="fig-packetfilter" class="imageblock text-center">
<div class="content">
<img src="resources/figs/packetfilter.png" alt="packetfilter" width="200">
</div>
<div class="title">Figure 13. A packet filter target model. The parser computes a Boolean value, which is used to decide whether the packet is dropped.</div>
</div>
<div class="paragraph">
<p>To illustrate the versatility of the P4 architecture description language,
we give an example of another architecture: one which models a packet
filter that makes a drop/no drop decision based only on the
computation in a P4 parser, as shown in <a href="#fig-packetfilter">Figure 13</a>.</p>
</div>
<div class="paragraph">
<p>This model could be used to program packet filters running in the
Linux kernel. For example, we could replace the <code>tcpdump</code> language with
the much more powerful P4 language; P4 can seamlessly support new
protocols, while providing complete "type safety" during packet
processing. For such a target, the P4 compiler could generate an eBPF
(Extended Berkeley Packet Filter) program, which is injected by the
<code>tcpdump</code> utility into the Linux kernel, and executed by the eBPF
kernel JIT compiler/runtime.</p>
</div>
<div class="paragraph">
<p>In this case the target is the Linux kernel, and the architecture
model is a packet filter.</p>
</div>
<div class="paragraph">
<p>The declaration for this architecture is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">parser</span> Parser<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> packet<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> H headers<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">control</span> Filter<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> H headers<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">out</span> <span style="color: #953800">bool</span> accept<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">package</span> Program<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>Parser<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span> p<span style="color: #24292f;background-color: #f6f8fa">,</span> Filter<span style="color: #0550ae">&lt;</span>H<span style="color: #0550ae">&gt;</span> f<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-p4-abstract-mach">18. P4 abstract machine: Evaluation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The evaluation of a P4 program is done in two stages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>static evaluation</strong>: at compile time the P4 program is
analyzed and all stateful blocks are instantiated.</p>
</li>
<li>
<p><strong>dynamic evaluation</strong>: at runtime each P4 functional block is
executed to completion, in isolation, when it receives control from the
architecture</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="sec-compile-time-known">18.1. Compile-time known and local compile-time known values</h3>
<div class="paragraph">
<p>Certain expressions in a P4 program have the property that their value
can be determined at compile time. Moreover, for some of these
expressions, their value can be determined only using information in
the current scope. We call these <em>compile-time known values</em> and
<em>local compile-time known values</em> respectively.</p>
</div>
<div class="paragraph">
<p>The following are local compile-time known values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Integer literals, Boolean literals, and string literals.</p>
</li>
<li>
<p>Identifiers declared as constants using the <code>const</code> keyword.</p>
</li>
<li>
<p>Identifiers declared in an <code>error</code>, <code>enum</code>, or <code>match_kind</code> declaration.</p>
</li>
<li>
<p>The <code>default</code> identifier.</p>
</li>
<li>
<p>The <code>size</code> field of a value with type header stack.</p>
</li>
<li>
<p>The <code>_</code> identifier when used as a <code>select</code> expression label</p>
</li>
<li>
<p>The expression <code>{#}</code> representing an invalid header or header union value.</p>
</li>
<li>
<p>Instances constructed by instance declarations (Section [#sec-instantiations]) and constructor invocations.</p>
</li>
<li>
<p>Identifiers that represent declared types, actions, functions, tables, parsers, controls, or packages.</p>
</li>
<li>
<p>Tuple expression where all components are local compile-time known values.</p>
</li>
<li>
<p>Structure-valued expressions, where all fields are local compile-time known values.</p>
</li>
<li>
<p>Expressions evaluating to a list type, where all elements are local compile-time known values.</p>
</li>
<li>
<p>Legal casts applied to local compile-time known values.</p>
</li>
<li>
<p>The following expressions (<code>`, `-`, `||</code>, <code>|-|</code>, <code>*</code>, <code>/ `, `%</code>, <code>!</code>, <code>&amp;</code>, <code>|</code>, <code>^</code>, <code>&amp;&amp;</code>, <code>||</code>, <code>&lt;&lt; `, `&gt;&gt;</code>, <code>~</code>, <code>/</code>, <code>&gt;</code>, <code>&lt;</code>, <code>==</code>, <code>!=</code>, <code>&#8656;</code>, <code>&gt;=</code>, <code>++</code>, <code>[:]</code>, <code>?:</code>) when their operands are all local compile-time known values.</p>
</li>
<li>
<p>Expressions of the form <code>e.minSizeInBits()</code>, <code>e.minSizeInBytes()</code>, <code>e.maxSizeInBits()</code> and <code>e.maxSizeInBytes()</code> where the type of <code>e</code> is not generic.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following are compile-time known values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All local compile-time known values.</p>
</li>
<li>
<p>Constructor parameters (i.e., the declared parameters for a <code>parser</code>, <code>control</code>, etc.)</p>
</li>
<li>
<p>Tuple expression where all components are compile-time known values.</p>
</li>
<li>
<p>Expressions evaluating to a list type, where all elements are compile-time known values.</p>
</li>
<li>
<p>Structure-valued expressions, where all fields are compile-time known values.</p>
</li>
<li>
<p>Expressions evaluating to a list type, where all elements are compile-time known values.</p>
</li>
<li>
<p>Legal casts applied to compile-time known values.</p>
</li>
<li>
<p>The following expressions (<code>`, `-`, `||</code>, <code>|-|</code>, <code>*</code>, <code>/ `, `%</code>, <code>cast</code>, <code>!</code>, <code>&amp;</code>, <code>|</code>, <code>^</code>, <code>&amp;&amp;</code>, <code>||</code>, <code>&lt;&lt; `, `&gt;&gt; `, `~</code>, <code>/</code>, <code>&gt;</code>, <code>&lt;</code>, <code>==</code>, <code>!=</code>, <code>&#8656;</code>, <code>&gt;=</code>, <code>++</code>, <code>[:]</code>, <code>?:</code>) when their operands are all compile-time known values.</p>
</li>
<li>
<p>Expressions of the form <code>e.minSizeInBits()</code>, <code>e.minSizeInBytes()</code>, <code>e.maxSizeInBits()</code> and <code>e.maxSizeInBytes()</code> where the the type of <code>e</code> is generic.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Intuitively, the main difference between <em>compile-time known values</em>
and <em>local compile-time known values</em> is that the former also contains
constructor parameters. The distinction is important when it comes to
defining the meaning of features like types. For example, in the type
<code>bit&lt;e&gt;</code>, the expression <code>e</code> must be a local compile-time known
value. Suppose instead that <code>e</code> were a constructor parameter---i.e.,
merely a compile-time known value. In this situation, it would be
impossible to resolve <code>bit&lt;e&gt;</code> to a concrete type using purely local
information---we would have to wait until the constructor was
instantiated and the value of <code>e</code> known.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-ct-eval">18.2. Compile-time Evaluation</h3>
<div class="paragraph">
<p>Evaluation of a program proceeds in order of declarations, starting in
the top-level namespace:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All declarations (e.g., <code>parsers</code>, <code>controls</code>, types,
constants) evaluate to themselves.</p>
</li>
<li>
<p>Each <code>table</code> evaluates to a table instance.</p>
</li>
<li>
<p>Constructor invocations evaluate to stateful objects of the
corresponding type. For this purpose, all constructor arguments are
evaluated recursively and bound to the constructor
parameters. Constructor arguments must be compile-time known
values. The order of evaluation of the constructor arguments should
be unimportant --- all evaluation orders should produce the same
results.</p>
</li>
<li>
<p>Instantiations evaluate to named stateful objects.</p>
</li>
<li>
<p>The instantiation of a <code>parser</code> or <code>control</code> block
recursively evaluates all stateful instantiations declared in the
block.</p>
</li>
<li>
<p>The result of the program&#8217;s evaluation is the value of the top-level <code>main</code>
variable.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that all stateful values are instantiated at compilation time.</p>
</div>
<div class="paragraph">
<p>As an example, consider the following program fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// architecture declaration
</span><span style="color: #cf222e">parser</span> P<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">control</span> C<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">control</span> D<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">package</span> Switch<span style="color: #24292f;background-color: #f6f8fa">(</span>P prs<span style="color: #24292f;background-color: #f6f8fa">,</span> C ctrl<span style="color: #24292f;background-color: #f6f8fa">,</span> D dep<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">extern</span> Checksum16 <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span><span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// user code
</span>Checksum16<span style="color: #24292f;background-color: #f6f8fa">()</span> ck16<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// checksum unit instance
</span>
<span style="color: #cf222e">parser</span> TopParser<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)(</span>Checksum16 unit<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> Pipe<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> TopDeparser<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)(</span>Checksum16 unit<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span><span style="color: #24292f;background-color: #f6f8fa">}</span>

Switch<span style="color: #24292f;background-color: #f6f8fa">(</span>TopParser<span style="color: #24292f;background-color: #f6f8fa">(</span>ck16<span style="color: #24292f;background-color: #f6f8fa">),</span>
       Pipe<span style="color: #24292f;background-color: #f6f8fa">(),</span>
       TopDeparser<span style="color: #24292f;background-color: #f6f8fa">(</span>ck16<span style="color: #24292f;background-color: #f6f8fa">))</span> main<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The evaluation of this program proceeds as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The declarations of <code>P</code>, <code>C</code>, <code>D</code>, <code>Switch</code>, and <code>Checksum16</code> all
evaluate to themselves.</p>
</li>
<li>
<p>The <code>Checksum16() ck16</code> instantiation is evaluated and it
produces an object named <code>ck16</code> with type <code>Checksum16</code>.</p>
</li>
<li>
<p>The declarations for <code>TopParser</code>, <code>Pipe</code>, and <code>TopDeparser</code>
evaluate as themselves.</p>
</li>
<li>
<p>The <code>main</code> variable instantiation is evaluated:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The arguments to the constructor are evaluated recursively</p>
</li>
<li>
<p><code>TopParser(ck16)</code> is a constructor invocation</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Its argument is evaluated recursively; it evaluates to the <code>ck16</code>
object</p>
</li>
</ol>
</div>
</li>
<li>
<p>The constructor itself is evaluated, leading to the
instantiation of an object of type <code>TopParser</code></p>
</li>
<li>
<p>Similarly, <code>Pipe()</code> and <code>TopDeparser(ck16)</code> are
evaluated as constructor calls.</p>
</li>
<li>
<p>All the arguments of the <code>Switch</code> package constructor have
been evaluated (they are an instance of <code>TopParser</code>, an
instance of <code>Pipe</code>, and an instance of <code>TopDeparser</code>).
Their signatures are matched with the <code>Switch</code> declaration.</p>
</li>
<li>
<p>Finally, the <code>Switch</code> constructor can be evaluated. The
result is an instance of the <code>Switch</code> package (that
contains a <code>TopParser</code> named <code>prs</code> the first
parameter of the <code>Switch</code>; a <code>Pipe</code> named <code>ctrl</code>;
and a <code>TopDeparser</code> named <code>dep</code>).</p>
</li>
</ol>
</div>
</li>
<li>
<p>The result of the program evaluation is the value of the <code>main</code>
variable, which is the above instance of the <code>Switch</code> <code>package</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="#fig-compileeval">Figure 14</a> shows the result of the evaluation in a
graphical form. The result is always a graph of instances. There is
only one instance of <code>Checksum16</code>, called <code>ck16</code>, shared
between the <code>TopParser</code> and <code>TopDeparser</code>. Whether this is
possible is architecture-dependent. Specific target compilers may
require distinct checksum units to be used in distinct blocks.</p>
</div>
<div id="fig-compileeval" class="imageblock text-center">
<div class="content">
<img src="resources/figs/compileeval.png" alt="compileeval" width="250">
</div>
<div class="title">Figure 14. Evaluation result.</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-cp-names">18.3. Control plane names</h3>
<div class="paragraph">
<p>Every controllable entity exposed in a P4 program must be assigned a
unique, fully-qualified name, which the control plane may use to
interact with that entity.  The following entities are controllable.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>value sets</p>
</li>
<li>
<p>tables</p>
</li>
<li>
<p>keys</p>
</li>
<li>
<p>actions</p>
</li>
<li>
<p>extern instances</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A fully qualified name consists of the local name of a controllable
entity prepended with the fully qualified name of its enclosing
namespace.  Hence, the following program constructs, which enclose
controllable entities, must themselves have unique, fully-qualified
names.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>control instances</p>
</li>
<li>
<p>parser instances</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Evaluation may create multiple instances from one type, each of which
must have a unique, fully-qualified name.</p>
</div>
<div class="sect3">
<h4 id="_computing_control_plane_names">18.3.1. Computing control-plane names</h4>
<div class="paragraph">
<p>The fully-qualified name of a construct is derived by concatenating
the fully-qualified name of its enclosing construct with its local
name.  Constructs with no enclosing namespace, i.e. those defined at
the global scope, have the same local and fully-qualified names.  The
local names of controllable entities and enclosing constructs are
derived from the syntax of a P4 program as follows.</p>
</div>
<div class="sect4">
<h5 id="sec-cp-value-set">18.3.1.1. Value sets</h5>
<div class="paragraph">
<p>For each <code>value_set</code> construct, its syntactic name becomes the local
name of the value set.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> <span style="color: #953800">vsk_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #0550ae">@match</span><span style="color: #24292f;background-color: #f6f8fa">(</span>ternary<span style="color: #24292f;background-color: #f6f8fa">)</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> port<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">value_set</span><span style="color: #0550ae">&lt;</span><span style="color: #953800">vsk_t</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">4</span><span style="color: #24292f;background-color: #f6f8fa">)</span> pvs<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This value_set&#8217;s local name is <code>pvs</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-cp-tables">18.3.1.2. Tables</h5>
<div class="paragraph">
<p>For each <code>table</code> construct, its syntactic name becomes the local
name of the table.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> c<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This table&#8217;s local name is <code>t</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-cp-keys">18.3.1.3. Keys</h5>
<div class="paragraph">
<p>Syntactically, table keys are expressions.  For simple expressions,
the local key name can be generated from the expression itself; the
algorithm by which a compiler derives control-plane names for complex
key expressions is target-dependent.</p>
</div>
<div class="paragraph">
<p>The spec suggests, but does not mandate, the following algorithm for
generating names for some kinds of key expressions:</p>
</div>
<table class="tableblock frame-all grid-all center" style="width: 80%;">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kind</th>
<th class="tableblock halign-left valign-top">Example</th>
<th class="tableblock halign-left valign-top">Name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>isValid()</code> method.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>h.isValid()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"h.isValid()"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Array accesses.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>header_stack[1]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"header_stack[1]"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Constants.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"1"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field projections.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>data.f1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"data.f1"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Slices.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>f1[3:0]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"f1[3:0]"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Masks.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>h.src &amp; 0xFFFF</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"h.src &amp; 0xFFFF"</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In the following example, the previous algorithm would derive for
table <code>t</code> two keys with names <code>data.f1</code> and <code>hdrs[3].f2</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    keys <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        data<span style="color: #0550ae">.</span>f1 <span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span>
        hdrs<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">]</span><span style="color: #0550ae">.</span>f2 <span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If a compiler cannot generate a name for a key it <strong>requires</strong> the key
expression to be annotated with a <code>@name</code> annotation (<a href="#sec-control-plane-api-annotations">Section 20.3.3</a>), as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    keys <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        data<span style="color: #0550ae">.</span>f1 <span style="color: #0550ae">+</span> <span style="color: #0550ae">1</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> exact <span style="color: #0550ae">@name</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"f1_mask"</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the <code>@name("f1_mask")</code> annotation assigns the local name <code>"f1_mask"</code>
to this key.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-cp-actions">18.3.1.4. Actions</h5>
<div class="paragraph">
<p>For each <code>action</code> construct, its syntactic name is the local name
of the action.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> c<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">action</span> a<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">...</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This action&#8217;s local name is <code>a</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="sec-cp-instances">18.3.1.5. Instances</h5>
<div class="paragraph">
<p>The local names of <code>extern</code>, <code>parser</code>, and <code>control</code>
instances are derived based on how the instance is used.  If the
instance is bound to a name, that name becomes its local control plane
name.  For example, if <code>control</code> <code>C</code> is declared as,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> C<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #6e7781">/* parameters omitted */</span><span style="color: #24292f;background-color: #f6f8fa">)()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and instantiated as,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">C<span style="color: #24292f;background-color: #f6f8fa">()</span> c_inst<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>then the local name of the instance is <code>c_inst</code>.</p>
</div>
<div class="paragraph">
<p>Alternatively, if the instance is created as an actual argument, then its
local name is the name of the formal parameter to which it will be
bound. For example, if <code>extern</code> <code>E</code> and <code>control</code> <code>C</code> are declared as,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> E <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> C<span style="color: #24292f;background-color: #f6f8fa">(</span> <span style="color: #6e7781">/* parameters omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">)(</span>E e_in<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and instantiated as,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">C<span style="color: #24292f;background-color: #f6f8fa">(</span>E<span style="color: #24292f;background-color: #f6f8fa">())</span> c_inst<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>then the local name of the extern instance is <code>e_in</code>.</p>
</div>
<div class="paragraph">
<p>If the construct being instantiated is passed as an argument to a
package, the instance name is derived from the user-supplied type
definition when possible.  In the following example, the local name of
the instance of <code>MyC</code> is <code>c</code>, and the local name of the <code>extern</code>
is <code>e2</code>, not <code>e1</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> E <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> ArchC<span style="color: #24292f;background-color: #f6f8fa">(</span>E e1<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #cf222e">package</span> Arch<span style="color: #24292f;background-color: #f6f8fa">(</span>ArchC c<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">control</span> MyC<span style="color: #24292f;background-color: #f6f8fa">(</span>E e2<span style="color: #24292f;background-color: #f6f8fa">)()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
Arch<span style="color: #24292f;background-color: #f6f8fa">(</span>MyC<span style="color: #24292f;background-color: #f6f8fa">())</span> main<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in this example, the architecture will supply an instance of
the extern when it applies the instance of <code>MyC</code> passed to the <code>Arch</code>
package.  The fully-qualified name of that instance is <code>main.c.e2</code>.</p>
</div>
<div class="paragraph">
<p>Next, consider a larger example that demonstrates name generation when
there are multiple instances.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> Callee<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> t<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> Caller<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    Callee<span style="color: #24292f;background-color: #f6f8fa">()</span> c1<span style="color: #24292f;background-color: #f6f8fa">;</span>
    Callee<span style="color: #24292f;background-color: #f6f8fa">()</span> c2<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
       c1<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
       c2<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> Simple<span style="color: #24292f;background-color: #f6f8fa">();</span>
<span style="color: #cf222e">package</span> Top<span style="color: #24292f;background-color: #f6f8fa">(</span>Simple s<span style="color: #24292f;background-color: #f6f8fa">);</span>
Top<span style="color: #24292f;background-color: #f6f8fa">(</span>Caller<span style="color: #24292f;background-color: #f6f8fa">())</span> main<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The compile-time evaluation of this program produces the structure in
<a href="#fig-evalmultiple">Figure 15</a>. Notice that there are two instances of the <code>table t</code>.
These instances must both be exposed to the control plane. To name an
object in this hierarchy, one uses a path composed of the names of
containing instances.  In this case, the two tables have names <code>s.c1.t</code>
and <code>s.c2.t</code>, where <code>s</code> is the name of the argument to the
package instantiation, which is derived from the name of its
corresponding formal parameter.</p>
</div>
<div id="fig-evalmultiple" class="imageblock text-center">
<div class="content">
<img src="resources/figs/evalmultiple.png" alt="evalmultiple" width="250">
</div>
<div class="title">Figure 15. Evaluating a program that has several instantiations of the same component.</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-name-annotations">18.3.2. Annotations controlling naming</h4>
<div class="paragraph">
<p>Control plane-related annotations (<a href="#sec-control-plane-api-annotations">Section 20.3.3</a>) can alter the names exposed to
the control plane in the following ways.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>@hidden</code> annotation hides a controllable entity from the
control plane.  This is the only case in which a controllable entity
is not required to have a unique, fully-qualified name.</p>
</li>
<li>
<p>The <code>@name</code> annotation may be used to change the local name of a
controllable entity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Programs that yield the same fully-qualified name for two different
controllable entities are invalid.</p>
</div>
</div>
<div class="sect3">
<h4 id="_recommendations">18.3.3. Recommendations</h4>
<div class="paragraph">
<p>The control plane may refer to a controllable entity by a postfix of
its fully qualified name when it is unambiguous in the context in
which it is used.  Consider the following example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> c<span style="color: #24292f;background-color: #f6f8fa">(</span> <span style="color: #6e7781">/* parameters omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">)()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">action</span> a <span style="color: #24292f;background-color: #f6f8fa">(</span> <span style="color: #6e7781">/* parameters omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
        keys <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> a<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
c<span style="color: #24292f;background-color: #f6f8fa">()</span> c_inst<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Control plane software may refer to action <code>c_inst.a</code> as <code>a</code>
when inserting rules into table <code>c_inst.t</code>, because it is clear
from the definition of the table which action <code>a</code> refers to.</p>
</div>
<div class="paragraph">
<p>Not all unambiguous postfix shortcuts are recommended. For instance, consider the
first example in <a href="#sec-cp-names">Section 18.3</a>.  One might be tempted to
refer to <code>s.c1</code> simply as <code>c1</code>, as no other instance named <code>c1</code>
appears in the program.  However, this leads to a brittle
program since future modifications can never introduce an instance named <code>c1</code>,
or include libraries of P4 code that contain instances with that name.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-dynamic-eval">18.4. Dynamic evaluation</h3>
<div class="paragraph">
<p>The dynamic evaluation of a P4 program is orchestrated by the architecture
model. Each architecture model needs to specify the order and the conditions
under which the various P4 component programs are dynamically
executed. For example, in the Simple Switch example from <a href="#sec-vss-arch">Section 5.1</a> the execution flow goes <code>Parser&#8594;Pipe&#8594;Deparser</code>.</p>
</div>
<div class="paragraph">
<p>Once a P4 execution block is invoked its execution proceeds until
termination according to the semantics defined in this document.</p>
</div>
<div class="sect3">
<h4 id="sec-concurrency">18.4.1. Concurrency model</h4>
<div class="paragraph">
<p>A typical packet processing system needs to execute multiple
simultaneous logical "threads." At the very least there is a thread
executing the control plane, which can modify the contents of the
tables. Architecture specifications should describe in detail the
interactions between the control-plane and the data-plane. The data
plane can exchange information with the control plane through <code>extern</code>
function and method calls. Moreover, high-throughput packet-processing
systems may be processing multiple packets simultaneously, e.g., in a
pipelined fashion, or concurrently parsing a first packet while
performing match-action operations on a second packet. This section
specifies the semantics of P4 programs with respect to such concurrent
executions.</p>
</div>
<div class="paragraph">
<p>Each top-level <code>parser</code> or <code>control</code> block is executed as a
separate thread when invoked by the architecture. All the parameters
of the block and all local variables are thread-local---i.e., each
thread has a private copy of these resources. This applies to the <code>packet_in</code>
and <code>packet_out</code> parameters of parsers and deparsers.</p>
</div>
<div class="paragraph">
<p>As long as a P4 block uses only thread-local storage (e.g., metadata,
packet headers, local variables), its behavior in the presence of
concurrency is identical with the behavior in isolation, since any
interleaving of statements from different threads must produce the
same output.</p>
</div>
<div class="paragraph">
<p>In contrast, <code>extern</code> blocks instantiated by a P4 program are
global, shared across all threads. If <code>extern</code> blocks mediate
access to state (e.g., counters, registers)---i.e., the methods of
the <code>extern</code> block read and write state, these stateful operations
are subject to data races. P4 mandates that
execution of a method call on an extern instance is atomic.</p>
</div>
<div class="paragraph">
<p>To allow users to express atomic execution of larger code blocks, P4
provides an <code>@atomic</code> annotation, which can be applied to block
statements, parser states, control blocks, or whole parsers.</p>
</div>
<div class="paragraph">
<p>Consider the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> Register <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> Ingress<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  Register<span style="color: #24292f;background-color: #f6f8fa">()</span> r<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #cf222e">table</span> flowlet <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* read state of r in an action */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
  <span style="color: #cf222e">table</span> new_flowlet <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* write state of r in an action */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
  <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #0550ae">@atomic</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
       flowlet<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
       <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ingress_metadata<span style="color: #0550ae">.</span>flow_ipg <span style="color: #0550ae">&gt;</span> FLOWLET_INACTIVE_TIMEOUT<span style="color: #24292f;background-color: #f6f8fa">)</span>
          new_flowlet<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
<span style="color: #24292f;background-color: #f6f8fa">}}}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This program accesses an extern object <code>r</code> of type <code>Register</code>
in actions invoked from tables <code>flowlet</code> (reading) and <code>new_flowlet</code>
(writing). Without the <code>@atomic</code> annotation these two operations
would not execute atomically: a second packet may read the state of <code>r</code>
before the first packet had a chance to update it.</p>
</div>
<div class="paragraph">
<p>Note that even within an <code>action</code> definition, if the action does
something like reading a register, modifying it, and writing it back,
in a way that only the modified value should be visible to the next
packet, then, to guarantee correct execution in all cases, that
portion of the action definition should be enclosed within a block
annotated with <code>@atomic</code>.</p>
</div>
<div class="paragraph">
<p>A compiler backend must reject a program containing <code>@atomic</code>
blocks if it cannot implement the atomic execution of the instruction
sequence. In such cases, the compiler should provide reasonable
diagnostics.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-static-assert">19. Static assertions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The P4 core library contains two overloaded declarations for a
<code>static_assert</code> function, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">/// Static assert evaluates a boolean expression
/// at compilation time.  If the expression evaluates to
/// false, compilation is stopped and the corresponding message is printed.
</span><span style="color: #cf222e">extern</span> <span style="color: #953800">bool</span> static_assert<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bool</span> check<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">string</span> message<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #6e7781">/// Like the above but using a default message.
</span><span style="color: #cf222e">extern</span> <span style="color: #953800">bool</span> static_assert<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bool</span> check<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These functions both return boolean values.  Since the parameters are
directionless, these functions require compile-time known values as
arguments, thus they can be used to enforce compile-time invariants.
Since P4 does not allow statements at the program top-level (outside
of apply blocks), these functions can be used at the top-level by
assigning their result to a dummy constant, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">const</span> <span style="color: #953800">bool</span> <span style="color: #0550ae">_</span>check <span style="color: #0550ae">=</span> static_assert<span style="color: #24292f;background-color: #f6f8fa">(</span>V1MODEL_VERSION <span style="color: #0550ae">&gt;</span> <span style="color: #0550ae">20180000</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
                                  <span style="color: #0a3069">"Expected a v1 model version &gt;= 20180000"</span><span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As the comment indicates, if <code>static_assert</code> returns <code>false</code>, it
causes the program compilation to be terminated immediately with an
error.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-annotations">20. Annotations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Annotations are a simple mechanism for extending the P4 language to
some limited degree without changing the grammar. Annotations are
attached to types, fields, variables, etc. using the <code>@</code> syntax
(as shown explicitly in the P4 grammar). Unstructured annotations,
or just "annotations," have an optional body; structured annotations
have a mandatory body, containing at least a pair of square brackets
<code>[]</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">optAnnotations
    : /* empty */
    | annotations
    ;

annotations
    : annotation
    | annotations annotation
    ;

annotation
    : "@" name
    | "@" name "(" annotationBody ")"
    | "@" name "[" structuredAnnotationBody "]"
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Structured annotations and unstructured annotations on any one element must not
use the same <code>name</code>. Thus, a given <code>name</code> can only be applied to one type of
annotation or the other for any one element. An annotation used on one element
does not affect the annotation on another because they have different scope.</p>
</div>
<div class="paragraph">
<p>This is legal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@my_anno</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">table</span> T <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #0550ae">@my_anno</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #cf222e">table</span> U <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #6e7781">// OK - different scope than previous
</span>                                           <span style="color: #6e7781">// use of my_anno</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is illegal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@my_anno</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #0550ae">@my_anno</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #cf222e">table</span> U <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #6e7781">// Error - changed type of anno
</span>                                           <span style="color: #6e7781">// on an element</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple unstructured annotations using the same <code>name</code> can appear on a given
element; they are cumulative. Each one will be bound to that element. In
contrast, only one structured annotation using a given <code>name</code> may appear on an
element; multiple uses of the same <code>name</code> will produce an error.</p>
</div>
<div class="paragraph">
<p>This is legal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@my_anno</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #0550ae">@my_anno</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">table</span> U <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>  <span style="color: #6e7781">// OK - unstructured annos accumulate</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is illegal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@my_anno</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">]</span>
<span style="color: #0550ae">@my_anno</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #cf222e">table</span> U <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #6e7781">// Error - reused the same structured
</span>                                           <span style="color: #6e7781">// anno on an element</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_bodies_of_unstructured_annotations">20.1. Bodies of Unstructured Annotations</h3>
<div class="paragraph">
<p>The flexibility of P4 unstructured annotations comes from the minimal structure
mandated by the P4 grammar: unstructured annotation bodies may contain any
sequence of terminals, so long as parentheses are balanced. In the following
grammar fragment, the <code>annotationToken</code> non-terminal represents any terminal
produced by the lexer, including keywords, identifiers, string and integer
literals, and symbols, but excluding parentheses.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">annotationBody
    : /* empty */
    | annotationBody "(" annotationBody ")"
    | annotationBody annotationToken
    ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unstructured annotations may impose additional structure on their
bodies, and are not confined to the P4 language. For example, the
P4Runtime specification <sup class="footnoteref">[<a class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup> defines a <code>@pkginfo</code> annotation
that expects key-value pairs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bodies_of_structured_annotations">20.2. Bodies of Structured Annotations</h3>
<div class="paragraph">
<p>Unlike unstructured annotations, structured annotations use square brackets
<code>[&#8230;&#8203;]</code> and have a restricted format. They are commonly used to declare custom
metadata, consisting of expression lists or key-value lists but not both. An
<code>expressionList</code> may be empty or contain a comma-separated list of member
<code>expression</code>s. A <code>kvList</code> consists of one or more <code>kvPair</code>s, each consisting of
a key and a value <code>expression</code>. Note the syntax for <code>expression</code> is rich, see
<a href="#sec-grammar">Appendix G</a> for details.</p>
</div>
<div class="paragraph">
<p>All <code>expression`s within a `structuredAnnotationBody</code> must be compile-time known
values with a result type that is either: <code>string</code>, <code>int</code>, or <code>bool</code>.
In particular, structured <code>expression`s (e.g. an `expression</code> containing an
<code>expressionList</code>, a <code>kvList</code>, etc.) are not allowed. Note that P4Runtime
information (P4Info) may stipulate additional restrictions. For example, an
integer expression might be limited to 64-bit values.</p>
</div>
<div class="paragraph">
<p>It is illegal to duplicate a <code>key</code> within the <code>kvList</code> of a structured
annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">structuredAnnotationBody
    : expressionList optTrailingComma
    | kvList optTrailingComma
    ;
...
expressionList
    : /* empty */
    | expression
    | expressionList "," expression
    ;
...
kvList
    : kvPair
    | kvList "," kvPair
    ;

kvPair
    : name "=" expression
    ;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_structured_annotation_examples">20.2.1. Structured Annotation Examples</h4>
<div class="paragraph">
<p><strong>Empty Expression List</strong></p>
</div>
<div class="paragraph">
<p>The following example produces an empty annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@Empty</span><span style="color: #24292f;background-color: #f6f8fa">[]</span>
<span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">/* body omitted */</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Mixed Expression List</strong></p>
</div>
<div class="paragraph">
<p>The following example will produce an effective expression list as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code>[1,"hello",true, false, 11]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">#define</span> TEXT_CONST <span style="color: #0a3069">"hello"</span>
<span style="color: #6e7781">#define</span> NUM_CONST <span style="color: #0550ae">6</span>
<span style="color: #0550ae">@MixedExprList</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">,</span>TEXT_CONST<span style="color: #24292f;background-color: #f6f8fa">,</span>true<span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #0550ae">1</span><span style="color: #0550ae">==</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">,</span><span style="color: #0550ae">5</span><span style="color: #0550ae">+</span>NUM_CONST<span style="color: #24292f;background-color: #f6f8fa">]</span>
<span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">/* body omitted */</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>kvList of Strings</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@Labels</span><span style="color: #24292f;background-color: #f6f8fa">[</span>short<span style="color: #0550ae">=</span><span style="color: #0a3069">"Short Label"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> hover<span style="color: #0550ae">=</span><span style="color: #0a3069">"My Longer Table Label to appear in hover-help"</span><span style="color: #24292f;background-color: #f6f8fa">]</span>
<span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">/* body omitted */</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>kvList of Mixed Expressions</strong></p>
</div>
<div class="paragraph">
<p>The following example will produce an effective kvList as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code>[label="text", my_bool=true, int_val=6]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@MixedKV</span><span style="color: #24292f;background-color: #f6f8fa">[</span>label<span style="color: #0550ae">=</span><span style="color: #0a3069">"text"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> my_bool<span style="color: #0550ae">=</span>true<span style="color: #24292f;background-color: #f6f8fa">,</span> int_val<span style="color: #0550ae">=</span><span style="color: #0550ae">2</span><span style="color: #0550ae">*</span><span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">]</span>
<span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">/* body omitted */</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Illegal Mixing of <code>kvPair</code> and <code>expressionList</code></strong></p>
</div>
<div class="paragraph">
<p>The following example is invalid because the body contains both a <code>kvPair</code> and
an <code>expression</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@IllegalMixing</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #cf222e">key</span><span style="color: #0550ae">=</span><span style="color: #0550ae">4</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #6e7781">// illegal mixing
</span><span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">/* body omitted */</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Illegal Duplicate Key</strong></p>
</div>
<div class="paragraph">
<p>The following example is invalid because the same key occurs more than once:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@DupKey</span><span style="color: #24292f;background-color: #f6f8fa">[</span>k1<span style="color: #0550ae">=</span><span style="color: #0550ae">4</span><span style="color: #24292f;background-color: #f6f8fa">,</span>k1<span style="color: #0550ae">=</span><span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #6e7781">// illegal duplicate key
</span><span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">/* body omitted */</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Illegal Duplicate Structured Annotation</strong></p>
</div>
<div class="paragraph">
<p>The following example is invalid because the annotation <code>name</code> occurs more
than once on the same element, e.g. <code>table t</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@DupAnno</span><span style="color: #24292f;background-color: #f6f8fa">[</span>k1<span style="color: #0550ae">=</span><span style="color: #0550ae">4</span><span style="color: #24292f;background-color: #f6f8fa">]</span>
<span style="color: #0550ae">@DupAnno</span><span style="color: #24292f;background-color: #f6f8fa">[</span>k2<span style="color: #0550ae">=</span><span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #6e7781">// illegal duplicate name
</span><span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">/* body omitted */</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Illegal Simultaneous Use of Both Structured and Unstructured Annotation</strong></p>
</div>
<div class="paragraph">
<p>The following example is invalid because the annotation <code>name</code> is used by both
an unstructured and structured annotation on the same element <code>table t</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@MixAnno</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"Anything"</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #0550ae">@MixAnno</span><span style="color: #24292f;background-color: #f6f8fa">[</span>k2<span style="color: #0550ae">=</span><span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #6e7781">// illegal use in both annotation types
</span><span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">/* body omitted */</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_predefined_annotations">20.3. Predefined annotations</h3>
<div class="paragraph">
<p>Annotation names that start with lowercase letters are reserved for
the standard library and architecture.  This document pre-defines a
set of "standard" annotations in <a href="#sec-p4-reserved-annotations">Appendix C</a>.
We expect that this list will grow.
We encourage custom architectures to define annotations starting with
a manufacturer prefix: e.g., an organization named X would use
annotations named like <code>@X_annotation</code></p>
</div>
<div class="sect3">
<h4 id="sec-optional-parameter-annotations">20.3.1. Optional parameter annotations</h4>
<div class="paragraph">
<p>A parameter to a package, parser type, control type, extern method, extern function or extern
object constructor can be annotated with <code>@optional</code> to indicate that
the user does not need to provide a corresponding argument for that
parameter.  The meaning of a parameter with no supplied value is
target-dependent.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-table-action-anno">20.3.2. Annotations on the table action list</h4>
<div class="paragraph">
<p>The following two annotations can be used to give additional
information to the compiler and control-plane about actions in a
table. These annotations have no bodies.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@tableonly</code>: actions with this annotation can only appear
within the table, and never as default action.</p>
</li>
<li>
<p><code>@defaultonly</code>: actions with this annotation can only appear in
the default action, and never in the table.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
       a<span style="color: #24292f;background-color: #f6f8fa">,</span>              <span style="color: #6e7781">// can appear anywhere
</span>       <span style="color: #0550ae">@tableonly</span> b<span style="color: #24292f;background-color: #f6f8fa">,</span>   <span style="color: #6e7781">// can only appear in the table
</span>       <span style="color: #0550ae">@defaultonly</span> c<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #6e7781">// can only appear in the default action
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #6e7781">/* body omitted */</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-control-plane-api-annotations">20.3.3. Control-plane API annotations</h4>
<div class="paragraph">
<p>The <code>@name</code> annotation directs the compiler to use a different
local name when generating the external APIs used to manipulate a
language element from the control plane. This annotation takes a string literal
body.  In the
following example, the fully-qualified name of the table is <code>c_inst.t1</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> c<span style="color: #24292f;background-color: #f6f8fa">(</span> <span style="color: #6e7781">/* parameters omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">)()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #0550ae">@name</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"t1"</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
c<span style="color: #24292f;background-color: #f6f8fa">()</span> c_inst<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@hidden</code> annotation hides a controllable entity, e.g. a table,
key, action, or extern, from the control plane.  This effectively
removes its fully-qualified name (<a href="#sec-cp-names">Section 18.3</a>).  This annotation
does not have a body.</p>
</div>
<div class="sect4">
<h5 id="_restrictions">20.3.3.1. Restrictions</h5>
<div class="paragraph">
<p>Each element may be annotated with at most one <code>@name</code>
or <code>@hidden</code> annotation, and each control plane name must refer to
at most one controllable entity.  This is of special concern when
using an absolute <code>@name</code> annotation: if a type containing a <code>@name</code>
annotation with an absolute pathname (i.e., one starting with a dot)
is instantiated more than once, it will result in the same
name referring to two controllable entities.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> noargs<span style="color: #24292f;background-color: #f6f8fa">();</span>
<span style="color: #cf222e">package</span> top<span style="color: #24292f;background-color: #f6f8fa">(</span>noargs c1<span style="color: #24292f;background-color: #f6f8fa">,</span> noargs c2<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">control</span> c<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #0550ae">@name</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">".foo.bar"</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
top<span style="color: #24292f;background-color: #f6f8fa">(</span>c<span style="color: #24292f;background-color: #f6f8fa">(),</span> c<span style="color: #24292f;background-color: #f6f8fa">())</span> main<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Without the <code>@name</code> annotation, this program would produce
two controllable entities with fully-qualified names <code>main.c1.t</code> and <code>main.c2.t</code>.
However, the <code>@name(".foo.bar")</code> annotation renames table <code>t</code>
in both instances to <code>foo.bar</code>, resulting in one name that refers
to two controllable entities, which is illegal.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_concurrency_control_annotations">20.3.4. Concurrency control annotations</h4>
<div class="paragraph">
<p>The <code>@atomic</code> annotation, described in <a href="#sec-concurrency">Section 18.4.1</a>
can be used to enforce the atomic execution of a code block.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-value-set-annotations">20.3.5. Value set annotations</h4>
<div class="paragraph">
<p>The <code>@match</code> annotation, described in <a href="#sec-select">Section 13.6</a>, is used
to specify a <code>match_kind</code> value other than the default <code>match_kind</code> of
<code>exact</code> for a field of a <code>value_set</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-extern-annotations">20.3.6. Extern function/method annotations</h4>
<div class="paragraph">
<p>Various annotations may appear on extern function and method
declarations to describe limitations on the behavior and interactions
of those functions.  By default extern functions might have any effect
on the environment of the P4 program and might interact in non-trivial
ways (subject to a few limitations&#8201;&#8212;&#8201;see <a href="#sec-calling-convention">Section 6.8</a>).  Since externs are
architecture-specific and their behavior is known to the architecture
definition, these annotations are not strictly necessary (an
implementation can have knowledge of how externs interact based on
their names built into it), but these annotations provide a uniform
way of describing certain well-defined interactions (or their
absence), allowing architecture-independent analysis of P4 programs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@pure</code> - Describes a function that depends solely on its <code>in</code>
parameter values, and has no effect other than returning a value,
and copy-out behavior on its <code>out</code> and <code>inout</code> parameters.  No
hidden state is recorded between calls, and its value does not
depend on any hidden state that may be changed by other calls.  An
example is a <code>hash</code> function that computes a deterministic hash of
its arguments, and its return value does not depend upon any
control-plane writable seed or initialization vector value.  A
<code>@pure</code> function whose results are unused may be safely eliminated
with no adverse effects, and multiple calls with identical arguments
may be combined into a single call (subject to the limits imposed by
copy-out behavior of <code>out</code> and <code>inout</code> parameters).  <code>@pure</code>
functions may also be reordered with respect to other computations
that are not data dependent.</p>
</li>
<li>
<p><code>@noSideEffects</code> - Weaker than <code>@pure</code> and describes a function that
does not change any hidden state, but may depend on hidden state.
One example is a <code>hash</code> function that computes a deterministic hash
of its arguments, plus some internal state that can be modified via
control plane API calls such as a seed or initialization vector.
Another example is a read of one element of a register array extern
object.  Such a function may be dead code eliminated, and may be
reordered or combined with other <code>@noSideEffects</code> or <code>@pure</code> calls
(subject to the limits imposed by copy-out behavior of <code>out</code> and
<code>inout</code> parameters), but not with other function calls that may have
side effects that affect the function.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="sec-deprecated-anno">20.3.7. Deprecated annotation</h4>
<div class="paragraph">
<p>The <code>deprecated</code> annotation has a required string argument that is a
message that will be printed by a compiler when a program is using the
deprecated construct.  This is mostly useful for annotating library
constructs, such as externs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@deprecated</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"Please use the 'check' function instead"</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">extern</span> Checker <span style="color: #24292f;background-color: #f6f8fa">{</span>
   <span style="color: #6e7781">/* body omitted */</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-nowarn-anno">20.3.8. No warnings annotation</h4>
<div class="paragraph">
<p>The <code>noWarn</code> annotation has a required string argument that indicates
a compiler warning that will be inhibited.  For example
<code>@noWarn("unused")</code> on a declaration will prevent a compiler warning
if that declaration is not used.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_target_specific_annotations">20.4. Target-specific annotations</h3>
<div class="paragraph">
<p>Each P4 compiler implementation can define additional annotations
specific to the target of the compiler. The syntax of the annotations
should conform to the above description. The semantics of such
annotations is target-specific. They could be used in a similar way to
pragmas in other languages.</p>
</div>
<div class="paragraph">
<p>The P4 compiler should provide:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Errors when annotations are used incorrectly (e.g., an annotation
expecting a parameter but used without arguments, or with arguments
of the wrong type)</p>
</li>
<li>
<p>Warnings for unknown annotations.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-revision-history">Appendix A: Revision History</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_summary_of_changes_made_in_unreleased_version">A.1. Summary of changes made in unreleased version</h3>

</div>
<div class="sect2">
<h3 id="_summary_of_changes_made_in_version_1_2_5_released_october_11_2024">A.2. Summary of changes made in version 1.2.5, released October 11, 2024</h3>
<div class="ulist">
<ul>
<li>
<p>Improved type nesting rules (<a href="#sec-type-nesting">Section 7.2.8</a>).</p>
</li>
<li>
<p>Clarified that directionless extern parameters are passed by reference.</p>
</li>
<li>
<p>Introduced distinction between local compile-time known and compile-time known values (<a href="#sec-compile-time-known">Section 18.1</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_summary_of_changes_made_in_version_1_2_4released_may_15_2023">A.3. Summary of changes made in version 1.2.4,released May 15, 2023</h3>
<div class="ulist">
<ul>
<li>
<p>Added header stack expressions (<a href="#sec-hs-init">Section 8.18.1</a>).</p>
</li>
<li>
<p>Allow casts from a type to itself (<a href="#sec-casts">Section 8.11</a>).</p>
</li>
<li>
<p>Added an invalid header or header union expression <code>{#}</code> (<a href="#sec-ops-on-hdrs">Section 8.17</a> and <a href="#sec-expr-hu">Section 8.19</a>).</p>
</li>
<li>
<p>Added a concept of numeric values (<a href="#sec-numeric-values">Section 7.4</a>).</p>
</li>
<li>
<p>Added a section on operations on extern objects (<a href="#sec-extern-operations">Section 8.22</a>).</p>
</li>
<li>
<p>Added note in sections operations on types for types that support compile-time size determination.</p>
</li>
<li>
<p>Clarified that header stacks are arrays of headers or header unions.</p>
</li>
<li>
<p>Added distinctness of fields for types that have fields including error, match kind, struct, header, and header union.</p>
</li>
<li>
<p>Clarified types <code>bit&lt;W&gt;</code>, <code>int&lt;W&gt;</code>, and <code>varbit&lt;W&gt;</code> encompass the case where the width is a compile-time known expression evaluating to an appropriate integer (<a href="#sec-unsigned-integers">Section 7.1.6.2</a>, <a href="#sec-signed-integers">Section 7.1.6.3</a>, <a href="#sec-dynamically-sized-integers">Section 7.1.6.4</a>).</p>
</li>
<li>
<p>Clarified restrictions for parameters with default values (<a href="#sec-calling-convention">Section 6.8</a>).</p>
</li>
<li>
<p>Added optional trailing commas (<a href="#sec-trailing-commas">Section 6.4.4</a>).</p>
</li>
<li>
<p>Clarified the scope of parser namespaces (<a href="#sec-parser-decl">Section 13.2</a>).</p>
</li>
<li>
<p>Specified that algorithm for generating control-plane names for keys is optional (<a href="#sec-cp-keys">Section 18.3.1.3</a>).</p>
</li>
<li>
<p>Clarified types of expressions that may appear in <code>select</code> (<a href="#sec-select">Section 13.6</a>).</p>
</li>
<li>
<p>Added description of semantics of the core.p4 match kinds (<a href="#sec-table-keys">Section 14.2.1.1</a>).</p>
</li>
<li>
<p>Explicitly disallow overloading of parsers, controls, and packages (<a href="#sec-extern-objects">Section 7.2.10.2</a>).</p>
</li>
<li>
<p>Clarified implicit casts present in select expressions (<a href="#sec-select">Section 13.6</a>).</p>
</li>
<li>
<p>Clarified that slices can be applied to arbitrary-precision integers (<a href="#sec-varint-ops">Section 8.8</a>).</p>
</li>
<li>
<p>Clarified that direct invocation is not possible for objects that have constructor arguments (<a href="#sec-direct-invocation">Section 15.1</a>).</p>
</li>
<li>
<p>Added comparison for tuples as a legal operation (<a href="#sec-tuple-exprs">Section 8.12</a>).</p>
</li>
<li>
<p>Clarified the behavior of <code>lookahead</code> on header-typed values (<a href="#sec-packet-lookahead">Section 13.8.3</a>).</p>
</li>
<li>
<p>Added <code>static_assert</code> function (<a href="#sec-static-assert">Chapter 19</a>).</p>
</li>
<li>
<p>Clarified semantics of ranges where the start is bigger than the end (<a href="#sec-ranges">Section 8.15.4</a>).</p>
</li>
<li>
<p>Allow ranges to be specified by serializable enums (<a href="#sec-ranges">Section 8.15.4</a>).</p>
</li>
<li>
<p>Specified type produced by the <code>*sizeInB*</code> methods (<a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</li>
<li>
<p>Added section with operations on <code>match_kind</code> values (<a href="#sec-match-kind-exprs">Section 8.4</a>).</p>
</li>
<li>
<p>Renamed infinite-precision integers to arbitrary-precision integers (<a href="#sec-arbitrary-precision-integers">Section 7.1.6.5</a>).</p>
</li>
<li>
<p>compiler-inserted <code>default_action</code> is not <code>const</code> (<a href="#sec-tables">Section 14.2</a>).</p>
</li>
<li>
<p>Clarified the restrictions on run time for tables with <code>const entries</code> (<a href="#sec-entries">Section 14.2.1.4</a>).</p>
</li>
<li>
<p>renamed list expressions to tuple expressions</p>
</li>
<li>
<p>Added <code>list</code> type (<a href="#sec-list-types">Section 7.2.7</a>).</p>
</li>
<li>
<p>Defined <code>entries</code> table property without <code>const</code>, for entries
installed when the P4 program is loaded, but the control plane can
later change them or add to them (<a href="#sec-entries">Section 14.2.1.4</a>).</p>
</li>
<li>
<p>Clarified behavior of table with no <code>key</code> property, or if its list
of keys is empty (<a href="#sec-table-keys">Section 14.2.1.1</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_summary_of_changes_made_in_version_1_2_3_released_july_11_2022">A.4. Summary of changes made in version 1.2.3, released July 11, 2022.</h3>
<div class="ulist">
<ul>
<li>
<p>Extended <code>minSizeInBits</code> and <code>minSizeInBytes</code> to apply to more expressions (<a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</li>
<li>
<p>Added support for <code>maxSizeInBits</code> and <code>maxSizeInBytes</code> (<a href="#sec-minsizeinbits">Chapter 9</a>).</p>
</li>
<li>
<p>Added support for empty lists of const entries in tables (<a href="#sec-entries">Section 14.2.1.4</a>).</p>
</li>
<li>
<p>Added support for <code>switch</code> statements in actions (<a href="#sec-actions">Section 14.1</a>).</p>
</li>
<li>
<p>Added support for direct invocation of controls and parsers (<a href="#sec-parameterization">Chapter 15</a>).</p>
</li>
<li>
<p>Added parser <code>value_set</code> to list of control-plane visible names (<a href="#sec-cp-names">Section 18.3</a>).</p>
</li>
<li>
<p>Added <code>match_kind</code> as a base type (<a href="#sec-match-kind-type">Section 7.1.3</a>).</p>
</li>
<li>
<p>Removed structure initializers as they are subsumed by structure-valued expressions (<a href="#sec-structure-expressions">Section 8.13</a>).</p>
</li>
<li>
<p>Specified operations on values typed as type variables (<a href="#sec-type-variable-operations">Section 8.24</a>).</p>
</li>
<li>
<p>Clarified semantics of compile-time known values (<a href="#sec-compile-time-known">Section 18.1</a>).</p>
</li>
<li>
<p>Clarified semantics of directionless parameters (<a href="#sec-calling-convention">Section 6.8</a>).</p>
</li>
<li>
<p>Clarified semantics of arbitrary precision integers (<a href="#sec-arbitrary-precision-integers">Section 7.1.6.5</a>).</p>
</li>
<li>
<p>Clarified semantics of bit slices, shifts, and concatenation (<a href="#sec-bit-ops">Section 8.6</a>).</p>
</li>
<li>
<p>Clarified semantics of optional parameters (<a href="#sec-optional-parameters">Section 6.8.2</a>).</p>
</li>
<li>
<p>Clarified restrictions on extern method and function invocation (<a href="#sec-calling-restrictions">Appendix F</a>).</p>
</li>
<li>
<p>Clarified semantics of implicit casts (<a href="#sec-implicit-casts">Section 8.11.2</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_summary_of_changes_made_in_version_1_2_2_released_may_17_2021">A.5. Summary of changes made in version 1.2.2, released May 17, 2021</h3>
<div class="ulist">
<ul>
<li>
<p>Added support for accessing tuple fields (<a href="#sec-tuple-exprs">Section 8.12</a>).</p>
</li>
<li>
<p>Added support for generic structures (<a href="#sec-type-spec">Section 7.2.11</a>).</p>
</li>
<li>
<p>Added support for integers, <code>enum</code>s, and <code>error</code>s in <code>switch</code> statements (<a href="#sec-switch-stmt">Section 12.7</a>).</p>
</li>
<li>
<p>Added support for additional enumeration types (<a href="#sec-enum-types">Section 7.2.1</a>).</p>
</li>
<li>
<p>Added support for abstract methods (<a href="#sec-abstract-methods">Section 7.2.10.2.1</a>).</p>
</li>
<li>
<p>Added support for conditional statements and empty statements in parsers (<a href="#sec-parser-state-stmt">Section 13.4</a>).</p>
</li>
<li>
<p>Added support for casts from <code>int</code> to <code>bool</code> (<a href="#sec-casts">Section 8.11</a>).</p>
</li>
<li>
<p>Added support for 0-width bitstrings and varbits (<a href="#sec-uninitialized-values-and-writing-invalid-headers">Section 8.25</a>).</p>
</li>
<li>
<p>Clarified that <code>default_action</code> is <code>NoAction</code> if otherwise unspecified (<a href="#sec-tables">Section 14.2</a>).</p>
</li>
<li>
<p>Clarified the types of expressions that may be used as indexes for header stacks (<a href="#sec-expr-hs">Section 8.18</a>).</p>
</li>
<li>
<p>Clarified representation of Booleans in headers (<a href="#sec-header-types">Section 7.2.2</a>).</p>
</li>
<li>
<p>Clarified representation of empty types (<a href="#sec-uninitialized-values-and-writing-invalid-headers">Section 8.25</a>).</p>
</li>
<li>
<p>Clarified that action data can be specified by the control plane, <code>default_action</code> table property, or <code>const entries</code> table property (<a href="#sec-actions">Section 14.1</a>).</p>
</li>
<li>
<p>Fixed several typos and inconsistencies in grammar (<a href="#sec-grammar">Appendix G</a>).</p>
</li>
<li>
<p>Eliminated annotations on <code>const</code> entries in grammar (<a href="#sec-grammar">Appendix G</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_summary_of_changes_made_in_version_1_2_1_released_june_11_2020">A.6. Summary of changes made in version 1.2.1, released June 11, 2020</h3>
<div class="ulist">
<ul>
<li>
<p>Added structure-value expressions (<a href="#sec-structure-expressions">Section 8.13</a>).</p>
</li>
<li>
<p>Added support for default values (<a href="#sec-default-values">Section 7.3</a>).</p>
</li>
<li>
<p>Added support for concatenating signed strings (<a href="#sec-concatenation">Section 8.9.1</a>).</p>
</li>
<li>
<p>Added key-value and list-structured annotations (<a href="#sec-annotations">Chapter 20</a>).</p>
</li>
<li>
<p>Added <code>@pure</code> and <code>@noSideEffects</code> annotations (<a href="#sec-extern-annotations">Section 20.3.6</a>).</p>
</li>
<li>
<p>Added <code>@noWarn</code> annotation (<a href="#sec-nowarn-anno">Section 20.3.8</a>).</p>
</li>
<li>
<p>Generalized typing for masks to allow serializable <code>enum</code>s (<a href="#sec-cubes">Section 8.15.3</a>).</p>
</li>
<li>
<p>Restricted the right operands of bit shifts involving
arbitrary-precision integers to be constant and positive (<a href="#sec-varint-ops">Section 8.8</a>).</p>
</li>
<li>
<p>Clarified copy-out behavior for <code>return</code> (<a href="#sec-return-stmt">Section 12.4</a>) and <code>exit</code> (<a href="#sec-exit-stmt">Section 12.5</a>)
statements.</p>
</li>
<li>
<p>Clarified semantics of invalid header stacks (<a href="#sec-uninitialized-values-and-writing-invalid-headers">Section 8.25</a>).</p>
</li>
<li>
<p>Clarified initialization semantics (<a href="#sec-lvalues">Section 6.7</a> and
<a href="#sec-calling-convention">Section 6.8</a>), especially for headers and local
variables.</p>
</li>
<li>
<p>Clarified evaluation order for table keys (<a href="#sec-mau-semantics">Section 14.2.3</a>).</p>
</li>
<li>
<p>Fixed grammar to clarify parsing of right shift operator (<code>&gt;&gt;</code>),
allow empty statements in parser (<a href="#sec-parser-state-stmt">Section 13.4</a>),
and eliminate annotations on const entries (<a href="#sec-entries">Section 14.2.1.4</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_summary_of_changes_made_in_version_1_2_0_released_october_14_2019">A.7. Summary of changes made in version 1.2.0, released October 14, 2019</h3>
<div class="ulist">
<ul>
<li>
<p>Added <code>table.apply().miss</code> (<a href="#sec-invoke-mau">Section 14.2.2</a>).</p>
</li>
<li>
<p>Added <code>string</code> type (<a href="#sec-string-type">Section 7.1.5</a>).</p>
</li>
<li>
<p>Added implicit casts from enum values (<a href="#sec-enum-exprs">Section 8.3</a>).</p>
</li>
<li>
<p>Allow 1-bit signed values</p>
</li>
<li>
<p>Define the type of bit slices from signed and unsigned values to be unsigned.</p>
</li>
<li>
<p>Constrain <code>default</code> label position for <code>switch</code> statements.</p>
</li>
<li>
<p>Allow empty tuples.</p>
</li>
<li>
<p>Added <code>@deprecated</code> annotation.</p>
</li>
<li>
<p>Relaxed the structure of annotation bodies.</p>
</li>
<li>
<p>Removed the <code>@pkginfo</code> annotation, which is now defined by the P4Runtime specification.</p>
</li>
<li>
<p>Added <code>int</code> type (<a href="#sec-arbitrary-precision-integers">Section 7.1.6.5</a>).</p>
</li>
<li>
<p>Added error <code>ParserInvalidArgument</code> (<a href="#sec-packet-extract-two">Section 13.8.2</a>, <a href="#sec-skip-bits">Section 13.8.4</a>).</p>
</li>
<li>
<p>Clarified the significance of order of entries in <code>const entries</code> (<a href="#sec-entries">Section 14.2.1.4</a>).</p>
</li>
<li>
<p>Added methods to calculate header size (<a href="#sec-ops-on-hdrs">Section 8.17</a>).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_summary_of_changes_made_in_version_1_1_0_released_november_26_2017">A.8. Summary of changes made in version 1.1.0, released November 26, 2017.</h3>
<div class="ulist">
<ul>
<li>
<p>Top-level functions (<a href="#sec-functions">Chapter 10</a>)</p>
<div class="ulist">
<ul>
<li>
<p>Functions may be declared at the top-level of a P4 program.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Optional and named parameters (<a href="#sec-calling-convention">Section 6.8</a>)</p>
<div class="ulist">
<ul>
<li>
<p>Parameters may be specified by name, with a default value, or designated as optional.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>enum</code> representations (<a href="#sec-enum-exprs">Section 8.3</a>)</p>
<div class="ulist">
<ul>
<li>
<p><code>enum</code> values to be specified with a concrete representation.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Parser values sets (<a href="#sec-value-set">Section 13.11</a>)</p>
<div class="ulist">
<ul>
<li>
<p><code>value_set</code> objects for control-plane programmable <code>select</code> labels.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Type definitions (<a href="#sec-newtype">Section 7.6</a>)</p>
<div class="ulist">
<ul>
<li>
<p>New types may be introduced in programs.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Saturating arithmetic (<a href="#sec-bit-ops">Section 8.6</a>)</p>
<div class="ulist">
<ul>
<li>
<p>Saturating arithmetic is supported on some targets.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Structured annotations (<a href="#sec-annotations">Chapter 20</a>)</p>
<div class="ulist">
<ul>
<li>
<p>Annotations may be specified as lists of key-value pairs</p>
</li>
</ul>
</div>
</li>
<li>
<p>Globalname (<a href="#sec-name-annotations">Section 18.3.2</a>)</p>
<div class="ulist">
<ul>
<li>
<p>The reserved <code>globalname</code> annotation has been removed.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Table <code>size</code> property (<a href="#sec-size-table-property">Section 14.2.1.5</a>)</p>
<div class="ulist">
<ul>
<li>
<p>Meaning of optional <code>size</code> property for tables has been defined.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Invalid headers (<a href="#sec-ops-on-hdrs">Section 8.17</a>)</p>
<div class="ulist">
<ul>
<li>
<p>Clarified semantics of operations on invalid headers.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Calling restrictions (<a href="#sec-calling-restrictions">Appendix F</a>)</p>
<div class="ulist">
<ul>
<li>
<p>Added restrictions on kinds of values that may be passed as arguments to calls.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Bitwise operator precedence (<a href="#sec-grammar">Appendix G</a>)</p>
<div class="ulist">
<ul>
<li>
<p>Modified precedence conventions so that bitwise operators <code>&amp;</code> <code>|</code> and <code>^</code> have higher precedence than relation operators <code>&lt;</code> <code>&gt;</code> <code>&lt;=</code> <code>&gt;=</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Computed bitwidths (<a href="#sec-base-types">Section 7.1</a>)</p>
<div class="ulist">
<ul>
<li>
<p>Added support for specifying widths using expressions in <code>bit</code> and <code>varbit</code> types.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_initial_version_1_0_0_released_may_17_2017">A.9. Initial version 1.0.0, released May 17, 2017</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-p4-keywords">Appendix B: P4 reserved keywords</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following table shows all P4 reserved keywords. Some identifiers
are treated as keywords only in specific contexts (e.g., the keyword <code>actions</code>).</p>
</div>
<table class="tableblock frame-all grid-all center" style="width: 80%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>abstract</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>action</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>apply</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bit</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bool</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>const</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>control</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>default</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>else</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enum</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>error</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extern</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>exit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>header</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>header_union</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>if</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>in</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>inout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>list</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>match_kind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>package</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parser</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>out</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>return</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>select</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>state</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>string</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>struct</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>switch</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>table</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>this</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>transition</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tuple</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>typedef</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>value_set</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varbit</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>verify</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="sec-p4-reserved-annotations">Appendix C: P4 reserved annotations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following table shows all P4 reserved annotations.</p>
</div>
<table class="tableblock frame-all grid-all stretch center">
<colgroup>
<col style="width: 20%;">
<col style="width: 60%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Purpose</th>
<th class="tableblock halign-left valign-top">See Section</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>atomic</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">specify atomic execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-concurrency">Section 18.4.1</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>defaultonly</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">action can only appear in the default action</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-annotations">Chapter 20</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hidden</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hides a controllable entity from the control plane</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-name-annotations">Section 18.3.2</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>match</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">specify <code>match_kind</code> of a field in a <code>value_set</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-value-set">Section 13.11</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">assign local control-plane name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-name-annotations">Section 18.3.2</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>optional</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">parameter is optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-optional-parameters">Section 6.8.2</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tableonly</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">action cannot be a default_action</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-annotations">Chapter 20</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deprecated</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Construct has been deprecated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-deprecated-anno">Section 20.3.7</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pure</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pure function</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-extern-annotations">Section 20.3.6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>noSideEffects</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">function with no side effects</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-extern-annotations">Section 20.3.6</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>noWarn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Has a string argument; inhibits compiler warnings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-nowarn-anno">Section 20.3.8</a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="sec-p4-core-lib">Appendix D: P4 core library</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The P4 core library contains declarations that are useful to most
programs.</p>
</div>
<div class="paragraph">
<p>For example, the core library includes the declarations of the
predefined <code>packet_in</code> and <code>packet_out</code> extern objects, used
in parsers and deparsers to access packet data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">/// Standard error codes.  New error codes can be declared by users.
</span><span style="color: #953800">error</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    NoError<span style="color: #24292f;background-color: #f6f8fa">,</span>           <span style="color: #6e7781">/// No error.
</span>    PacketTooShort<span style="color: #24292f;background-color: #f6f8fa">,</span>    <span style="color: #6e7781">/// Not enough bits in packet for 'extract'.
</span>    NoMatch<span style="color: #24292f;background-color: #f6f8fa">,</span>           <span style="color: #6e7781">/// 'select' expression has no matches.
</span>    StackOutOfBounds<span style="color: #24292f;background-color: #f6f8fa">,</span>  <span style="color: #6e7781">/// Reference to invalid element of a header stack.
</span>    HeaderTooShort<span style="color: #24292f;background-color: #f6f8fa">,</span>    <span style="color: #6e7781">/// Extracting too many bits into a varbit field.
</span>    ParserTimeout<span style="color: #24292f;background-color: #f6f8fa">,</span>     <span style="color: #6e7781">/// Parser execution time limit exceeded.
</span>    ParserInvalidArgument  <span style="color: #6e7781">/// Parser operation was called with a value
</span>                           <span style="color: #6e7781">/// not supported by the implementation.
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">extern</span> <span style="color: #cf222e">packet_in</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">/// Read a header from the packet into a fixed-sized header @hdr
</span>    <span style="color: #6e7781">/// and advance the cursor.
</span>    <span style="color: #6e7781">/// May trigger error PacketTooShort or StackOutOfBounds.
</span>    <span style="color: #6e7781">/// @T must be a fixed-size header type
</span>    <span style="color: #953800">void</span> <span style="color: #953800">extract</span><span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">out</span> T hdr<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #6e7781">/// Read bits from the packet into a variable-sized header @variableSizeHeader
</span>    <span style="color: #6e7781">/// and advance the cursor.
</span>    <span style="color: #6e7781">/// @T must be a header containing exactly 1 varbit field.
</span>    <span style="color: #6e7781">/// May trigger errors PacketTooShort, StackOutOfBounds, or HeaderTooShort.
</span>    <span style="color: #953800">void</span> <span style="color: #953800">extract</span><span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">out</span> T variableSizeHeader<span style="color: #24292f;background-color: #f6f8fa">,</span>
                    <span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> variableFieldSizeInBits<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #6e7781">/// Read bits from the packet without advancing the cursor.
</span>    <span style="color: #6e7781">/// @returns: the bits read from the packet.
</span>    <span style="color: #6e7781">/// T may be an arbitrary fixed-size type.
</span>    T lookahead<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #6e7781">/// Advance the packet cursor by the specified number of bits.
</span>    <span style="color: #953800">void</span> advance<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> sizeInBits<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #6e7781">/// @return packet length in bytes.  This method may be unavailable on
</span>    <span style="color: #6e7781">/// some target architectures.
</span>    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> length<span style="color: #24292f;background-color: #f6f8fa">();</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">extern</span> <span style="color: #cf222e">packet_out</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">/// Write @data into the output packet, skipping invalid headers
</span>    <span style="color: #6e7781">/// and advancing the cursor
</span>    <span style="color: #6e7781">/// @T can be a header type, a header stack, a header_union, or a struct
</span>    <span style="color: #6e7781">/// containing fields with such types.
</span>    <span style="color: #953800">void</span> emit<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">action</span> NoAction<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{}</span>
<span style="color: #6e7781">/// Standard match kinds for table key fields.
/// Some architectures may not support all these match kinds.
/// Architectures can declare additional match kinds.
</span><span style="color: #953800">match_kind</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">/// Match bits exactly.
</span>    exact<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #6e7781">/// Ternary match, using a mask.
</span>    ternary<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #6e7781">/// Longest-prefix match.
</span>    lpm
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">/// Static assert evaluates a boolean expression
/// at compilation time.  If the expression evaluates to
/// false, compilation is stopped and the corresponding message is printed.
/// The function returns a boolean, so that it can be used
/// as a global constant value in a program, e.g.:
/// const version = static_assert(V1MODEL_VERSION &gt; 20180000, "Expected a v1 model version &gt;= 20180000");
</span><span style="color: #cf222e">extern</span> <span style="color: #953800">bool</span> static_assert<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bool</span> check<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">string</span> message<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #6e7781">/// Like the above but using a default message.
</span><span style="color: #cf222e">extern</span> <span style="color: #953800">bool</span> static_assert<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bool</span> check<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-checksums">Appendix E: Checksums</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are no built-in constructs in P4<sub>16</sub> for manipulating packet
checksums. We expect that checksum operations can be expressed as <code>extern</code>
library objects that are provided in target-specific libraries. The
standard architecture library should provide such checksum units.</p>
</div>
<div class="paragraph">
<p>For example, one could provide an incremental checksum unit <code>Checksum16</code>
(also described in the VSS example in <a href="#sec-vss-extern">Section 5.2.4</a>) for
computing 16-bit one&#8217;s complement using an <code>extern</code> object with a
signature such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> Checksum16 <span style="color: #24292f;background-color: #f6f8fa">{</span>
    Checksum16<span style="color: #24292f;background-color: #f6f8fa">();</span>              <span style="color: #6e7781">// constructor
</span>    <span style="color: #953800">void</span> clear<span style="color: #24292f;background-color: #f6f8fa">();</span>              <span style="color: #6e7781">// prepare unit for computation
</span>    <span style="color: #953800">void</span> update<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// add data to checksum
</span>    <span style="color: #953800">void</span> remove<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// remove data from existing checksum
</span>    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> get<span style="color: #24292f;background-color: #f6f8fa">();</span> <span style="color: #6e7781">// get the checksum for the data added since last clear
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>IP checksum verification could be done in a parser as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">ck16<span style="color: #0550ae">.</span>clear<span style="color: #24292f;background-color: #f6f8fa">();</span>           <span style="color: #6e7781">// prepare checksum unit
</span>ck16<span style="color: #0550ae">.</span>update<span style="color: #24292f;background-color: #f6f8fa">(</span>h<span style="color: #0550ae">.</span>ipv4<span style="color: #24292f;background-color: #f6f8fa">);</span>    <span style="color: #6e7781">// write header
</span><span style="color: #953800">verify</span><span style="color: #24292f;background-color: #f6f8fa">(</span>ck16<span style="color: #0550ae">.</span>get<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #0550ae">==</span> <span style="color: #0550ae">16w0</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">error</span><span style="color: #0550ae">.</span>IPv4ChecksumError<span style="color: #24292f;background-color: #f6f8fa">);</span> <span style="color: #6e7781">// check for 0 checksum
</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>IP checksum generation could be done as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">h<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>hdrChecksum <span style="color: #0550ae">=</span> <span style="color: #0550ae">16w0</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
ck16<span style="color: #0550ae">.</span>clear<span style="color: #24292f;background-color: #f6f8fa">();</span>
ck16<span style="color: #0550ae">.</span>update<span style="color: #24292f;background-color: #f6f8fa">(</span>h<span style="color: #0550ae">.</span>ipv4<span style="color: #24292f;background-color: #f6f8fa">);</span>
h<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>hdrChecksum <span style="color: #0550ae">=</span> ck16<span style="color: #0550ae">.</span>get<span style="color: #24292f;background-color: #f6f8fa">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Moreover, some switch architectures do not perform checksum
verification, but only update checksums incrementally to reflect
packet modifications. This could be achieved as well, as the following
P4 program fragments illustrates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">ck16<span style="color: #0550ae">.</span>clear<span style="color: #24292f;background-color: #f6f8fa">();</span>
ck16<span style="color: #0550ae">.</span>update<span style="color: #24292f;background-color: #f6f8fa">(</span>h<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>hdrChecksum<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// original checksum
</span>ck16<span style="color: #0550ae">.</span>remove<span style="color: #24292f;background-color: #f6f8fa">(</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> h<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ttl<span style="color: #24292f;background-color: #f6f8fa">,</span> h<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>proto <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #24292f;background-color: #f6f8fa">);</span>
h<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ttl <span style="color: #0550ae">=</span> h<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ttl <span style="color: #0550ae">-</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
ck16<span style="color: #0550ae">.</span>update<span style="color: #24292f;background-color: #f6f8fa">(</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> h<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ttl<span style="color: #24292f;background-color: #f6f8fa">,</span> h<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>proto <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #24292f;background-color: #f6f8fa">);</span>
h<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>hdrChecksum <span style="color: #0550ae">=</span> ck16<span style="color: #0550ae">.</span>get<span style="color: #24292f;background-color: #f6f8fa">();</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-calling-restrictions">Appendix F: Restrictions on compile time and run time calls</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This appendix summarizes restrictions on compile time and run time
calls that can be made.  Many of them are described earlier in this
document, but are collected here for easy reference.</p>
</div>
<div class="paragraph">
<p>The stateful types of objects in P4<sub>16</sub> are packages, parsers,
controls, externs, tables, and value-sets.  P4<sub>16</sub> functions are also
considered to be in that group, even if they happen to be pure
functions of their arguments.  All other types are referred to as
"value types" here.</p>
</div>
<div class="paragraph">
<p>Some guiding principles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Controls are not allowed to call parsers, and vice versa, so there
is no use in passing one type to the other in constructor parameters
or run-time parameters.</p>
</li>
<li>
<p>At run time, after a control is called, and before that call is
complete, there can be no recursive calls between controls, nor from
a control to itself.  Similarly for parsers.  There can be loops
among states within a single parser.</p>
</li>
<li>
<p>Externs are not allowed to call parsers or controls, so there is no
use in passing objects of those types to them.</p>
</li>
<li>
<p>Tables are always instantiated directly in their enclosing control,
and cannot be instantiated at the top level.  There is no syntax for
specifying parameters that are tables.  Tables are only intended to
be used from within the control where they are defined.</p>
</li>
<li>
<p>Value-sets can be instantiated in an enclosing parser or at the top level.
There is no syntax for specifying parameters that are value-sets. Value-sets
can be shared between the parsers as long as they are in the scope.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A note on recursion: It is expected that some architectures will
define capabilities for recirculating a packet to be processed again
as if it were a newly arriving packet, or to make "clones" of packets
that are then processed by parsers and/or control blocks that the
original packet has already completed.  This does not change the notes
above on recursion that apply while a parser or control is executing.</p>
</div>
<div class="paragraph">
<p>The first table lists restrictions on what types can be passed as
constructor parameters to other types.</p>
</div>
<table class="tableblock frame-all grid-all center" style="width: 80%;">
<colgroup>
<col style="width: 27.2727%;">
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 18.1819%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">This type</th>
<th class="tableblock halign-center valign-top" colspan="4">can be a constructor parameter for this type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">parser</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">control</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">extern</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parser</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">control</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extern</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">function</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">table</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value-set</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value types</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The next table lists restrictions on where one may perform
instantiations (see <a href="#sec-instantiations">Section 11.3</a>) of different types.
The answer for <code>package</code> is always "no" because there is no
"inside a package" where instantiations can be written in P4<sub>16</sub>.  One
can definitely make constructor calls and use instances of stateful
types as parameters when instantiating a package, and restrictions on
those types are in the table above.</p>
</div>
<div class="paragraph">
<p>For externs, one can only specify their interface in P4<sub>16</sub>, not their
implementation.  Thus there is no place to instantiate objects within
an extern.</p>
</div>
<div class="paragraph">
<p>You may declare variables and constants of any of the value types
within a parser, control, or function (see <a href="#sec-variables">Section 11.2</a> for more
details).  Declaring a variable or constant is not the same as
instantiation, hence the answer "N/A" (for not applicable) in those
table entries.  Variables may not be declared at the top level of your
program, but constants may.</p>
</div>
<table class="tableblock frame-all grid-all center" style="width: 90%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 13.3335%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">This type</th>
<th class="tableblock halign-center valign-top" colspan="6">can be instantiated in this place</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">top level</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">parser</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">control</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">extern</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">function</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parser</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">control</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extern</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">function</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">table</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value-set</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value types</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The next table lists restrictions on what types can be passed as
run-time parameters to other callable things that have run-time
parameters: parsers, controls, externs (including methods and
extern functions), actions, and functions.</p>
</div>
<table class="tableblock frame-all grid-all center" style="width: 80%;">
<colgroup>
<col style="width: 23.0769%;">
<col style="width: 15.3846%;">
<col style="width: 15.3846%;">
<col style="width: 15.3846%;">
<col style="width: 15.3846%;">
<col style="width: 15.3847%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">This type</th>
<th class="tableblock halign-center valign-top" colspan="5">can be a run-time parameter to this callable thing</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">parser</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">control</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">extern</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">action</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">function</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parser</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">control</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extern</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">table</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value-set</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">action</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">function</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value types</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Extern method and extern function calls may only return a value that
is a value type, or no value at all (specified by a return type of
<code>void</code>).</p>
</div>
<div class="paragraph">
<p>The next table lists restrictions on what kinds of calls can be made
from which places in a P4 program.  Calling a parser, control, or
table means invoking its <code>apply()</code> method. Calling a value-set means using it
in a select expression. The row for <code>extern</code> describes where extern method
calls can be made from.</p>
</div>
<div class="paragraph">
<p>One way that an extern can be called from the top level of a parser or
control is in an initializer expression for a declared variable,
e.g. <code>bit&lt;32&gt; x = rand.get();</code>.</p>
</div>
<table class="tableblock frame-all grid-all center" style="width: 90%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 13.3335%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">This type</th>
<th class="tableblock halign-center valign-top" colspan="6">can be called at run time from this place in a P4 program</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-center valign-bottom"><p class="tableblock">parser state</p></td>
<td class="tableblock halign-center valign-bottom"><p class="tableblock">control apply block</p></td>
<td class="tableblock halign-center valign-bottom"><p class="tableblock">parser or top level</p></td>
<td class="tableblock halign-center valign-bottom"><p class="tableblock">action</p></td>
<td class="tableblock halign-center valign-bottom"><p class="tableblock">extern</p></td>
<td class="tableblock halign-center valign-bottom"><p class="tableblock">function</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">package</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parser</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">control</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">extern</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">table</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value-set</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">action</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">function</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value types</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">N/A</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There may not be any recursion in calls, neither by a thing calling
itself directly, nor mutual recursion.</p>
</div>
<div class="paragraph">
<p>An extern can never cause any other type of P4 program object to be
called.  See <a href="#sec-calling-convention">Section 6.8</a>.</p>
</div>
<div class="paragraph">
<p>Actions may be called directly from a control <code>apply</code> block.</p>
</div>
<div class="paragraph">
<p>Note that while the extern row shows that extern methods can be called
from many places, particular externs may have additional restrictions
not listed in this table.  Any such restrictions should be documented
in the description for each extern, as part of the documentation for
the architecture that defines the extern.</p>
</div>
<div class="paragraph">
<p>In many cases, the restriction will be "from a parser state only" or
"from a control apply block or action only", but it may be even more
restrictive, e.g. only from a particular kind of control block
instantiated in a particular role in an architecture.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-grammar">Appendix G: P4 grammar</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the grammar of P4<sub>16</sub> written using the YACC/bison
language. Absent from this grammar is the precedence of various
operations.</p>
</div>
<div class="paragraph">
<p>The grammar is actually ambiguous, so the lexer and the parser must
collaborate for parsing the language. In particular, the lexer must be
able to distinguish two kinds of identifiers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Type names previously introduced (<code>TYPE_IDENTIFIER</code> tokens)</p>
</li>
<li>
<p>Regular identifiers (<code>IDENTIFIER</code> token)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The parser has to use a symbol table to indicate to the lexer how to
parse subsequent appearances of identifiers. For example, given the
following program fragment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">4</span><span style="color: #0550ae">&gt;</span> t<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">struct</span> s <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
t x<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">parser</span> p<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> b<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #6e7781">/* body omitted */</span> <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The lexer has to return the following terminal kinds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">t <span style="color: #0550ae">-</span> TYPE_IDENTIFIER
s <span style="color: #0550ae">-</span> TYPE_IDENTIFIER
x <span style="color: #0550ae">-</span> IDENTIFIER
p <span style="color: #0550ae">-</span> TYPE_IDENTIFIER
b <span style="color: #0550ae">-</span> IDENTIFIER</code></pre>
</div>
</div>
<div class="paragraph">
<p>This grammar has been heavily influenced by limitations of the Bison
parser generator tool.</p>
</div>
<div class="paragraph">
<p>The <code>STRING_LITERAL</code> token corresponds to a string literal
enclosed within double quotes, as described in <a href="#sec-string-literals">Section 6.4.3.3</a>.</p>
</div>
<div class="paragraph">
<p>All other terminals are uppercase spellings of the corresponding
keywords. For example, <code>RETURN</code> is the terminal returned by the
lexer when parsing the keyword return.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="bison">p4program
    : /* empty */
    | p4program declaration
    | p4program ";"  /* empty declaration */
    ;

declaration
    : constantDeclaration
    | externDeclaration
    | actionDeclaration
    | parserDeclaration
    | typeDeclaration
    | controlDeclaration
    | instantiation
    | errorDeclaration
    | matchKindDeclaration
    | functionDeclaration
    ;

nonTypeName
    : IDENTIFIER
    | APPLY
    | KEY
    | ACTIONS
    | STATE
    | ENTRIES
    | TYPE
    | PRIORITY
    ;

name
    : nonTypeName
    | LIST
    | TYPE_IDENTIFIER
    ;

nonTableKwName
   : IDENTIFIER
   | TYPE_IDENTIFIER
   | APPLY
   | STATE
   | TYPE
   | PRIORITY
   ;

optCONST
    : /* empty */
    | CONST
    ;

optAnnotations
    : /* empty */
    | annotations
    ;

annotations
    : annotation
    | annotations annotation
    ;

annotation
    : "@" name
    | "@" name "(" annotationBody ")"
    | "@" name "[" structuredAnnotationBody "]"
    ;

annotationBody
    : /* empty */
    | annotationBody "(" annotationBody ")"
    | annotationBody annotationToken
    ;

annotationToken
    : UNEXPECTED_TOKEN
    | ABSTRACT
    | ACTION
    | ACTIONS
    | APPLY
    | BOOL
    | BIT
    | BREAK
    | CONST
    | CONTINUE
    | CONTROL
    | DEFAULT
    | ELSE
    | ENTRIES
    | ENUM
    | ERROR
    | EXIT
    | EXTERN
    | FALSE
    | FOR
    | HEADER
    | HEADER_UNION
    | IF
    | IN
    | INOUT
    | INT
    | KEY
    | MATCH_KIND
    | TYPE
    | OUT
    | PARSER
    | PACKAGE
    | PRAGMA
    | RETURN
    | SELECT
    | STATE
    | STRING
    | STRUCT
    | SWITCH
    | TABLE
    | THIS
    | TRANSITION
    | TRUE
    | TUPLE
    | TYPEDEF
    | VARBIT
    | VALUESET
    | LIST
    | VOID
    | "_"
    | IDENTIFIER
    | TYPE_IDENTIFIER
    | STRING_LITERAL
    | INTEGER
    | "&amp;&amp;&amp;"
    | ".."
    | "&lt;&lt;"
    | "&amp;&amp;"
    | "||"
    | "=="
    | "!="
    | "&gt;="
    | "&lt;="
    | "++"
    | "+"
    | "|+|"
    | "-"
    | "|-|"
    | "*"
    | "/"
    | "%"
    | "|"
    | "&amp;"
    | "^"
    | "~"
    | "["
    | "]"
    | "{"
    | "}"
    | "&lt;"
    | "&gt;"
    | "!"
    | ":"
    | ","
    | "?"
    | "."
    | "="
    | ";"
    | "@"
    ;

kvList
    : kvPair
    | kvList "," kvPair
    ;

kvPair
    : name "=" expression
    ;

parameterList
    : /* empty */
    | nonEmptyParameterList
    ;

nonEmptyParameterList
    : parameter
    | nonEmptyParameterList "," parameter
    ;

parameter
    : optAnnotations direction typeRef name
    | optAnnotations direction typeRef name "=" expression
    ;

direction
    : IN
    | OUT
    | INOUT
    | /* empty */
    ;

packageTypeDeclaration
    : optAnnotations PACKAGE name optTypeParameters
      "(" parameterList ")"
    ;

instantiation
    : annotations typeRef "(" argumentList ")" name ";"
    | typeRef "(" argumentList ")" name ";"
    | annotations typeRef "(" argumentList ")" name "=" objInitializer ";"
    | typeRef "(" argumentList ")" name "=" objInitializer ";"
    ;

objInitializer
    : "{" objDeclarations "}"
    ;

objDeclarations
    : /* empty */
    | objDeclarations objDeclaration
    ;

objDeclaration
    : functionDeclaration
    | instantiation
    ;

optConstructorParameters
    : /* empty */
    | "(" parameterList ")"
    ;

dotPrefix
    : "."
    ;

/**************************** PARSER ******************************/

parserDeclaration
    : parserTypeDeclaration optConstructorParameters
      "{" parserLocalElements parserStates "}"
    ;

parserLocalElements
    : /* empty */
    | parserLocalElements parserLocalElement
    ;

parserLocalElement
    : constantDeclaration
    | instantiation
    | variableDeclaration
    | valueSetDeclaration
    ;

parserTypeDeclaration
    : optAnnotations PARSER name optTypeParameters
      "(" parameterList ")"
    ;

parserStates
    : parserState
    | parserStates parserState
    ;

parserState
    : optAnnotations STATE name
      "{" parserStatements transitionStatement "}"
    ;

parserStatements
    : /* empty */
    | parserStatements parserStatement
    ;

parserStatement
    : assignmentOrMethodCallStatement
    | directApplication
    | emptyStatement
    | variableDeclaration
    | constantDeclaration
    | parserBlockStatement
    | conditionalStatement
    ;

parserBlockStatement
    : optAnnotations "{" parserStatements "}"
    ;

transitionStatement
    : /* empty */
    | TRANSITION stateExpression
    ;

stateExpression
    : name ";"
    | selectExpression
    ;

selectExpression
    : SELECT "(" expressionList ")" "{" selectCaseList "}"
    ;

selectCaseList
    : /* empty */
    | selectCaseList selectCase
    ;

selectCase
    : keysetExpression ":" name ";"
    ;

keysetExpression
    : tupleKeysetExpression
    | simpleKeysetExpression
    ;

tupleKeysetExpression
    : "(" simpleKeysetExpression "," simpleExpressionList ")"
    | "(" reducedSimpleKeysetExpression ")"
    ;

optTrailingComma
    : /* empty */
    | ","
    ;

simpleExpressionList
    : simpleKeysetExpression
    | simpleExpressionList "," simpleKeysetExpression
    ;

reducedSimpleKeysetExpression
    : expression "&amp;&amp;&amp;" expression
    | expression ".." expression
    | DEFAULT
    | "_"
    ;

simpleKeysetExpression
    : expression
    | expression "&amp;&amp;&amp;" expression
    | expression ".." expression
    | DEFAULT
    | "_"
    ;

valueSetDeclaration
  : optAnnotations
      VALUESET "&lt;" baseType "&gt;" "(" expression ")" name ";"
  | optAnnotations
      VALUESET "&lt;" tupleType "&gt;" "(" expression ")" name ";"
  | optAnnotations
      VALUESET "&lt;" typeName "&gt;" "(" expression ")" name ";"
  ;

/*************************** CONTROL ************************/

controlDeclaration
    : controlTypeDeclaration optConstructorParameters
      /* controlTypeDeclaration cannot contain type parameters */
      "{" controlLocalDeclarations APPLY controlBody "}"
    ;

controlTypeDeclaration
    : optAnnotations CONTROL name optTypeParameters
      "(" parameterList ")"
    ;

controlLocalDeclarations
    : /* empty */
    | controlLocalDeclarations controlLocalDeclaration
    ;

controlLocalDeclaration
    : constantDeclaration
    | actionDeclaration
    | tableDeclaration
    | instantiation
    | variableDeclaration
    ;

controlBody
    : blockStatement
    ;

/*************************** EXTERN *************************/

externDeclaration
    : optAnnotations EXTERN nonTypeName optTypeParameters "{" methodPrototypes "}"
    | optAnnotations EXTERN functionPrototype ";"
    ;

methodPrototypes
    : /* empty */
    | methodPrototypes methodPrototype
    ;

functionPrototype
    : typeOrVoid name optTypeParameters "(" parameterList ")"
    ;

methodPrototype
    : optAnnotations functionPrototype ";"
    | optAnnotations TYPE_IDENTIFIER "(" parameterList ")" ";"
    ;

/************************** TYPES ****************************/

typeRef
    : baseType
    | typeName
    | specializedType
    | headerStackType
    | p4listType
    | tupleType
    ;

namedType
    : typeName
    | specializedType
    ;

prefixedType
    : TYPE_IDENTIFIER
    | dotPrefix TYPE_IDENTIFIER
    ;

typeName
    : prefixedType
    ;

p4listType
    : LIST "&lt;" typeArg "&gt;"
    ;

tupleType
    : TUPLE "&lt;" typeArgumentList "&gt;"
    ;

headerStackType
    : typeName "[" expression "]"
    | specializedType "[" expression "]"
    ;

specializedType
    : typeName "&lt;" typeArgumentList "&gt;"
    ;

baseType
    : BOOL
    | MATCH_KIND
    | ERROR
    | BIT
    | STRING
    | INT
    | BIT "&lt;" INTEGER "&gt;"
    | INT "&lt;" INTEGER "&gt;"
    | VARBIT "&lt;" INTEGER "&gt;"
    | BIT "&lt;" "(" expression ")" "&gt;"
    | INT "&lt;" "(" expression ")" "&gt;"
    | VARBIT "&lt;" "(" expression ")" "&gt;"
    ;

typeOrVoid
    : typeRef
    | VOID
    | IDENTIFIER     // may be a type variable
    ;

optTypeParameters
    : /* empty */
    | typeParameters
    ;

typeParameters
    : "&lt;" typeParameterList "&gt;"
    ;

typeParameterList
    : name
    | typeParameterList "," name
    ;

typeArg
    : typeRef
    | nonTypeName
    | VOID
    | "_"
    ;

typeArgumentList
    : /* empty */
    | typeArg
    | typeArgumentList "," typeArg
    ;

realTypeArg
    : typeRef
    | VOID
    | "_"
    ;

realTypeArgumentList
    : realTypeArg
    | realTypeArgumentList "," typeArg
    ;

typeDeclaration
    : derivedTypeDeclaration
    | typedefDeclaration ";"
    | parserTypeDeclaration ";"
    | controlTypeDeclaration ";"
    | packageTypeDeclaration ";"
    ;

derivedTypeDeclaration
    : headerTypeDeclaration
    | headerUnionDeclaration
    | structTypeDeclaration
    | enumDeclaration
    ;

headerTypeDeclaration
    : optAnnotations HEADER name optTypeParameters "{" structFieldList "}"
    ;

structTypeDeclaration
    : optAnnotations STRUCT name optTypeParameters "{" structFieldList "}"
    ;

headerUnionDeclaration
    : optAnnotations HEADER_UNION name optTypeParameters "{" structFieldList "}"
    ;

structFieldList
    : /* empty */
    | structFieldList structField
    ;

structField
    : optAnnotations typeRef name ";"
    ;

enumDeclaration
    : optAnnotations ENUM name "{" identifierList optTrailingComma "}"
    | optAnnotations ENUM typeRef name "{"
      specifiedIdentifierList optTrailingComma "}"
    ;

specifiedIdentifierList
    : specifiedIdentifier
    | specifiedIdentifierList "," specifiedIdentifier
    ;

specifiedIdentifier
    : name "=" initializer
    ;

errorDeclaration
    : ERROR "{" identifierList "}"
    ;

matchKindDeclaration
    : MATCH_KIND "{" identifierList optTrailingComma "}"
    ;

identifierList
    : name
    | identifierList "," name
    ;

typedefDeclaration
    : optAnnotations TYPEDEF typeRef name
    | optAnnotations TYPEDEF derivedTypeDeclaration name
    | optAnnotations TYPE typeRef name
    ;

/*************************** STATEMENTS *************************/

assignmentOrMethodCallStatement
    : lvalue "(" argumentList ")" ";"
    | lvalue "&lt;" typeArgumentList "&gt;" "(" argumentList ")" ";"
    | lvalue "="  expression ";"
    ;

breakStatement
    : BREAK ";"
    ;

continueStatement
    : CONTINUE ";"
    ;

emptyStatement
    : ";"
    ;

exitStatement
    : EXIT ";"
    ;

returnStatement
    : RETURN ";"
    | RETURN expression ";"
    ;

conditionalStatement
    : IF "(" expression ")" statement
    | IF "(" expression ")" statement ELSE statement
    ;

// To support direct invocation of a control or parser without instantiation
directApplication
    : typeName "." APPLY "(" argumentList ")" ";"
    | specializedType "." APPLY "(" argumentList ")" ";"
    ;

statement
    : assignmentOrMethodCallStatement
    | directApplication
    | conditionalStatement
    | emptyStatement
    | blockStatement
    | returnStatement
    | exitStatement
    | breakStatement
    | continueStatement
    | switchStatement
    | loopStatement
    ;

blockStatement
    : optAnnotations "{" statOrDeclList "}"
    ;

statOrDeclList
    : /* empty */
    | statOrDeclList statementOrDeclaration
    ;

switchStatement
    : SWITCH "(" expression ")" "{" switchCases "}"
    ;

switchCases
    : /* empty */
    | switchCases switchCase
    ;

switchCase
    : switchLabel ":" blockStatement
    | switchLabel ":"  // fall-through
    ;

switchLabel
    : DEFAULT
    | nonBraceExpression
    ;

loopStatement
    : optAnnotations FOR "(" optForInitStatements ";" expression ";"
      optForUpdateStatements ")" statement
    | optAnnotations FOR "(" typeRef name IN forCollectionExpr ")" statement
    ;

optForInitStatements
    : /* empty */
    | forInitStatements
    ;

forInitStatements
    : forInitStatement
    | forInitStatements "," forInitStatement
    ;

forInitStatement
    : optAnnotations typeRef name optInitializer
    | lvalue "(" argumentList ")"
    | lvalue "&lt;" typeArgumentList "&gt;" "(" argumentList ")"
    | lvalue "=" expression
    ;

optForUpdateStatements
    : /* empty */
    | forUpdateStatements
    ;

forUpdateStatements
    : forUpdateStatement
    | forUpdateStatements "," forUpdateStatement
    ;

forUpdateStatement
    : lvalue "(" argumentList ")"
    | lvalue "&lt;" typeArgumentList "&gt;" "(" argumentList ")"
    | lvalue "=" expression
    ;

forCollectionExpr
    : expression
    | expression ".." erxpression
    ;

statementOrDeclaration
    : variableDeclaration
    | constantDeclaration
    | statement
    ;

/************************* TABLE *********************************/

tableDeclaration
    : optAnnotations TABLE name "{" tablePropertyList "}"
    ;

tablePropertyList
    : tableProperty
    | tablePropertyList tableProperty
    ;

tableProperty
    : KEY "=" "{" keyElementList "}"
    | ACTIONS "=" "{" actionList "}"
    | optAnnotations optCONST ENTRIES "=" "{" entriesList "}"
    | optAnnotations optCONST nonTableKwName "=" initializer ";"
    ;

keyElementList
    : /* empty */
    | keyElementList keyElement
    ;

keyElement
    : expression ":" name optAnnotations ";"
    ;

actionList
    : /* empty */
    | actionList optAnnotations actionRef ";"
    ;

actionRef
    : prefixedNonTypeName
    | prefixedNonTypeName "(" argumentList ")"
    ;

entry
    : optCONST entryPriority keysetExpression ':' actionRef optAnnotations ';'
    | optCONST keysetExpression ':' actionRef optAnnotations ';'
    ;

entryPriority
 : PRIORITY '=' INTEGER ":"
 | PRIORITY '=' '(' expression ')' ":"
 ;

entriesList
    : /* empty */
    | entriesList entry
    ;

/************************* ACTION ********************************/

actionDeclaration
    : optAnnotations ACTION name "(" parameterList ")" blockStatement
    ;

/************************* VARIABLES *****************************/

variableDeclaration
    : annotations typeRef name optInitializer ";"
    | typeRef name optInitializer ";"
    ;

constantDeclaration
    : optAnnotations CONST typeRef name "=" initializer ";"
    ;

optInitializer
    : /* empty */
    | "=" initializer
    ;

initializer
    : expression
    ;

/**************** Expressions ****************/

functionDeclaration
    : annotations functionPrototype blockStatement
    | functionPrototype blockStatement
    ;

argumentList
    : /* empty */
    | nonEmptyArgList
    ;

nonEmptyArgList
    : argument
    | nonEmptyArgList "," argument
    ;

argument
    : expression  /* positional argument */
    | name "=" expression  /* named argument */
    | "_"
    | name "=" "_"
    ;

expressionList
    : /* empty */
    | expression
    | expressionList "," expression
    ;

structuredAnnotationBody
    : expressionList optTrailingComma
    | kvList optTrailingComma
    ;

member
    : name
    ;

prefixedNonTypeName
    : nonTypeName
    | dotPrefix nonTypeName
    ;

lvalue
    : prefixedNonTypeName
    | THIS
    | lvalue "." member
    | lvalue "[" expression "]"
    | lvalue "[" expression ":" expression "]"
    | "(" lvalue ")"
    ;

%left ","
%nonassoc "?"
%nonassoc ":"
%left "||"
%left "&amp;&amp;"
%left "==" "!="
%left "&lt;" "&gt;" "&lt;=" "&gt;="
%left "|"
%left "^"
%left "&amp;"
%left "&lt;&lt;" "&gt;&gt;"
%left "++" "+" "-" "|+|" "|-|"
%left "*" "/" "%"
%right PREFIX
%nonassoc "]" "(" "["
%left "."

// Additional precedences need to be specified

expression
    : INTEGER
    | DOTS
    | STRING_LITERAL
    | TRUE
    | FALSE
    | THIS
    | prefixedNonTypeName
    | expression "[" expression "]"
    | expression "[" expression ":" expression "]"
    | "{" expressionList optTrailingComma "}"
    | "{#}"
    | "{" kvList optTrailingComma "}"
    | "{" kvList "," DOTS optTrailingComma "}"
    | "(" expression ")"
    | "!" expression %prec PREFIX
    | "~" expression %prec PREFIX
    | "-" expression %prec PREFIX
    | "+" expression %prec PREFIX
    | typeName "." member
    | ERROR "." member
    | expression "." member
    | expression "*" expression
    | expression "/" expression
    | expression "%" expression
    | expression "+" expression
    | expression "-" expression
    | expression "|+|" expression
    | expression "|-|" expression
    | expression "&lt;&lt;" expression
    | expression "&gt;&gt;" expression
    | expression "&lt;=" expression
    | expression "&gt;=" expression
    | expression "&lt;" expression
    | expression "&gt;" expression
    | expression "!=" expression
    | expression "==" expression
    | expression "&amp;" expression
    | expression "^" expression
    | expression "|" expression
    | expression "++" expression
    | expression "&amp;&amp;" expression
    | expression "||" expression
    | expression "?" expression ":" expression
    | expression "&lt;" realTypeArgumentList "&gt;" "(" argumentList ")"
    | expression "(" argumentList ")"
    | namedType "(" argumentList ")"
    | "(" typeRef ")" expression
    ;

nonBraceExpression
    : INTEGER
    | STRING_LITERAL
    | TRUE
    | FALSE
    | THIS
    | prefixedNonTypeName
    | nonBraceExpression "[" expression "]"
    | nonBraceExpression "[" expression ":" expression "]"
    | "(" expression ")"
    | "!" expression %prec PREFIX
    | "~" expression %prec PREFIX
    | "-" expression %prec PREFIX
    | "+" expression %prec PREFIX
    | typeName "." member
    | ERROR "." member
    | nonBraceExpression "." member
    | nonBraceExpression "*" expression
    | nonBraceExpression "/" expression
    | nonBraceExpression "%" expression
    | nonBraceExpression "+" expression
    | nonBraceExpression "-" expression
    | nonBraceExpression "|+|" expression
    | nonBraceExpression "|-|" expression
    | nonBraceExpression "&lt;&lt;" expression
    | nonBraceExpression "&gt;&gt;" expression
    | nonBraceExpression "&lt;=" expression
    | nonBraceExpression "&gt;=" expression
    | nonBraceExpression "&lt;" expression
    | nonBraceExpression "&gt;" expression
    | nonBraceExpression "!=" expression
    | nonBraceExpression "==" expression
    | nonBraceExpression "&amp;" expression
    | nonBraceExpression "^" expression
    | nonBraceExpression "|" expression
    | nonBraceExpression "++" expression
    | nonBraceExpression "&amp;&amp;" expression
    | nonBraceExpression "||" expression
    | nonBraceExpression "?" expression ":" expression
    | nonBraceExpression "&lt;" realTypeArgumentList "&gt;" "(" argumentList ")"
    | nonBraceExpression "(" argumentList ")"
    | namedType "(" argumentList ")"
    | "(" typeRef ")" expression
    ;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. <a href="https://github.com/p4lang/p4-spec/blob/master/p4-16/spec/docs/implementing-generalized-switch-statements.md" class="bare">https://github.com/p4lang/p4-spec/blob/master/p4-16/spec/docs/implementing-generalized-switch-statements.md</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <a href="https://github.com/p4lang/p4-spec/blob/master/p4-16/spec/docs/p4-table-and-parser-value-set-sizes.md" class="bare">https://github.com/p4lang/p4-spec/blob/master/p4-16/spec/docs/p4-table-and-parser-value-set-sizes.md</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. The P4Runtime API is defined as a Google Protocol Buffer <code>.proto</code> file and an accompanying English specification document here: <a href="https://github.com/p4lang/p4runtime" class="bare">https://github.com/p4lang/p4runtime</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. TDI is the Table Driven Interface.  More information can be found here: <a href="https://github.com/p4lang/tdi" class="bare">https://github.com/p4lang/tdi</a>
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. Most existing P4<sub>16</sub> programs today do not use function or method calls in table key expressions, and the order of evaluation of these key expressions makes no difference in the resulting lookup key value. In this overwhelmingly common case, if an implementation chooses to insert extra assignment statements to implement side-effecting key expressions, but does not insert them when there are no side-effecting key expressions, then in typical programs they will almost never be inserted.
</div>
</div>
<div id="footer">
<div id="footer-text">
Version v1.2.5<br>
Last updated 2024-11-14 07:19:19 UTC
</div>
</div>
</body>
</html>