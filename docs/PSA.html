<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>P416 Portable Switch Architecture (PSA)</title>
<style>
@import url(//cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.0/css/font-awesome.css);
/* normalize.css v2.1.1 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address styling not present in IE 8/9. */
[hidden] { display: none; }

/* ========================================================================== Base ========================================================================== */
/** 1. Prevent system color scheme's background color being used in Firefox, IE, and Opera. 2. Prevent system color scheme's text color being used in Firefox, IE, and Opera. 3. Set default font family to sans-serif. 4. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { background: #fff; /* 1 */ color: #000; /* 2 */ font-family: sans-serif; /* 3 */ -ms-text-size-adjust: 100%; /* 4 */ -webkit-text-size-adjust: 100%; /* 4 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 15px; }

body { background: white; color: #0a0a0a; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

a:focus { outline: none; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.23333em; line-height: 1.6; }

.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #030303; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #4183c4; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #4183c4; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: helvetica, arial, freesans, clean, sans-serif; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.93333em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: helvetica, arial, freesans, clean, sans-serif; font-weight: bold; font-style: normal; color: #333333; text-rendering: optimizeLegibility; margin-top: 0.2em; margin-bottom: 0.5em; line-height: 1.2em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: gray; line-height: 0; }

h1 { font-size: 1.33333em; }

h2 { font-size: 0.93333em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 0.86667em; }

h4 { font-size: 0.66667em; }

h5 { font-size: 1em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.33333em 0 1.26667em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Monaco, "DejaVu Sans Mono", "Courier New", monospace; font-weight: normal; color: #B12146; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1em; list-style-position: outside; font-family: helvetica, arial, freesans, clean, sans-serif; }

ul, ol { margin-left: 0.7em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.33333em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }


/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.33333em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.33333em; font-weight: bold; }
dl dd { margin-bottom: 1.33333em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #030303; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1em; padding: 0; border-left: none; }
blockquote cite { display: block; font-size: 0.86667em; color: #030303; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #030303; }

blockquote, blockquote p { line-height: 1.4; color: #030303; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.33333em 0; border: 1px solid #dddddd; padding: 0.66667em 0.8em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 1em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.06667em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2em; }
  h2 { font-size: 1.6em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.2em; }
  h4 { font-size: 1em; } }
/* Print styles.  Inlined to avoid required HTTP connection: www.phpied.com/delay-loading-your-print-css/ Credit to Paul Irish and HTML5 Boilerplate (html5boilerplate.com)
*/
.print-only { display: none !important; }

@media print { * { background: transparent !important; color: #000 !important; /* Black prints faster: h5bp.com/s */ box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999999; page-break-inside: avoid; }
  thead { display: table-header-group; /* h5bp.com/t */ }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
/* Tables */
table { background: white; margin-bottom: 1.33333em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.53333em 0.66667em 0.66667em; font-size: 0.93333em; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.6em 0.66667em; font-size: 0.8em; color: black; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

a:hover, a:focus { text-decoration: underline; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: 0.86667em; padding: 1px 5px 1px 5px; white-space: nowrap; background-color: transparent; border: 1px solid #dddddd; -webkit-border-radius: 3px; border-radius: 3px; text-shadow: none; }

pre, pre > code { line-height: 1.6; color: black; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }

kbd.keyseq { color: black; }

kbd:not(.keyseq) { display: inline-block; color: black; font-size: 0.8em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

kbd kbd:first-child { margin-left: 0; }

kbd kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #1a1a1a; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 66.66667em; *zoom: 1; position: relative; padding-left: 1em; padding-right: 1em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#header { margin-bottom: 2.66667em;}
#header > h1 { color: #030303; font-weight: 300;  border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; text-align: center; }
#header span { color: #030303;}
#header #revnumber { text-align: center; text-transform: capitalize;}
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }

#toc { border-bottom: 0 solid #dddddd; padding-bottom: 1.33333em; }
#toc > ul { margin-left: 0.26667em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }

#toctitle { color: #030303; }

@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #dddddd; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul { font-size: .95em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1.33333em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.33333em; padding: 1.33333em; background: white; border-width: 0; -webkit-border-radius: 3px; border-radius: 3px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }

#content #toctitle { font-weight: bold; font-family: helvetica, arial, freesans, clean, sans-serif; font-size: 1.06667em; padding-left: 0.13333em; }

#footer { max-width: 100%; background-color: whitesmoke; padding: 1.33333em; }

#footer-text { color: #030303; line-height: 1.26; }

.sect1 { padding-bottom: 1.33333em; }

.sect1 + .sect1 { border-top: 0 solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #0830df; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #262626; }

.imageblock, .literalblock, .listingblock, .verseblock, .videoblock { margin-bottom: 1.33333em; }

.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: center; font-weight: bold; }

.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.2em; padding-right: 1.33333em; border-left: 1px solid #dddddd; color: #030303; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.33333em; padding: 1.33333em; background: white; -webkit-border-radius: 3px; border-radius: 3px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.66667em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }

.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #eaeaea; box-shadow: 0 1px 8px #eaeaea; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.33333em; padding: 1.33333em; background: white; -webkit-border-radius: 3px; border-radius: 3px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.66667em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #030303; margin-top: 0; line-height: 1.4; border-width: 0 0 1px 0; border-style: solid; border-color: #cacaca; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock > .content pre, .listingblock > .content pre { background: #F7F7F7; border-width: 2px; border-style: solid; border-color: #dddddd; -webkit-border-radius: 3px; border-radius: 3px; padding: 0.66667em; word-wrap: break-word; }
.literalblock > .content pre.nowrap, .listingblock > .content pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content pre > code, .listingblock > .content pre > code { display: block; }
@media only screen { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.69333em; } }
@media only screen and (min-width: 768px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.78em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.86667em; } }

.listingblock > .content { position: relative; }

.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.4em; right: 0.4em; }

.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }

table.pyhltable { border: 0; margin-bottom: 0; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }

.quoteblock { margin: 0 0 1em; padding: 0; border-left: none; }
.quoteblock blockquote { margin: 0 0 1em 0; padding: 0 0 0.6em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.6em; font-size: 0.86667em; color: #666666; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.66667em; }

table thead th, table tfoot th { font-weight: bold; }

table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 3px; border-radius: 3px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }

table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }

table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }

table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }

th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }

th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }

th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }

th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }

th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }

th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }

p.tableblock.header { color: #222222; font-weight: bold; }

td > div.verse { white-space: pre; }

ol { margin-left: 0.96667em; }

ul li ol { margin-left: 0.7em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.5em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.66667em; }

ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.5em auto; margin-left: -1.46667em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.46667em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .8em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.26667em 0; }

.qanda > ol > li > p > em:only-child { color: #3876b4; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.26667em 0.66667em 1.33333em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.26667em 0 1.33333em 0.66667em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.13333em; }

.image.left, .image.right { margin-top: 0.26667em; margin-bottom: 0.26667em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.66667em; }
.image.right { margin-left: 0.66667em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.93333em; }
span.footnote a, span.footnoteref a { text-decoration: none; }

#footnotes { padding-top: 0.8em; padding-bottom: 0.8em; margin-bottom: 0.66667em; }
#footnotes hr { width: 20%; min-width: 6.66667em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.4em; line-height: 1.3; font-size: 0.93333em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.66667em; margin-bottom: 0; padding: 0.8em 0; }

.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }

.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #4183c4; color: #2e6295; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum { display: inline-block; color: white !important; background-color: #333333; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1em; color: #666666; }

h2 { color: #030303; border-bottom: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { color: #333333; }

#header, #content, #footnotes { max-width: 660px; padding-left: 0; padding-right: 0; }


#content ul li { padding-left: .7em; }

.olist.procedure > ol { counter-reset: li; list-style: none; position: relative; }
.olist.procedure > ol > li { position: relative; padding: 5px 0 5px 55px; margin-bottom: 5px; }
.olist.procedure > ol > li:before { content: counter(li); counter-increment: li; position: absolute; top: 0; left: 0; height: 100%; width: 30px; padding: 0 10px 0 0; color: #999; font-size: 1.46667em; font-weight: bold; line-height: 1.6; text-align: right; border-right: 1px solid #ddd; }

.quoteblock blockquote { background: url('../images/github/blockquote-arrow.png?1372292342') 0 2px no-repeat; padding-left: 1em; }

.sidebarblock > .content > .title { margin-top: -20px; margin-right: -20px; margin-left: -20px; margin-bottom: 20px; padding: 1em; font-size: 0.8em; background: #eaeaea; }
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>P4<sub>16</sub> Portable Switch Architecture (PSA)</h1>
<div class="details">
<span id="revnumber">version v1.2,</span>
<span id="revdate">2024-11-14</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Contents</div>
<ul class="sectlevel1">
<li><a href="#_target_architecture_model">1. Target Architecture Model</a></li>
<li><a href="#_naming_conventions">2. Naming conventions</a></li>
<li><a href="#packet-paths">3. Packet paths</a></li>
<li><a href="#_psa_data_types">4. PSA Data types</a>
<ul class="sectlevel2">
<li><a href="#sec-psa-type-definitions">4.1. PSA type definitions</a></li>
<li><a href="#_psa_supported_metadata_types">4.2. PSA supported metadata types</a></li>
<li><a href="#sec-match-kinds">4.3. Match kinds</a>
<ul class="sectlevel3">
<li><a href="#_range_tables">4.3.1. Range tables</a></li>
<li><a href="#_ternary_tables">4.3.2. Ternary tables</a></li>
<li><a href="#_longest_prefix_match_tables">4.3.3. Longest prefix match tables</a></li>
<li><a href="#_exact_match_tables">4.3.4. Exact match tables</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-data-plane-vs-control-plane-values">5. Data plane vs. control plane data representations</a></li>
<li><a href="#sec-programmable-blocks">6. Programmable blocks</a></li>
<li><a href="#sec-packet-path-details">7. Packet Path Details</a>
<ul class="sectlevel2">
<li><a href="#_initial_values_of_packets_processed_by_ingress">7.1. Initial values of packets processed by ingress</a></li>
<li><a href="#_initial_packet_contents_for_packets_from_ports">7.2. Initial packet contents for packets from ports</a>
<ul class="sectlevel3">
<li><a href="#_initial_packet_contents_for_resubmitted_packets">7.2.1. Initial packet contents for resubmitted packets</a></li>
<li><a href="#_initial_packet_contents_for_recirculated_packets">7.2.2. Initial packet contents for recirculated packets</a></li>
<li><a href="#sec-ingress_initial-metadata">7.2.3. User-defined metadata for all ingress packets</a></li>
</ul>
</li>
<li><a href="#sec-after-ingress">7.3. Behavior of packets after ingress processing is complete</a>
<ul class="sectlevel3">
<li><a href="#sec-multicast">7.3.1. Multicast replication</a></li>
</ul>
</li>
<li><a href="#sec-ingress-actions">7.4. Actions for directing packets during ingress</a>
<ul class="sectlevel3">
<li><a href="#_unicast_operation">7.4.1. Unicast operation</a></li>
<li><a href="#_multicast_operation">7.4.2. Multicast operation</a></li>
<li><a href="#_drop_operation">7.4.3. Drop operation</a></li>
</ul>
</li>
<li><a href="#sec-initial-values-egress">7.5. Initial values of packets processed by egress</a>
<ul class="sectlevel3">
<li><a href="#_initial_packet_contents_for_normal_packets">7.5.1. Initial packet contents for normal packets</a></li>
<li><a href="#_initial_packet_contents_for_packets_cloned_from_ingress_to_egress">7.5.2. Initial packet contents for packets cloned from ingress to egress</a></li>
<li><a href="#_initial_packet_contents_for_packets_cloned_from_egress_to_egress">7.5.3. Initial packet contents for packets cloned from egress to egress</a></li>
<li><a href="#_user_defined_metadata_for_all_egress_packets">7.5.4. User-defined metadata for all egress packets</a></li>
<li><a href="#_multicast_and_clone_copies">7.5.5. Multicast and clone copies</a></li>
</ul>
</li>
<li><a href="#sec-after-egress">7.6. Behavior of packets after egress processing is complete</a></li>
<li><a href="#sec-egress-actions">7.7. Actions for directing packets during egress</a>
<ul class="sectlevel3">
<li><a href="#sec-bqe-drop">7.7.1. Drop operation</a></li>
</ul>
</li>
<li><a href="#_contents_of_packets_sent_out_to_ports">7.8. Contents of packets sent out to ports</a></li>
<li><a href="#sec-clone">7.9. Packet Cloning</a>
<ul class="sectlevel3">
<li><a href="#sec-clone-examples">7.9.1. Clone Examples</a></li>
</ul>
</li>
<li><a href="#sec-resubmit">7.10. Packet Resubmission</a></li>
<li><a href="#sec-recirculate">7.11. Packet Recirculation</a></li>
</ul>
</li>
<li><a href="#_psa_externs">8. PSA Externs</a>
<ul class="sectlevel2">
<li><a href="#sec-extern-restrictions">8.1. Restrictions on where externs may be used</a></li>
<li><a href="#_psa_table_properties">8.2. PSA Table Properties</a>
<ul class="sectlevel3">
<li><a href="#sec-idle-timeout">8.2.1. Table entry timeout notification</a></li>
</ul>
</li>
<li><a href="#sec-pre">8.3. Packet Replication Engine</a></li>
<li><a href="#sec-bqe">8.4. Buffering Queuing Engine</a></li>
<li><a href="#sec-hash-algorithms">8.5. Hashes</a>
<ul class="sectlevel3">
<li><a href="#_hash_function">8.5.1. Hash function</a></li>
</ul>
</li>
<li><a href="#sec-checksums">8.6. Checksums</a>
<ul class="sectlevel3">
<li><a href="#sec-basic-checksum">8.6.1. Basic checksum</a></li>
<li><a href="#sec-incremental-checksum">8.6.2. Incremental checksum</a></li>
<li><a href="#sec-checksum-examples">8.6.3. InternetChecksum examples</a></li>
</ul>
</li>
<li><a href="#_counters">8.7. Counters</a>
<ul class="sectlevel3">
<li><a href="#_counter_types">8.7.1. Counter types</a></li>
<li><a href="#_counter">8.7.2. Counter</a></li>
<li><a href="#sec-direct-counter">8.7.3. Direct Counter</a></li>
<li><a href="#_example_program_using_counters">8.7.4. Example program using counters</a></li>
</ul>
</li>
<li><a href="#sec-meters">8.8. Meters</a>
<ul class="sectlevel3">
<li><a href="#_meter_types">8.8.1. Meter types</a></li>
<li><a href="#_meter_colors">8.8.2. Meter colors</a></li>
<li><a href="#_meter">8.8.3. Meter</a></li>
<li><a href="#_direct_meter">8.8.4. Direct Meter</a></li>
</ul>
</li>
<li><a href="#sec-registers">8.9. Registers</a></li>
<li><a href="#_random">8.10. Random</a></li>
<li><a href="#sec-action-profile">8.11. Action Profile</a>
<ul class="sectlevel3">
<li><a href="#_action_profile_example">8.11.1. Action Profile Example</a></li>
</ul>
</li>
<li><a href="#sec-action-selector">8.12. Action Selector</a>
<ul class="sectlevel3">
<li><a href="#_action_selector_example">8.12.1. Action Selector Example</a></li>
</ul>
</li>
<li><a href="#_timestamps">8.13. Timestamps</a></li>
<li><a href="#sec-packet-digest">8.14. Packet Digest</a></li>
</ul>
</li>
<li><a href="#sec-atomicity-of-control-plane-api-operations">9. Atomicity of control plane API operations</a></li>
<li><a href="#appendix-open-issues">Appendix A: Open Issues</a>
<ul class="sectlevel2">
<li><a href="#_action_selectors">A.1. Action Selectors</a></li>
<li><a href="#_observation_and_control_of_congestion">A.2. Observation and control of congestion</a></li>
<li><a href="#_enabling_full_implementation_of_in_band_network_telemetry">A.3. Enabling full implementation of In-band Network Telemetry</a></li>
<li><a href="#_psa_profiles">A.4. PSA profiles</a></li>
</ul>
</li>
<li><a href="#appendix-internetchecksum-implementation">Appendix B: Implementation of the InternetChecksum extern</a></li>
<li><a href="#appendix-counter-implementation">Appendix C: Example implementation of Counter extern</a></li>
<li><a href="#appendix-rationale">Appendix D: Rationale for design</a>
<ul class="sectlevel2">
<li><a href="#appendix-rationale-egress">D.1. Why egress processing?</a></li>
<li><a href="#appendix-rationale-egress-cannot-change-output-port">D.2. No output port change during egress</a></li>
<li><a href="#appendix-rationale-ingress-deparser-egress-parser">D.3. Ingress deparser and egress parser</a></li>
</ul>
</li>
<li><a href="#appendix-multi-pipeline-psa-devices">Appendix E: Multi-pipeline PSA devices</a></li>
<li><a href="#appendix-packet-ordering">Appendix F: Packet ordering</a></li>
<li><a href="#appendix-empty-action-selector-groups">Appendix G: Supporting empty action selector groups</a></li>
<li><a href="#appendix-revision-history">Appendix H: Revision History</a>
<ul class="sectlevel2">
<li><a href="#_changes_made_in_version_1_2">H.1. Changes made in version 1.2</a>
<ul class="sectlevel3">
<li><a href="#_add_match_kind_optional">H.1.1. Add match_kind <code>optional</code></a></li>
<li><a href="#_remove_control_plane_api_function_signatures">H.1.2. Remove control plane API function signatures</a></li>
</ul>
</li>
<li><a href="#_changes_made_in_version_1_1">H.2. Changes made in version 1.1</a>
<ul class="sectlevel3">
<li><a href="#_numeric_translation_between_p4runtime_api_values_and_data_plane_values">H.2.1. Numeric translation between P4Runtime API values and data plane values</a></li>
<li><a href="#_add_the_ability_for_packet_clone_sessions_to_create_multiple_copies">H.2.2. Add the ability for packet clone sessions to create multiple copies</a></li>
<li><a href="#_add_psa_idle_timeout_table_property">H.2.3. Add psa_idle_timeout table property</a></li>
<li><a href="#_add_psa_empty_group_action_table_property">H.2.4. Add psa_empty_group_action table property</a></li>
<li><a href="#_other_changes">H.2.5. Other changes</a></li>
<li><a href="#_changes_to_the_psa_p4_include_file">H.2.6. Changes to the psa.p4 include file</a></li>
<li><a href="#_changes_to_example_psa_programs_in_the_p4_16psaexamples_directory">H.2.7. Changes to example PSA programs in the <code>p4-16/psa/examples</code> directory</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<div class="title">Abstract</div>
<blockquote>
P4 is a language for expressing how packets are processed by the data
plane of a programmable network forwarding element. P4 programs
specify how the various programmable blocks of a target architecture
are programmed and connected.  The Portable Switch Architecture (PSA)
is a target architecture that describes common capabilities of network
switch devices that process and forward packets across multiple
interface ports.
</blockquote>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect1">
<h2 id="_target_architecture_model">1. Target Architecture Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As an analogy, the PSA is to the P4<sub>16</sub> language as the C standard
library is to the C programming language.  PSA defines a library of
types, P4<sub>16</sub> externs for frequently used constructs such as counters,
meters, and registers, and a set of "packet paths" that enable you to
write P4 programs that control the flow of packets in a packet switch
that has multiple ports, e.g. dozens of Ethernet ports.  By following
the APIs and guidelines here, developers will be able to write P4
programs that are portable across many devices that are conformant to
the PSA.</p>
</div>
<div class="paragraph">
<p>While parts of PSA are specific to network switches, and the "Portable
NIC Architecture" differs significantly from PSA in those parts, we
expect the externs defined here will be of general use across multiple
P4<sub>16</sub> architectures.</p>
</div>
<div class="paragraph">
<p>The Portable Switch Architecture (PSA) Model has six programmable P4
blocks and two fixed-function blocks, as shown in <a href="#fig-switch">Figure 1</a>. The
behavior of the programmable blocks is specified using P4.  The Packet
buffer and Replication Engine (PRE) and the Buffer Queuing Engine (BQE)
are target dependent functional blocks that may be configured for a
fixed set of operations.</p>
</div>
<div id="fig-switch" class="imageblock">
<div class="content">
<img src="figs/psa_pipeline.png" alt="psa pipeline">
</div>
<div class="title">Figure 1. Portable Switch Pipeline</div>
</div>
<div class="paragraph">
<p>Incoming packets are parsed and validated, and then passed to an
ingress match action pipeline, which makes decisions on where the
packets go.  The ingress deparser P4 code specifies the packet
contents to be sent to the packet buffer, and what metadata related to
the packet is carried with it.  After the ingress pipeline, the packet
may optionally be replicated (i.e. copies made to multiple egress
ports), then stored in the packet buffer.</p>
</div>
<div class="paragraph">
<p>For each such egress port, the packet passes through an egress parser
and match action pipeline before it is deparsed and queued to leave
the pipeline.</p>
</div>
<div class="paragraph">
<p>A programmer targeting the PSA is required to define objects in P4 for
the programmable blocks that conform to APIs defined later (see
<a href="#sec-programmable-blocks">Chapter 6</a>).  The programmable block inputs and outputs
are templatized on user defined headers and metadata.  Once these six
blocks are defined, a P4 program for PSA instantiates the <code>main</code>
<code>package</code> object, with the programmable blocks passed as arguments (see
<a href="#sec-pre">Section 8.3</a> for an example).</p>
</div>
<div class="paragraph">
<p>A P4 programmer wishing to maximize the portability of their program
should follow several general guidelines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do not use undefined values in a way that affects the resulting
output packet(s), or for side effects such as updating <code>Counter</code>,
<code>Meter</code> or <code>Register</code> instances.</p>
</li>
<li>
<p>Use as few resources as possible, e.g. table search key bits, array
sizes, quantity of metadata associated with packets, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This document contains excerpts of several P4<sub>16</sub> programs that use
the <code>psa.p4</code> include file and demonstrate features of PSA.  Source
code for the complete programs can be found in the official repository
containing the PSA specification{PSAExamplePrograms}.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_naming_conventions">2. Naming conventions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this document we use the following naming conventions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Types are named using CamelCase followed by <code>_t</code>. For example, <code>PortId_t</code>.</p>
</li>
<li>
<p>Control types and extern object types are named using CamelCase. For
example <code>IngressParser</code>.</p>
</li>
<li>
<p>Struct types are named using lower case words separated by <code>_</code>
followed by <code>_t</code>. For example <code>psa_ingress_input_metadata_t</code>.</p>
</li>
<li>
<p>Actions, extern methods, extern functions, headers, structs, and
instances of controls and externs start with lower case and words
are separated using <code>_</code>. For example <code>send_to_port</code>.</p>
</li>
<li>
<p>Enum members, const definitions, and #define constants are all
caps, with words separated by <code>_</code>. For example <code>PSA_PORT_CPU</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Architecture specific metadata (e.g. structs) are prefixed by <code>psa_</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="packet-paths">3. Packet paths</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#fig-packet-paths">Figure 2</a> shows all possible paths for packets that
must be supported by a PSA implementation.  An implementation is
allowed to support paths for packets that are not described here.</p>
</div>
<div id="fig-packet-paths" class="imageblock">
<div class="content">
<img src="figs/psa-packet-paths-figure.png" alt="psa packet paths figure">
</div>
<div class="title">Figure 2. Packet Paths in PSA</div>
</div>
<div class="paragraph">
<p><a href="#packet-path-abbreviations">Table 1</a> defines the meanings of the
abbreviations in <a href="#fig-packet-paths">Figure 2</a>.  There can be one or more
hardware, software, or PSA architecture components between the "packet
source" and "packet destination" given in that table, e.g. a normal
multicast packet passes through the packet replication engine and
typically also a packet buffer after leaving the ingress deparser,
before arriving at the egress parser.  This table focuses on the
P4-programmable portions of the architecture as sources and
destinations of these packet paths.</p>
</div>
<table id="packet-path-abbreviations" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Packet path abbreviation meanings</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Abbreviation</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Packet Source</th>
<th class="tableblock halign-left valign-top">Packet Destination</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NFP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">normal packet from port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ingress parser</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NFCPU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">packet from CPU port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CPU port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ingress parser</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">normal unicast packet from ingress to egress</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ingress deparser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">egress parser</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">normal multicast-replicated packet from ingress to egress</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ingress deparser, with help from PRE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">egress parser (more than one copy is possible)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">normal packet to port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">egress deparser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTCPU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">normal packet to CPU port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">egress deparser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CPU port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RESUB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resubmitted packet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ingress deparser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ingress parser</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CI2E</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">clone from ingress to egress</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ingress deparser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">egress parser</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RECIRC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">recirculated packet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">egress deparser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ingress parser</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CE2E</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">clone from egress to egress</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">egress deparser</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">egress parser</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Table {results-of-one-pkt-thru-ingress-or-egress} shows what can
happen to a packet as a result of a single time being processed in
ingress, or a single time being processed in egress.  The cases are
the same as shown in <a href="#packet-path-abbreviations">Table 1</a>, but have been
grouped together by similar values of "Processed next by".</p>
</div>
<table id="results-of-one-pkt-thru-ingress-or-egress" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Result of packet processed one time by ingress or egress</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Abbreviation</th>
<th class="tableblock halign-left valign-top">Descriptiona</th>
<th class="tableblock halign-left valign-top">Processed next by</th>
<th class="tableblock halign-left valign-top">Resulting packet(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NFP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">normal packet from port</p></td>
<td class="tableblock halign-left valign-top" rowspan="4"><p class="tableblock">ingress</p></td>
<td class="tableblock halign-left valign-top" rowspan="4"><p class="tableblock">At most one CI2E packet, plus at most one of a RESUB, NU, or NM packet. See <a href="#sec-after-ingress">Section 7.3</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NFCPU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">packet from CPU port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RESUB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resubmitted packet</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RECIRC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">recirculated packet</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">normal unicast packet from ingress to egress</p></td>
<td class="tableblock halign-left valign-top" rowspan="4"><p class="tableblock">egress</p></td>
<td class="tableblock halign-left valign-top" rowspan="4"><p class="tableblock">At most one CE2E packet, plus at most one of a RECIRC, NTP, or NTCPU packet. See <a href="#sec-after-egress">Section 7.6</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">normal multicast-replicated packet from ingress to egress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CI2E</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">clone from ingress to egress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CE2E</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">clone from egress to egress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">normal packet to port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">device at other end of port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">determined by the other device</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NTCPU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">normal packet to CPU port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CPU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">determined by CPU</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There are metadata fields defined by PSA that enable your P4 program
to identify which path each packet arrived on, and to control where it
will go next.  See <a href="#sec-packet-path-details">Chapter 7</a>.</p>
</div>
<div class="paragraph">
<p>For egress packets, the choice between one of multiple egress ports,
the port to the CPU, or the "recirculation port", is made by the
immediately previous processing step (ingress for NU, NM, or CI2E
packets, egress for CE2E packets).  Egress processing can choose to
drop the packet instead of sending it to the port chosen earlier, but
it cannot change the choice to a different port.  Ingress code is the
most common place in a P4 program where the output port(s) are chosen.
The only exception to ingress choosing the output port is for
egress-to-egress clone packets, whose destination port is chosen when
the clone is created in the immediately preceding egress processing
step.  See
<a href="#appendix-rationale-egress-cannot-change-output-port">Section D.2</a> for why this
restriction exists.</p>
</div>
<div class="paragraph">
<p>A single packet received by a PSA system from a port can result in 0,
1, or many packets going out, all under control of the P4 program.
For example, a single packet received from a port could cause all of
the following to occur, if the P4 program so directed it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The original packet received as NFP from port 2.  Ingress processing
creates a CI2E clone destined for the CPU port (copy 1), and a
multicast NM packet to multicast group 18, which is configured in
the PacketReplicationEngine to have copies made to ports 5 (copy 2)
and the recirculate port <code>PSA_PORT_RECIRCULATE</code> (copy 3).</p>
</li>
<li>
<p>Copy 1 performs egress processing, which sends the packet on path
NTCPU to the CPU port.</p>
</li>
<li>
<p>Copy 2 performs egress processing, which creates a CE2E clone
destined for port 8 (copy 4), and sends a NTP packet to port 5.</p>
</li>
<li>
<p>Copy 3 performs egress processing, which does a RECIRC back to
ingress (copy 5).</p>
</li>
<li>
<p>Copy 4 performs egress processing, which sends a NTP packet to port
8.</p>
</li>
<li>
<p>Copy 5 performs ingress processing, which sends a NU packet destined
for port 1 (copy 6).</p>
</li>
<li>
<p>Copy 6 performs egress processing, which drops the packet instead of
sending it to port 1.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is simply an example of what is possible given an appropriately
written P4 program.  There is no need to use all of the packet paths
available.  The numbering of the packet copies above is only for
purposes of distinctly identifying each one in the example.  The ports
described in the example are also arbitrary. A PSA
implementation is free to perform the steps above in many possible
orders.</p>
</div>
<div class="paragraph">
<p>There is no mandated mechanism in PSA to prevent a single received
packet from creating packets that continue to recirculate, resubmit,
or clone from egress to egress indefinitely.  This can be prevented by
suitable testing of your P4 program, and/or creating in your P4
program a "time to live" metadata field that is carried along with
copies of a packet, similar to the IPv4 Time To Live header field.</p>
</div>
<div class="paragraph">
<p>A PSA implementation may optionally drop resubmitted, recirculated, or
egress-to-egress clone packets after an implementation-specific
maximum number of times from the same original packet.  If so, the
implementation should maintain counters of packets dropped for these
reasons, and preferably record some debug information about the first
few packets dropped for these reasons (perhaps only one).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_psa_data_types">4. PSA Data types</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="sec-psa-type-definitions">4.1. PSA type definitions</h3>
<div class="paragraph">
<p>Each PSA implementation will have specific bit widths for the
following types in the data plane.  These widths are defined in the
target specific <code>psa.p4</code> include file.  They are expected to differ
from one PSA implementation to another<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>.</p>
</div>
<div class="paragraph">
<p>For each of these types, the P4Runtime API<sup class="footnote" id="_footnote_p4rt">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> may use bit
widths independent of the targets.  These widths are defined by the
P4Runtime API specification, and they are expected to be at least as
large as the corresponding <code>InHeader_t</code> type below, such that they
hold a value for any target.  All PSA implementations must use data
plane sizes for these types no wider than the corresponding
<code>InHeader_t</code>-defined types.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">/* These are defined using `typedef`, not `type`, so they are truly
 * just different names for the type bit&lt;W&gt; for the particular width W
 * shown.  Unlike the `type` definitions below, values declared with
 * the `typedef` type names can be freely mingled in expressions, just
 * as any value declared with type bit&lt;W&gt; can.  Values declared with
 * one of the `type` names below _cannot_ be so freely mingled, unless
 * you first cast them to the corresponding `typedef` type.  While
 * that may be inconvenient when you need to do arithmetic on such
 * values, it is the price to pay for having all occurrences of values
 * of the `type` types marked as such in the automatically generated
 * control plane API.
 *
 * Note that the width of typedef &lt;name&gt;Uint_t will always be the same
 * as the width of type &lt;name&gt;_t. */</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span>unspecified<span style="color: #0550ae">&gt;</span> <span style="color: #953800">PortIdUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span>unspecified<span style="color: #0550ae">&gt;</span> <span style="color: #953800">MulticastGroupUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span>unspecified<span style="color: #0550ae">&gt;</span> <span style="color: #953800">CloneSessionIdUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span>unspecified<span style="color: #0550ae">&gt;</span> <span style="color: #953800">ClassOfServiceUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span>unspecified<span style="color: #0550ae">&gt;</span> <span style="color: #953800">PacketLengthUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span>unspecified<span style="color: #0550ae">&gt;</span> <span style="color: #953800">EgressInstanceUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span>unspecified<span style="color: #0550ae">&gt;</span> <span style="color: #953800">TimestampUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/PortId_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">32</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span> <span style="color: #953800">PortIdUint_t</span>         <span style="color: #953800">PortId_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/MulticastGroup_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">32</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span> <span style="color: #953800">MulticastGroupUint_t</span> <span style="color: #953800">MulticastGroup_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/CloneSessionId_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">16</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span> <span style="color: #953800">CloneSessionIdUint_t</span> <span style="color: #953800">CloneSessionId_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/ClassOfService_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">8</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span> <span style="color: #953800">ClassOfServiceUint_t</span> <span style="color: #953800">ClassOfService_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/PacketLength_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">16</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span> <span style="color: #953800">PacketLengthUint_t</span>   <span style="color: #953800">PacketLength_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/EgressInstance_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">16</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span> <span style="color: #953800">EgressInstanceUint_t</span> <span style="color: #953800">EgressInstance_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/Timestamp_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">64</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span> <span style="color: #953800">TimestampUint_t</span>      <span style="color: #953800">Timestamp_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">error</span>   <span style="color: #953800">ParserError_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">const</span> <span style="color: #953800">PortId_t</span> PSA_PORT_RECIRCULATE <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PortId_t</span><span style="color: #24292f;background-color: #f6f8fa">)</span> unspecified<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">const</span> <span style="color: #953800">PortId_t</span> PSA_PORT_CPU <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PortId_t</span><span style="color: #24292f;background-color: #f6f8fa">)</span> unspecified<span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">const</span> <span style="color: #953800">CloneSessionId_t</span> PSA_CLONE_SESSION_TO_CPU <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">CloneSessiontId_t</span><span style="color: #24292f;background-color: #f6f8fa">)</span> unspecified<span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #6e7781">/* Note: All of the types with `InHeader` in their name are intended
 * only to carry values of the corresponding types in packet headers
 * between a PSA device and the P4Runtime Server software that manages
 * it.
 *
 * The bit widths here are _independent_ of any particular PSA target
 * device, and should _not_ be customized for each target.
 *
 * The bit widths are intended to be at least as large as any PSA
 * device will ever have for that type.  Thus these types may also be
 * useful to define packet headers that are sent directly between a
 * PSA device and other devices, without going through P4Runtime
 * Server software (e.g. this could be useful for sending packets to a
 * controller or data collection system using higher packet rates than
 * the P4Runtime Server can handle).  If used for this purpose, there
 * is no requirement that the PSA data plane _automatically_ perform
 * the numerical translation of these types that would occur if the
 * header went through the P4Runtime Server.  Any such desired
 * translation is up to the author of the P4 program to perform with
 * explicit code.
 *
 * All widths must be a multiple of 8, so that any subset of these
 * fields may be used in a single P4 header definition, even on P4
 * implementations that restrict headers to contain fields with a
 * total length that is a multiple of 8 bits. */</span>

<span style="color: #6e7781">/* See the comments near the definition of PortIdUint_t for why these
 * typedef definitions exist. */</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">PortIdInHeaderUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">MulticastGroupInHeaderUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">CloneSessionIdInHeaderUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  <span style="color: #953800">ClassOfServiceInHeaderUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">PacketLengthInHeaderUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">EgressInstanceInHeaderUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">64</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">TimestampInHeaderUint_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/PortIdInHeader_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">32</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span>  <span style="color: #953800">PortIdInHeaderUint_t</span>         <span style="color: #953800">PortIdInHeader_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/MulticastGroupInHeader_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">32</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span>  <span style="color: #953800">MulticastGroupInHeaderUint_t</span> <span style="color: #953800">MulticastGroupInHeader_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/CloneSessionIdInHeader_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">16</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span>  <span style="color: #953800">CloneSessionIdInHeaderUint_t</span> <span style="color: #953800">CloneSessionIdInHeader_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/ClassOfServiceInHeader_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">8</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span>  <span style="color: #953800">ClassOfServiceInHeaderUint_t</span> <span style="color: #953800">ClassOfServiceInHeader_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/PacketLengthInHeader_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">16</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span>  <span style="color: #953800">PacketLengthInHeaderUint_t</span>   <span style="color: #953800">PacketLengthInHeader_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/EgressInstanceInHeader_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">16</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span>  <span style="color: #953800">EgressInstanceInHeaderUint_t</span> <span style="color: #953800">EgressInstanceInHeader_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #0550ae">@p4runtime_translation</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"p4.org/psa/v1/TimestampInHeader_t"</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">64</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">type</span>  <span style="color: #953800">TimestampInHeaderUint_t</span>      <span style="color: #953800">TimestampInHeader_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_psa_supported_metadata_types">4.2. PSA supported metadata types</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">PSA_PacketPath_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    NORMAL<span style="color: #24292f;background-color: #f6f8fa">,</span>     <span style="color: #6e7781">/// Packet received by ingress that is none of the cases below.
</span>    NORMAL_UNICAST<span style="color: #24292f;background-color: #f6f8fa">,</span>   <span style="color: #6e7781">/// Normal packet received by egress which is unicast
</span>    NORMAL_MULTICAST<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #6e7781">/// Normal packet received by egress which is multicast
</span>    CLONE_I2E<span style="color: #24292f;background-color: #f6f8fa">,</span>  <span style="color: #6e7781">/// Packet created via a clone operation in ingress,
</span>                <span style="color: #6e7781">/// destined for egress
</span>    CLONE_E2E<span style="color: #24292f;background-color: #f6f8fa">,</span>  <span style="color: #6e7781">/// Packet created via a clone operation in egress,
</span>                <span style="color: #6e7781">/// destined for egress
</span>    RESUBMIT<span style="color: #24292f;background-color: #f6f8fa">,</span>   <span style="color: #6e7781">/// Packet arrival is the result of a resubmit operation
</span>    RECIRCULATE <span style="color: #6e7781">/// Packet arrival is the result of a recirculate operation
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">struct</span> <span style="color: #953800">psa_ingress_parser_input_metadata_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #953800">PortId_t</span>                 ingress_port<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #953800">PSA_PacketPath_t</span>         packet_path<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">struct</span> <span style="color: #953800">psa_egress_parser_input_metadata_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #953800">PortId_t</span>                 egress_port<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #953800">PSA_PacketPath_t</span>         packet_path<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">struct</span> <span style="color: #953800">psa_ingress_input_metadata_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">// All of these values are initialized by the architecture before
</span>  <span style="color: #6e7781">// the Ingress control block begins executing.
</span>  <span style="color: #953800">PortId_t</span>                 ingress_port<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #953800">PSA_PacketPath_t</span>         packet_path<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #953800">Timestamp_t</span>              ingress_timestamp<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #953800">ParserError_t</span>            parser_error<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">struct</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">// The comment after each field specifies its initial value when the
</span>  <span style="color: #6e7781">// Ingress control block begins executing.
</span>  <span style="color: #953800">ClassOfService_t</span>         class_of_service<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// 0
</span>  <span style="color: #953800">bool</span>                     clone<span style="color: #24292f;background-color: #f6f8fa">;</span>            <span style="color: #6e7781">// false
</span>  <span style="color: #953800">CloneSessionId_t</span>         clone_session_id<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// initial value is undefined
</span>  <span style="color: #953800">bool</span>                     drop<span style="color: #24292f;background-color: #f6f8fa">;</span>             <span style="color: #6e7781">// true
</span>  <span style="color: #953800">bool</span>                     resubmit<span style="color: #24292f;background-color: #f6f8fa">;</span>         <span style="color: #6e7781">// false
</span>  <span style="color: #953800">MulticastGroup_t</span>         multicast_group<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// 0
</span>  <span style="color: #953800">PortId_t</span>                 egress_port<span style="color: #24292f;background-color: #f6f8fa">;</span>      <span style="color: #6e7781">// initial value is undefined
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">struct</span> <span style="color: #953800">psa_egress_input_metadata_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #953800">ClassOfService_t</span>         class_of_service<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #953800">PortId_t</span>                 egress_port<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #953800">PSA_PacketPath_t</span>         packet_path<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #953800">EgressInstance_t</span>         instance<span style="color: #24292f;background-color: #f6f8fa">;</span>       <span style="color: #6e7781">/// instance comes from the PacketReplicationEngine
</span>  <span style="color: #953800">Timestamp_t</span>              egress_timestamp<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #953800">ParserError_t</span>            parser_error<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">/// This struct is an 'in' parameter to the egress deparser.  It
/// includes enough data for the egress deparser to distinguish
/// whether the packet should be recirculated or not.
</span><span style="color: #cf222e">struct</span> <span style="color: #953800">psa_egress_deparser_input_metadata_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #953800">PortId_t</span>                 egress_port<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">struct</span> <span style="color: #953800">psa_egress_output_metadata_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">// The comment after each field specifies its initial value when the
</span>  <span style="color: #6e7781">// Egress control block begins executing.
</span>  <span style="color: #953800">bool</span>                     clone<span style="color: #24292f;background-color: #f6f8fa">;</span>         <span style="color: #6e7781">// false
</span>  <span style="color: #953800">CloneSessionId_t</span>         clone_session_id<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// initial value is undefined
</span>  <span style="color: #953800">bool</span>                     drop<span style="color: #24292f;background-color: #f6f8fa">;</span>          <span style="color: #6e7781">// false
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-match-kinds">4.3. Match kinds</h3>
<div class="paragraph">
<p>PSA supports the following additional <code>match_kind</code> types, over and
above the three defined in the P4<sub>16</sub> language specification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">match_kind</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    range<span style="color: #24292f;background-color: #f6f8fa">,</span>    <span style="color: #6e7781">/// Used to represent min..max intervals
</span>    selector<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #6e7781">/// Used for dynamic action selection via the ActionSelector extern
</span>    optional  <span style="color: #6e7781">/// Either an exact match, or a wildcard matching any value for the entire field
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>selector</code> is only supported for tables with an action selector implementation.
See <a href="#sec-action-selector">Section 8.12</a> for details.</p>
</div>
<div class="sect3">
<h4 id="_range_tables">4.3.1. Range tables</h4>
<div class="paragraph">
<p>If a table has at least one <code>range</code> field, then a single search key could match
multiple table entries. Every entry must be assigned a numeric priority by the
control plane software when it is installed. If multiple installed table entries
match the same search key, one among them with the maximum numeric priority will
"win", and its action performed. If there are multiple matching table entries
with the same maximum numeric priority, it is implementation-specific which one
will have its action performed. Control plane software should assign different
priority values to table entries that can match the same packet if they wish to
avoid this implementation-specific behavior.</p>
</div>
<div class="paragraph">
<p>The winner is one with maximum numeric priority value if you use the P4Runtime
API to specify the numeric priorities. Check the documentation of your control
plane API if you use a different one, as some APIs might choose to use the
convention that smaller numeric priority values win over larger ones.</p>
</div>
<div class="paragraph">
<p>A range table may have one or more <code>lpm</code> fields. If so, the prefix length is
used to determine whether a search key matches the entry, but the prefix length
does <em>not</em> determine the relative priority among multiple matching table
entries. Only the numeric priority supplied by the control plane software
determines that.</p>
</div>
<div class="paragraph">
<p>If a range table has entries defined via a <code>const entries</code> table property, then
the relative priority of the entries are highest priority first, to lowest
priority last, based upon the order they appear in the P4 program.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ternary_tables">4.3.2. Ternary tables</h4>
<div class="paragraph">
<p>If a table has no <code>range</code> field, but at least one <code>ternary</code> or <code>optional</code> field,
then as for tables with <code>range</code> fields, a single search key can be matched by
multiple table entries, and thus every entry must have a numeric priority
assigned by the control plane software. The same note about <code>lpm</code> fields in the
previous section applies here, as well as the note about entries specified via
<code>const entries</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_longest_prefix_match_tables">4.3.3. Longest prefix match tables</h4>
<div class="paragraph">
<p>If a table has no <code>range</code>, <code>ternary</code>, nor <code>optional</code> fields, but at least one
<code>lpm</code> field, there must be exactly one <code>lpm</code> field. There may be 0 or more
<code>exact</code> fields in addition to the <code>lpm</code> field. While there can be multiple
installed table entries that match a single search key, there can be at most one
matching table entry of each possible prefix length of the <code>lpm</code> field (because
no two table entries installed at the same time are allowed to have the same
search key). The matching entry with the longest prefix length is always the
winner. The control plane cannot specify a priority when installing entries for
such a table&#8201;&#8212;&#8201;it is always determined by the prefix length.</p>
</div>
<div class="paragraph">
<p>If a longest prefix match table has entries defined via a <code>const entries</code> table
property, then the relative priority of the entries are determined by the prefix
lengths, not by the order they appear in the P4 program.</p>
</div>
</div>
<div class="sect3">
<h4 id="_exact_match_tables">4.3.4. Exact match tables</h4>
<div class="paragraph">
<p>If a table has only <code>exact</code> fields, then for any search key, there can be at
most one matching table entry, because duplicate search keys are not allowed to
be installed. Thus no numeric priority is ever needed to determine the "winning"
matching table entry.</p>
</div>
<div class="paragraph">
<p>If an exact match table has entries defined via a <code>const entries</code> table
property, there can be at most one matching entry for any search key, so the
relative order that entries appear in the P4 program is unimportant in
determining which entry will win.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-data-plane-vs-control-plane-values">5. Data plane vs. control plane data representations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A PSA data plane may support multiple control plane APIs. Some of the
notes in this section apply specifically to the case of the P4Runtime
API<sup class="footnoteref">[<a class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> when used to control a PSA device. If you are using
a different control plane API to control a PSA device, you should
consult the documentation for that control plane API to learn exactly
what API it provides to configure your PSA device.</p>
</div>
<div class="paragraph">
<p>A PSA data plane implementation that supports the P4Runtime
API<sup class="footnoteref">[<a class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> includes software called a "P4Runtime Server" that
enables runtime programming of the PSA device from one or more
"P4Runtime Clients".  For brevity, here we will call a P4Runtime Server
an "agent", and a P4Runtime Client a "controller".  A controller may
control multiple devices with different PSA implementations.</p>
</div>
<div class="paragraph">
<p>As mentioned in <a href="#sec-psa-type-definitions">Section 4.1</a>, different PSA
implementations are expected to customize the size of the data types
that refer directly to those objects in the data plane, i.e. ports,
multicast group ids, etc.</p>
</div>
<div class="paragraph">
<p>Some PSA implementations are expected to use noticeably fewer
resources for things like table keys and action parameters if the data
plane stores only the fewest number of bits required for values of
these types, for that implementation.  For example, an implementation
that defines <code>PortId_t</code> as <code>bit&lt;6&gt;</code> instead of <code>bit&lt;16&gt;</code>, and can take
advantage of this difference, could save 10 Mbits of storage in a
table with a million entries<sup class="footnote" id="_footnote_cachecost">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>.</p>
</div>
<div class="paragraph">
<p>The P4Runtime API uses quantities with bit widths independent
of the target device to hold values of the types
listed in <a href="#sec-psa-type-definitions">Section 4.1</a>, to simplify the
manipulation of these values in the controller and agent software.
For control plane
operations on tables, any trimming or padding of values will be
performed in the agent (usually trimming in the direction from
controller to device, and padding in the direction from device
to controller).</p>
</div>
<div class="paragraph">
<p>There are multiple channels of communication over which such values
might be carried between the controller and the data plane.  These
channels of communication include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Control plane operations on tables, where values of these types may
be included as part of the key, or as an action parameter.</p>
</li>
<li>
<p>Control plane operations on parser value sets, where values of these
types may be included as part of the key.</p>
</li>
<li>
<p>Packets sent to the CPU ("packet in" from the controller&#8217;s
perspective), or received from the CPU ("packet out" from the
controller&#8217;s perspective).</p>
</li>
<li>
<p>Fields in a <code>Digest</code> extern notification message
(<a href="#sec-packet-digest">Section 8.14</a>).</p>
</li>
<li>
<p>Fields in the data contents of a <code>Register</code> array
(<a href="#sec-registers">Section 8.9</a>).</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
There may be other channels not listed above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For packets between the control plane and the PSA device, there is the
issue that many PSA implementations are expected to restrict P4
programs to have headers with fields with a total length that is a
multiple of 8 bits.  To make it possible to define P4 header types
that meet this restriction, and contain values of fields with these
PSA-specific types, and be source-compatible across multiple PSA
implementations, additional types are defined that contain <code>InHeader</code> in
their name.  For example, <code>PortIdInHeader_t</code> is the same as <code>PortId_t</code>,
except it must be a multiple of 8 bits long, and contain at least as
many bits as <code>PortId_t</code> does.</p>
</div>
<div class="paragraph">
<p>Because these <code>InHeader</code> types are guaranteed to be a multiple of 8 bits long,
you may include any combination of them in a P4 header type
definition, as long as the other fields in the header satisfy the
multiple of 8 bits restriction.  The controller or P4 program
generating packets with such headers should fill in any most
significant "padding" bits with 0.  You may do this with a normal
assignment statement in your P4 program, where the value on the
right hand side is cast to the wider <code>InHeader</code> type.  Similarly,
casting a value of a wider type such as <code>PortIdInHeader_t</code> to the
corresponding narrower type <code>PortId_t</code> truncates the excess most
significant bits as part of the cast.</p>
</div>
<div class="paragraph">
<p>Values of type <code>PortId_t</code> have an unusual property in PSA
implementations.  Because it can make some hardware implementations
more straightforward, the numerical values of fields with type
<code>PortId_t</code> in the P4 data plane might not be a simple range of values
such as 0 through 31, as one might choose when writing control plane
software for a 32-port device.  The agent is expected to implement
numerical translation between controller port id values and data plane
port id values, for each of the channels of communication between the
controller and data plane described above.</p>
</div>
<div class="paragraph">
<p>The file <code>psa.p4</code> contains an annotation <code>p4runtime_translation</code> on
the <code>type</code> definition of types <code>PortId_t</code> and <code>PortIdInHeader_t</code>.
This enables the compiler to mark all uses of values of these types
that are accessible from the P4Runtime API, so the agent software
knows that it must translate them, and what kind of translation to
perform.  The benefit is that you do not need to put any special
markings on your uses of values of these types throughout your P4
program.</p>
</div>
<div class="paragraph">
<p>The cost of this approach is: if you want to do arithmetic on values
of these types, you must explicitly cast them to a <code>bit&lt;W&gt;</code>
type.  The <code>psa.p4</code> include file defines <code>PortIdUint_t</code> as a <code>typedef</code>
with exactly the same width in bits as <code>type</code> <code>PortId_t</code>, so you can
cast values of type <code>PortId_t</code> to type <code>PortIdUint_t</code>, and then you
can perform all P4 arithmetic operations on the value.  The result
must be explicitly cast back to type <code>PortId_t</code> if you wish to assign
it to a metadata field with that type.  Corresponding types with
<code>Uint</code> in their name are defined for all PSA types.</p>
</div>
<div class="paragraph">
<p>Because of this translation, we recommend that values of type
<code>PortId_t</code> be treated similarly to values of an <code>enum</code> type.
Comparing two values of this type for equality or "not equal to" is
reasonable, as well as assigning the values to other variables or
parameters of the same type, but nearly any other operations are prone
to error.  When matching values of type <code>PortId_t</code> as part of a table
key, always match a complete value exactly, or wildcard every bit of
the value (i.e. a <code>ternary</code> match kind with all bits wildcard, or an
<code>lpm</code> match kind with prefix length 0).  If you attempt to do any of
the following things on a value with type <code>PortId_t</code> or
<code>PortIdInHeader_t</code>, the numerical translation performed may lead to
functional errors in your program:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do a table key match on a subset of the bits, or a range match.</p>
</li>
<li>
<p>Compare port values with relational operators like <code>&lt;</code> or <code>&gt;</code>.</p>
</li>
<li>
<p>Compare port values to specific numeric literal values like 0 or
0xff.  It is recommended instead to compare their values by using
them as table key fields, or parser value set key fields, against
values installed by the control plane (which have been translated to
the corresponding device-specific value as determined by the
device&#8217;s agent software).  It is also reasonable to compare port
values for equality against the symbolic constant values
<code>PSA_PORT_CPU</code> or <code>PSA_PORT_RECIRCULATE</code>, which have target-specific
numeric values.</p>
</li>
<li>
<p>Perform arithmetic on the value, and expect to get a value that
corresponds to another port of the device.  Some numerical values
may not correspond to any port of the device, and the values
corresponding to ports need not be consecutive.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The list above is not intended to be exhaustive.</p>
</div>
<div class="paragraph">
<p>All of the comments above apply to all types where numerical
translation occurs between the controller and the data plane.  Below
is a complete list of numeric types planned for numerical translation
by default in PSA:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PortId_t</code> or <code>PortIdInHeader_t</code></p>
</li>
<li>
<p><code>ClassOfService_t</code> or <code>ClassOfServiceInHeader_t</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the types listed below, no numerical translation occurs by
default<sup class="footnote" id="_footnote_pcnumtrans">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup>.  A PSA
data plane must support all numerical values from 0 up to the maximum
value that it supports.  Except for <code>Timestamp_t</code> values, the number
of values supported by the data plane need not be a power of 2.
Controllers must have a way to discover each PSA device&#8217;s maximum
supported value for each of these types.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>MulticastGroup_t</code> - 0 is a special value that indicates no
multicast replication is to be performed for a packet, so this type
is an exception to the rule above that 0 must be supported in the
data plane.</p>
</li>
<li>
<p><code>CloneSessionId_t</code></p>
</li>
<li>
<p><code>PacketLength_t</code></p>
</li>
<li>
<p><code>EgressInstance_t</code></p>
</li>
<li>
<p><code>Timestamp_t</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TBD: Values of type <code>Timestamp_t</code> are being considered for numerical translation in the agent software, between target-specific values, and a value with a common unit and 0 value reference across all targets.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that all of these types have a <code>p4runtime_translation</code> annotation
in the <code>psa.p4</code> include file.  This is to ensure that when the
compiler generates a P4Runtime P4Info file from source programs, it
will include in the P4Info file the type specified by the
<code>p4runtime_translation</code> rather than the target-specific bit width.
For the same P4 source program, the P4Info file contents are intended
to be identical for all targets.</p>
</div>
<div class="paragraph">
<p>If the type bitwidth specified as the second parameter to the
<code>p4runtime_translation</code> is different from the device-specific bitwidth
(of the underlying type), we expect the P4Runtime server to perform
the appropriate casting. Additionally, more advanced numerical
translation can be enabled at runtime for any type annotated with
<code>p4runtime_translation</code>, although arbitrary numerical translation is
only mandated for <code>PortId_t</code>, <code>ClassOfService_t</code>, and their <code>Inheader</code>
variants. To request arbitrary numerical translation for a give type,
the P4Runtime system will expect the URI (first parameter to the
<code>p4runtime_translation</code>) and the desired mapping.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-programmable-blocks">6. Programmable blocks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following declarations provide a template for the programmable
blocks in the PSA. The P4 programmer is responsible for
implementing controls that match these interfaces and instantiate
them in a package definition.</p>
</div>
<div class="paragraph">
<p>It uses the same user-defined metadata type <code>IM</code> and header type <code>IH</code>
for all ingress parsers and control blocks.  The egress parser and
control blocks can use the same types for those things, or different
types, as the P4 program author wishes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">parser</span> IngressParser<span style="color: #0550ae">&lt;</span>H<span style="color: #24292f;background-color: #f6f8fa">,</span> M<span style="color: #24292f;background-color: #f6f8fa">,</span> RESUBM<span style="color: #24292f;background-color: #f6f8fa">,</span> RECIRCM<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>
    <span style="color: #cf222e">packet_in</span> buffer<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">out</span> H parsed_hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">inout</span> M user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> <span style="color: #953800">psa_ingress_parser_input_metadata_t</span> istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> RESUBM resubmit_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> RECIRCM recirculate_meta<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">control</span> Ingress<span style="color: #0550ae">&lt;</span>H<span style="color: #24292f;background-color: #f6f8fa">,</span> M<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>
    <span style="color: #cf222e">inout</span> H hdr<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">inout</span> M user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span>    <span style="color: #953800">psa_ingress_input_metadata_t</span>  istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">inout</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> ostd<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">control</span> IngressDeparser<span style="color: #0550ae">&lt;</span>H<span style="color: #24292f;background-color: #f6f8fa">,</span> M<span style="color: #24292f;background-color: #f6f8fa">,</span> CI2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> RESUBM<span style="color: #24292f;background-color: #f6f8fa">,</span> NM<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>
    <span style="color: #cf222e">packet_out</span> buffer<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">out</span> CI2EM clone_i2e_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">out</span> RESUBM resubmit_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">out</span> NM normal_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">inout</span> H hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> M meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> istd<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">parser</span> EgressParser<span style="color: #0550ae">&lt;</span>H<span style="color: #24292f;background-color: #f6f8fa">,</span> M<span style="color: #24292f;background-color: #f6f8fa">,</span> NM<span style="color: #24292f;background-color: #f6f8fa">,</span> CI2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> CE2EM<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>
    <span style="color: #cf222e">packet_in</span> buffer<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">out</span> H parsed_hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">inout</span> M user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> <span style="color: #953800">psa_egress_parser_input_metadata_t</span> istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> NM normal_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> CI2EM clone_i2e_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> CE2EM clone_e2e_meta<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">control</span> Egress<span style="color: #0550ae">&lt;</span>H<span style="color: #24292f;background-color: #f6f8fa">,</span> M<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>
    <span style="color: #cf222e">inout</span> H hdr<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">inout</span> M user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span>    <span style="color: #953800">psa_egress_input_metadata_t</span>  istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">inout</span> <span style="color: #953800">psa_egress_output_metadata_t</span> ostd<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">control</span> EgressDeparser<span style="color: #0550ae">&lt;</span>H<span style="color: #24292f;background-color: #f6f8fa">,</span> M<span style="color: #24292f;background-color: #f6f8fa">,</span> CE2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> RECIRCM<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>
    <span style="color: #cf222e">packet_out</span> buffer<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">out</span> CE2EM clone_e2e_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">out</span> RECIRCM recirculate_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">inout</span> H hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> M meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> <span style="color: #953800">psa_egress_output_metadata_t</span> istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> <span style="color: #953800">psa_egress_deparser_input_metadata_t</span> edstd<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">package</span> IngressPipeline<span style="color: #0550ae">&lt;</span>IH<span style="color: #24292f;background-color: #f6f8fa">,</span> IM<span style="color: #24292f;background-color: #f6f8fa">,</span> NM<span style="color: #24292f;background-color: #f6f8fa">,</span> CI2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> RESUBM<span style="color: #24292f;background-color: #f6f8fa">,</span> RECIRCM<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>
    IngressParser<span style="color: #0550ae">&lt;</span>IH<span style="color: #24292f;background-color: #f6f8fa">,</span> IM<span style="color: #24292f;background-color: #f6f8fa">,</span> RESUBM<span style="color: #24292f;background-color: #f6f8fa">,</span> RECIRCM<span style="color: #0550ae">&gt;</span> ip<span style="color: #24292f;background-color: #f6f8fa">,</span>
    Ingress<span style="color: #0550ae">&lt;</span>IH<span style="color: #24292f;background-color: #f6f8fa">,</span> IM<span style="color: #0550ae">&gt;</span> ig<span style="color: #24292f;background-color: #f6f8fa">,</span>
    IngressDeparser<span style="color: #0550ae">&lt;</span>IH<span style="color: #24292f;background-color: #f6f8fa">,</span> IM<span style="color: #24292f;background-color: #f6f8fa">,</span> CI2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> RESUBM<span style="color: #24292f;background-color: #f6f8fa">,</span> NM<span style="color: #0550ae">&gt;</span> id<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">package</span> EgressPipeline<span style="color: #0550ae">&lt;</span>EH<span style="color: #24292f;background-color: #f6f8fa">,</span> EM<span style="color: #24292f;background-color: #f6f8fa">,</span> NM<span style="color: #24292f;background-color: #f6f8fa">,</span> CI2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> CE2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> RECIRCM<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>
    EgressParser<span style="color: #0550ae">&lt;</span>EH<span style="color: #24292f;background-color: #f6f8fa">,</span> EM<span style="color: #24292f;background-color: #f6f8fa">,</span> NM<span style="color: #24292f;background-color: #f6f8fa">,</span> CI2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> CE2EM<span style="color: #0550ae">&gt;</span> ep<span style="color: #24292f;background-color: #f6f8fa">,</span>
    Egress<span style="color: #0550ae">&lt;</span>EH<span style="color: #24292f;background-color: #f6f8fa">,</span> EM<span style="color: #0550ae">&gt;</span> eg<span style="color: #24292f;background-color: #f6f8fa">,</span>
    EgressDeparser<span style="color: #0550ae">&lt;</span>EH<span style="color: #24292f;background-color: #f6f8fa">,</span> EM<span style="color: #24292f;background-color: #f6f8fa">,</span> CE2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> RECIRCM<span style="color: #0550ae">&gt;</span> ed<span style="color: #24292f;background-color: #f6f8fa">);</span>

<span style="color: #cf222e">package</span> PSA_Switch<span style="color: #0550ae">&lt;</span>IH<span style="color: #24292f;background-color: #f6f8fa">,</span> IM<span style="color: #24292f;background-color: #f6f8fa">,</span> EH<span style="color: #24292f;background-color: #f6f8fa">,</span> EM<span style="color: #24292f;background-color: #f6f8fa">,</span> NM<span style="color: #24292f;background-color: #f6f8fa">,</span> CI2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> CE2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> RESUBM<span style="color: #24292f;background-color: #f6f8fa">,</span> RECIRCM<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>
    IngressPipeline<span style="color: #0550ae">&lt;</span>IH<span style="color: #24292f;background-color: #f6f8fa">,</span> IM<span style="color: #24292f;background-color: #f6f8fa">,</span> NM<span style="color: #24292f;background-color: #f6f8fa">,</span> CI2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> RESUBM<span style="color: #24292f;background-color: #f6f8fa">,</span> RECIRCM<span style="color: #0550ae">&gt;</span> ingress<span style="color: #24292f;background-color: #f6f8fa">,</span>
    PacketReplicationEngine pre<span style="color: #24292f;background-color: #f6f8fa">,</span>
    EgressPipeline<span style="color: #0550ae">&lt;</span>EH<span style="color: #24292f;background-color: #f6f8fa">,</span> EM<span style="color: #24292f;background-color: #f6f8fa">,</span> NM<span style="color: #24292f;background-color: #f6f8fa">,</span> CI2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> CE2EM<span style="color: #24292f;background-color: #f6f8fa">,</span> RECIRCM<span style="color: #0550ae">&gt;</span> egress<span style="color: #24292f;background-color: #f6f8fa">,</span>
    BufferingQueueingEngine bqe<span style="color: #24292f;background-color: #f6f8fa">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-packet-path-details">7. Packet Path Details</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Refer to section {packet-paths} for the packet paths provided by PSA,
and their abbreviated names, used often in this section.</p>
</div>
<div class="sect2">
<h3 id="_initial_values_of_packets_processed_by_ingress">7.1. Initial values of packets processed by ingress</h3>
<div class="paragraph">
<p>Table [#ingress-initial-values] describes the initial values of the
packet contents and metadata when a packet begins ingress processing.</p>
</div>
<table id="ingress-initial-values" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Initial values for packets processed by ingress</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">NFP</th>
<th class="tableblock halign-left valign-top">NFCPU</th>
<th class="tableblock halign-left valign-top">RESUB</th>
<th class="tableblock halign-left valign-top">RECIRC</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>packet_in</code></p></td>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">see text</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user_meta</code></p></td>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">see text</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="5"><p class="tableblock">IngressParser <code>istd</code> fields (type <code>psa_ingress_parser_input_metadata_t</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ingress_port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PortId_t</code> value of packets' input port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PSA_PORT_CPU</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">copied from resub&#8217;d packet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PSA_PORT_RECIRCULATE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>packet_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NORMAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NORMAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>RESUBMIT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>RECIRCULATE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="5"><p class="tableblock">Ingress <code>istd</code> fields (type <code>psa_ingress_input_metadata_t</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ingress_port</code></p></td>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">Same value as received by IngressParser above.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>packet_path</code></p></td>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">Same value as received by IngressParser above.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ingress_timestamp</code></p></td>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">Time that packet began processing in IngressParser. For RESUB or RECIRC packets, the time the 'copy' began IngressParser, not the original.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parser_error</code></p></td>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">From IngressParser.  Always <code>error.NoError</code> if there was no parser error.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that the <code>ingress_port</code> value for a resubmitted packet could be
<code>PSA_PORT_RECIRCULATE</code> if a packet was recirculated, and then that
recirculated packet was resubmitted.</p>
</div>
</div>
<div class="sect2">
<h3 id="_initial_packet_contents_for_packets_from_ports">7.2. Initial packet contents for packets from ports</h3>
<div class="paragraph">
<p>For Ethernet ports, <code>packet_in</code> for FP and NFCPU path packets contains
the Ethernet frame starting with the Ethernet header.  It does not
include the Ethernet frame CRC.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TBD Whether the payload is always the minimum of 46 bytes (64 byte minimum Ethernet frame size, minus 14 bytes of header, minus 4 bytes of CRC), or whether an implementation is allowed to leave some of those bytes out.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The PSA does not put further restrictions on <code>packet_in.length()</code>
as defined in the P4<sub>16</sub> spec. Targets that do not support it, should provide mechanisms
to raise an error.</p>
</div>
<div class="paragraph">
<p>The P4Runtime has a "Packet Out" capability to send a packet from the
controller to a PSA device.  Such packets are sent into the PSA device
as NFCPU path packets.  There is no metadata associated with such
packets, only the contents of the packet that are parsed normally by
the P4 program&#8217;s IngressParser code.  There may be some translation of
header field values, as described in
<a href="#sec-data-plane-vs-control-plane-values">Chapter 5</a>.</p>
</div>
<div class="sect3">
<h4 id="_initial_packet_contents_for_resubmitted_packets">7.2.1. Initial packet contents for resubmitted packets</h4>
<div class="paragraph">
<p>For RESUB packets, <code>packet_in</code> is the same as the pre-IngressParser
contents of <code>packet_in</code>, for the packet that caused this resubmitted
packet to occur (i.e. with NO modifications from any ingress processing).</p>
</div>
</div>
<div class="sect3">
<h4 id="_initial_packet_contents_for_recirculated_packets">7.2.2. Initial packet contents for recirculated packets</h4>
<div class="paragraph">
<p>For RECIRC packets, <code>packet_in</code> is created by starting with the
headers emitted by the egress deparser of the egress packet that was
recirculated, followed by the payload of that packet, i.e. the part
that was not parsed by the egress parser.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-ingress_initial-metadata">7.2.3. User-defined metadata for all ingress packets</h4>
<div class="paragraph">
<p>The PSA architecture does not mandate initialization of user-defined
metadata to known values as given as input to the ingress parser.  If
a user&#8217;s P4 program explicitly initializes all user-defined metadata
early on (e.g. in the parser&#8217;s <code>start</code> state), then that will flow
through the rest of the parser into the <code>Ingress</code> control block as one
might normally expect.  This will be left as an option to the user in
their P4 programs, not required behavior for all P4 programs.</p>
</div>
<div class="paragraph">
<p>There are two direction <code>in</code> parameters to the ingress parser with
user-defined types, named <code>resubmit_meta</code> and <code>recirculate_meta</code>.
They may be used to carry metadata for resubmitted and recirculated
packets.</p>
</div>
<div class="paragraph">
<p>Consider a packet that arrives at the ingress pipeline, and during
ingress processing the P4 program assigns values to fields of the PSA
standard metadata such that the packet is resubmitted (see
<a href="#sec-after-ingress">Section 7.3</a> for details on how to do so).  In the ingress
deparser, the P4 program assigns a value to the <code>out</code> parameter named
<code>resubmit_meta</code>.  This value (which can be a collection of many
individual values in fields, sub-structs, headers, etc.) becomes
associated with the resubmitted packet by the PSA implementation, and
when the resubmitted packet begins ingress parsing, that becomes the
value of the <code>in</code> parameter named <code>resubmit_meta</code> to the ingress
parser.</p>
</div>
<div class="paragraph">
<p>For resubmitted packets, the value of the <code>in</code> parameter named
<code>recirculate_meta</code> is undefined.</p>
</div>
<div class="paragraph">
<p>Conversely, for recirculated packets, the value of the <code>in</code> parameter
named <code>recirculate_meta</code> contains whatever value was assigned to the
egress deparser <code>out</code> parameter named <code>recirculate_meta</code> when the
packet was recirculated.  The value of the <code>in</code> parameter
<code>resubmit_meta</code> is undefined for recirculated packets.</p>
</div>
<div class="paragraph">
<p>For packets from a port, including the CPU port, both of the <code>in</code>
parameters <code>resubmit_meta</code> and <code>recirculate_meta</code> are undefined.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-after-ingress">7.3. Behavior of packets after ingress processing is complete</h3>
<div class="paragraph">
<p>The pseudocode below defines where copies of packets will be made
after the <code>Ingress</code> control block has completed executing, based upon
the contents of several metadata fields in the struct
<code>psa_ingress_output_metadata_t</code>.</p>
</div>
<div class="paragraph">
<p>The function <code>platform_port_valid()</code> mentioned below takes a value of
type <code>PortId_t</code>, returning <code>true</code> only when the value represents an
output port for the implementation. It is expected that for some PSA
implementations there will be bit patterns for a value of type
<code>PortId_t</code> that do not correspond to any port. This function returns
true for both <code>PSA_PORT_CPU</code> and <code>PSA_PORT_RECIRCULATE</code>. <code>platform_port_valid</code>
is not defined in PSA for calling from the P4 data-plane program,
since there is no known use case for calling it at packet processing
time. It is intended for describing the behavior in pseudocode.  The
control plane is expected to configure tables with valid port numbers.</p>
</div>
<div class="paragraph">
<p>A comment saying "recommended to log error" is not a requirement, but
a recommendation, that a PSA implementation should maintain a counter
that counts the number of times this error occurs.  It would also be
useful if the implementation recorded details about the first few
times this error occurred, e.g. a FIFO queue of the first several
invalid values of <code>ostd.egress_port</code> that cause an error to occur,
perhaps with other information about the packet that caused it, with
tail dropping if it fills up.  Control plane or driver software would
be able to read these counters, and read and drain the FIFO queues to
assist P4 developers in debugging their code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">// The comment after each field specifies its initial value when the
</span>  <span style="color: #6e7781">// Ingress control block begins executing.
</span>  <span style="color: #953800">ClassOfService_t</span>         class_of_service<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// 0
</span>  <span style="color: #953800">bool</span>                     clone<span style="color: #24292f;background-color: #f6f8fa">;</span>            <span style="color: #6e7781">// false
</span>  <span style="color: #953800">CloneSessionId_t</span>         clone_session_id<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// initial value is undefined
</span>  <span style="color: #953800">bool</span>                     drop<span style="color: #24292f;background-color: #f6f8fa">;</span>             <span style="color: #6e7781">// true
</span>  <span style="color: #953800">bool</span>                     resubmit<span style="color: #24292f;background-color: #f6f8fa">;</span>         <span style="color: #6e7781">// false
</span>  <span style="color: #953800">MulticastGroup_t</span>         multicast_group<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">// 0
</span>  <span style="color: #953800">PortId_t</span>                 egress_port<span style="color: #24292f;background-color: #f6f8fa">;</span>      <span style="color: #6e7781">// initial value is undefined
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>First we give an outline of behavior, for quick reference of the
relative priority of the possible actions.  This outline is only for
reader convenience&#8201;&#8212;&#8201;it is not the specification for the behavior.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">    <span style="color: #953800">psa_ingress_output_metadata_t</span> ostd<span style="color: #24292f;background-color: #f6f8fa">;</span>

    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>clone<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        create ingress to egress clone<span style="color: #24292f;background-color: #f6f8fa">(</span>s<span style="color: #24292f;background-color: #f6f8fa">),</span> with options as configured by
            the PRE clone session numbered ostd<span style="color: #0550ae">.</span>clone_session_id<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> no clone<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>

    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>drop<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> drop packet<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">else</span> <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>resubmit<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> resubmit packet<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">else</span> <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>multicast_group <span style="color: #0550ae">!=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> PRE multicast replicates packet<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">else</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> PRE sends one copy of packet to ostd<span style="color: #0550ae">.</span>egress_port<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The pseudocode below defines the behavior a PSA implementation must
follow.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">    <span style="color: #953800">psa_ingress_output_metadata_t</span> ostd<span style="color: #24292f;background-color: #f6f8fa">;</span>

    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>clone<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>clone_session_id value is supported<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            from the values configured for ostd<span style="color: #0550ae">.</span>clone_session_id <span style="color: #cf222e">in</span> PRE <span style="color: #24292f;background-color: #f6f8fa">{</span>
                cos <span style="color: #0550ae">=</span> class_of_service
                set<span style="color: #24292f;background-color: #f6f8fa">((</span>egress_port<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">],</span> instance<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">]),</span> <span style="color: #0550ae">...</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>egress_port<span style="color: #24292f;background-color: #f6f8fa">[</span>n<span style="color: #24292f;background-color: #f6f8fa">],</span> instance<span style="color: #24292f;background-color: #f6f8fa">[</span>n<span style="color: #24292f;background-color: #f6f8fa">]))</span> <span style="color: #0550ae">=</span>
                    set of egress_port and instance pairs
                trunc <span style="color: #0550ae">=</span> truncate
                plen <span style="color: #0550ae">=</span> packet_length_bytes
            <span style="color: #24292f;background-color: #f6f8fa">}</span>
            <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>cos value is not supported<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
                cos <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
                <span style="color: #6e7781">// Recommended to log error about unsupported cos value.
</span>            <span style="color: #24292f;background-color: #f6f8fa">}</span>
            for each pair <span style="color: #24292f;background-color: #f6f8fa">(</span>egress_port<span style="color: #24292f;background-color: #f6f8fa">,</span> instance<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">in</span> the set <span style="color: #24292f;background-color: #f6f8fa">{</span>
                Create a clone of the packet and send it to the packet
                buffer with the egress_port<span style="color: #24292f;background-color: #f6f8fa">,</span> instance<span style="color: #24292f;background-color: #f6f8fa">,</span> and
                class_of_service cos<span style="color: #24292f;background-color: #f6f8fa">,</span> after which it will start egress
                processing<span style="color: #0550ae">.</span>  It will contain at most the first plen
                bytes of the packet as received at the ingress <span style="color: #cf222e">parser</span>
                <span style="color: #cf222e">if</span> trunc is true<span style="color: #24292f;background-color: #f6f8fa">,</span> otherwise the entire packet<span style="color: #0550ae">.</span>
            <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #6e7781">// Do not create a clone.  Recommended to log error about
</span>            <span style="color: #6e7781">// unsupported ostd.clone_session_id value.
</span>        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #6e7781">// Continue below, regardless of whether a clone was created.
</span>    <span style="color: #6e7781">// Any clone created above is unaffected by the code below.
</span>    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>drop<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        drop the packet
        <span style="color: #cf222e">return</span><span style="color: #24292f;background-color: #f6f8fa">;</span>   <span style="color: #6e7781">// Do not continue below.
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>class_of_service value is not supported<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        ostd<span style="color: #0550ae">.</span>class_of_service <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">;</span>    <span style="color: #6e7781">// use default class 0 instead
</span>        <span style="color: #6e7781">// Recommended to log error about unsupported
</span>        <span style="color: #6e7781">// ostd.class_of_service value.
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>resubmit<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        resubmit the packet<span style="color: #24292f;background-color: #f6f8fa">,</span> i<span style="color: #0550ae">.</span>e<span style="color: #0550ae">.</span> it will go back to starting with the
            ingress <span style="color: #cf222e">parser</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #cf222e">return</span><span style="color: #24292f;background-color: #f6f8fa">;</span>   <span style="color: #6e7781">// Do not continue below.
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>multicast_group <span style="color: #0550ae">!=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        Make <span style="color: #0550ae">0</span> or more copies of the packet according to the <span style="color: #cf222e">control</span>
            plane configuration of multicast group ostd<span style="color: #0550ae">.</span>multicast_group<span style="color: #0550ae">.</span>
            Every copy will have the same value of ostd<span style="color: #0550ae">.</span>class_of_service
        <span style="color: #cf222e">return</span><span style="color: #24292f;background-color: #f6f8fa">;</span>   <span style="color: #6e7781">// Do not continue below.
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>platform_port_valid<span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>egress_port<span style="color: #24292f;background-color: #f6f8fa">))</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        enqueue one packet for output port ostd<span style="color: #0550ae">.</span>egress_port with class
            of service ostd<span style="color: #0550ae">.</span>class_of_service
    <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        drop the packet
        <span style="color: #6e7781">// Recommended to log error about unsupported ostd.egress_port value.
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Whenever the pseudocode above indicates that a packet should be sent
on a particular packet path, a PSA implementation may under some
circumstances instead drop the packet.  For example, the packet buffer
may be too low on available space for storing new packets, or some
other congestion control mechanism such as RED (Random Early
Detection) or AFD (Approximate Fair Dropping) may select the packet
for dropping.  It is recommended that an implementation maintain
counters of packets dropped, preferably with separate counters for as
many different reasons as the implementation has for dropping packets
outside the control of the P4 program.</p>
</div>
<div class="paragraph">
<p>A PSA implementation may implement multiple classes of service for
packets sent to the packet buffer.  If so, the <code>Ingress</code> control block
may choose to assign a value to the <code>ostd.class_of_service</code> field to
change the packet&#8217;s class of service to a value other than the default
of 0.</p>
</div>
<div class="paragraph">
<p>PSA only specifies how the <code>Ingress</code> control block can control the class
of service of packets.  PSA does not mandate a scheduling policy among
queues that may exist in the packet buffer.  Something at least as
flexible as weighted fair queuing, with an optional strict high
priority queue, is recommended for PSA implementations with separate
queues for each class of service.  See
<a href="#appendix-packet-ordering">Appendix F</a> for more on packet ordering
recommendations in PSA devices.</p>
</div>
<div class="paragraph">
<p>The P4Runtime API specification defines how a controller may discover
the number of distinct class of service values that a PSA device
supports.</p>
</div>
<div class="sect3">
<h4 id="sec-multicast">7.3.1. Multicast replication</h4>
<div class="paragraph">
<p>The control plane may configure each <code>multicast_group</code> in the PRE to
create the desired copies of packets sent to that group.  Each group
begins empty.  Sending a packet to an empty group causes the packet to
be dropped.  The control plane may add one or more pairs of the form
<code>(egress_port, instance)</code> to a multicast group, and may also remove
pairs from a group that were added earlier.</p>
</div>
<div class="paragraph">
<p>Suppose a multicast group contains the following set of pairs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">    <span style="color: #24292f;background-color: #f6f8fa">(</span>egress_port<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">],</span> instance<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">]),</span>
    <span style="color: #24292f;background-color: #f6f8fa">(</span>egress_port<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">],</span> instance<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">]),</span>
    <span style="color: #0550ae">...</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #24292f;background-color: #f6f8fa">(</span>egress_port<span style="color: #24292f;background-color: #f6f8fa">[</span>N<span style="color: #0550ae">-</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">],</span> instance<span style="color: #24292f;background-color: #f6f8fa">[</span>N<span style="color: #0550ae">-</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When a packet is sent to that group, <code>N</code> copies of the packet are
made.  Copy number <code>i</code> that is sent to egress processing will have its
<code>struct</code> of type <code>psa_egress_input_metadata_t</code> filled in with the
field <code>egress_port</code> equal to <code>egress_port[i]</code>, and the field
<code>instance</code> filled in with <code>instance[i]</code>.  Note: A multicast group is a
set of pairs, and it is not required that an implementation create
copies in an order that the control plane can enforce.  See
<a href="#appendix-packet-ordering">Appendix F</a> for more on packet ordering
recommendations in PSA devices.</p>
</div>
<div class="paragraph">
<p>Within a single multicast group, the pairs <code>(egress_port, instance)</code>
must be different from each other, but it is allowed for any number of
pairs within a multicast group to have the same value of
<code>egress_port</code>, or to have the same value of <code>instance</code>.  The same pair
<code>(egress_port, instance)</code> can occur in any number of different
multicast groups.</p>
</div>
<div class="paragraph">
<p>A PSA implementation need only support <code>egress_port</code> values that
represent single ports of the PSA device.  That is, it need not
implement support for <code>egress_port</code> values that represent an entire
Link Aggregation Group (LAG) interface, which is a set of physical
ports over which load balancing of traffic is performed.</p>
</div>
<div class="paragraph">
<p>A PSA device must support <code>egress_port</code> values in a multicast group
that are equal to <code>PSA_PORT_CPU</code> or <code>PSA_PORT_RECIRCULATE</code>.  The copies of a
multicast packet made to those ports will behave the same in egress as
a unicast packets sent to the corresponding port, i.e. if not dropped,
those copies will go the the CPU port, or be recirculated back to
ingress.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-ingress-actions">7.4. Actions for directing packets during ingress</h3>
<div class="paragraph">
<p>All of these actions modify one or more metadata fields in the struct
with type <code>psa_ingress_output_metadata_t</code> that is an <code>inout</code> parameter
of the <code>Ingress</code> control block.  None of these actions have any other
immediate effect.  What happens to the packet is determined by the
value of all fields in that struct when ingress processing is
complete, not at the time one of these actions is called. See
<a href="#sec-after-ingress">Section 7.3</a>.</p>
</div>
<div class="paragraph">
<p>These actions are provided for convenience in making changes to these
metadata fields.  Their effects are expected to be common kinds of
changes one will want to make in a P4 program.  If they do not suit
your use cases, you may modify the metadata fields directly in your P4
programs however you prefer, e.g. within actions you define.</p>
</div>
<div class="sect3">
<h4 id="_unicast_operation">7.4.1. Unicast operation</h4>
<div class="paragraph">
<p>Sends packet to a port.  See Table [#egress-initial-values], column
NU, for how metadata fields are filled in when such a packet begins
egress processing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">/// Modify ingress output metadata to cause one packet to be sent to
/// egress processing, and then to the output port egress_port.
/// (Egress processing may choose to drop the packet instead.)
</span>
<span style="color: #6e7781">/// This action does not change whether a clone or resubmit operation
/// will occur.
</span>
<span style="color: #0550ae">@noWarn</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"unused"</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">action</span> send_to_port<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                    <span style="color: #cf222e">in</span> <span style="color: #953800">PortId_t</span> egress_port<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    meta<span style="color: #0550ae">.</span>drop <span style="color: #0550ae">=</span> false<span style="color: #24292f;background-color: #f6f8fa">;</span>
    meta<span style="color: #0550ae">.</span>multicast_group <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">MulticastGroup_t</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    meta<span style="color: #0550ae">.</span>egress_port <span style="color: #0550ae">=</span> egress_port<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_multicast_operation">7.4.2. Multicast operation</h4>
<div class="paragraph">
<p>Sends packet to a multicast group or a port.  See Table
[#egress-initial-values], column NM, for how metadata fields are
filled in when each multicast-replicated copy of such a packet begins
egress processing.</p>
</div>
<div class="paragraph">
<p>The <code>multicast_group</code> parameter is the multicast group id.  The
control plane must configure the multicast groups through a separate
mechanism such as the P4Runtime API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">/// Modify ingress output metadata to cause 0 or more copies of the
/// packet to be sent to egress processing.
</span>
<span style="color: #6e7781">/// This action does not change whether a clone or resubmit operation
/// will occur.
</span>
<span style="color: #0550ae">@noWarn</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"unused"</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">action</span> multicast<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                 <span style="color: #cf222e">in</span> <span style="color: #953800">MulticastGroup_t</span> multicast_group<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    meta<span style="color: #0550ae">.</span>drop <span style="color: #0550ae">=</span> false<span style="color: #24292f;background-color: #f6f8fa">;</span>
    meta<span style="color: #0550ae">.</span>multicast_group <span style="color: #0550ae">=</span> multicast_group<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_drop_operation">7.4.3. Drop operation</h4>
<div class="paragraph">
<p>Do not send a copy of the packet for normal egress processing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">/// Modify ingress output metadata to cause no packet to be sent for
/// normal egress processing.
</span>
<span style="color: #6e7781">/// This action does not change whether a clone will occur.  It will
/// prevent a packet from being resubmitted.
</span>
<span style="color: #0550ae">@noWarn</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"unused"</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">action</span> ingress_drop<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> meta<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    meta<span style="color: #0550ae">.</span>drop <span style="color: #0550ae">=</span> true<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-initial-values-egress">7.5. Initial values of packets processed by egress</h3>
<div class="paragraph">
<p>Table {egress-initial-values} describes the initial values of the
packet contents and metadata when a packet begins egress processing.</p>
</div>
<table id="egress-initial-values" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Initial values for packets processed by egress</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">NU</th>
<th class="tableblock halign-left valign-top">NM</th>
<th class="tableblock halign-left valign-top">CI2E</th>
<th class="tableblock halign-left valign-top">CE2E</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>packet_in</code></p></td>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">see text</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user_meta</code></p></td>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">see text</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="5"><p class="tableblock">EgressParser <code>istd</code> fields (type <code>psa_egress_parser_input_metadata_t</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>egress_port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ostd.egress_port</code> of ingress packet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">from PRE configuration of multicast group</p></td>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">from PRE configuration of clone session</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>packet_path</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NORMAL_UNICAST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NORMAL_MULTICAST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CLONE_I2E</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CLONE_E2E</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="5"><p class="tableblock">Egress <code>istd</code> fields (type <code>psa_egress_input_metadata_t</code>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>class_of_service</code></p></td>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock"><code>ostd.class_of_service</code> of ingress packet</p></td>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">from PRE configuration of clone session</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>egress_port</code></p></td>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">Same value as received by EgressParser above.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>packet_path</code></p></td>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">Same value as received by EgressParser above.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instance</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">from PRE configuration of multicast group</p></td>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">from PRE configuration of clone session</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>egress_timestamp</code></p></td>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">Time that packet began processing in EgressParser.  Filled in independently for each copy of a multicast-replicated packet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>parser_error</code></p></td>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock">From EgressParser.  Always <code>error.NoError</code> if there was no parser error.  See "Multicast copies" section.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Note that while some P4 architectures have a standard metadata field
that gives the length of the packet in bytes, there is no such field
in PSA.  If a target device supports cut-through
switching<sup class="footnote" id="_footnote_cutthru">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup> and this feature is enabled, it is
possible for egress processing to begin before the last byte of the
packet has arrived on the input port.  Thus it is not possible for the
target device to determine the packet length yet.  It is recommended
that a P4 developer use fields available in some packet headers to
determine the length of a packet, such as the Total Length field in
the IPv4 header, or the Payload length field in the IPv6 header.</p>
</div>
<div class="sect3">
<h4 id="_initial_packet_contents_for_normal_packets">7.5.1. Initial packet contents for normal packets</h4>
<div class="paragraph">
<p>For NU and NM packets, <code>packet_in</code> comes from the ingress packet that
caused this packet to be sent to egress.  It starts with the packet
headers as emitted by the ingress deparser, followed by the payload of
that packet, i.e. the part that was not parsed by the ingress parser.</p>
</div>
<div class="paragraph">
<p>Packets to be recirculated, i.e. those sent to port <code>PSA_PORT_RECIRCULATE</code>
via the normal unicast or multicast packet paths, fit into this
category.  They are not treated differently by a PSA implementation
from normal unicast or multicast packets until they reach the egress
deparser.</p>
</div>
</div>
<div class="sect3">
<h4 id="_initial_packet_contents_for_packets_cloned_from_ingress_to_egress">7.5.2. Initial packet contents for packets cloned from ingress to egress</h4>
<div class="paragraph">
<p>For CI2E packets, <code>packet_in</code> is from the ingress packet that caused
this clone to be created.  It is the same as the pre-IngressParser
contents of <code>packet_in</code> of that ingress packet, with no modifications
from any ingress processing.  Truncation of the payload is supported.</p>
</div>
<div class="paragraph">
<p>Packets cloned in ingress using a clone session configured with
<code>egress_port</code> equal to <code>PSA_PORT_RECIRCULATE</code> fit into this category.</p>
</div>
</div>
<div class="sect3">
<h4 id="_initial_packet_contents_for_packets_cloned_from_egress_to_egress">7.5.3. Initial packet contents for packets cloned from egress to egress</h4>
<div class="paragraph">
<p>For CE2E packets, <code>packet_in</code> is from the egress packet that caused this
clone to be created.  It starts with the headers emitted by the egress
deparser, followed by the payload of that packet, i.e. the part that
was not parsed by the egress parser.  Truncation of the payload is
supported.</p>
</div>
<div class="paragraph">
<p>Packets cloned in egress using a clone session configured with
<code>egress_port</code> equal to <code>PSA_PORT_RECIRCULATE</code> fit into this category.</p>
</div>
</div>
<div class="sect3">
<h4 id="_user_defined_metadata_for_all_egress_packets">7.5.4. User-defined metadata for all egress packets</h4>
<div class="paragraph">
<p>This is very similar to how metadata is initialized for ingress
packets.  See <a href="#sec-ingress_initial-metadata">Section 7.2.3</a>.</p>
</div>
<div class="paragraph">
<p>The primary differences for egress packets are the different packet
paths involved.  There are three parameters with direction <code>in</code> for
the egress parser, named <code>normal_meta</code>, <code>clone_i2e_meta</code>, and
<code>clone_e2e_meta</code>.  For every packet that begins egress processing,
exactly one of those three has defined contents, and the other two
have undefined contents.</p>
</div>
<div class="paragraph">
<p>For NU and NM packets, the parameter <code>normal_meta</code> is the only one
with defined contents.  Its value is the one that was assigned to the
<code>out</code> parameter with the same name of the ingress deparser, when the
normal packet was completing its ingress processing.</p>
</div>
<div class="paragraph">
<p>For CLONE_I2E packets, the parameter <code>clone_i2e_meta</code> is the only one
with defined contents.  Its value is the one that was assigned to the
<code>out</code> parameter with the same name of the ingress deparser, when the
clone was created.</p>
</div>
<div class="paragraph">
<p>For CLONE_E2E packets, the parameter <code>clone_e2e_meta</code> is the only one
with defined contents.  Its value is the one that was assigned to the
<code>out</code> parameter with the same name of the egress deparser, when the
clone was created.</p>
</div>
</div>
<div class="sect3">
<h4 id="_multicast_and_clone_copies">7.5.5. Multicast and clone copies</h4>
<div class="paragraph">
<p>The following fields may differ among copies of a multicast-replicated
packet that are processed in egress.  Similarly for copies of a cloned
packet when they are processed in egress.  Both are referred to as
replicated packets in this section.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>egress_port</code> - This field will typically differ among copies of a
replicated packet, but it may also be the same for
arbitrary copies, as determined by the control plane configuration
of the PacketReplicationEngine.  It is expected that the control
plane will configure the PacketReplicationEngine so that each copy
of the same original packet is assigned a unique value of the pair
<code>(egress_port, instance)</code>.</p>
</li>
<li>
<p><code>instance</code> - See <code>egress_port</code></p>
</li>
<li>
<p><code>egress_timestamp</code> - This value is filled in independently for each
copy of a replicated packet.  Depending upon the quantity
of traffic destined to each output port, the timestamp could vary
significantly between copies of the same original packet.</p>
</li>
<li>
<p><code>parser_error</code> - In the common case, this will typically be the same
for every copy of the same original replicated packet.
However, it is determined by the EgressParser P4 code for each copy
independently, so if that parsing behavior depends upon a field that
can differ among copies, e.g. <code>egress_port</code>, then <code>parser_error</code>
can differ among copies.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All contents of a packet and its associated metadata, other than those
mentioned above, will be the same for every copy of the same original
replicated packet.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-after-egress">7.6. Behavior of packets after egress processing is complete</h3>
<div class="paragraph">
<p>The pseudocode below defines where copies of packets will be made
after the <code>Egress</code> control block has completed executing, based upon
the contents of several metadata fields in the struct
<code>psa_egress_output_metadata_t</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> <span style="color: #953800">psa_egress_output_metadata_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">// The comment after each field specifies its initial value when the
</span>  <span style="color: #6e7781">// Egress control block begins executing.
</span>  <span style="color: #953800">bool</span>                     clone<span style="color: #24292f;background-color: #f6f8fa">;</span>         <span style="color: #6e7781">// false
</span>  <span style="color: #953800">CloneSessionId_t</span>         clone_session_id<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #6e7781">// initial value is undefined
</span>  <span style="color: #953800">bool</span>                     drop<span style="color: #24292f;background-color: #f6f8fa">;</span>          <span style="color: #6e7781">// false
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #953800">psa_egress_input_metadata_t</span>  istd<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">psa_egress_output_metadata_t</span> ostd<span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>clone<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>clone_session_id value is supported<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        from the values configured for ostd<span style="color: #0550ae">.</span>clone_session_id <span style="color: #cf222e">in</span> PRE <span style="color: #24292f;background-color: #f6f8fa">{</span>
            cos <span style="color: #0550ae">=</span> class_of_service
            set<span style="color: #24292f;background-color: #f6f8fa">((</span>egress_port<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">],</span> instance<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">]),</span> <span style="color: #0550ae">...</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>egress_port<span style="color: #24292f;background-color: #f6f8fa">[</span>n<span style="color: #24292f;background-color: #f6f8fa">],</span> instance<span style="color: #24292f;background-color: #f6f8fa">[</span>n<span style="color: #24292f;background-color: #f6f8fa">]))</span> <span style="color: #0550ae">=</span>
                set of egress_port and instance pairs
            trunc <span style="color: #0550ae">=</span> truncate
            plen <span style="color: #0550ae">=</span> packet_length_bytes
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>cos value is not supported<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            cos <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
            <span style="color: #6e7781">// Recommended to log error about unsupported cos
</span>            <span style="color: #6e7781">// value.
</span>        <span style="color: #24292f;background-color: #f6f8fa">}</span>
        for each pair <span style="color: #24292f;background-color: #f6f8fa">(</span>egress_port<span style="color: #24292f;background-color: #f6f8fa">,</span> instance<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #cf222e">in</span> the set <span style="color: #24292f;background-color: #f6f8fa">{</span>
            Create a clone of the packet and send it to the packet
            buffer with the egress_port<span style="color: #24292f;background-color: #f6f8fa">,</span> instance<span style="color: #24292f;background-color: #f6f8fa">,</span> and
            class_of_service cos<span style="color: #24292f;background-color: #f6f8fa">,</span> after which it will start egress
            processing<span style="color: #0550ae">.</span>  It will contain at most the first plen
            bytes of the packet as sent <span style="color: #cf222e">out</span> from the egress
            deparser <span style="color: #cf222e">if</span> trunc is true<span style="color: #24292f;background-color: #f6f8fa">,</span> otherwise the entire
            packet<span style="color: #0550ae">.</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #6e7781">// Do not create a clone.  Recommended to log error about
</span>        <span style="color: #6e7781">// unsupported ostd.clone_session_id value.
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #6e7781">// Continue below, regardless of whether a clone was created.
// Any clone created above is unaffected by the code below.
</span><span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #0550ae">.</span>drop<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    drop the packet
    <span style="color: #cf222e">return</span><span style="color: #24292f;background-color: #f6f8fa">;</span>   <span style="color: #6e7781">// Do not continue below.
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #6e7781">// The value istd.egress_port below is the same one that the
// packet began its egress processing with, as decided during
// ingress processing for this packet (or as determined by the PRE
// configuration of a clone session, for cloned packets,
// regardless of whether the clone operation was done in ingress
// or egress).  The egress code is not allowed to change it.
</span><span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>istd<span style="color: #0550ae">.</span>egress_port <span style="color: #0550ae">==</span> PSA_PORT_RECIRCULATE<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    recirculate the packet<span style="color: #24292f;background-color: #f6f8fa">,</span> i<span style="color: #0550ae">.</span>e<span style="color: #0550ae">.</span> it will go back to starting with the
        ingress <span style="color: #cf222e">parser</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">return</span><span style="color: #24292f;background-color: #f6f8fa">;</span>   <span style="color: #6e7781">// Do not continue below.
</span><span style="color: #24292f;background-color: #f6f8fa">}</span>
enqueue one packet for output port istd<span style="color: #0550ae">.</span>egress_port</code></pre>
</div>
</div>
<div class="paragraph">
<p>As for the handling of a packet after ingress processing, a PSA
implementation may drop a packet after egress processing, even if the
pseudocode above says that a packet will be sent.  For example, you
may attempt to clone a packet after egress when the packet buffer is
too full, or you may attempt to recirculate a packet when the ingress
pipeline is busy handling other packets.  It is recommended that an
implementation maintain counters of packets dropped, preferably with
separate counters for as many different reasons as the implementation
has for dropping packets outside the control of the P4 program.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-egress-actions">7.7. Actions for directing packets during egress</h3>
<div class="sect3">
<h4 id="sec-bqe-drop">7.7.1. Drop operation</h4>
<div class="paragraph">
<p>Do not send the packet out of the device after egress processing is
complete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">/// Modify egress output metadata to cause no packet to be sent out of
/// the device.
</span>
<span style="color: #6e7781">/// This action does not change whether a clone will occur.
</span>
<span style="color: #0550ae">@noWarn</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"unused"</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">action</span> egress_drop<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> <span style="color: #953800">psa_egress_output_metadata_t</span> meta<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    meta<span style="color: #0550ae">.</span>drop <span style="color: #0550ae">=</span> true<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_contents_of_packets_sent_out_to_ports">7.8. Contents of packets sent out to ports</h3>
<div class="paragraph">
<p>There is no metadata associated with NTP and NTCPU packets.</p>
</div>
<div class="paragraph">
<p>They begin with the series of bytes emitted by the egress deparser.
Following that is the payload, which are those packet bytes that were
not parsed in the egress parser.</p>
</div>
<div class="paragraph">
<p>For Ethernet ports, any padding required to get the packet up to the
minimum frame size required is done by the implementation, as well as
calculation of and appending the Ethernet frame CRC.</p>
</div>
<div class="paragraph">
<p>It is expected that typical P4 programs will have explicit checks to
avoid sending packets larger than a port&#8217;s maximum frame size.  A
typical implementation will drop frames larger than this maximum
supported size.  It is recommended that they maintain error counters
for such dropped frames.</p>
</div>
<div class="paragraph">
<p>The P4Runtime has a "Packet In" capability to receive packets sent by
a PSA device to the port <code>PSA_PORT_CPU</code>.  There is no metadata
associated with such packets, only the contents of the packet that are
emitted normally by the P4 program&#8217;s EgressDeparser code.  There may
be some translation of header field values, as described in
<a href="#sec-psa-type-definitions">Section 4.1</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-clone">7.9. Packet Cloning</h3>
<div class="paragraph">
<p>Packet cloning is a mechanism to send a copy of a packet to a
specified port, in addition to the 'regular' packet.  Multiple clones
can be made via a single clone operation, by appropriate control plane
configuration.</p>
</div>
<div class="paragraph">
<p>One use case for cloning is packet mirroring, i.e. send the packet to
its normal destination according to other features implemented by the
P4 program, and in addition, send a copy of the packet as received to
another output port, e.g. to a monitoring device.</p>
</div>
<div class="paragraph">
<p>Packet cloning happens at the end of the ingress and/or egress
pipeline. PSA specifies the following semantics for the clone
operation.  When the clone operation is invoked at the end of the
ingress pipeline, each cloned packet is a copy of the packet as it
entered the ingress parser.  When the clone operation is invoked at
the end of the egress pipeline, each cloned packet is a copy of the
modified packet after egress processing, as output by the egress
deparser.  In both cases, the cloned packets are submitted to the egress
pipeline for further processing.</p>
</div>
<div class="paragraph">
<p>Logically, PRE implements the mechanics of copying a packet.  The
metadata fields that control cloning are those whose names begin with
<code>clone</code> in types <code>psa_ingress_output_metadata_t</code> and
<code>psa_egress_output_metadata_t</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #953800">bool</span>                     clone<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">CloneSessionId_t</span>         clone_session_id<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>clone</code> flag specifies whether a packet should be cloned.  If
true, then a cloned packet, or packets, should be generated at the end of the
pipeline.  The <code>clone_session_id</code> specifies one of several possible
clone sessions that the control plane may configure in the PRE.  For
each clone session, the control plane may configure the following
values that should be associated with packets cloned using that
session.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">/// Each clone session may configure zero or more pairs of (egress_port, instance).
</span><span style="color: #953800">PortId_t</span>         egress_port<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">/// egress_port in a pair of (egress_port, instance)
</span><span style="color: #953800">EgressInstance_t</span> instance<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">/// instance in a pair of (egress_port, instance)
</span>
<span style="color: #6e7781">/// Each clone session has configuration for exactly one of each of
/// the following values.
</span><span style="color: #953800">ClassOfService_t</span> class_of_service<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bool</span>             truncate<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">PacketLength_t</span>   packet_length_bytes<span style="color: #24292f;background-color: #f6f8fa">;</span>  <span style="color: #6e7781">/// only used if truncate is true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The configuration of the set of <code>(egress_port, instance)</code> values for a
clone session is similar to, and has the same requirements and
restrictions as, the configuration of a set of pairs for a multicast
group, as described in <a href="#sec-multicast">Section 7.3.1</a>.</p>
</div>
<div class="paragraph">
<p>The <code>egress_port</code> values may be any ports that can be used for normal
unicast packets, i.e. any normal port, <code>PSA_PORT_CPU</code>, or
<code>PSA_PORT_RECIRCULATE</code>. For the latter two values, the cloned packet
will be sent to the CPU, or recirculated at the end of egress
processing, as a normal unicast packet would at the end of egress
processing.</p>
</div>
<div class="paragraph">
<p>Truncation of cloned packets is supported as an optimization to
reduce the bandwidth required to send the beginning of packets.  This
is sometimes useful in sending packet headers to the control plane, or
some kinds of data collection system for traffic monitoring.  Here by
"headers" we simply mean "some number of bytes from the beginning of
the packet", not headers as defined and parsed in your P4 program.</p>
</div>
<div class="paragraph">
<p>If <code>truncate</code> is false for a clone session, then no truncation is
performed for packets cloned using that session.</p>
</div>
<div class="paragraph">
<p>Otherwise, packets are truncated to contain at most the first
<code>packet_length_bytes</code> bytes of the packet, with any additional bytes
removed.  Truncating a packet has no effect on any metadata that is
carried along with it, and the size of that metadata is not counted as
part of the <code>packet_length_bytes</code> quantity.  Any truncation is based
completely upon the length of the packet as passed to the type
<code>packet_in</code> parameter to the ingress parser (for ingress to egress
clones), or as sent out as the type <code>packet_out</code> parameter from the
egress deparser (for egress to egress clones).</p>
</div>
<div class="paragraph">
<p>PSA implementations are allowed to support only a restricted set of
possible values for <code>packet_length_bytes</code>, e.g. an implementation
might choose only to support values that are multiples of 32 bytes.</p>
</div>
<div class="paragraph">
<p>Since it is an expected common case to clone packets to the CPU, every
PSA implementation begins with a clone session
<code>PSA_CLONE_SESSION_TO_CPU</code> initialized with the set of (<code>egress_port</code>,
<code>instance</code>) values containing exactly one pair with
<code>egress_port = PSA_PORT_CPU</code> and <code>instance = 0</code>.  This clone session
is also initialized with the configuration values
<code>class_of_service = 0</code>, and <code>truncate = false</code>.</p>
</div>
<div class="sect3">
<h4 id="sec-clone-examples">7.9.1. Clone Examples</h4>
<div class="paragraph">
<p>The partial program below demonstrates how to clone a packet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">header</span> <span style="color: #953800">clone_i2e_metadata_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span> custom_tag<span style="color: #24292f;background-color: #f6f8fa">;</span>
    EthernetAddress srcAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> ingress<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> metadata user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">in</span>  <span style="color: #953800">psa_ingress_input_metadata_t</span>  istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> ostd<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">action</span> do_clone <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">CloneSessionId_t</span> session_id<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        ostd<span style="color: #0550ae">.</span>clone <span style="color: #0550ae">=</span> true<span style="color: #24292f;background-color: #f6f8fa">;</span>
        ostd<span style="color: #0550ae">.</span>clone_session_id <span style="color: #0550ae">=</span> session_id<span style="color: #24292f;background-color: #f6f8fa">;</span>
        user_meta<span style="color: #0550ae">.</span>custom_clone_id <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            user_meta<span style="color: #0550ae">.</span>fwd_metadata<span style="color: #0550ae">.</span>outport <span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> do_clone<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>

    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        t<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #cf222e">control</span> IngressDeparserImpl<span style="color: #24292f;background-color: #f6f8fa">(</span>
    <span style="color: #cf222e">packet_out</span> packet<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">out</span> <span style="color: #953800">clone_i2e_metadata_t</span> clone_i2e_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">out</span> <span style="color: #953800">empty_metadata_t</span> resubmit_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">out</span> metadata normal_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">inout</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> metadata meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
    <span style="color: #cf222e">in</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> istd<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    DeparserImpl<span style="color: #24292f;background-color: #f6f8fa">()</span> common_deparser<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #6e7781">// Assignments to the out parameter clone_i2e_meta must be
</span>        <span style="color: #6e7781">// guarded by this if condition:
</span>        <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>psa_clone_i2e<span style="color: #24292f;background-color: #f6f8fa">(</span>istd<span style="color: #24292f;background-color: #f6f8fa">))</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            clone_i2e_meta<span style="color: #0550ae">.</span>custom_tag <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)</span> meta<span style="color: #0550ae">.</span>custom_clone_id<span style="color: #24292f;background-color: #f6f8fa">;</span>
            <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>meta<span style="color: #0550ae">.</span>custom_clone_id <span style="color: #0550ae">==</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
                clone_i2e_meta<span style="color: #0550ae">.</span>srcAddr <span style="color: #0550ae">=</span> hdr<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>srcAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
            <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
        common_deparser<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">(</span>packet<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-resubmit">7.10. Packet Resubmission</h3>
<div class="paragraph">
<p>Packet resubmission is a mechanism to repeat ingress processing on a
packet.</p>
</div>
<div class="paragraph">
<p>Packet resubmission happens at the end of the ingress pipeline. When a
packet is resubmitted, the packet finishes the ingress pipeline
processing and re-enters the ingress parser without being deparsed. In
other words, the resubmitted packet has the same header and payload as
the original packet. The <code>ingress_port</code> of the resubmitted packet is
the same as the original packet. The <code>packet_path</code> of the resubmitted
packet is changed to <code>RESUBMIT</code>.</p>
</div>
<div class="paragraph">
<p>The ingress parser distinguishes the resubmitted packet from the
original packet with the <code>packet_path</code> field in
<code>ingress_parser_intrinsic_metadata_t</code>. The ingress parser can choose a
different algorithm to parse the resubmitted packet. Similarly, the
ingress pipeline can choose to process the resubmitted packet with
different actions as opposed to the ones used to process the original
packet. Further, if a target permits the same packet to be resubmitted
multiple times, the user program can distinguish the packet
resubmitted the first time, or second time, by the extra metadata
associated with the packet.  Note the maximum number of packet
resubmission for a single packet is target-dependent.  See section
{packet-paths}.</p>
</div>
<div class="paragraph">
<p>PSA specifies that the resubmit operation can only be used in the
ingress pipeline. The egress pipeline cannot resubmit packets. As
described in Section [#packet-paths], there is no mandated mechanism
in PSA to prevent a single received packet from creating packets that
continue to recirculate, resubmit, or clone from egress to egress
indefinitely. However, targets may impose limits on the number of
resubmissions, recirculations, or clones.</p>
</div>
<div class="paragraph">
<p>One use case of packet resubmission is to increase the capacity and
flexibility of the packet processing pipeline. For example, because
the same packet is processed by the ingress pipeline multiple times,
it effectively increase the amount of operations on the packet by N
folds, where N is the number of times the packet is resubmitted.</p>
</div>
<div class="paragraph">
<p>Another use case is to deploy multiple packet processing algorithms on
the same packet. For example, the original packet can be parsed and
resubmitted in the first pass with additional metadata to select one
of the algorithms. Then, the resubmitted packet can be parsed,
modified and deparsed using the selected algorithm.</p>
</div>
<div class="paragraph">
<p>To facilitate communication from the ingress processing pass that
caused a resubmit to occur, to the next ingress processing pass after
the resubmit has happened, the resubmission mechanism supports
attaching optional metadata with the resubmitted packet.  The metadata
is generated during the pass through the ingress pipeline that chooses
the resubmit operation, and used in the next pass.</p>
</div>
<div class="paragraph">
<p>A PSA implementation provides a configuration bit <code>resubmit</code> to the
PRE to enable the resubmission mechanism. If true, the original packet
is resubmitted with the optional resubmit metadata. If false, the
resubmission mechanism is disabled and no assignments to
<code>resubmit_meta</code> should be performed.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-recirculate">7.11. Packet Recirculation</h3>
<div class="paragraph">
<p>Packet recirculation is a mechanism to repeat ingress processing on a
packet, after it has completed egress processing.  Unlike a resubmit,
where the resubmitted packet contents are identical to the packet that
arrived at the ingress parser, a recirculated packet may have
different headers than the packet had before recirculation.  This
could be useful in implementing features such as multiple levels of
tunnel encapsulation or decapsulation.</p>
</div>
<div class="paragraph">
<p>Whether a packet is recirculated must be chosen during ingress
processing, by sending the packet to port <code>PSA_PORT_RECIRCULATE</code>.  Packet
recirculation happens at the end of the egress pipeline.  When a
packet is sent to the recirculate port, the packet finishes egress
processing, including the egress deparser, and then re-enters the
ingress parser.  The <code>ingress_port</code> of the recirculated packet is set
to <code>PSA_PORT_RECIRCULATE</code>. The <code>packet_path</code> of the recirculated packet is
set to <code>RECIRCULATE</code>.</p>
</div>
<div class="paragraph">
<p>Similar to packet resubmission, packet recirculation also supports
attaching optional metadata with the recirculated packet.  The
metadata is generated during egress processing, and filled in by
assigning a value to the <code>out</code> parameter <code>recirculate_meta</code> of the
egress deparser.  The metadata is available to the ingress parser
after the packet is recirculated.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_psa_externs">8. PSA Externs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="sec-extern-restrictions">8.1. Restrictions on where externs may be used</h3>
<div class="paragraph">
<p>All instantiations in a P4<sub>16</sub> program occur at compile time, and can
be arranged in a tree structure we will call the instantiation tree.
The root of the tree <code>T</code> represents the top level of the program.  Its
children are the node for the package <code>PSA_Switch</code> described in
<a href="#sec-programmable-blocks">Chapter 6</a>, and any externs instantiated at
the top level of the program.  The children of the <code>PSA_Switch</code> node
are the packages and externs passed as parameters to the <code>PSA_Switch</code>
instantiation.  See <a href="#fig-instantiation-tree">Figure 3</a> for a drawing of
the smallest instantiation tree possible for a P4 program written for
PSA.</p>
</div>
<div id="fig-instantiation-tree" class="imageblock">
<div class="content">
<img src="figs/psa-instantiation-tree-figure.png" alt="psa instantiation tree figure">
</div>
<div class="title">Figure 3. Minimal PSA instantiation tree</div>
</div>
<div class="paragraph">
<p>If any of those parsers or controls instantiate other parsers,
controls, and/or externs, the instantiation tree contains child nodes
for them, continuing until the instantiation tree is complete.</p>
</div>
<div class="paragraph">
<p>For every instance whose node is a descendant of the <code>Ingress</code> node in
this tree, call it an <code>Ingress</code> instance.  Similarly for the other
ingress and egress parsers and controls.  All other instances are top
level instances.</p>
</div>
<div class="paragraph">
<p>A PSA implementation is allowed to reject programs that instantiate
externs, or attempt to call their methods, from anywhere other than
the places mentioned in Table {table-extern-usage}.</p>
</div>
<table id="table-extern-usage" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Summary of controls that can instantiate and invoke externs.</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Extern type</th>
<th class="tableblock halign-left valign-top">Where it may be instantiated and called from</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ActionProfile</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ingress, Egress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ActionSelector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ingress, Egress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Checksum</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IngressParser, EgressParser, IngressDeparser, EgressDeparser</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Counter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ingress, Egress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Digest</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IngressDeparser</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DirectCounter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ingress, Egress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DirectMeter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ingress, Egress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Hash</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ingress, Egress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>InternetChecksum</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IngressParser, EgressParser, IngressDeparser, EgressDeparser</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Meter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ingress, Egress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Random</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ingress, Egress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Register</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ingress, Egress</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, <code>Counter</code> being restricted to "Ingress, Egress" means
that every <code>Counter</code> instance must be instantiated within either the
<code>Ingress</code> control block or the <code>Egress</code> control block, or be a descendant
of one of those nodes in the instantiation tree.  If a <code>Counter</code>
instance is instantiated in Ingress, for example, then it cannot be
referenced, and thus its methods cannot be called, from any control
block except <code>Ingress</code> or one of its descendants in the tree.</p>
</div>
<div class="paragraph">
<p>PSA implementations need not support instantiating these externs at
the top level.  PSA implementations are allowed to accept programs
that use these externs in other places, but they need not.  Thus P4
programmers wishing to maximize the portability of their programs
should restrict their use of these externs to the places indicated in
the table.</p>
</div>
<div class="paragraph">
<p><code>emit</code> method calls for the type <code>packet_out</code> are restricted to be
within deparser control blocks in PSA, because those are the only
places where an instance of type <code>packet_out</code> is visible.  Similarly
all methods for type <code>packet_in</code>, e.g. <code>extract</code> and <code>advance</code>, are
restricted to be within parsers in PSA programs.  P4<sub>16</sub> restricts all
<code>verify</code> method calls to be within parsers for all P4<sub>16</sub> programs,
regardless of whether they are for the PSA.</p>
</div>
<div class="paragraph">
<p>Rationale:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is expected that the highest performance PSA implementations will
not be able to update the same extern instance from both <code>Ingress</code> and
Egress, nor from more than one of the parsers or controls defined in
the PSA architecture.</p>
</li>
<li>
<p>In a multi-pipeline device, there are effectively multiple
instantiations of the ingress pipeline and of the egress pipeline.
The primary motivation to create a multi-pipeline device is the
practical difficulty in allowing the same stateful object
(e.g. table, counter, etc.) to be accessed at a packet rate higher
than that of a single pipeline.  Thus each stateful object should be
accessed from only a single pipeline on such a device.
See <a href="#appendix-multi-pipeline-psa-devices">Appendix E</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_psa_table_properties">8.2. PSA Table Properties</h3>
<div class="paragraph">
<p>Table {table-table-properties} lists all P4 table properties defined
by PSA that are not included in the base P4<sub>16</sub> language
specification.</p>
</div>
<table id="table-table-properties" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Summary of PSA table properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">See also</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>psa_direct_counter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">one <code>DirectCounter</code> instance name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-direct-counter">Section 8.7.3</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>psa_direct_meter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">one <code>DirectMeter</code> instance name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-meters">Section 8.8</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>psa_implementation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">instance name of one <code>ActionProfile</code> or <code>ActionSelector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-action-profile">Section 8.11</a>, <a href="#sec-action-selector">Section 8.12</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>psa_empty_group_action</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">action</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-action-selector">Section 8.12</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>psa_idle_timeout</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PSA_IdleTimeout_t</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#sec-idle-timeout">Section 8.2.1</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A PSA implementation need not support both of a <code>psa_implementation</code>
and <code>psa_direct_counter</code> property on the same table.</p>
</div>
<div class="paragraph">
<p>Similarly, a PSA implementation need not support both of a
<code>psa_implementation</code> and <code>psa_direct_meter</code> property on the same
table.</p>
</div>
<div class="paragraph">
<p>A PSA implementation must implement tables that have both a
<code>psa_direct_counter</code> and <code>psa_direct_meter</code> property.</p>
</div>
<div class="paragraph">
<p>A PSA implementation need not support both <code>psa_implementation</code> and
<code>psa_idle_timeout</code> properties on the same table.</p>
</div>
<div class="sect3">
<h4 id="sec-idle-timeout">8.2.1. Table entry timeout notification</h4>
<div class="paragraph">
<p>PSA defines the table property <code>psa_idle_timeout</code> to enable specifying
whether a table should maintain an idle time for each of its entries,
and if so, what the data plane should do when a table entry has not
been matched for a length of time at least its configured idle time.</p>
</div>
<div class="paragraph">
<p>The value assigned to <code>psa_idle_timeout</code> must be a value of type
<code>PSA_IdleTimeout_t</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">/// Supported values for the psa_idle_timeout table property
</span><span style="color: #cf222e">enum</span> <span style="color: #953800">PSA_IdleTimeout_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    NO_TIMEOUT<span style="color: #24292f;background-color: #f6f8fa">,</span>
    NOTIFY_CONTROL
<span style="color: #24292f;background-color: #f6f8fa">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the property <code>psa_idle_timeout</code> is not specified for a table, its
default value is <code>NO_TIMEOUT</code>.  Such tables need not maintain an idle
time for any of its table entries, and will not perform any special
action regardless of how long a table entry remains unmatched.</p>
</div>
<div class="paragraph">
<p>If the property <code>psa_idle_timeout</code> is assigned a value of
<code>NOTIFY_CONTROL</code> for a table <code>t</code>, this enables idle timeout
notifications for the table.  There is an API for the control plane to
set idle timeout values for entries of table <code>t</code>.</p>
</div>
<div class="paragraph">
<p>If a table entry <code>e</code> has not been "hit" (ie; not matched by an
invocation of <code>t.apply()</code>) for a time interval at least as long as its
idle timeout value, the device should generate a notification to the
control plane for entry <code>e</code>.  The rate and mode of how the
notifications are generated and delivered to the control plane are
subject to configuration parameters specified by the control plane
API.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">table</span> t <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #cf222e">action</span> a1 <span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">...</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
  <span style="color: #cf222e">action</span> a2 <span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> <span style="color: #0550ae">...</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
  <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> hdr<span style="color: #0550ae">.</span>f1<span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
  <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> a1<span style="color: #24292f;background-color: #f6f8fa">;</span> a2<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
  <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> a2<span style="color: #24292f;background-color: #f6f8fa">;</span>
  psa_idle_timeout <span style="color: #0550ae">=</span> <span style="color: #953800">PSA_IdleTimeout_t</span><span style="color: #0550ae">.</span>NOTIFY_CONTROL<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Restrictions on the idle timeout values and notifications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is likely that any hardware implementation will have a limited number of
bits to represent the values, and, since the values are programmed at
runtime, it is the responsibility of the runtime (P4Runtime or other
controller software) to guarantee that the idle timeout values can be represented in
the device. This can be done by scaling the values to the number of bits
available on the platform, ensuring that the range of values between
different entries are representable. A PSA implementation should only enable
the programming of such tables, and return an error if the device does not
support the idle timeout at all.</p>
</li>
<li>
<p>If no value is programmed for a table entry, even though the table has
enabled the idle timeout property, the entry will not generate a
notification.</p>
</li>
<li>
<p>PSA does not require a timeout value for a default action entry. The reason
for not making this mandatory in the specification is that the default
action may not have an explicit table entry to represent it, and also there
are no known compelling use cases for a controller knowing when no misses
have occurred for a particular table for a long time. The default action entry will not be aged out.</p>
</li>
<li>
<p>Currently, tables implemented using ActionSelectors and ActionProfiles do not support the <code>psa_idle_timeout</code> property. Future versions of the specification may remove this restriction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Devices are allowed to send idle timeout notifications on a best
effort basis.  For example, if a table has one million entries, and
every entry reaches its idle timeout duration at the same instant in
time, an implementation cannot send all of these notifications
instantaneously, but only at some finite rate.  Possible behaviors
include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the control plane deletes entry <code>e</code>, the deletion might occur
even though the device never notified the control plane that `e&#8217;s
idle timeout was reached before it was deleted.</p>
</li>
<li>
<p>If entry <code>e</code> is matched some time after its idle timeout has
elapsed, and the device has not yet generated an idle timeout
notification for <code>e</code>, it is possible that the device will never
generate a notification to the control plane for that entry.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-pre">8.3. Packet Replication Engine</h3>
<div class="paragraph">
<p>The <code>PacketReplicationEngine</code> extern (abbreviated PRE) represents
a part of the PSA pipeline that is not programmable via writing P4
code.</p>
</div>
<div class="paragraph">
<p>Even though the PRE can not be programmed using P4, it can be
configured using control plane APIs, e.g. configuring multicast groups
and clone sessions.  For every packet, your P4 program will typically
assign values to intrinsic metadata in structs such as those of type
<code>psa_ingress_output_metadata_t</code> and <code>psa_egress_output_metadata_t</code>,
which direct the operation of the PRE on that packet.  The file
<code>psa.p4</code> defines some actions to help set these metadata fields for
some common use cases, described in <a href="#sec-ingress-actions">Section 7.4</a>
and <a href="#sec-egress-actions">Section 7.7</a>.</p>
</div>
<div class="paragraph">
<p>The PRE extern must be instantiated exactly once, in the <code>PSA_Switch</code>
package instantiation.  See near the end of <a href="#sec-programmable-blocks">Chapter 6</a>
for the package definitions from <code>psa.p4</code>.  See below for an example of
instantiating these packages, including the instantiation of one
instance of <code>PacketReplicationEngine</code> and one of
<code>BufferingQueueingEngine</code> in the <code>PSA_Switch</code> package instantiation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">IngressPipeline<span style="color: #24292f;background-color: #f6f8fa">(</span>IngressParserImpl<span style="color: #24292f;background-color: #f6f8fa">(),</span>
                ingress<span style="color: #24292f;background-color: #f6f8fa">(),</span>
                IngressDeparserImpl<span style="color: #24292f;background-color: #f6f8fa">())</span> ip<span style="color: #24292f;background-color: #f6f8fa">;</span>

EgressPipeline<span style="color: #24292f;background-color: #f6f8fa">(</span>EgressParserImpl<span style="color: #24292f;background-color: #f6f8fa">(),</span>
               egress<span style="color: #24292f;background-color: #f6f8fa">(),</span>
               EgressDeparserImpl<span style="color: #24292f;background-color: #f6f8fa">())</span> ep<span style="color: #24292f;background-color: #f6f8fa">;</span>

PSA_Switch<span style="color: #24292f;background-color: #f6f8fa">(</span>ip<span style="color: #24292f;background-color: #f6f8fa">,</span> PacketReplicationEngine<span style="color: #24292f;background-color: #f6f8fa">(),</span> ep<span style="color: #24292f;background-color: #f6f8fa">,</span> BufferingQueueingEngine<span style="color: #24292f;background-color: #f6f8fa">())</span> main<span style="color: #24292f;background-color: #f6f8fa">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-bqe">8.4. Buffering Queuing Engine</h3>
<div class="paragraph">
<p>The <code>BufferingQueueingEngine</code> extern (abbreviated BQE) represents
another part of the PSA pipeline, after egress, that is not
programmable via writing P4 code.</p>
</div>
<div class="paragraph">
<p>Even though the BQE can not be programmed using P4, it can be
configured both directly using control plane APIs and by setting
intrinsic metadata.</p>
</div>
<div class="paragraph">
<p>The BQE extern must be instantiated exactly once, as the PRE must.
See <a href="#sec-pre">Section 8.3</a> for additional discussion and example code.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-hash-algorithms">8.5. Hashes</h3>
<div class="paragraph">
<p>Supported hash algorithms:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">PSA_HashAlgorithm_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  IDENTITY<span style="color: #24292f;background-color: #f6f8fa">,</span>
  CRC32<span style="color: #24292f;background-color: #f6f8fa">,</span>
  CRC32_CUSTOM<span style="color: #24292f;background-color: #f6f8fa">,</span>
  CRC16<span style="color: #24292f;background-color: #f6f8fa">,</span>
  CRC16_CUSTOM<span style="color: #24292f;background-color: #f6f8fa">,</span>
  ONES_COMPLEMENT16<span style="color: #24292f;background-color: #f6f8fa">,</span>  <span style="color: #6e7781">/// One's complement 16-bit sum used for IPv4 headers,
</span>                      <span style="color: #6e7781">/// TCP, and UDP.
</span>  TARGET_DEFAULT      <span style="color: #6e7781">/// target implementation defined
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_hash_function">8.5.1. Hash function</h4>
<div class="paragraph">
<p>Example usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">parser</span> P<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  Hash<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PSA_HashAlgorithm_t</span><span style="color: #0550ae">.</span>CRC16<span style="color: #24292f;background-color: #f6f8fa">)</span> h<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> hash_value <span style="color: #0550ae">=</span> h<span style="color: #0550ae">.</span>get_hash<span style="color: #24292f;background-color: #f6f8fa">(</span>buffer<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>algo</code>&#8201;&#8212;&#8201;The algorithm to use for computation (see <a href="#sec-hash-algorithms">Section 8.5</a>).</p>
</li>
<li>
<p><code>O</code>   &#8201;&#8212;&#8201;The type of the return value of the hash.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> Hash<span style="color: #0550ae">&lt;</span>O<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">/// Constructor
</span>  Hash<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PSA_HashAlgorithm_t</span> algo<span style="color: #24292f;background-color: #f6f8fa">);</span>

  <span style="color: #6e7781">/// Compute the hash for data.
</span>  <span style="color: #6e7781">/// @param data The data over which to calculate the hash.
</span>  <span style="color: #6e7781">/// @return The hash value.
</span>  <span style="color: #0550ae">@pure</span>
  O get_hash<span style="color: #0550ae">&lt;</span>D<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> D data<span style="color: #24292f;background-color: #f6f8fa">);</span>

  <span style="color: #6e7781">/// Compute the hash for data, with modulo by max, then add base.
</span>  <span style="color: #6e7781">/// @param base Minimum return value.
</span>  <span style="color: #6e7781">/// @param data The data over which to calculate the hash.
</span>  <span style="color: #6e7781">/// @param max The hash value is divided by max to get modulo.
</span>  <span style="color: #6e7781">///        An implementation may limit the largest value supported,
</span>  <span style="color: #6e7781">///        e.g. to a value like 32, or 256, and may also only
</span>  <span style="color: #6e7781">///        support powers of 2 for this value.  P4 developers should
</span>  <span style="color: #6e7781">///        limit their choice to such values if they wish to
</span>  <span style="color: #6e7781">///        maximize portability.
</span>  <span style="color: #6e7781">/// @return (base + (h % max)) where h is the hash value.
</span>  <span style="color: #0550ae">@pure</span>
  O get_hash<span style="color: #0550ae">&lt;</span>T<span style="color: #24292f;background-color: #f6f8fa">,</span> D<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T base<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> D data<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> T max<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-checksums">8.6. Checksums</h3>
<div class="paragraph">
<p>PSA provides checksum functions compute an integer on the stream of
bytes in packet headers. Checksums are often used as an integrity
check to detect corrupted or otherwise malformed packets.</p>
</div>
<div class="sect3">
<h4 id="sec-basic-checksum">8.6.1. Basic checksum</h4>
<div class="paragraph">
<p>The basic checksum extern provided in PSA supports arbitrary hash
algorithms.</p>
</div>
<div class="paragraph">
<p>Parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>W</code>&#8201;&#8212;&#8201;The width of the checksum</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> Checksum<span style="color: #0550ae">&lt;</span>W<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">/// Constructor
</span>  Checksum<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PSA_HashAlgorithm_t</span> hash<span style="color: #24292f;background-color: #f6f8fa">);</span>

  <span style="color: #6e7781">/// Reset internal state and prepare unit for computation.
</span>  <span style="color: #6e7781">/// Every instance of a Checksum object is automatically initialized as
</span>  <span style="color: #6e7781">/// if clear() had been called on it. This initialization happens every
</span>  <span style="color: #6e7781">/// time the object is instantiated, that is, whenever the parser or control
</span>  <span style="color: #6e7781">/// containing the Checksum object are applied.
</span>  <span style="color: #6e7781">/// All state maintained by the Checksum object is independent per packet.
</span>  <span style="color: #953800">void</span> clear<span style="color: #24292f;background-color: #f6f8fa">();</span>

  <span style="color: #6e7781">/// Add data to checksum
</span>  <span style="color: #953800">void</span> update<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span>

  <span style="color: #6e7781">/// Get checksum for data added (and not removed) since last clear
</span>  <span style="color: #0550ae">@noSideEffects</span>
  W    get<span style="color: #24292f;background-color: #f6f8fa">();</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-incremental-checksum">8.6.2. Incremental checksum</h4>
<div class="paragraph">
<p>PSA also provides an incremental checksum that comes equipped with an
additional <code>subtract</code> method that can be used to remove data previously
added. The checksum is computed using the <code>ONES_COMPLEMENT16</code> hash
algorithm used with protocols such as IPv4, TCP, and UDP&#8201;&#8212;&#8201;see [IETF
RFC 1624](<a href="https://tools.ietf.org/html/rfc1624" class="bare">https://tools.ietf.org/html/rfc1624</a>)
and <a href="#appendix-internetchecksum-implementation">Appendix B</a> for details.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// Checksum based on `ONES_COMPLEMENT16` algorithm used in IPv4, TCP, and UDP.
// Supports incremental updating via `subtract` method.
// See IETF RFC 1624.
</span><span style="color: #cf222e">extern</span> InternetChecksum <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">/// Constructor
</span>  InternetChecksum<span style="color: #24292f;background-color: #f6f8fa">();</span>

  <span style="color: #6e7781">/// Reset internal state and prepare unit for computation.  Every
</span>  <span style="color: #6e7781">/// instance of an InternetChecksum object is automatically
</span>  <span style="color: #6e7781">/// initialized as if clear() had been called on it, once for each
</span>  <span style="color: #6e7781">/// time the parser or control it is instantiated within is
</span>  <span style="color: #6e7781">/// executed.  All state maintained by it is independent per packet.
</span>  <span style="color: #953800">void</span> clear<span style="color: #24292f;background-color: #f6f8fa">();</span>

  <span style="color: #6e7781">/// Add data to checksum.  data must be a multiple of 16 bits long.
</span>  <span style="color: #953800">void</span> add<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span>

  <span style="color: #6e7781">/// Subtract data from existing checksum.  data must be a multiple of
</span>  <span style="color: #6e7781">/// 16 bits long.
</span>  <span style="color: #953800">void</span> subtract<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span>

  <span style="color: #6e7781">/// Get checksum for data added (and not removed) since last clear
</span>  <span style="color: #0550ae">@noSideEffects</span>
  <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> get<span style="color: #24292f;background-color: #f6f8fa">();</span>

  <span style="color: #6e7781">/// Get current state of checksum computation.  The return value is
</span>  <span style="color: #6e7781">/// only intended to be used for a future call to the set_state
</span>  <span style="color: #6e7781">/// method.
</span>  <span style="color: #0550ae">@noSideEffects</span>
  <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> get_state<span style="color: #24292f;background-color: #f6f8fa">();</span>

  <span style="color: #6e7781">/// Restore the state of the InternetChecksum instance to one
</span>  <span style="color: #6e7781">/// returned from an earlier call to the get_state method.  This
</span>  <span style="color: #6e7781">/// state could have been returned from the same instance of the
</span>  <span style="color: #6e7781">/// InternetChecksum extern, or a different one.
</span>  <span style="color: #953800">void</span> set_state<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> checksum_state<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sec-checksum-examples">8.6.3. InternetChecksum examples</h4>
<div class="paragraph">
<p>The partial program below demonstrates one way to use the <code>InternetChecksum</code>
extern to verify whether the checksum field in a parsed IPv4 header is
correct, and set a parser error if it is wrong.  It also demonstrates
checking for parser errors in the <code>Ingress</code> control block, dropping
the packet if any errors occurred during parsing.  PSA programs may
choose to handle packets with parser errors in other ways than shown
in this example&#8201;&#8212;&#8201;it is up to the P4 program author to choose and
write the desired behavior.</p>
</div>
<div class="paragraph">
<p>Neither P4<sub>16</sub> nor the PSA provide any special mechanisms to record
the location within a packet that a parser error occurred. A P4
program author can choose to record such location information
explicitly. For example, one may define metadata fields specifically
for that purpose&#8201;&#8212;&#8201;e.g. to hold an encoded value representing the last
parser state reached, or the number of bytes extracted so far&#8201;&#8212;&#8201;and then
assign values to those fields within the parser state code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// Define additional error values, one of them for packets with
// incorrect IPv4 header checksums.
</span><span style="color: #953800">error</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    UnhandledIPv4Options<span style="color: #24292f;background-color: #f6f8fa">,</span>
    BadIPv4HeaderChecksum
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">PacketCounter_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">8</span><span style="color: #0550ae">&gt;</span>  <span style="color: #953800">ErrorIndex_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">const</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">9</span><span style="color: #0550ae">&gt;</span> NUM_ERRORS <span style="color: #0550ae">=</span> <span style="color: #0550ae">256</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">parser</span> IngressParserImpl<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_in</span> buffer<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">out</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">inout</span> metadata user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">in</span> <span style="color: #953800">psa_ingress_parser_input_metadata_t</span> istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">in</span> <span style="color: #953800">empty_metadata_t</span> resubmit_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                         <span style="color: #cf222e">in</span> <span style="color: #953800">empty_metadata_t</span> recirculate_meta<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    InternetChecksum<span style="color: #24292f;background-color: #f6f8fa">()</span> ck<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">state</span> start <span style="color: #24292f;background-color: #f6f8fa">{</span>
        buffer<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ethernet<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>etherType<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #0550ae">0x0800</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_ipv4<span style="color: #24292f;background-color: #f6f8fa">;</span>
            <span style="color: #cf222e">default</span><span style="color: #24292f;background-color: #f6f8fa">:</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">state</span> parse_ipv4 <span style="color: #24292f;background-color: #f6f8fa">{</span>
        buffer<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #6e7781">// TBD: It would be good to enhance this example to
</span>        <span style="color: #6e7781">// demonstrate checking of IPv4 header checksums for IPv4
</span>        <span style="color: #6e7781">// headers with options, but this example does not handle such
</span>        <span style="color: #6e7781">// packets.
</span>        <span style="color: #953800">verify</span><span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ihl <span style="color: #0550ae">==</span> <span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">error</span><span style="color: #0550ae">.</span>UnhandledIPv4Options<span style="color: #24292f;background-color: #f6f8fa">);</span>
        ck<span style="color: #0550ae">.</span>clear<span style="color: #24292f;background-color: #f6f8fa">();</span>
        ck<span style="color: #0550ae">.</span>add<span style="color: #24292f;background-color: #f6f8fa">({</span>
            <span style="color: #6e7781">/* 16-bit word  0   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>version<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ihl<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>diffserv<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  1   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>totalLen<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  2   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>identification<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  3   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>flags<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>fragOffset<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  4   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ttl<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>protocol<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  5 skip hdr.ipv4.hdrChecksum, */</span>
            <span style="color: #6e7781">/* 16-bit words 6-7 */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>srcAddr<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit words 8-9 */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>dstAddr
            <span style="color: #24292f;background-color: #f6f8fa">});</span>
        <span style="color: #6e7781">// The verify statement below will cause the parser to enter
</span>        <span style="color: #6e7781">// the reject state, and thus terminate parsing immediately,
</span>        <span style="color: #6e7781">// if the IPv4 header checksum is wrong.  It will also record
</span>        <span style="color: #6e7781">// the error error.BadIPv4HeaderChecksum, which will be
</span>        <span style="color: #6e7781">// available in a metadata field in the ingress control block.
</span>        <span style="color: #953800">verify</span><span style="color: #24292f;background-color: #f6f8fa">(</span>ck<span style="color: #0550ae">.</span>get<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #0550ae">==</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>hdrChecksum<span style="color: #24292f;background-color: #f6f8fa">,</span>
               <span style="color: #953800">error</span><span style="color: #0550ae">.</span>BadIPv4HeaderChecksum<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #cf222e">transition</span> <span style="color: #cf222e">select</span><span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>protocol<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #0550ae">6</span><span style="color: #24292f;background-color: #f6f8fa">:</span> parse_tcp<span style="color: #24292f;background-color: #f6f8fa">;</span>
            <span style="color: #cf222e">default</span><span style="color: #24292f;background-color: #f6f8fa">:</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">state</span> parse_tcp <span style="color: #24292f;background-color: #f6f8fa">{</span>
        buffer<span style="color: #0550ae">.</span><span style="color: #953800">extract</span><span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>tcp<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #cf222e">transition</span> accept<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">control</span> ingress<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> metadata user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">in</span>    <span style="color: #953800">psa_ingress_input_metadata_t</span>  istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> ostd<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">// Table parser_error_count_and_convert below shows one way to
</span>    <span style="color: #6e7781">// count the number of times each parser error was encountered.
</span>    <span style="color: #6e7781">// Although it is not used in this example program, it also shows
</span>    <span style="color: #6e7781">// how to convert the error value into a unique bit vector value
</span>    <span style="color: #6e7781">// 'error_idx', which can be useful if you wish to put a bit
</span>    <span style="color: #6e7781">// vector encoding of an error into a packet header, e.g. for a
</span>    <span style="color: #6e7781">// packet sent to the control CPU.
</span>
    DirectCounter<span style="color: #0550ae">&lt;</span><span style="color: #953800">PacketCounter_t</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PSA_CounterType_t</span><span style="color: #0550ae">.</span>PACKETS<span style="color: #24292f;background-color: #f6f8fa">)</span> parser_error_counts<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">ErrorIndex_t</span> error_idx<span style="color: #24292f;background-color: #f6f8fa">;</span>

    <span style="color: #cf222e">action</span> set_error_idx <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">ErrorIndex_t</span> idx<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        error_idx <span style="color: #0550ae">=</span> idx<span style="color: #24292f;background-color: #f6f8fa">;</span>
        parser_error_counts<span style="color: #0550ae">.</span>count<span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">table</span> parser_error_count_and_convert <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            istd<span style="color: #0550ae">.</span>parser_error <span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            set_error_idx<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> set_error_idx<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #cf222e">const</span> <span style="color: #cf222e">entries</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #953800">error</span><span style="color: #0550ae">.</span>NoError               <span style="color: #24292f;background-color: #f6f8fa">:</span> set_error_idx<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #953800">error</span><span style="color: #0550ae">.</span>PacketTooShort        <span style="color: #24292f;background-color: #f6f8fa">:</span> set_error_idx<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #953800">error</span><span style="color: #0550ae">.</span>NoMatch               <span style="color: #24292f;background-color: #f6f8fa">:</span> set_error_idx<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #953800">error</span><span style="color: #0550ae">.</span>StackOutOfBounds      <span style="color: #24292f;background-color: #f6f8fa">:</span> set_error_idx<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">4</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #953800">error</span><span style="color: #0550ae">.</span>HeaderTooShort        <span style="color: #24292f;background-color: #f6f8fa">:</span> set_error_idx<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #953800">error</span><span style="color: #0550ae">.</span>ParserTimeout         <span style="color: #24292f;background-color: #f6f8fa">:</span> set_error_idx<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">6</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #953800">error</span><span style="color: #0550ae">.</span>BadIPv4HeaderChecksum <span style="color: #24292f;background-color: #f6f8fa">:</span> set_error_idx<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">7</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #953800">error</span><span style="color: #0550ae">.</span>UnhandledIPv4Options  <span style="color: #24292f;background-color: #f6f8fa">:</span> set_error_idx<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">8</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
        psa_direct_counter <span style="color: #0550ae">=</span> parser_error_counts<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>istd<span style="color: #0550ae">.</span>parser_error <span style="color: #0550ae">!=</span> <span style="color: #953800">error</span><span style="color: #0550ae">.</span>NoError<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #6e7781">// Example code showing how to count number of times each
</span>            <span style="color: #6e7781">// kind of parser error was seen.
</span>            parser_error_count_and_convert<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
            ingress_drop<span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #cf222e">exit</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #6e7781">// Do normal packet processing here.
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The partial program below demonstrates one way to use the <code>InternetChecksum</code>
extern to calculate and then fill in a correct IPv4 header checksum in
the deparser block.  In this example, the checksum is calculated
fresh, so the outgoing checksum will be correct regardless of what
changes might have been made to the IPv4 header fields in the Ingress
(or Egress) control block that precedes it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> EgressDeparserImpl<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_out</span> packet<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">out</span> <span style="color: #953800">empty_metadata_t</span> clone_e2e_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">out</span> <span style="color: #953800">empty_metadata_t</span> recirculate_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">inout</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">in</span> metadata meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">in</span> <span style="color: #953800">psa_egress_output_metadata_t</span> istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">in</span> <span style="color: #953800">psa_egress_deparser_input_metadata_t</span> edstd<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    InternetChecksum<span style="color: #24292f;background-color: #f6f8fa">()</span> ck<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        ck<span style="color: #0550ae">.</span>clear<span style="color: #24292f;background-color: #f6f8fa">();</span>
        ck<span style="color: #0550ae">.</span>add<span style="color: #24292f;background-color: #f6f8fa">({</span>
            <span style="color: #6e7781">/* 16-bit word  0   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>version<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ihl<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>diffserv<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  1   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>totalLen<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  2   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>identification<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  3   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>flags<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>fragOffset<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  4   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ttl<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>protocol<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  5 skip hdr.ipv4.hdrChecksum, */</span>
            <span style="color: #6e7781">/* 16-bit words 6-7 */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>srcAddr<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit words 8-9 */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>dstAddr
            <span style="color: #24292f;background-color: #f6f8fa">});</span>
        hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>hdrChecksum <span style="color: #0550ae">=</span> ck<span style="color: #0550ae">.</span>get<span style="color: #24292f;background-color: #f6f8fa">();</span>
        packet<span style="color: #0550ae">.</span>emit<span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ethernet<span style="color: #24292f;background-color: #f6f8fa">);</span>
        packet<span style="color: #0550ae">.</span>emit<span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #24292f;background-color: #f6f8fa">);</span>
        packet<span style="color: #0550ae">.</span>emit<span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>tcp<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As a final example, we can use the <code>InternetChecksum</code> to compute an
incremental checksum for the TCP header. Recall the TCP checksum is
computed over the <em>entire</em> packet, including the payload. Because the
packet payload need not be available in a PSA implementation, we
assume that the TCP checksum
on the original packet is correct, and update it incrementally by
invoking <code>subtract</code> and then <code>add</code> on any fields that are modified by
the program. For example, the <code>Ingress</code> control in the program below
updates the IPv4 source address, recording the original source address
in a metadata field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> ingress<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> metadata user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">in</span>    <span style="color: #953800">psa_ingress_input_metadata_t</span>  istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> ostd<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">action</span> drop<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
      ingress_drop<span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">action</span> forward<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PortId_t</span> port<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> srcAddr<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
      user_meta<span style="color: #0550ae">.</span>fwd_metadata<span style="color: #0550ae">.</span>old_srcAddr <span style="color: #0550ae">=</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>srcAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
      hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>srcAddr <span style="color: #0550ae">=</span> srcAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
      send_to_port<span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #24292f;background-color: #f6f8fa">,</span> port<span style="color: #24292f;background-color: #f6f8fa">);</span>      
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">table</span> route <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>dstAddr <span style="color: #24292f;background-color: #f6f8fa">:</span> lpm<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
          forward<span style="color: #24292f;background-color: #f6f8fa">;</span>
          drop<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">if</span><span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span><span style="color: #953800">isValid</span><span style="color: #24292f;background-color: #f6f8fa">())</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
          route<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The deparser first updates the IPv4 checksum as above, and then
incrementally computes the TCP checksum.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> EgressDeparserImpl<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_out</span> packet<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">out</span> <span style="color: #953800">empty_metadata_t</span> clone_e2e_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">out</span> <span style="color: #953800">empty_metadata_t</span> recirculate_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">inout</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">in</span> metadata user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">in</span> <span style="color: #953800">psa_egress_output_metadata_t</span> istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
                           <span style="color: #cf222e">in</span> <span style="color: #953800">psa_egress_deparser_input_metadata_t</span> edstd<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    InternetChecksum<span style="color: #24292f;background-color: #f6f8fa">()</span> ck<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #6e7781">// Update IPv4 checksum
</span>        <span style="color: #6e7781">// This clear() call can be removed without affecting
</span>        <span style="color: #6e7781">// behavior, as an InternetCheckum instance is automatically
</span>        <span style="color: #6e7781">// cleared for each packet.
</span>        ck<span style="color: #0550ae">.</span>clear<span style="color: #24292f;background-color: #f6f8fa">();</span>
        ck<span style="color: #0550ae">.</span>add<span style="color: #24292f;background-color: #f6f8fa">({</span>
            <span style="color: #6e7781">/* 16-bit word  0   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>version<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ihl<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>diffserv<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  1   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>totalLen<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  2   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>identification<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  3   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>flags<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>fragOffset<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  4   */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>ttl<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>protocol<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit word  5 skip hdr.ipv4.hdrChecksum, */</span>
            <span style="color: #6e7781">/* 16-bit words 6-7 */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>srcAddr<span style="color: #24292f;background-color: #f6f8fa">,</span>
            <span style="color: #6e7781">/* 16-bit words 8-9 */</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>dstAddr
            <span style="color: #24292f;background-color: #f6f8fa">});</span>
        hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>hdrChecksum <span style="color: #0550ae">=</span> ck<span style="color: #0550ae">.</span>get<span style="color: #24292f;background-color: #f6f8fa">();</span>
        <span style="color: #6e7781">// Update TCP checksum
</span>        <span style="color: #6e7781">// This clear() call is necessary for correct behavior, since
</span>        <span style="color: #6e7781">// the same instance 'ck' is reused from above for the same
</span>        <span style="color: #6e7781">// packet.  If a second InternetChecksum instance other than
</span>        <span style="color: #6e7781">// 'ck' were used below instead, this clear() call would be
</span>        <span style="color: #6e7781">// unnecessary.
</span>        ck<span style="color: #0550ae">.</span>clear<span style="color: #24292f;background-color: #f6f8fa">();</span>
        <span style="color: #6e7781">// Subtract the original TCP checksum
</span>        ck<span style="color: #0550ae">.</span>subtract<span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>tcp<span style="color: #0550ae">.</span>checksum<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #6e7781">// Subtract the effect of the original IPv4 source address,
</span>        <span style="color: #6e7781">// which is part of the TCP 'pseudo-header' for the purposes
</span>        <span style="color: #6e7781">// of TCP checksum calculation (see RFC 793), then add the
</span>        <span style="color: #6e7781">// effect of the new IPv4 source address.
</span>        ck<span style="color: #0550ae">.</span>subtract<span style="color: #24292f;background-color: #f6f8fa">(</span>user_meta<span style="color: #0550ae">.</span>fwd_metadata<span style="color: #0550ae">.</span>old_srcAddr<span style="color: #24292f;background-color: #f6f8fa">);</span>
        ck<span style="color: #0550ae">.</span>add<span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>srcAddr<span style="color: #24292f;background-color: #f6f8fa">);</span>
        hdr<span style="color: #0550ae">.</span>tcp<span style="color: #0550ae">.</span>checksum <span style="color: #0550ae">=</span> ck<span style="color: #0550ae">.</span>get<span style="color: #24292f;background-color: #f6f8fa">();</span>
        packet<span style="color: #0550ae">.</span>emit<span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ethernet<span style="color: #24292f;background-color: #f6f8fa">);</span>
        packet<span style="color: #0550ae">.</span>emit<span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #24292f;background-color: #f6f8fa">);</span>
        packet<span style="color: #0550ae">.</span>emit<span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>tcp<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_counters">8.7. Counters</h3>
<div class="paragraph">
<p>Counters are a mechanism for keeping statistics.  The control plane
can read counter values.  A P4 program cannot read counter values,
only update them.  If you wish to implement a feature involving
sequence numbers in packets, for example, use Registers instead
(<a href="#sec-registers">Section 8.9</a>).</p>
</div>
<div class="paragraph">
<p>Direct counters are counters associated with a particular P4 table,
and are implemented by the extern <code>DirectCounter</code>.  There are also
indexed counters, which are implemented by the extern <code>Counter</code>.  The
primary differences between direct counters and indexed counters are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Number of independently updatable counter values:</p>
<div class="ulist">
<ul>
<li>
<p>A single instantiation of a direct counter always contains as many
independent counter values as the number of entries in the table
with which it is associated.</p>
</li>
<li>
<p>You must specify the number of independent counter values for an
indexed counter when instantiating it.  This number of counters
need not be the same as the size of any table.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Where counter updates are allowed in the P4 program:</p>
<div class="ulist">
<ul>
<li>
<p>For a direct counter, you may only invoke its <code>count</code> method from
inside the actions of the table with which it is associated, and
this always updates the counter value associated with the matching
table entry.</p>
</li>
<li>
<p>For an indexed counter, you may invoke its <code>count</code> method
anywhere in the P4 program where extern object method invocations
are permitted (e.g. inside actions, or directly inside a control&#8217;s
<code>apply</code> block), and every such invocation must specify the index
of the counter value to be updated.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Counters are only intended to support packet counters and byte
counters, or a combination of both called <code>PACKETS_AND_BYTES</code>.  The
byte counts are always increased by some measure of the packet length,
where the packet length used might vary from one PSA implementation to
another.  For example, one implementation might use the Ethernet frame
length, including the Ethernet header and FCS bytes, as the packet
arrived on a physical port.  Another might not include the FCS bytes
in its definition of the packet length.  Another might only include
the Ethernet payload length.  Each PSA implementation should document
how it determines the packet length used for byte counter updates.</p>
</div>
<div class="paragraph">
<p>If you wish to keep counts of other quantities, or to have more
precise control over the packet length used in a byte counter, you may
use Registers to achieve that (<a href="#sec-registers">Section 8.9</a>).</p>
</div>
<div class="sect3">
<h4 id="_counter_types">8.7.1. Counter types</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">PSA_CounterType_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    PACKETS<span style="color: #24292f;background-color: #f6f8fa">,</span>
    BYTES<span style="color: #24292f;background-color: #f6f8fa">,</span>
    PACKETS_AND_BYTES
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_counter">8.7.2. Counter</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">/// Indirect counter with n_counters independent counter values, where
/// every counter value has a data plane size specified by type W.
</span>
<span style="color: #0550ae">@noWarn</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"unused"</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">extern</span> Counter<span style="color: #0550ae">&lt;</span>W<span style="color: #24292f;background-color: #f6f8fa">,</span> S<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  Counter<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> n_counters<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">PSA_CounterType_t</span> <span style="color: #cf222e">type</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
  <span style="color: #953800">void</span> count<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> S index<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#appendix-counter-implementation">Appendix C</a> for pseudocode of an
example implementation of the Counter extern.</p>
</div>
<div class="paragraph">
<p>PSA implementations must not update any counter values if an indexed
counter is updated with an index that is too large.  It is recommended
that they count such erroneous attempted updates, and record other
information that can help an P4 programmer debug such errors.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-direct-counter">8.7.3. Direct Counter</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #0550ae">@noWarn</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">"unused"</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #cf222e">extern</span> DirectCounter<span style="color: #0550ae">&lt;</span>W<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  DirectCounter<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PSA_CounterType_t</span> <span style="color: #cf222e">type</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
  <span style="color: #953800">void</span> count<span style="color: #24292f;background-color: #f6f8fa">();</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>DirectCounter</code> instance must appear as the value of the
<code>psa_direct_counter</code> table attribute for at most one table.  We call
this table the <code>DirectCounter</code> instance&#8217;s "owner".  It is an error to
call the <code>count</code> method for a <code>DirectCounter</code> instance anywhere except
inside an action of its owner table.</p>
</div>
<div class="paragraph">
<p>The counter value updated by an invocation of <code>count</code> is always the
one associated with the table entry that matched.</p>
</div>
<div class="paragraph">
<p>An action of an owner table need not have <code>count</code> method calls for all
of the <code>DirectCounter</code> instances that the table owns.  You must use an
explicit <code>count()</code> method call on a <code>DirectCounter</code> to update it,
otherwise its state will not change.</p>
</div>
<div class="paragraph">
<p>An example implementation for the <code>DirectCounter</code> extern is
essentially the same as the one for <code>Counter</code>.  Since there is no
<code>index</code> parameter to the <code>count</code> method, there is no need to check for
whether it is in range.</p>
</div>
<div class="paragraph">
<p>The rules here mean that an action that calls <code>count</code> on a
<code>DirectCounter</code> instance may only be an action of that instance&#8217;s one
owner table.  If you want to have a single action <code>A</code> that can be
invoked by multiple tables, you can still do so by having a unique
action for each such table with a <code>DirectCounter</code>, where each such
action in turn calls action <code>A</code>, in addition to any <code>count</code>
invocations they have.</p>
</div>
<div class="paragraph">
<p>A <code>DirectCounter</code> instance must have a counter value associated with
its owner table that is updated when there is a default action
assigned to the table, and a search of the table results in a miss.
If there is no default action assigned to the table, then there need
not be any counter updated when a search of the table results in a
miss.</p>
</div>
<div class="paragraph">
<p>By "a default action is assigned to a table", we mean that either the
table has a <code>default_action</code> table property with an action assigned to
it in the P4 program, or the control plane has made an explicit call
to assign the table a default action.  If neither of these is true,
then there is no default action assigned to the table.</p>
</div>
</div>
<div class="sect3">
<h4 id="_example_program_using_counters">8.7.4. Example program using counters</h4>
<div class="paragraph">
<p>The following partial P4 program demonstrates the instantiation and
updating of <code>Counter</code> and <code>DirectCounter</code> externs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">48</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">ByteCounter_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">PacketCounter_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">80</span><span style="color: #0550ae">&gt;</span> <span style="color: #953800">PacketByteCounter_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">const</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> NUM_PORTS <span style="color: #0550ae">=</span> <span style="color: #0550ae">512</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">struct</span> headers <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">ethernet_t</span>       ethernet<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">ipv4_t</span>           ipv4<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">control</span> ingress<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> metadata user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">in</span>    <span style="color: #953800">psa_ingress_input_metadata_t</span>  istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> ostd<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    Counter<span style="color: #0550ae">&lt;</span><span style="color: #953800">ByteCounter_t</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">PortId_t</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>NUM_PORTS<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">PSA_CounterType_t</span><span style="color: #0550ae">.</span>BYTES<span style="color: #24292f;background-color: #f6f8fa">)</span>
        port_bytes_in<span style="color: #24292f;background-color: #f6f8fa">;</span>
    DirectCounter<span style="color: #0550ae">&lt;</span><span style="color: #953800">PacketByteCounter_t</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PSA_CounterType_t</span><span style="color: #0550ae">.</span>PACKETS_AND_BYTES<span style="color: #24292f;background-color: #f6f8fa">)</span>
        per_prefix_pkt_byte_count<span style="color: #24292f;background-color: #f6f8fa">;</span>

    <span style="color: #cf222e">action</span> next_hop<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PortId_t</span> oport<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        per_prefix_pkt_byte_count<span style="color: #0550ae">.</span>count<span style="color: #24292f;background-color: #f6f8fa">();</span>
        send_to_port<span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #24292f;background-color: #f6f8fa">,</span> oport<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">action</span> default_route_drop<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        per_prefix_pkt_byte_count<span style="color: #0550ae">.</span>count<span style="color: #24292f;background-color: #f6f8fa">();</span>
        ingress_drop<span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">table</span> ipv4_da_lpm <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>dstAddr<span style="color: #24292f;background-color: #f6f8fa">:</span> lpm<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            next_hop<span style="color: #24292f;background-color: #f6f8fa">;</span>
            default_route_drop<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> default_route_drop<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #6e7781">// table ipv4_da_lpm owns this DirectCounter instance
</span>        psa_direct_counter <span style="color: #0550ae">=</span> per_prefix_pkt_byte_count<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        port_bytes_in<span style="color: #0550ae">.</span>count<span style="color: #24292f;background-color: #f6f8fa">(</span>istd<span style="color: #0550ae">.</span>ingress_port<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span><span style="color: #953800">isValid</span><span style="color: #24292f;background-color: #f6f8fa">())</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            ipv4_da_lpm<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">control</span> egress<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
               <span style="color: #cf222e">inout</span> metadata user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
               <span style="color: #cf222e">in</span>    <span style="color: #953800">psa_egress_input_metadata_t</span>  istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
               <span style="color: #cf222e">inout</span> <span style="color: #953800">psa_egress_output_metadata_t</span> ostd<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    Counter<span style="color: #0550ae">&lt;</span><span style="color: #953800">ByteCounter_t</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">PortId_t</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>NUM_PORTS<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">PSA_CounterType_t</span><span style="color: #0550ae">.</span>BYTES<span style="color: #24292f;background-color: #f6f8fa">)</span>
        port_bytes_out<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #6e7781">// By doing these stats updates on egress, then because
</span>        <span style="color: #6e7781">// multicast replication happens before egress processing,
</span>        <span style="color: #6e7781">// this update will occur once for each copy made, which in
</span>        <span style="color: #6e7781">// this example is intentional.
</span>        port_bytes_out<span style="color: #0550ae">.</span>count<span style="color: #24292f;background-color: #f6f8fa">(</span>istd<span style="color: #0550ae">.</span>egress_port<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-meters">8.8. Meters</h3>
<div class="paragraph">
<p>Meters (RFC 2698) are a more complex mechanism for keeping statistics
about packets, most often used for dropping
or "marking" packets that exceed an average packet or bit rate.  To
mark a packet means to change one or more of its quality of service
values in packet headers such as the 802.1Q PCP (priority code point)
or DSCP (differentiated service code point) bits within the IPv4 or
IPv6 type of service byte.  The meters specified in the PSA are
3-color meters.</p>
</div>
<div class="paragraph">
<p>PSA meters do not require any particular drop or marking actions, nor
do they automatically implement those behaviors for you.  Meters keep
enough state, and update their state during <code>execute()</code> method calls,
in such a way that they return a <code>GREEN</code> (also known as conform),
<code>YELLOW</code> (exceed), or <code>RED</code> (violate) result.  See RFC 2698 for details on the
conditions under which one of these three results is returned.  The P4
program is responsible for examining that returned result, and making
changes to packet forwarding behavior as a result.
The value returned by an uninitialized meter shall be GREEN. This is in
accordance with the P4Runtime specification.</p>
</div>
<div class="paragraph">
<p>RFC 2698 describes "color aware" and "color blind" variations of
meters.  The <code>Meter</code> and <code>DirectMeter</code> externs implement both.  The
only difference is in which <code>execute</code> method you use when updating
them.  See the comments on the <code>extern</code> definitions below.</p>
</div>
<div class="paragraph">
<p>Similar to counters, there are two flavors of meters: indexed and
direct.  (Indexed) meters are addressed by index, while direct meters
always update a meter state corresponding to the matched table entry
or action, and from the control plane API are addressed using
P4Runtime table entry as key.</p>
</div>
<div class="paragraph">
<p>There are many other similarities between counters and meters,
including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The number of independently updatable meter values.</p>
</li>
<li>
<p>Where meter updates are allowed in a P4 program.</p>
</li>
<li>
<p>For <code>BYTES</code> type meters, the packet length used in the update is
determined by the PSA implementation, and can vary from one PSA
implementation to another.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Further similarities between direct counters and direct meters
include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DirectMeter</code> <code>execute</code> method calls must be performed within
actions invoked by the table that owns the <code>DirectMeter</code> instance.
It is optional for such an action to call the <code>execute</code> method.</p>
</li>
<li>
<p>There must be a meter state associated with a <code>DirectMeter</code>
instance&#8217;s owner table, that can be updated when the table result is
a miss.  As for a <code>DirectCounter</code>, this state only needs to exist if
a default action is assigned to the table.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The table attribute to specify that a table owns a <code>DirectMeter</code>
instance is <code>psa_direct_meter</code>.  The value of this table attribute is
a <code>DirectMeter</code> instance name.</p>
</div>
<div class="paragraph">
<p>As for counters, if you call the <code>execute(idx)</code> method on an indexed
meter and <code>idx</code> is at least the number of meter states, so <code>idx</code> is
out of range, no meter state is updated.  The <code>execute</code> call still
returns a value of type <code>PSA_MeterColor_t</code>, but the value is undefined&#8201;&#8212;&#8201;programs that wish to have predictable behavior across implementations
must not use the undefined value in a way that affects the output
packet or other side effects.  The example code below shows one way to
achieve predictable behavior.  Note that this undefined behavior
cannot occur if the value of <code>n_meters</code> of an indexed meter is $2^W$,
and the type <code>S</code> used to construct the meter is <code>bit&lt;W&gt;</code>, since the
index value could never be out of range.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">#define</span> METER1_SIZE <span style="color: #0550ae">100</span>
Meter<span style="color: #0550ae">&lt;</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">7</span><span style="color: #0550ae">&gt;&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>METER1_SIZE<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">PSA_MeterType_t</span><span style="color: #0550ae">.</span>BYTES<span style="color: #24292f;background-color: #f6f8fa">)</span> meter1<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">7</span><span style="color: #0550ae">&gt;</span> idx<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #953800">PSA_MeterColor_t</span> color1<span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #6e7781">// ... later ...
</span>
<span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>idx <span style="color: #0550ae">&lt;</span> METER1_SIZE<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    color1 <span style="color: #0550ae">=</span> meter1<span style="color: #0550ae">.</span>execute<span style="color: #24292f;background-color: #f6f8fa">(</span>idx<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">PSA_MeterColor_t</span><span style="color: #0550ae">.</span>GREEN<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #6e7781">// If idx is out of range, use a default value for color1.  One
</span>    <span style="color: #6e7781">// may also choose to store an error flag in some metadata field.
</span>    color1 <span style="color: #0550ae">=</span> <span style="color: #953800">PSA_MeterColor_t</span><span style="color: #0550ae">.</span>RED<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Any implementation will have a finite range that can be specified for
the Peak Burst Size and Committed Burst Size.  An implementation
should document the maximum burst sizes they support, and if the
implementation internally truncates the values that the control plane
requests to something more coarse than any number of bytes, that
should also be documented.  It is recommended that the maximum burst
sizes be allowed as large as the number of bytes that can be
transmitted across the implementation&#8217;s maximum speed port in 100
milliseconds.</p>
</div>
<div class="paragraph">
<p>Implementations will also have finite ranges and precisions that they
support for the Peak Information Rate and Committed Information Rate.
An implementation should document the maximum rate it supports, as
well as the precision it supports for implementing requested rates.
It is recommended that the maximum rate supported be at least the rate
of the implementation&#8217;s fastest port, and that the actual implemented
rate should always be within plus or minus 0.1% of the requested rate.</p>
</div>
<div class="sect3">
<h4 id="_meter_types">8.8.1. Meter types</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">PSA_MeterType_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    PACKETS<span style="color: #24292f;background-color: #f6f8fa">,</span>
    BYTES
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_meter_colors">8.8.2. Meter colors</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">enum</span> <span style="color: #953800">PSA_MeterColor_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> RED<span style="color: #24292f;background-color: #f6f8fa">,</span> GREEN<span style="color: #24292f;background-color: #f6f8fa">,</span> YELLOW <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_meter">8.8.3. Meter</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// Indexed meter with n_meters independent meter states.
</span>
<span style="color: #cf222e">extern</span> Meter<span style="color: #0550ae">&lt;</span>S<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  Meter<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> n_meters<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">PSA_MeterType_t</span> <span style="color: #cf222e">type</span><span style="color: #24292f;background-color: #f6f8fa">);</span>

  <span style="color: #6e7781">// Use this method call to perform a color aware meter update (see
</span>  <span style="color: #6e7781">// RFC 2698). The color of the packet before the method call was
</span>  <span style="color: #6e7781">// made is specified by the color parameter.
</span>  <span style="color: #953800">PSA_MeterColor_t</span> execute<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> S index<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> <span style="color: #953800">PSA_MeterColor_t</span> color<span style="color: #24292f;background-color: #f6f8fa">);</span>

  <span style="color: #6e7781">// Use this method call to perform a color blind meter update (see
</span>  <span style="color: #6e7781">// RFC 2698).  It may be implemented via a call to execute(index,
</span>  <span style="color: #6e7781">// MeterColor_t.GREEN), which has the same behavior.
</span>  <span style="color: #953800">PSA_MeterColor_t</span> execute<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> S index<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_direct_meter">8.8.4. Direct Meter</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> DirectMeter <span style="color: #24292f;background-color: #f6f8fa">{</span>
  DirectMeter<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PSA_MeterType_t</span> <span style="color: #cf222e">type</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
  <span style="color: #6e7781">// See the corresponding methods for extern Meter.
</span>  <span style="color: #953800">PSA_MeterColor_t</span> execute<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">PSA_MeterColor_t</span> color<span style="color: #24292f;background-color: #f6f8fa">);</span>
  <span style="color: #953800">PSA_MeterColor_t</span> execute<span style="color: #24292f;background-color: #f6f8fa">();</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-registers">8.9. Registers</h3>
<div class="paragraph">
<p>Registers are stateful memories whose values can be read and written
during packet forwarding under the control of the P4 program.  They
are similar to counters and meters in that their state can be modified
as a result of processing packets, but they are far more general in
the behavior they can implement.</p>
</div>
<div class="paragraph">
<p>Although you may not use register contents directly in table match
keys, you may use the <code>read()</code> method call on the right-hand side of
an assignment statement, which retrieves the current value of the
register.  You may copy the register value into metadata, and it is
then available for matching in subsequent tables.</p>
</div>
<div class="paragraph">
<p>There are two different constructors for Register instances.  The
value returned for the uninitialized variant is undefined.  The value
returned for the initialized variant is the one specified by the
<code>initial_value</code> parameter of the constructor.</p>
</div>
<div class="paragraph">
<p>A simple usage example is to verify that a "first packet" was
seen for a particular type of flow.  A register cell would be
allocated to the flow, initialized to "clear".  When the protocol
signaled a "first packet", the table would match on this value and
update the flow&#8217;s cell to "marked".  Subsequent packets in the flow
would be mapped to the same cell; the current cell value would
be stored in metadata for the packet and a subsequent table could
check that the flow was marked as active.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> Register<span style="color: #0550ae">&lt;</span>T<span style="color: #24292f;background-color: #f6f8fa">,</span> S<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">/// Instantiate an array of &lt;size&gt; registers. The initial value is
</span>  <span style="color: #6e7781">/// undefined.
</span>  Register<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> <span style="color: #cf222e">size</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
  <span style="color: #6e7781">/// Initialize an array of &lt;size&gt; registers and set their value to
</span>  <span style="color: #6e7781">/// initial_value.
</span>  Register<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> <span style="color: #cf222e">size</span><span style="color: #24292f;background-color: #f6f8fa">,</span> T initial_value<span style="color: #24292f;background-color: #f6f8fa">);</span>

  <span style="color: #0550ae">@noSideEffects</span>
  T    read  <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> S index<span style="color: #24292f;background-color: #f6f8fa">);</span>
  <span style="color: #953800">void</span> write <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> S index<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> T value<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another example using registers is given below.  It implements a
packet and byte counter, where the byte counter can be updated by a
packet length specified in the P4 program, rather than one chosen by
the PSA implementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">const</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> NUM_PORTS <span style="color: #0550ae">=</span> <span style="color: #0550ae">512</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #6e7781">// It would be more convenient to use a struct type to represent the
// state of a combined packet and byte count, and many other compound
// values one might wish to store in a Register instance.  However,
// the latest p4test as of 2018-Feb-10 does not allow a struct type to
// be returned from a method call like Register.read().
</span>
<span style="color: #6e7781">// Refer to this Github issue for status of generalizing this:
// https://github.com/p4lang/p4-spec/issues/383
</span>
<span style="color: #6e7781">#define</span> PACKET_COUNT_WIDTH <span style="color: #0550ae">32</span>
<span style="color: #6e7781">#define</span> BYTE_COUNT_WIDTH <span style="color: #0550ae">48</span>
<span style="color: #6e7781">//#define PACKET_BYTE_COUNT_WIDTH (PACKET_COUNT_WIDTH + BYTE_COUNT_WIDTH)
</span><span style="color: #6e7781">#define</span> PACKET_BYTE_COUNT_WIDTH <span style="color: #0550ae">80</span>

<span style="color: #6e7781">#define</span> PACKET_COUNT_RANGE <span style="color: #24292f;background-color: #f6f8fa">(</span>PACKET_BYTE_COUNT_WIDTH<span style="color: #0550ae">-</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">):</span>BYTE_COUNT_WIDTH
<span style="color: #6e7781">#define</span> BYTE_COUNT_RANGE <span style="color: #24292f;background-color: #f6f8fa">(</span>BYTE_COUNT_WIDTH<span style="color: #0550ae">-</span><span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">):</span><span style="color: #0550ae">0</span>

<span style="color: #cf222e">typedef</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span>PACKET_BYTE_COUNT_WIDTH<span style="color: #0550ae">&gt;</span> <span style="color: #953800">PacketByteCountState_t</span><span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #cf222e">action</span> update_pkt_ip_byte_count <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> <span style="color: #953800">PacketByteCountState_t</span> s<span style="color: #24292f;background-color: #f6f8fa">,</span>
                                 <span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> ip_length_bytes<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    s<span style="color: #24292f;background-color: #f6f8fa">[</span>PACKET_COUNT_RANGE<span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #0550ae">=</span> s<span style="color: #24292f;background-color: #f6f8fa">[</span>PACKET_COUNT_RANGE<span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #0550ae">+</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    s<span style="color: #24292f;background-color: #f6f8fa">[</span>BYTE_COUNT_RANGE<span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>s<span style="color: #24292f;background-color: #f6f8fa">[</span>BYTE_COUNT_RANGE<span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #0550ae">+</span>
                           <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span>BYTE_COUNT_WIDTH<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)</span> ip_length_bytes<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">control</span> ingress<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> metadata user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">in</span>    <span style="color: #953800">psa_ingress_input_metadata_t</span>  istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> ostd<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    Register<span style="color: #0550ae">&lt;</span><span style="color: #953800">PacketByteCountState_t</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">PortId_t</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span>NUM_PORTS<span style="color: #24292f;background-color: #f6f8fa">)</span>
        port_pkt_ip_bytes_in<span style="color: #24292f;background-color: #f6f8fa">;</span>

    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        ostd<span style="color: #0550ae">.</span>egress_port <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PortId_t</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span><span style="color: #953800">isValid</span><span style="color: #24292f;background-color: #f6f8fa">())</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #0550ae">@atomic</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
                <span style="color: #953800">PacketByteCountState_t</span> tmp<span style="color: #24292f;background-color: #f6f8fa">;</span>
                tmp <span style="color: #0550ae">=</span> port_pkt_ip_bytes_in<span style="color: #0550ae">.</span>read<span style="color: #24292f;background-color: #f6f8fa">(</span>istd<span style="color: #0550ae">.</span>ingress_port<span style="color: #24292f;background-color: #f6f8fa">);</span>
                update_pkt_ip_byte_count<span style="color: #24292f;background-color: #f6f8fa">(</span>tmp<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>totalLen<span style="color: #24292f;background-color: #f6f8fa">);</span>
                port_pkt_ip_bytes_in<span style="color: #0550ae">.</span>write<span style="color: #24292f;background-color: #f6f8fa">(</span>istd<span style="color: #0550ae">.</span>ingress_port<span style="color: #24292f;background-color: #f6f8fa">,</span> tmp<span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the use of the <code>@atomic</code> annotation in the block enclosing the
<code>read()</code> and <code>write()</code> method calls on the <code>Register</code> instance.  It is
expected to be common that register accesses will need the <code>@atomic</code>
annotation around portions of your program in order to behave as you
desire.  As stated in the P4<sub>16</sub> specification, without the <code>@atomic</code>
annotation in this example, an implementation is allowed to process
two packets <code>P1</code> and <code>P2</code> in parallel, and perform the register access
operations in this order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">    <span style="color: #6e7781">// Possible order of operations for the example program if the
</span>    <span style="color: #6e7781">// @atomic annotation is _not_ used.
</span>
    tmp <span style="color: #0550ae">=</span> port_pkt_ip_bytes_in<span style="color: #0550ae">.</span>read<span style="color: #24292f;background-color: #f6f8fa">(</span>istd<span style="color: #0550ae">.</span>ingress_port<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// for packet P1
</span>    tmp <span style="color: #0550ae">=</span> port_pkt_ip_bytes_in<span style="color: #0550ae">.</span>read<span style="color: #24292f;background-color: #f6f8fa">(</span>istd<span style="color: #0550ae">.</span>ingress_port<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// for packet P2
</span>
    <span style="color: #6e7781">// At this time, if P1 and P2 came from the same ingress_port,
</span>    <span style="color: #6e7781">// each of their values of tmp are identical.
</span>
    update_pkt_ip_byte_count<span style="color: #24292f;background-color: #f6f8fa">(</span>tmp<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>totalLen<span style="color: #24292f;background-color: #f6f8fa">);</span>    <span style="color: #6e7781">// for packet P1
</span>    update_pkt_ip_byte_count<span style="color: #24292f;background-color: #f6f8fa">(</span>tmp<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>totalLen<span style="color: #24292f;background-color: #f6f8fa">);</span>    <span style="color: #6e7781">// for packet P2
</span>
    port_pkt_ip_bytes_in<span style="color: #0550ae">.</span>write<span style="color: #24292f;background-color: #f6f8fa">(</span>istd<span style="color: #0550ae">.</span>ingress_port<span style="color: #24292f;background-color: #f6f8fa">,</span> tmp<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// for packet P1
</span>    port_pkt_ip_bytes_in<span style="color: #0550ae">.</span>write<span style="color: #24292f;background-color: #f6f8fa">(</span>istd<span style="color: #0550ae">.</span>ingress_port<span style="color: #24292f;background-color: #f6f8fa">,</span> tmp<span style="color: #24292f;background-color: #f6f8fa">);</span>  <span style="color: #6e7781">// for packet P2
</span>    <span style="color: #6e7781">// The write() from packet P1 is lost.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since different implementations may have different upper limits on the
complexity of code that they will accept within an <code>@atomic</code> block, we
recommend you keep them as small as possible, subject to maintaining
your desired correct behavior.</p>
</div>
<div class="paragraph">
<p>Individual counter and meter method calls need not be enclosed in
<code>@atomic</code> blocks to be safe&#8201;&#8212;&#8201;they guarantee atomic behavior of their
individual method calls, without losing any updates.  Even though the
P4<sub>16</sub> v1.0.0 language specification currently requires that every
<code>action</code> of a table behave as if its entire body is annotated by an
<code>@atomic</code> annotation, it is recommended to explicitly use <code>@atomic</code>
annotations inside of action bodies as if this were not the case,
since (a) it is harmless, and more importantly (b) this requirement
may be removed in a near future revision of the language
specification.</p>
</div>
<div class="paragraph">
<p>As for indexed counters and meters, access to an index of a register
that is at least the size of the register is out of bounds.  An out of
bounds write has no effect on the state of the system.  An out of
bounds read returns an undefined value.  See the example in
<a href="#sec-meters">Section 8.8</a> for one way to write code to guarantee avoiding this
undefined behavior.  Out of bounds register accesses are impossible
for a register instance with type <code>S</code> declared as <code>bit&lt;W&gt;</code> and size
$2^W$ entries.</p>
</div>
</div>
<div class="sect2">
<h3 id="_random">8.10. Random</h3>
<div class="paragraph">
<p>The <code>Random</code> extern provides generation of pseudo-random numbers in a
specified range with a uniform distribution.  If one wishes to
generate numbers with a non-uniform distribution, you may do so by
first generating a uniformly distributed random value, and then using
appropriate table lookups and/or arithmetic on the resulting value to
achieve the desired distribution.</p>
</div>
<div class="paragraph">
<p>An implementation is not required to produce cryptographically strong
pseudo-random number generation.  For example, a particularly
inexpensive implementation might use a linear feedback shift register
to generate values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> Random<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>

  <span style="color: #6e7781">/// Return a random value in the range [min, max], inclusive.
</span>  <span style="color: #6e7781">/// Implementations are allowed to support only ranges where (max -
</span>  <span style="color: #6e7781">/// min + 1) is a power of 2.  P4 developers should limit their
</span>  <span style="color: #6e7781">/// arguments to such values if they wish to maximize portability.
</span>
  Random<span style="color: #24292f;background-color: #f6f8fa">(</span>T min<span style="color: #24292f;background-color: #f6f8fa">,</span> T max<span style="color: #24292f;background-color: #f6f8fa">);</span>
  T read<span style="color: #24292f;background-color: #f6f8fa">();</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-action-profile">8.11. Action Profile</h3>
<div class="paragraph">
<p>Action profiles are used as table implementation attributes.</p>
</div>
<div class="paragraph">
<p>Action profiles provide a mechanism to populate table entries
with action specifications that have been defined outside the table entry
specification. An action profile extern can be instantiated as
a resource in the P4 program. A table that uses this action profile
must specify its <code>psa_implementation</code> attribute as the action profile
instance.</p>
</div>
<div id="fig-ap" class="imageblock">
<div class="content">
<img src="figs/action_profile.png" alt="action profile">
</div>
<div class="title">Figure 4. Action profiles in PSA</div>
</div>
<div class="paragraph">
<p><a href="#fig-ap">Figure 4</a> contrasts a direct table with a table that has an action
profile implementation. A direct table, as seen in <a href="#fig-ap">Figure 4</a> (a)
contains the action specification in each table entry. In this example,
the table has a match key consisting of an LPM on header field <code>h.f</code>.
The action is to set the port. As we can see, entries t1 and t3 have the
same action, i.e. to set the port to 1. Action profiles enable sharing
an action across multiple entries by using a separate table as shown in
<a href="#fig-ap">Figure 4</a> (b).</p>
</div>
<div class="paragraph">
<p>A table with an action profile implementation has entries that point to a member
reference instead of directly defining an action specification. A mapping from
member references to action specifications is maintained in a separate table
that is part of the action profile instance defined in the table <code>psa_implementation</code>
attribute. When a table with an action profile implementation is applied, the
member reference is resolved and the corresponding action specification is
applied to the packet.</p>
</div>
<div class="paragraph">
<p>Action profile members may only specify action types defined in the <code>actions</code>
attribute of the implemented table. An action profile instance may be shared
across multiple tables only if all such tables define the same set of actions
in their <code>actions</code> attribute. Tables with an action profile implementation
cannot define a default action. The default action for such tables is implicitly
set to <code>NoAction</code>.</p>
</div>
<div class="paragraph">
<p>The control plane can add, modify or delete member entries for a
given action profile instance. The controller-assigned member reference
must be unique in the scope of the action profile instance. An
action profile instance may hold at most <code>size</code> entries as defined in the
constructor parameter. Table entries must specify the action using the
controller-assigned reference for the desired member entry. Directly specifying
the action as part of the table entry is not allowed for tables with an
action profile implementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> ActionProfile <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">/// Construct an action profile of 'size' entries
</span>  ActionProfile<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> <span style="color: #cf222e">size</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_action_profile_example">8.11.1. Action Profile Example</h4>
<div class="paragraph">
<p>The P4 control block <code>Ctrl</code> in the example below instantiates an
action profile <code>ap</code> that can contain at most 128 member entries. Table
<code>indirect</code> uses this instance by specifying the <code>psa_implementation</code> attribute.
The control plane can add member entries to <code>ap</code>, where each member can
specify either a <code>foo</code> or <code>NoAction</code> action. Table entries for <code>indirect</code>
table must specify the action using the controller-assigned member reference.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> Ctrl<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> H hdr<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">inout</span> M meta<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>

  <span style="color: #cf222e">action</span> foo<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> meta<span style="color: #0550ae">.</span>foo <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>

  ActionProfile<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">128</span><span style="color: #24292f;background-color: #f6f8fa">)</span> ap<span style="color: #24292f;background-color: #f6f8fa">;</span>

  <span style="color: #cf222e">table</span> indirect <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>dst_address<span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;}</span>
    <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> foo<span style="color: #24292f;background-color: #f6f8fa">;</span> NoAction<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    psa_implementation <span style="color: #0550ae">=</span> ap<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #24292f;background-color: #f6f8fa">}</span>

  <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    indirect<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
  <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-action-selector">8.12. Action Selector</h3>
<div class="paragraph">
<p>Action selectors are used as table implementation attributes.</p>
</div>
<div class="paragraph">
<p>Action selectors implement yet another mechanism to populate table
entries with action specifications that have been defined outside the
table entry. They are more powerful than action profiles because they also
provide the ability to dynamically select the action specification to apply
upon matching a table entry. An action selector extern can be instantiated as
a resource in the P4 program, similar to action profiles. Furthermore,
a table that uses this action selector must specify its <code>psa_implementation</code> attribute
as the action selector instance.</p>
</div>
<div id="fig-as" class="imageblock">
<div class="content">
<img src="figs/action_selector.png" alt="action selector">
</div>
<div class="title">Figure 5. Action selectors in PSA</div>
</div>
<div class="paragraph">
<p><a href="#fig-as">Figure 5</a> illustrates a table that has an action selector implementation.
In this example, the table has a match key consisting of an LPM on header field
<code>h.f</code>. A second match type <code>selector</code> is used to define the fields that are
used to look up the action specification from the selector at runtime.</p>
</div>
<div class="paragraph">
<p>A table with an action action selector implementation consists of
entries that point to either an action profile member reference or an
action profile group reference. An action selector instance can be
logically visualized as two tables as shown in <a href="#fig-as">Figure 5</a>. The first
table contains a mapping from group references to a set of member
references. The second table contains a mapping from member references
to action specifications.</p>
</div>
<div class="paragraph">
<p>When a packet matches a table entry at runtime, the controller-assigned
reference of the action profile member or group is read. If the entry points to
a member then the corresponding action specification is applied to the packet.
However, if the entry points to a group, a dynamic selection algorithm is used
to select a member from the group, and the action specification
corresponding to that member is applied. The dynamic selection algorithm is
specified as a parameter when instantiating the action selector.</p>
</div>
<div class="paragraph">
<p>Action selector members may only specify action types defined in the
<code>actions</code> attribute of the implemented table.</p>
</div>
<div class="paragraph">
<p>Minimum requirements for a PSA implementation of action selectors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Support non-empty groups where every action in the same group has
the same action name.</p>
</li>
<li>
<p>Within the same group, support arbitrary action parameter values
among different members of the group.</p>
</li>
<li>
<p>Support different action names in different groups.</p>
</li>
<li>
<p>No predictable data plane behavior is required if a table entry is
matched that points at an empty group.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Optional extensions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Support non-empty groups where in the same group, different actions
can have different action names, as well as arbitrary action
parameter values.</p>
</li>
<li>
<p>Support table entries that point at an empty group.  When the entry
is matched, execute the action assigned to the table property
<code>psa_empty_group_action</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>psa_empty_group_action</code> property of a table is similar to the
<code>default_action</code> property in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>They both have actions as their values.</p>
</li>
<li>
<p>The P4 source code specifies the initial value.</p>
</li>
<li>
<p>If the table property <code>psa_empty_group_action</code> is not given in the
P4 source code, its value is <code>NoAction()</code>.</p>
</li>
<li>
<p>They may have a <code>const</code> modifier, indicating that control software
is not allowed to change this action.</p>
</li>
<li>
<p>In the absence of a <code>const</code> modifier, the control software is
allowed to change the action assigned to <code>psa_empty_group_action</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>PSA implementers should note that supporting empty groups with
predictable data plane behavior may be required in a future version of
PSA.  In some cases, it may be possible for the combination of a PSA
data plane plus its P4Runtime server software to achieve this desired
behavior, as far as the P4Runtime client controller software can
observe.  See <a href="#appendix-empty-action-selector-groups">Appendix G</a>.</p>
</div>
<div class="paragraph">
<p>An action selector instance may be shared across multiple tables only if all such
tables define the same set of actions in their <code>actions</code> attribute. Furthermore,
the selector match fields for such tables must be identical and must be specified
in the same order across all tables sharing the selector. Tables with an action
selector implementation cannot define a default action. The default action for
such tables is implicitly set to <code>NoAction</code>.</p>
</div>
<div class="paragraph">
<p>The dynamic selection algorithm requires a field list as an input for generating
the index to a member entry in a group. This field list is created by using the
match type <code>selector</code> when defining the table match key. The match fields of
type <code>selector</code> are composed into a field list in the order they are specified.
The composed field list is passed as an input to the action selector
implementation. It is illegal to define a <code>selector</code> type match field if the
table does not have an action selector implementation.</p>
</div>
<div class="paragraph">
<p>The control plane can add, modify or delete member and group entries for a
given action selector instance. An action selector instance may hold at most
<code>size</code> member entries as defined in the constructor parameter. The number of
groups may be at most the size of the table that is implemented by the selector.
Table entries must specify the action using a reference to the desired member
or group entry. Directly specifying the action as part of the table entry is not
allowed for tables with an action selector implementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> ActionSelector <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">/// Construct an action selector of 'size' entries
</span>  <span style="color: #6e7781">/// @param algo hash algorithm to select a member in a group
</span>  <span style="color: #6e7781">/// @param size number of entries in the action selector
</span>  <span style="color: #6e7781">/// @param outputWidth size of the key
</span>  ActionSelector<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PSA_HashAlgorithm_t</span> algo<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> <span style="color: #cf222e">size</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> outputWidth<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_action_selector_example">8.12.1. Action Selector Example</h4>
<div class="paragraph">
<p>The P4 control block <code>Ctrl</code> in the example below instantiates an
action selector <code>as</code> that can contain at most 128 member entries. The
action selector uses a crc16 algorithm with output width of 10 bits
to select a member entry within a group.</p>
</div>
<div class="paragraph">
<p>Table <code>indirect_with_selection</code> uses this instance by specifying the
<code>psa_implementation</code> table property as shown. The control plane can add member and group
entries to <code>as</code>. Each member can specify either a <code>foo</code> or <code>NoAction</code> action.
When programming the table entries, the control plane <strong>does not</strong> include the
fields of match type <code>selector</code> in the match key. The selector match fields are
instead used to compose a list that is passed to the action selector instance.
In the example below, the list <code>{hdr.ipv4.src_address, hdr.ipv4.protocol}</code> is
passed as input to the crc16 hash algorithm used for dynamic member selection
by action selector <code>as</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">control</span> Ctrl<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> H hdr<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">inout</span> M meta<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>

  <span style="color: #cf222e">action</span> foo<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> meta<span style="color: #0550ae">.</span>foo <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>

  ActionSelector<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PSA_HashAlgorithm_t</span><span style="color: #0550ae">.</span>CRC16<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">128</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">10</span><span style="color: #24292f;background-color: #f6f8fa">)</span> as<span style="color: #24292f;background-color: #f6f8fa">;</span>

  <span style="color: #cf222e">table</span> indirect_with_selection <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
      hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>dst_address<span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span>
      hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>src_address<span style="color: #24292f;background-color: #f6f8fa">:</span> selector<span style="color: #24292f;background-color: #f6f8fa">;</span>
      hdr<span style="color: #0550ae">.</span>ipv4<span style="color: #0550ae">.</span>protocol<span style="color: #24292f;background-color: #f6f8fa">:</span> selector<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> foo<span style="color: #24292f;background-color: #f6f8fa">;</span> NoAction<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
    psa_implementation <span style="color: #0550ae">=</span> as<span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #24292f;background-color: #f6f8fa">}</span>

  <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    indirect_with_selection<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
  <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the management of action selector entries in the presence of
link failures is outside the scope of the PSA. Fast-failover requires
information from the control plane and will be addressed as part of the
P4Runtime API<sup class="footnoteref">[<a class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> working group.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_timestamps">8.13. Timestamps</h3>
<div class="paragraph">
<p>A PSA implementation provides an <code>ingress_timestamp</code> value for every
packet in the <code>Ingress</code> control block, as a field in the struct with
type <code>psa_ingress_input_metadata_t</code>.  This timestamp should be close
to the time that the first bit of the packet arrived to the device, or
alternately, to the time that the device began parsing the packet.
This timestamp is <em>not</em> automatically included with the packet in the
<code>Egress</code> control block.  A P4 program wishing to use the value of
<code>ingress_timestamp</code> in egress code must copy it to a user-defined
metadata field that reaches egress.</p>
</div>
<div class="paragraph">
<p>A PSA implementation also provides an <code>egress_timestamp</code> value for
every packet in the <code>Egress</code> control block, as a field of the struct
with type <code>psa_egress_input_metadata_t</code>.</p>
</div>
<div class="paragraph">
<p>One expected use case for timestamps is to store them in tables or
<code>Register</code> instances to implement checking for timeout events for
protocols, where precision on the order of milliseconds is sufficient
for most protocols.</p>
</div>
<div class="paragraph">
<p>Another expected use case is INT (In-band Network Telemetry<sup class="footnote" id="_footnote_telem">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup>),
where precision on the order of microseconds or smaller is necessary
to measure queueing latencies that differ by those amounts.  It takes
only 0.74 microseconds to transmit a 9 Kbyte Ethernet jumbo frame on a
100 gigabit per second link.</p>
</div>
<div class="paragraph">
<p>For these applications, it is recommended that an implementation&#8217;s
timestamp increments at least once every microsecond.  Incrementing
once per clock cycle in an ASIC or FPGA implementation would be a
reasonable choice.  The timestamp should increment at a constant rate
over time.  For example, it should not be a simple count of clock
cycles in a device that implements dynamic frequency
scaling<sup class="footnote" id="_footnote_dynfreq">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup>.</p>
</div>
<div class="paragraph">
<p>Timestamps are of type <code>Timestamp_t</code>, which is type <code>bit&lt;W&gt;</code> for a
value of <code>W</code> defined by the implementation.  Timestamps are expected
to wrap around during the normal passage of time.  It is recommended
that an implementation pick a rate of advance and a bit width such
that wrapping around occurs at most once every hour.  Making the wrap
time this long (or longer) makes timestamps more useful for several
use cases.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Checking for timeouts of protocol hello / keep-alive traffic that is
on the order of seconds or minutes.</p>
</li>
<li>
<p>If timestamps are placed into packets without converting them to
other formats, then external data analysis systems using those
timestamps will in many cases need to do so, e.g. to compare
timestamps stored in packets by different PSA devices.  These
systems will need different formulas and/or parameters to perform
this conversion for each wrap period, or to add extra external time
references to the recorded data.  The extra data required for
accurate conversion is lower, and the likelihood of conversion
mistakes is lower, if the timestamp values wrap less often.</p>
</li>
<li>
<p>If timestamps are converted to other formats within a P4 program, it
will need access to parameters that are likely to change every wrap
time, e.g. at least a "base value" to add some calculated value to.
A straightforward way to do this requires the control plane to
update these values at least once or twice per timestamp wrap time.</p>
</li>
<li>
<p>Programs that wish to use <code>(egress_timestamp - ingress_timestamp)</code>
to calculate the queueing latency experienced by a packet need the
wrap time to exceed the maximum queueing latency.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples of the number of bits required for wrap times of at least one
hour:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A 32-bit timestamp advancing by 1 per microsecond takes 1.19 hours
to wrap.</p>
</li>
<li>
<p>A 42-bit timestamp advancing by 1 per nanosecond takes 1.22 hours to
wrap.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A PSA implementation is not required to implement time
synchronization, e.g. via PTP<sup class="footnote" id="_footnote_ptp">[<a id="_footnoteref_8" class="footnote" href="#_footnotedef_8" title="View footnote.">8</a>]</sup> or NTP<sup class="footnote" id="_footnote_ntp">[<a id="_footnoteref_9" class="footnote" href="#_footnotedef_9" title="View footnote.">9</a>]</sup>.</p>
</div>
<div class="paragraph">
<p>The control plane API excerpt below is intended to be added as part of
the P4Runtime API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// The TimestampInfo and Timestamp messages should be added to the
// "oneof" inside of message "Entity".
</span>
<span style="color: #6e7781">// TimestampInfo is only intended to be read.  Attempts to update this
// entity have no effect, and should return an error status that the
// entity is read only.
</span>
message TimestampInfo <span style="color: #24292f;background-color: #f6f8fa">{</span>
  <span style="color: #6e7781">// The number of bits in the device's `Timestamp_t` type.
</span>  uint32 size_in_bits <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
  <span style="color: #6e7781">// The timestamp value of this device increments
</span>  <span style="color: #6e7781">// `increments_per_period` times every `period_in_seconds` seconds.
</span>  uint64 increments_per_period <span style="color: #0550ae">=</span> <span style="color: #0550ae">2</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
  uint64 period_in_seconds <span style="color: #0550ae">=</span> <span style="color: #0550ae">3</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// The timestamp value can be read or written.  Note that if there are
// already timestamp values stored in tables or `Register` instances,
// they will not be updated as a result of writing this timestamp
// value.  Writing the device timestamp is intended only for
// initialization and testing.
</span>
message Timestamp <span style="color: #24292f;background-color: #f6f8fa">{</span>
  bytes value <span style="color: #0550ae">=</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For every packet <code>P</code> that is processed by ingress and then egress,
with the minimum possible latency in the packet buffer, it is
guaranteed that the <code>egress_timestamp</code> value for that packet will be
the same as, or slightly larger than, the <code>ingress_timestamp</code> value
that the packet was assigned on ingress.  By "slightly larger than",
we mean that the difference <code>(egress_timestamp - ingress_timestamp)</code>
should be a reasonably accurate estimate of this minimum possible
latency through the packet buffer, perhaps truncated down to 0 if
timestamps advance more slowly than this minimum latency.</p>
</div>
<div class="paragraph">
<p>Consider two packets such that at the same time (e.g. the same clock
cycle), one is assigned its value of <code>ingress_timestamp</code> near the time
it begins parsing, and the other is assigned its value of
<code>egress_timestamp</code> near the time that it begins its egress processing.
It is allowed that these timestamps differ by a few tens of
nanoseconds (or by one "tick" of the timestamp, if one tick is larger
than that time), due to practical difficulties in making them always
equal.</p>
</div>
<div class="paragraph">
<p>Recall that the binary operators <code>+</code> and <code>-</code> on the <code>bit&lt;W&gt;</code> type in
P4 are defined to perform wrap-around unsigned arithmetic.  Thus even
if a timestamp value wraps around from its maximum value back to 0,
you can always calculate the number of ticks that have elapsed from
timestamp $t1$ until timestamp $t2$ using the expression $(t2 - t1)$
(if more than $2^W$ ticks have elapsed, there will be aliasing of the
result).  For example, if timestamps were $W &gt;= 4$ bits in size,
$t1=2^{W}-5$, and $t2=3$, then $(t2-t1)=8$.  There is thus no need for
conditional execution to calculate such elapsed times.</p>
</div>
<div class="paragraph">
<p>It is sometimes useful to minimize storage costs by discarding some
bits of a timestamp value in a P4 program for use cases that do not
need the full wrap time or precision.  For example, an application
that only needs to detect protocol timeouts with an accuracy of 1
second can discard the least significant bits of a timestamp that
change more often than every 1 second.</p>
</div>
<div class="paragraph">
<p>Another example is an application that needed full precision of the
least significant bits of a timestamp, but the combination of the
control plane and P4 program are designed to examine all entries of a
<code>Register</code> array where these partial timestamps are stored more often
than once every 5 seconds, to prevent wrapping.  In that case, the P4
program could discard the most significant bits of the timestamp so
that the remaining bits wrap every 8 seconds, and store those partial
timestamps in the <code>Register</code> instance.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-packet-digest">8.14. Packet Digest</h3>
<div class="paragraph">
<p>A digest is one mechanism to send a message from the data plane to the
control plane.  Another is to send a packet to the control plane via
the port numbered <code>PSA_PORT_CPU</code>.  Sending a packet to port
<code>PSA_PORT_CPU</code> typically sends most or all of the original packet
headers, and perhaps also the payload, each as a separate message to
be received and processed by the control plane.  The contents of a
digest for one packet are typically much smaller than the packet.  A
PSA implementation can take advantage of this, e.g. it might combine
digests for multiple packets into larger messages, to reduce the
rate of messages sent to the control plane.</p>
</div>
<div class="paragraph">
<p>A digest message may contain any values from the data plane.  Because
a P4 program may have multiple Digest instances, each with different
message contents, the PSA implementation as a whole must provide the
ability to distinguish the messages created by different Digest
instances from each other.</p>
</div>
<div class="paragraph">
<p>In PSA, a digest is created by calling the <code>pack</code> method on the digest
instance.  The argument is the value to be included in the digest,
often a collection of values in a P4 <code>struct</code> type.  The compiler
decides the best serialization format to send the digest contents to a
local software agent, which is responsible for sending the digest data
in a form defined by the P4Runtime API specification.</p>
</div>
<div class="paragraph">
<p>A PSA program can instantiate multiple Digest instances in the same
IngressDeparser control block, and make at most one <code>pack</code> call on
each instance during a single execution of this control block.
A PSA implementation need not support the use of the Digest
extern in the EgressDeparser control block.</p>
</div>
<div class="paragraph">
<p>There is no requirement that if multiple Digest messages are created
while processing the same packet, that these messages must be "bundled
together" in any way.  An implementation is free to put them in
separate queues per Digest instance, for example, and they may arrive
to the controller completely separate from each other, and in a
different order than they were generated.  It is recommended that a
PSA implementation send Digest messages <em>from a single Digest
instance</em> to the control plane in the order they were generated.</p>
</div>
<div class="paragraph">
<p>If you wish to associate multiple Digest messages from different
instances with each other in control plane software, it may suit your
purposes to include a common sequence number or timestamp in all
Digest messages generated by the same packet.  Then use those in the
control plane for correlation of different messages.</p>
</div>
<div class="paragraph">
<p>Since high speed PSA implementations are expected to be able to
generate digests much faster than control software can consume them,
it is expected that loss of such digest messages will occur if the
data plane generates them too quickly.  It is recommended that PSA
implementations maintain a count of digest messages that the data
plane creates, but do not reach the control plane, independently for
each digest instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">extern</span> Digest<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
  Digest<span style="color: #24292f;background-color: #f6f8fa">();</span>                       <span style="color: #6e7781">/// define a digest stream to the control plane
</span>  <span style="color: #953800">void</span> pack<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">);</span>           <span style="color: #6e7781">/// emit data into the stream
</span><span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is a part of an example program that demonstrates using a digest
to notify the control plane about source Ethernet MAC addresses and
ingress ports of packets that have not been seen before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #cf222e">struct</span> <span style="color: #953800">mac_learn_digest_t</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    EthernetAddress srcAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">PortId_t</span>        ingress_port<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">struct</span> metadata <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bool</span>               send_mac_learn_msg<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #953800">mac_learn_digest_t</span> mac_learn_msg<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// This is part of the functionality of a typical Ethernet learning bridge.
</span>
<span style="color: #6e7781">// The control plane will typically enter the _same_ keys into the
// learned_sources and l2_tbl tables.  The entries in l2_tbl are searched for
// the packet's dest MAC address, and on a hit the resulting action tells
// where to send the packet.
</span>
<span style="color: #6e7781">// The entries in learned_sources are the same, and the action of every table
// entry added is NoAction.  If there is a _miss_ in learned_sources, we want
// to send a message to the control plane software containing the packet's
// source MAC address, and the port it arrived on.  The control plane will
// make a decision about creating an entry with that packet's source MAC
// address into both tables, with the l2_tbl sending future packets out this
// packet's ingress_port.
</span>
<span style="color: #6e7781">// This is only a simple example, e.g. there is no implementation of
// "flooding" shown here, typical when a learning bridge gets a miss when
// looking up the dest MAC address of a packet.
</span>
<span style="color: #cf222e">control</span> ingress<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">inout</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> metadata meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">in</span>    <span style="color: #953800">psa_ingress_input_metadata_t</span>  istd<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> ostd<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">action</span> unknown_source <span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        meta<span style="color: #0550ae">.</span>send_mac_learn_msg <span style="color: #0550ae">=</span> true<span style="color: #24292f;background-color: #f6f8fa">;</span>
        meta<span style="color: #0550ae">.</span>mac_learn_msg<span style="color: #0550ae">.</span>srcAddr <span style="color: #0550ae">=</span> hdr<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>srcAddr<span style="color: #24292f;background-color: #f6f8fa">;</span>
        meta<span style="color: #0550ae">.</span>mac_learn_msg<span style="color: #0550ae">.</span>ingress_port <span style="color: #0550ae">=</span> istd<span style="color: #0550ae">.</span>ingress_port<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #6e7781">// meta.mac_learn_msg will be sent to control plane in
</span>        <span style="color: #6e7781">// IngressDeparser control block
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">table</span> learned_sources <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> hdr<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>srcAddr <span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> NoAction<span style="color: #24292f;background-color: #f6f8fa">;</span> unknown_source<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> unknown_source<span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>

    <span style="color: #cf222e">action</span> do_L2_forward <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PortId_t</span> egress_port<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        send_to_port<span style="color: #24292f;background-color: #f6f8fa">(</span>ostd<span style="color: #24292f;background-color: #f6f8fa">,</span> egress_port<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">table</span> l2_tbl <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> hdr<span style="color: #0550ae">.</span>ethernet<span style="color: #0550ae">.</span>dstAddr <span style="color: #24292f;background-color: #f6f8fa">:</span> exact<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> do_L2_forward<span style="color: #24292f;background-color: #f6f8fa">;</span> NoAction<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">default_action</span> <span style="color: #0550ae">=</span> NoAction<span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        meta<span style="color: #0550ae">.</span>send_mac_learn_msg <span style="color: #0550ae">=</span> false<span style="color: #24292f;background-color: #f6f8fa">;</span>
        learned_sources<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
        l2_tbl<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #cf222e">control</span> IngressDeparserImpl<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">packet_out</span> packet<span style="color: #24292f;background-color: #f6f8fa">,</span>
                            <span style="color: #cf222e">out</span> <span style="color: #953800">empty_metadata_t</span> clone_i2e_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                            <span style="color: #cf222e">out</span> <span style="color: #953800">empty_metadata_t</span> resubmit_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                            <span style="color: #cf222e">out</span> <span style="color: #953800">empty_metadata_t</span> normal_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                            <span style="color: #cf222e">inout</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
                            <span style="color: #cf222e">in</span> metadata meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                            <span style="color: #cf222e">in</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> istd<span style="color: #24292f;background-color: #f6f8fa">)</span>
<span style="color: #24292f;background-color: #f6f8fa">{</span>
    CommonDeparserImpl<span style="color: #24292f;background-color: #f6f8fa">()</span> common_deparser<span style="color: #24292f;background-color: #f6f8fa">;</span>
    Digest<span style="color: #0550ae">&lt;</span><span style="color: #953800">mac_learn_digest_t</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">()</span> mac_learn_digest<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>meta<span style="color: #0550ae">.</span>send_mac_learn_msg<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            mac_learn_digest<span style="color: #0550ae">.</span>pack<span style="color: #24292f;background-color: #f6f8fa">(</span>meta<span style="color: #0550ae">.</span>mac_learn_msg<span style="color: #24292f;background-color: #f6f8fa">);</span>
        <span style="color: #24292f;background-color: #f6f8fa">}</span>
        common_deparser<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">(</span>packet<span style="color: #24292f;background-color: #f6f8fa">,</span> hdr<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec-atomicity-of-control-plane-api-operations">9. Atomicity of control plane API operations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All table add, delete, and modify operations must be atomic relative
to packet forwarding.  That is, for every table <code>apply</code> operation, and
every control plane operation on a table that adds, deletes, or
modifies one table entry, the <code>apply</code> operation should behave as if
that control plane operation has not yet occurred, or as if the
control plane operation is complete.  The P4 program should never
behave as if the control plane operation is partially complete.</p>
</div>
<div class="paragraph">
<p>Note that this requirement is for every table <code>apply</code> operation
individually.  A PSA implementation is not required to support
performing multiply <code>apply</code> operations on the same table in the same
invocation of a control block.  If it does support that, it is allowed
that a control plane update <em>may</em> occur after one <code>apply</code> call by a
packet to a table, but before the next <code>apply</code> call by the same
packet.</p>
</div>
<div class="paragraph">
<p>A PSA implementation should give an error and fail to compile P4
programs for which it cannot meet this atomicity requirement.  For
example, perhaps the implementation can only satisfy this requirement
for tables with actions having at most 128 bits of action parameters,
and thus gives an error if you attempt to compile a P4 program that
contains an action with more bits of parameters.</p>
</div>
<div class="paragraph">
<p>For example, suppose a table <code>T</code> has an action <code>A</code> with 100 total bits
of action parameters, and the control plane has added a table entry
with a search key <code>K</code> and action <code>A</code>.  Later the control plane
performs an update operation on the entry with key <code>K</code> that leaves the
key <code>K</code> the same, but changes the 100 bits of action parameters.
Every packet doing an <code>apply</code> on table <code>T</code> and matching the entry with
key <code>K</code> should execute action <code>A</code> with either the old 100 bits of
action parameters, or the new 100 bits of action parameters.</p>
</div>
<div class="paragraph">
<p>The P4Runtime API enables controllers to create "batch" messages that perform
more than one single operation, as defined here.  If so, a PSA
implementation need only ensure that each single operation is atomic.
There is no requirement that a sequence of <em>multiple</em> table entry add,
delete, or update operations should be atomic.</p>
</div>
<div class="paragraph">
<p>The same applies for all control plane API operations on externs,
unless the control plane operation explicitly documents otherwise.</p>
</div>
<div class="paragraph">
<p>In particular, ActionProfile and ActionSelector single operations,
such as adding a member to a group, removing a member from a group,
adding an empty group, deleting an empty group, or modifying the
action parameters of an action added earlier to a group, should all be
atomic.</p>
</div>
<div class="paragraph">
<p>Also, a control plane read, or write, of a single element of a
Register array should be atomic, and behave as if it occurred before
or after (but not during) any P4 program&#8217;s section of code labeled
with the <code>@atomic</code> annotation.  There is <em>no</em> control plane operation
on a Register that can atomically read an element, then write back a
modified value.</p>
</div>
<div class="paragraph">
<p>Advice for P4 developers: If you desire a capability for the control
plane to atomically read, modify, then write back a Register array
element, you should write your P4 program such that the desired read,
modify, and write operation can be done by a packet that your control
plane can inject into the data plane, e.g. via packet in / packet out
P4Runtime API operations.</p>
</div>
<div class="paragraph">
<p>A high speed PSA implementation might process hundreds or thousands of
packets between each single control plane operation.  There are common
"write tables from later to earlier in the data flow", sometimes also
called "back to front" or "pointer flipping", techniques used by
existing control planes to achieve an effect that is similar to making
a sequence of many table entry operations atomic relative to packet
forwarding.  Recent research analyzes these techniques in a more
general setting<sup class="footnote" id="_footnote_cernyeta">[<a id="_footnoteref_10" class="footnote" href="#_footnotedef_10" title="View footnote.">10</a>]</sup>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-open-issues">Appendix A: Open Issues</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As with any work in progress, we have a number of open issues that are under discussion in the
working group. In addition to the TBDs in the document, there a number of larger issues that are
summarized here:</p>
</div>
<div class="sect2">
<h3 id="_action_selectors">A.1. Action Selectors</h3>
<div class="paragraph">
<p>The size parameter in the action_selector instance that defines the maximum number of members in a
selector. In some cases it might be useful to allow the controller to dynamically provision
resources on the selector or to utilize different selector sizes on different targets, while using
a common P4 program.</p>
</div>
<div class="paragraph">
<p>We also need to formalize the interaction of action profiles and action selectors with counters and
meters.</p>
</div>
</div>
<div class="sect2">
<h3 id="_observation_and_control_of_congestion">A.2. Observation and control of congestion</h3>
<div class="paragraph">
<p>The current PSA does not provide any mechanisms to observe if
particular output ports or queues are leading to congestion in the
packet buffer.  Thus it is not possible without using mechanisms
defined outside of PSA to implement a feature like Explicit Congestion
Notification (ECN)<sup class="footnote" id="_footnote_ecn">[<a id="_footnoteref_11" class="footnote" href="#_footnotedef_11" title="View footnote.">11</a>]</sup>.  One possibility here is to define a small
field, perhaps only 1 bit, that is part of the metadata associated
with each packet as it begins egress processing.  This field would
indicate "how much congestion" the packet experienced in the packet
buffer.</p>
</div>
<div class="paragraph">
<p>There is also currently no way defined in PSA for ingress P4 code to
send information about a packet to the packet buffer that might
influence the behavior of a congestion control algorithm, such as
Approximate Fair Drop (AFD).  This is partly because of the variety of
congestion control mechanisms in use by switches today.</p>
</div>
<div class="paragraph">
<p>It would be desirable to define in PSA a small set of fields about a
packet that would be useful inputs to multiple congestion control
algorithms.  One possibility is a hash of the packet&#8217;s "flow id",
often implemented as a hash of packet header fields like IP source and
destination address, IP protocol, and optionally TCP/UDP source and
destination ports.  Given that P4 programmable devices can implement
network protocols other than IP, including custom ones, a more general
mechanism is desirable in PSA devices.</p>
</div>
</div>
<div class="sect2">
<h3 id="_enabling_full_implementation_of_in_band_network_telemetry">A.3. Enabling full implementation of In-band Network Telemetry</h3>
<div class="paragraph">
<p>One promising use case for P4 programmable network devices is to
implement In-band Network Telemetry<sup class="footnoteref">[<a class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup>.  While PSA mechanisms such
as timestamps enable a significant portion of INT features to be
implemented, they do not yet define any mechanisms to access
information such as egress port link utilization or queue
occupancyfootnoote:psaint[<a href="https://github.com/p4lang/p4-spec/issues/510" class="bare">https://github.com/p4lang/p4-spec/issues/510</a>].</p>
</div>
</div>
<div class="sect2">
<h3 id="_psa_profiles">A.4. PSA profiles</h3>
<div class="paragraph">
<p>We are considering whether to specify different limits that a certain PSA implementation has to have in order for the implementation to be considered compliant. The main point of PSA is to enable a variety of devices, and thus limits may be artificial. On the other hand, for most interesting applications, it is necessary to support a minimum of functionality.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-internetchecksum-implementation">Appendix B: Implementation of the InternetChecksum extern</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Besides RFC 1461, RFC 1071 and RFC 1141 also contain useful tips on
efficiently computing the Internet checksum, especially in software
implementations.</p>
</div>
<div class="paragraph">
<p>Here we give reference implementations for the methods of the
<code>InternetChecksum</code> extern, specified with the syntax and semantics of
P4<sub>16</sub>, with extensions of a <code>for</code> loop and a <code>return</code> statement for
returning a value from a function.</p>
</div>
<div class="paragraph">
<p>The minimum internal state necessary for one instance of an
<code>InternetChecksum</code> object is a 16-bit bit vector, here called <code>sum</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4"><span style="color: #6e7781">// This is one way to perform a normal one's complement sum of two
// 16-bit values.
</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> ones_complement_sum<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> x<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">in</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> y<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">17</span><span style="color: #0550ae">&gt;</span> ret <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">17</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)</span> x <span style="color: #0550ae">+</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">17</span><span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">)</span> y<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>ret<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">16</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #0550ae">16</span><span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #0550ae">==</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        ret <span style="color: #0550ae">=</span> ret <span style="color: #0550ae">+</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #cf222e">return</span> ret<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">15</span><span style="color: #24292f;background-color: #f6f8fa">:</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">];</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> sum<span style="color: #24292f;background-color: #f6f8fa">;</span>

<span style="color: #953800">void</span> clear<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    sum <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// Restriction: data is a multiple of 16 bits long
</span><span style="color: #953800">void</span> add<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> d<span style="color: #24292f;background-color: #f6f8fa">;</span>
    for <span style="color: #24292f;background-color: #f6f8fa">(</span>each <span style="color: #0550ae">16</span><span style="color: #0550ae">-</span><span style="color: #953800">bit</span> aligned piece d of data<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        sum <span style="color: #0550ae">=</span> ones_complement_sum<span style="color: #24292f;background-color: #f6f8fa">(</span>sum<span style="color: #24292f;background-color: #f6f8fa">,</span> d<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// Restriction: data is a multiple of 16 bits long
</span><span style="color: #953800">void</span> subtract<span style="color: #0550ae">&lt;</span>T<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> T data<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> d<span style="color: #24292f;background-color: #f6f8fa">;</span>
    for <span style="color: #24292f;background-color: #f6f8fa">(</span>each <span style="color: #0550ae">16</span><span style="color: #0550ae">-</span><span style="color: #953800">bit</span> aligned piece d of data<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #6e7781">// ~d is the negative of d in one's complement arithmetic.
</span>        sum <span style="color: #0550ae">=</span> ones_complement_sum<span style="color: #24292f;background-color: #f6f8fa">(</span>sum<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #0550ae">~</span>d<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #6e7781">// The Internet checksum is the one's complement _of_ the one's
// complement sum of the relevant parts of the packet.  The methods
// above calculate the one's complement sum of the parts in the
// variable 'sum'.  get() returns the bitwise negation of 'sum', which
// is the one's complement of 'sum'.
</span>
<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> get<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">return</span> <span style="color: #0550ae">~</span>sum<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> get_state<span style="color: #24292f;background-color: #f6f8fa">()</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">return</span> sum<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #953800">void</span> set_state<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">16</span><span style="color: #0550ae">&gt;</span> checksum_state<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    sum <span style="color: #0550ae">=</span> checksum_state<span style="color: #24292f;background-color: #f6f8fa">;</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-counter-implementation">Appendix C: Example implementation of Counter extern</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The example implementation below, in particular the function
<code>next_counter_value</code>, is not intended to restrict PSA implementations.
The storage format for <code>PACKETS_AND_BYTES</code> type counters demonstrated
there is one example of how it could be done.  Implementations are
free to store state in other ways, as long as the control plane API
returns the correct packet and byte count values.</p>
</div>
<div class="paragraph">
<p>Two common techniques for counter implementations in the data plane are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>wrap around counters</p>
</li>
<li>
<p>saturating counters, that 'stick' at their maximum possible value,
without wrapping around.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This specification does not mandate any particular approach in the
data plane.  Implementations should strive to avoid losing information
in counters.  One common implementation technique is to implement an
atomic "read and clear" operation in the data plane that can be
invoked by the control plane software.  The control plane software
invokes this operation frequently enough to prevent counters from ever
wrapping or saturating, and adds the values read to larger counters in
driver memory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">Counter<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">32</span><span style="color: #0550ae">&gt;</span> n_counters<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">PSA_CounterType_t</span> <span style="color: #cf222e">type</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>num_counters <span style="color: #0550ae">=</span> n_counters<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>counter_vals <span style="color: #0550ae">=</span> new array of <span style="color: #cf222e">size</span> n_counters<span style="color: #24292f;background-color: #f6f8fa">,</span> each element with <span style="color: #cf222e">type</span> W<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span><span style="color: #cf222e">type</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">type</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">this</span><span style="color: #0550ae">.</span><span style="color: #cf222e">type</span> <span style="color: #0550ae">==</span> <span style="color: #953800">PSA_CounterType_t</span><span style="color: #0550ae">.</span>PACKETS_AND_BYTES<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #6e7781">// Packet and byte counts share storage in the same counter
</span>        <span style="color: #6e7781">// state.  Should we have a separate constructor with an
</span>        <span style="color: #6e7781">// additional argument indicating how many of the bits to use
</span>        <span style="color: #6e7781">// for the byte counter?
</span>        W shift_amount <span style="color: #0550ae">=</span> TBD<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>shifted_packet_count <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">((</span>W<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #0550ae">&lt;&lt;</span> shift_amount<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>packet_count_mask <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">~</span><span style="color: #24292f;background-color: #f6f8fa">((</span>W<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">))</span> <span style="color: #0550ae">&lt;&lt;</span> shift_amount<span style="color: #24292f;background-color: #f6f8fa">;</span>
        <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>byte_count_mask <span style="color: #0550ae">=</span> <span style="color: #0550ae">~</span><span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>packet_count_mask<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

W next_counter_value<span style="color: #24292f;background-color: #f6f8fa">(</span>W cur_value<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">PSA_CounterType_t</span> <span style="color: #cf222e">type</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">type</span> <span style="color: #0550ae">==</span> <span style="color: #953800">PSA_CounterType_t</span><span style="color: #0550ae">.</span>PACKETS<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>cur_value <span style="color: #0550ae">+</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #6e7781">// Exactly which packet bytes are included in packet_len is
</span>    <span style="color: #6e7781">// implementation-specific.
</span>    <span style="color: #953800">PacketLength_t</span> packet_len <span style="color: #0550ae">=</span> <span style="color: #0550ae">&lt;</span>packet length <span style="color: #cf222e">in</span> bytes<span style="color: #0550ae">&gt;</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">type</span> <span style="color: #0550ae">==</span> <span style="color: #953800">PSA_CounterType_t</span><span style="color: #0550ae">.</span>BYTES<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>cur_value <span style="color: #0550ae">+</span> packet_len<span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #6e7781">// type must be PSA_CounterType_t.PACKETS_AND_BYTES
</span>    <span style="color: #6e7781">// In type W, the least significant bits contain the byte
</span>    <span style="color: #6e7781">// count, and most significant bits contain the packet count.
</span>    <span style="color: #6e7781">// This is merely one example storage format.  Implementations
</span>    <span style="color: #6e7781">// are free to store packets_and_byte state in other ways, as
</span>    <span style="color: #6e7781">// long as the control plane API returns the correct separate
</span>    <span style="color: #6e7781">// packet and byte count values.
</span>    W next_packet_count <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">((</span>cur_value <span style="color: #0550ae">+</span> <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>shifted_packet_count<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #0550ae">&amp;</span>
                           <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>packet_count_mask<span style="color: #24292f;background-color: #f6f8fa">);</span>
    W next_byte_count <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>cur_value <span style="color: #0550ae">+</span> packet_len<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #0550ae">&amp;</span> <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>byte_count_mask<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">return</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>next_packet_count <span style="color: #0550ae">|</span> next_byte_count<span style="color: #24292f;background-color: #f6f8fa">);</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span>

<span style="color: #953800">void</span> count<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">in</span> S index<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
    <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>index <span style="color: #0550ae">&lt;</span> <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>num_counters<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>counter_vals<span style="color: #24292f;background-color: #f6f8fa">[</span>index<span style="color: #24292f;background-color: #f6f8fa">]</span> <span style="color: #0550ae">=</span> next_counter_value<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">this</span><span style="color: #0550ae">.</span>counter_vals<span style="color: #24292f;background-color: #f6f8fa">[</span>index<span style="color: #24292f;background-color: #f6f8fa">],</span>
                                                      <span style="color: #cf222e">this</span><span style="color: #0550ae">.</span><span style="color: #cf222e">type</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #6e7781">// No counter_vals updated if index is out of range.
</span>        <span style="color: #6e7781">// See below for optional debug information to record.
</span>    <span style="color: #24292f;background-color: #f6f8fa">}</span>
<span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Optional debugging information that may be kept if an <code>index</code> value is
out of range includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Number of times this occurs.</p>
</li>
<li>
<p>A FIFO of the first N out-of-range index values that occur, where N
is implementation-defined (e.g. it might only be 1).  Extra
information to identify which <code>count()</code> method call in the P4
program had the out-of-range <code>index</code> value is also recommended.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-rationale">Appendix D: Rationale for design</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="appendix-rationale-egress">D.1. Why egress processing?</h3>
<div class="paragraph">
<p>Question: Why is it useful to have separate ingress vs. egress
processing in a switch device?</p>
</div>
<div class="paragraph">
<p>There have been packet processing ASICs built that effectively only do
'ingress' processing, then go to a packet buffer with one or more
queues, and then go out of the device, effectively being restricted to
no or "empty" egress processing.</p>
</div>
<div class="paragraph">
<p>There are a few things that are trickier to do in such a device.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Last-nanosecond changes to the packet</p>
<div class="paragraph">
<p>If you want to measure the queuing latency through the device, and put
a measurement of this quantity inside the packet somewhere, it is in
general not possible to know the queueing latency before the packet is
sent to the packet buffer.  There are <em>special cases</em> where you can
predict it, e.g. when there is a single FIFO queue feeding a constant
bit rate output port, with nothing like Ethernet pause flow control.</p>
</div>
<div class="paragraph">
<p>But if you have variable bit rate links, e.g. because of things like
Ethernet pause flow control, or Wi-Fi signal quality changes, or if
you have multiple class-of-service queues with a scheduling policy
between them like weighted fair queueing, then it is not possible to
predict at the time the packet is enqueued, when it will be dequeued.
The queueing latency depends upon unknown future events, such as
whether Ethernet pause frames will arrive, or how many and what size
of packets arriving in the near future will be put into which class of
service queues for the same output port.</p>
</div>
<div class="paragraph">
<p>In such cases, having egress processing for taking the measurement,
after it is known and easy to calculate as "dequeue time - enqueue
time", allows the egress processing to modify the packet further.</p>
</div>
</li>
<li>
<p>Multicast efficiency and flexibility</p>
<div class="paragraph">
<p>It is possible in a PSA device to handle multicast by doing a
recirculate plus clone operation for each of N copies to be made, but
this reduces the processing capacity of ingress that is available to
newly arriving packets, in particular newly arriving packets that you
might consider more important to keep than the multicast packets.</p>
</div>
<div class="paragraph">
<p>By designing a packet buffer that can take a packet with a 'multicast
group id', which the control plane configures to make copies to a
selected set of output ports, it frees up the part of the system that
performs ingress processing to accept new packets more quickly, and at
a more predictable rate.</p>
</div>
<div class="paragraph">
<p>There could still be a challenge in designing the packet replication
portion of the system not to fall behind when many multicast packets
to be replicated to many output ports arrive close together in time,
but it is fairly easy to separate the concerns of multicast from
unicast packets.  For example, a device implementer could prioritize
unicast packets so that they are not slowed down if multicast
replication is falling behind.</p>
</div>
<div class="paragraph">
<p>Once you have multicast designed in this way, there are still
multicast use cases where one needs to process different copies of the
packet differently.  For example, the copy going out port 5 might need
a VLAN tag of 7 placed in its header, whereas the copy going out port
2 might need a VLAN tag of 18 placed in its header.  Similarly for
multicast packets entering one of many flavors of tunnels, e.g. VXLAN,
GRE, etc.  By doing this per-copy modifications in egress processing,
the packet replication logic can be kept very simple&#8201;&#8212;&#8201;just make
identical copies of the packet as ingress finished with it, except for
some kind of unique 'id' on each copy that egress processing can use
to distinguish them.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="appendix-rationale-egress-cannot-change-output-port">D.2. No output port change during egress</h3>
<div class="paragraph">
<p>Question: Why can&#8217;t my P4 program change the output port during egress
processing?</p>
</div>
<div class="paragraph">
<p>In a network device that has many input and output ports, packets can
arrive at or near the same time on multiple input ports, all destined
for the same output port.</p>
</div>
<div class="paragraph">
<p>Packet buffers are typically designed into such network devices, to
store the packets that cannot be sent out immediately, absorbing this
short term congestion.</p>
</div>
<div class="paragraph">
<p>For a given output port P, we now wish to retrieve packets from the
packet buffer at a rate that is equal to the rate we will send them to
port P, typically equal to the maximum bit rate that it is possible to
send data out of port P.</p>
</div>
<div class="paragraph">
<p>Packet scheduling algorithms such as weighted fair queueing, and many
others, have been developed that can determine which among a set of
potentially many FIFO queues that a packet should be read from next,
and sent out on the port.</p>
</div>
<div class="paragraph">
<p>These link scheduling algorithms are real time algorithms with very
tight timing constraints.  If they go too slow, the output port goes
idle and its capacity is wasted.  If they go too fast, we read packets
from the packet buffer faster than they can be transmitted on the
port, and we are back at the same problem we had originally&#8201;&#8212;&#8201;either
drop some of the packets, or store them somewhere again until the port
is ready to transmit them.</p>
</div>
<div class="paragraph">
<p>Such a scheduling algorithm that handles multiple output ports must
know which output port all packets are destined to, before they are
put into the packet buffer.  If that target output port can be changed
after the packet is read out, then we can simultaneously overload one
output port while starving another.</p>
</div>
<div class="paragraph">
<p>That is why the <code>egress_port</code> of a packet must be selected during
ingress processing, and egress processing is not allowed to change it.</p>
</div>
<div class="paragraph">
<p>These scheduling algorithms also need to know the size of each packet,
i.e. the size as it will be when transmitted on the port.</p>
</div>
<div class="paragraph">
<p>It is possible in egress P4 code to drop a packet, or to change the
size of the packet by adding or removing headers.  Very likely
P4-programmable network devices will have their scheduling algorithms
run just slightly faster than the port to handle cases where many
packets in a row are decreased in size during egress processing, and
have tight control loops monitoring the size of packets leaving egress
processing to make small adjustments in the rate that the scheduling
algorithm operates for each port.  Either that, or they will just
leave some fraction of the output port&#8217;s capacity unused during times
when all packet sizes are being decreased.</p>
</div>
<div class="paragraph">
<p>Certainly if there are long durations of time when egress decides to
drop all packets to an output port, that port will go idle.  The
scheduling algorithm implementations are all built with a finite
maximum packet scheduling rate.</p>
</div>
</div>
<div class="sect2">
<h3 id="appendix-rationale-ingress-deparser-egress-parser">D.3. Ingress deparser and egress parser</h3>
<div class="paragraph">
<p>Question: P4<sub>14</sub> did not have an ingress deparser, or an egress
parser.  Why does PSA have these things?</p>
</div>
<div class="paragraph">
<p>P4<sub>14</sub> did not have these things explicitly, but there was also not
much <em>explicitly</em> stated in the P4<sub>14</sub> specification about what data
about each packet was carried from ingress to egress.  Often such
things were left implicit.  Some implementations have an ingress
deparser whose order of emitting headers is auto-generated from the
P4<sub>14</sub> program&#8217;s parser code.  This leads to restrictions on your
P4<sub>14</sub> program, not stated in the P4<sub>14</sub> specification, that the
contents of your headers and metadata must be in a state where if you
deparse at that point, then your P4<sub>14</sub> parser code must be able to
parse that packet, or else the device will fail to parse it in the
(implicit) egress parser.</p>
</div>
<div class="paragraph">
<p>By making the ingress deparser and egress parser explicit, we hope to
make this behavior more defined, and more portable across different
PSA implementations.  We expect that the common case will be that the
ingress and egress parsers will have much (or all) code in common with
each other, and this is easy to do using P4<sub>16</sub>'s capability for one
parser to call another, i.e. you can write a common parser, then call
it from your ingress and egress parsers.</p>
</div>
<div class="paragraph">
<p>You can also choose to make the two parsers different, and have full
control over the differences between them.  For example, you might
wish your egress parser to handle extra headers that you only put onto
cloned packets, that should never appear on packets from input ports.</p>
</div>
<div class="paragraph">
<p>Similarly for the ingress deparser.  By making this an explicit and
separate control block, you now have full control over exactly what
data about a packet is included when it is sent to the packet buffer,
and what is not.  In P4<sub>14</sub>, it was implicit that "all packet metadata
used somewhere in egress code" was carried along with each packet.
This can still be done in P4<sub>16</sub> programs for the PSA, but now you
must be explicit in doing so.  With PSA, you now have a way to
restrict how much data is carried with each packet, which can be
important if the I/O bandwidth of the packet buffer becomes a
bottleneck.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-multi-pipeline-psa-devices">Appendix E: Multi-pipeline PSA devices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The highest packet rate network devices today are ASICs running at a
clock rate on the order of 1 to 2 GHz.  This discussion will assume 1
GHz for the sake of a concrete numerical example, but everything
discussed here scales linearly with the clock rate.</p>
</div>
<div class="paragraph">
<p>It is common to design a portion of a network ASIC such that it can
start processing a new packet once every clock cycle, and finish a
packet every clock cycle.  The latency might be hundreds of clock
cycles from starting a packet until it is complete.  P4 tables in such
ASICs are typically implemented using logic such as TCAMs and SRAMs.
TCAM designs can do 1 search per clock cycle.  The lowest area and
power SRAMs can do 1 read or 1 write per clock cycle.</p>
</div>
<div class="paragraph">
<p>While there are "multi ported" SRAM designs that can be read and/or
written multiple times per clock cycle, these have a noticeable
increase in area and power over the "single ported" designs that are
limited to 1 access per cycle.  If multi ported TCAM designs even
exist, the cost premium for multi-ported TCAMs is likely to be even
higher than the cost premium for multi-ported SRAMs.  The typical way
to achieve higher TCAM search rates is via parallelism, by creating
multiple copies of the desired TCAM, which is a linear increase in
area and power (at least).</p>
</div>
<div class="paragraph">
<p>Due to these issues, if one wishes to create a switch ASIC that
achieves a packet processing rate of N times the clock rate, e.g. 2
billion packets per second in a 1 GHz ASIC, the most straightforward
way to do this is to take advantage of the fact that packet processing
is (mostly) an embarrassingly parallel
problem<sup class="footnote" id="_footnote_embarrassing">[<a id="_footnoteref_12" class="footnote" href="#_footnotedef_12" title="View footnote.">12</a>]</sup>, and create a device with N
pipelines<sup class="footnote">[<a id="_footnoteref_13" class="footnote" href="#_footnotedef_13" title="View footnote.">13</a>]</sup>, each pipeline processing packets at 1
billion packets per second.</p>
</div>
<div class="paragraph">
<p>A PSA device designed in this way would typically have N ingress
pipelines, plus N egress pipelines.  It is common to
assign multiple physical ports of the switch ASIC to each pipeline in
a hard-wired fashion, e.g. a device with 32 100 Gigabit Ethernet ports
might physically hard-wire ports 0 through 15 to pipeline 0, and ports
16 through 31 to pipeline 1.  All packets received on ports 0 through
15 will be processed by ingress pipeline 0, then go to the packet
buffer (if they were not dropped in ingress), then go to egress
pipeline 0 if ingress chose output port 0 through 15, or go to egress
pipeline 1 if ingress chose output port 16 through 31.</p>
</div>
<div class="paragraph">
<p>In such a device, typically you will want the same P4 program to be
run on every one of these N ingress pipelines, and every one of the N
egress pipelines.</p>
</div>
<div class="paragraph">
<p>It is physically possible in such a device for the control plane to
install different table entries in the different pipelines, and there
are use cases where this can help achieve higher scale in number of
usable table entries.  For example, perhaps you have an ingress table
with the ingress port as one of the fields in its search key.  If this
is the case, the packet processing behavior is the same even if table
entries for port X are installed only in the ingress pipeline that
processes packets from port X.  Installing that table entry in the
other pipelines would be an unnecessary use of table space, since it
could never be matched.  Whether the device-dependent control software
of such a PSA device enables taking advantage of such space savings is
implementation dependent.</p>
</div>
<div class="paragraph">
<p>Regardless of this issue, applying tables in P4 is an embarrassingly
parallel activity, because as long as table entries are installed
where they might be matched, pipelines can operate completely
independently of each other with no communication between them (one
small exception is described below).  The same is true for most PSA
externs, e.g. <code>ActionProfile</code>, <code>ActionSelector</code>, <code>Checksum</code>, <code>Digest</code>,
<code>Hash</code>, and <code>Random</code>.  What P4 tables and these externs have in common
is: either the P4 program behavior cannot modify their state at all
(e.g. tables, <code>ActionProfile</code>, <code>ActionSelector</code>), or can only modify
it in a way that does not affect the processing of other packets
(e.g. <code>Checksum</code>, <code>Digest</code>, <code>Hash</code>).  <code>Random</code> is a special case here:
updating the state of a pseudo-random number generator can affect the
processing of other packets, but this is typically not a concern for
the way that pseudo-random numbers are used (e.g. randomly choosing
packets to drop or mark in Random Early Detection).</p>
</div>
<div class="paragraph">
<p>For counters, there is counter state maintained independently in each
pipeline, but if corresponding counter entries in each pipeline count
"the same thing" (e.g. packets matching a table entry with key X
installed in all pipelines), then it is straightforward to add up the
corresponding counter values from all pipelines.</p>
</div>
<div class="paragraph">
<p>Consider a device where meter state is maintained independently in
each pipeline.  If you have a multi-pipeline PSA device, and wish to
achieve the effect: "meter all packets matching table entry X to at
most Y bytes per second", this is <em>not</em> an embarrassingly parallel
problem.  It could be done by coordinating state between the
pipelines, e.g. using something like cache coherency protocols
commonly implemented within multi-core CPUs, or by "moving the packets
to where the shared state is", e.g. recirculating packets to a common
pipeline where the meter state is kept.  Both of these techniques lead
to lower packet processing performance, at least in some cases, and
both add complexity to the system.  It is typical in network switches
to simply maintain the meter state independently in each pipeline and
not coordinate it, and accept the resulting behavior.</p>
</div>
<div class="paragraph">
<p>This issue is not specific to packet switches.  It falls under the
category of accessing mutable state in a distributed system, with not
only correctness concerns, but very strong performance concerns.</p>
</div>
<div class="paragraph">
<p>The <code>Register</code> extern is more general in its capability than meters,
and the same potential issue of state being split across multiple
pipelines exists.  It is recommended that you talk to your PSA device
vendor about this issue if it could affect features you wish to write
in your P4 program.  If a PSA device does not implement automatic
coherency for such state, common strategies are the same as mentioned
above for meters: accept the resulting behavior of the independently
maintained state in each pipeline, or move the relevant packets to one
place where the state is maintained.</p>
</div>
<div class="paragraph">
<p>Note that the proposed <code>psa_idle_timeout</code> table property introduces a
way by which doing table <code>apply</code> operations <em>does</em> update state within
a P4 table.  Each table entry requires at least one, and more likely several, bits of state to represent a "last matched time" value, and this value is updated with every <code>apply</code> operation.  If this state in
tables with this option is not automatically coordinated between
pipelines, then it can differ for corresponding
table entries in different pipelines.  An entry with key X in one
pipeline could remain unmatched for longer than the desired timeout,
at the same time that the corresponding entries with key X are
recently matched in other pipelines.  One possible approach to handle
this is for the PSA device and its implementation-specific control
software to make the existence of multiple pipelines explicit to the
control plane software in some way, e.g. assign each pipeline, and the
tables and externs it contains, a distinct name.</p>
</div>
<div class="paragraph">
<p>For programming multiple pipelines, it is the responsibility of the
vendor and of target dependent tools to specify how PSA programs are
mapped to multiple pipelines.  An implementation may use a copy of the
PSA program on each pipeline, thus keeping pipelines fully isolated.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-packet-ordering">Appendix F: Packet ordering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes <em>recommendations</em> for PSA implementations on
the order that packets are processed.  These are not requirements,
since there are known implementation techniques, especially
parallelism that can be taken advantage of in a variety of ways, that
can lead to cheaper implementations if these recommendations are not
followed.  We recommend that developers selecting P4 devices ask their
designers about these issues, if those developers consider the issues
important for their purposes.</p>
</div>
<div class="paragraph">
<p>Recommendation 1: Packets that arrive on the same input port should
begin ingress processing in the same relative order as they arrived.</p>
</div>
<div class="paragraph">
<p>Recommendation 2: Packets that go out on the same output port should
be transmitted on the port in the same relative order that they began
egress processing.</p>
</div>
<div class="paragraph">
<p>Recommendation 3: PRE unicast packets (i.e. those that follow the
"enqueue one packet" path in the pseudocode of <a href="#sec-after-ingress">Section 7.3</a>)
that arrived from the same ingress port, did ingress processing once
(i.e. were not resubmitted or recirculated), were sent to the PRE with
the same <code>class_of_service</code> value, and destined for the same egress
port, should begin egress processing in the same relative order as they
began ingress processing.</p>
</div>
<div class="paragraph">
<p>It is expected that some PSA implementations will implement the class
of service mechanism by having a separate FIFO queue per class of
service, and thus while unicast packets with the same ingress port,
egress port, and class of service will pass through the system in FIFO
order if they follow all recommendations above, unicast packets with
the same ingress and egress port, but different classes of service,
may be processed by the egress control block in a different order than
they were processed by the ingress control block.</p>
</div>
<div class="paragraph">
<p>If an implementation satisfies recommendations 1 through 3, then
unicast traffic assigned to the same class of service will maintain
its relative order through the device.</p>
</div>
<div class="paragraph">
<p>Recommendation 4: Consider PRE multicast packets (i.e. those that
follow the "Make 0 or more copies" path in the pseudocode of
<a href="#sec-after-ingress">Section 7.3</a>) that arrived on the same ingress port, did
ingress processing once, and were sent to the PRE with the same pair
of values (<code>class_of_service</code>, <code>multicast_group</code>).  For copies of
those original packets that are destined to the same egress port, and
with the same pair of values for (<code>egress_port</code>, <code>instance</code>), those
copies should begin egress processing in the same relative order as
the original packets began ingress processing.</p>
</div>
<div class="paragraph">
<p>There is no such expectation for multicast packets with different
<code>class_of_service</code> values, again because of separate queues in the PRE
for different <code>class_of_service</code> values.</p>
</div>
<div class="paragraph">
<p>It is also understood that for a short period of time after the
control plane modifies the set of copies to be made for a particular
<code>multicast_group</code> value, that it may be especially difficult to
satisfy Recommendation 4.  That recommendation is intended to apply
only when the set of copies to be made for the multicast group has
remained unchanged for a period of time.</p>
</div>
<div class="paragraph">
<p>If an implementation satisfies recommendations 1, 2, and 4, then
multicast traffic assigned to the same class of service will maintain
its relative order through the device, when multicast group membership
has been stable for long enough.</p>
</div>
<div class="paragraph">
<p>Note that there is no recommendation to enforce any relative ingress
to egress processing order of unicast packets vs. multicast packets.
Commonly used mechanisms for creating multicast copies in the PRE
allow unicast packets to "go around" the packet replication logic,
which is unnecessary for unicast packets, and thus change the relative
order of such packets there.  Also, it is common in packet buffers to
use separate queues for multicast traffic versus unicast.</p>
</div>
<div class="paragraph">
<p>We give some motivations for these recommendations below.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expectations of hosts</p>
<div class="paragraph">
<p>While the Internet Protocol does not have strong ordering requirements
for sequences of packets sent by one host to another, there are still
widely deployed implementations of TCP that lead to significantly
degraded throughput when the network frequently delivers packets to
the receiver in a different order than they were transmitted.  While
significant research and development has been done to mitigate this
issue, e.g. later Linux TCP implementations (since 2011 when version
2.6.35 was released) are much more resilient to this problem than
earlier versions, there are still many commonly deployed TCP
implementations that suffer from this issue.  See references within
Kandula et al&#8217;s work<sup class="footnote">[<a id="_footnoteref_14" class="footnote" href="#_footnotedef_14" title="View footnote.">14</a>]</sup> for some of the research done
towards making TCP more robust in the face of network packet
reordering.</p>
</div>
<div class="paragraph">
<p>Such TCP implementations interpret acknowledgements with repeated
cumulative acknowledgement sequence numbers as a likely indication of
packet loss in the network, and reduce their sending window in an
effort to avoid network congestion.</p>
</div>
<div class="paragraph">
<p>While applications using UDP should also be aware of possible packet
reordering in a network, some of them behave poorly if this reordering
becomes common<sup class="footnote">[<a id="_footnoteref_15" class="footnote" href="#_footnotedef_15" title="View footnote.">15</a>]</sup>.</p>
</div>
<div class="paragraph">
<p>These expectations of hosts are a significant reason why ECMP (Equal
Cost Multi Path) path selection and LAG (Link Aggregation Group) link
selection are so often done by using a hash of packet header fields
such as IP source and destination address, and TCP or UDP source and
destination port.  Choosing among parallel paths in this way helps to
preserve the order of packets in the same application flow, at the
cost of not balancing the load as evenly as possible.  If a network
device&#8217;s internal implementation reordered packets, it would be an
independent source of network reordering.</p>
</div>
</li>
<li>
<p>Implementation of stateful protocols</p>
<div class="paragraph">
<p>This reason is much less significant than the previous one.  We
mention it here primarily so implementers of networking protocols are
aware of the issue.  This issue is only relevant for a relatively
small fraction of network protocols.</p>
</div>
<div class="paragraph">
<p>Some networking protocols add sequence numbers to packets, and require
either dropping packets that arrive out of sequence number order at a
later network point (e.g. GRE with sequence numbers enabled), or with
a looser check that allows some amount of network reordering to occur
without dropping the packets (e.g. IPsec).  When a device implementing
these protocols does the sequence number insertion or checking in a
different order than packets are sent or received on a physical port,
that is effectively another kind of network reordering that can affect
the performance of these protocols.</p>
</div>
<div class="paragraph">
<p>Similarly, there are some protocols like IP header compression, where
multiple variants have been developed, some with more or less
robustness in the face of network reordering.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-empty-action-selector-groups">Appendix G: Supporting empty action selector groups</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As mentioned in <a href="#sec-action-selector">Section 8.12</a>, a PSA data plane implementation
need not implement any specific defined behavior if one attempts to add
a table entry for a key that points at a group that is currently empty.</p>
</div>
<div class="paragraph">
<p>Some P4 users have expressed an interest in enabling a P4Runtime
client (hereafter called the controller) to remove the last member of
an action selector group, and have the data plane behave in a
predictable way.</p>
</div>
<div class="paragraph">
<p>For example, if one has a table that maps logical interface id numbers
to physical port numbers, using an action selector to implement LAG
(Link Aggregation Group), what should the controller do when there was
only one physical port in a LAG that was enabled, and that port goes
down?  A straightforward desired behavior from the controller&#8217;s
perspective is: issue the P4Runtime command to remove the last member
from the group, and have an empty group action of "drop the packet"
take effect for any packets applying the table and selecting the empty
group.</p>
</div>
<div class="paragraph">
<p>Fully supporting empty action groups should meet all of these
requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All P4Runtime API operations such as adding a member to a group
(even when changing from empty to 1 member), removing a member from
a group (even when changing from 1 member to empty), modifying the
action associated with a member, etc. should be atomic relative to
data packet processing.  That is, every packet should be processed
as if the table was in the old state, or the new state, with no
undefined packet processing behavior.</p>
</li>
<li>
<p>The empty group action that is executed when the matching table
entry points at an empty group, may have an action name that is the
same as, or different than, the action name used by the group when
it was non-empty (if it was non-empty, and then became empty by
removing its last member).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A high performance implementation will also be able to make changes to
group membership using a number of data plane update operations that
does not grow with the number of table entries that point at the
group.</p>
</div>
<div class="paragraph">
<p>Achieving all of these requirements seems not to be possible with a
PSA data plane implementation that meets only the minimum requirements
for action selectors, i.e. one that restricts members of a group to
all have the same action name, and that does not natively support
predictable behavior if a group is empty in the data plane.</p>
</div>
<div class="paragraph">
<p>Below we describe one way that achieves the goals above, but only for
a data plane implementation that supports multiple different action
names in the same group at the same time.  For a data plane that does
not support this, the idea only <em>nearly</em> achieves the goal.  It
requires the empty group action to have the same action name as the
non-empty groups of the action selector.  This may be too onerous of a
restriction on system developers to be worth implementing.</p>
</div>
<div class="paragraph">
<p>This behavior can be implemented via a small extra bit of logic in the
P4Runtime server implementation (hereafter called the agent).  The
basic idea is that the agent obtains the empty group action, with
action parameter values, e.g. from the compiled representation of the
P4 program.</p>
</div>
<div class="paragraph">
<p>If no table entry currently "points at" an empty group G, then G&#8217;s
empty group action need not be installed anywhere in the data plane.
Similarly if G is currently non-empty, and there are table entries
currently pointing at G.</p>
</div>
<div class="paragraph">
<p>Suppose there is currently one member in G, and G is pointed at by at
least one table entry.  The controller issues a command to remove that
only member from G.</p>
</div>
<div class="paragraph">
<p>The agent can implement this command by the following sequence of
changes in the data plane:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add to G a new member, which is the empty group action.  Now in the
data plane, for a short time, G contains two members.</p>
</li>
<li>
<p>Remove from G the member that the controller requested to be
removed.  Now the data plane version of G has only one member
containing the empty group action, so all packets using G will execute
that action.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When G is currently empty as far as the controller is concerned (but
contains one member pointing at the empty group action in the data
plane), and the controller adds one member to it, the agent can
implement this via these steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add to G the member requested by the controller.  The data plane
temporarily has two members for G, including the empty group action.</p>
</li>
<li>
<p>Remove from G the empty group action.  Now G in the data plane is back
to the one member that the controller wants.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A PSA implementation with an agent that implements empty action
selector groups in this way must implement each of the two steps for
such transitions in an atomic way, as described in
<a href="#sec-atomicity-of-control-plane-api-operations">Chapter 9</a>, but it is allowed
for one or more packets to be processed in the intermediate state that
exists between the two steps.</p>
</div>
<div class="paragraph">
<p>If a PSA implementation supports multiple different action names in
the same group at the same time, then there is no need to read
further.  Below we only describe what might be done for a data plane
that restricts each group to contain only actions with the same action
name.</p>
</div>
<div class="paragraph">
<p>Because a PSA implementation need not support multiple different
action types in the same action selector group at the same time
(mentioned in <a href="#sec-action-selector">Section 8.12</a>), a developer wishing to
take advantage of this in a portable way may need to modify one or
more of the actions used in their tables that use action selectors.</p>
</div>
<div class="paragraph">
<p>For example, if in the LAG port selection example mentioned earlier,
there was only one action for a table <code>lag</code> defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">    <span style="color: #cf222e">action</span> set_output_port <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PortId_t</span> p<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        user_meta<span style="color: #0550ae">.</span>out_port <span style="color: #0550ae">=</span> p<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>
    ActionProfile<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">128</span><span style="color: #24292f;background-color: #f6f8fa">)</span> ap<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #cf222e">table</span> lag <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">key</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #6e7781">// ... key fields go here ...
</span>        <span style="color: #24292f;background-color: #f6f8fa">}</span>
        <span style="color: #cf222e">actions</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{</span> set_output_port<span style="color: #24292f;background-color: #f6f8fa">;</span> <span style="color: #24292f;background-color: #f6f8fa">}</span>
        psa_implementation <span style="color: #0550ae">=</span> ap<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>

    <span style="color: #cf222e">control</span> cIngress <span style="color: #24292f;background-color: #f6f8fa">(</span>
                <span style="color: #cf222e">inout</span> headers hdr<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> metadata user_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">in</span>    <span style="color: #953800">psa_ingress_input_metadata_t</span>  istd_meta<span style="color: #24292f;background-color: #f6f8fa">,</span>
                <span style="color: #cf222e">inout</span> <span style="color: #953800">psa_ingress_output_metadata_t</span> ostd_meta
    <span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #6e7781">// ... earlier ingress code goes here ...
</span>            lag<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
            send_to_port<span style="color: #24292f;background-color: #f6f8fa">(</span>ostd_meta<span style="color: #24292f;background-color: #f6f8fa">,</span> user_meta<span style="color: #0550ae">.</span>out_port<span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #6e7781">// ... later ingress code goes here ...
</span>        <span style="color: #24292f;background-color: #f6f8fa">}</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>with a single action parameter equal to a physical port number of the
device, one of the following approaches could be used, and of course
there are likely to be other approaches not mentioned here.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Approach 1: Use an invalid port number</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pick a value of type <code>PortId_t</code> that corresponds to no valid physical
port of the device (TBD whether PSA should define such a value with a
name&#8201;&#8212;&#8201;it currently doesn&#8217;t guarantee that such a value even exists
for type <code>PortId_t</code>) and use that value for the empty group action of an
empty group.  In the code after <code>lag.apply</code>, add an <code>if</code> statement
checking for that invalid value, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">        <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #6e7781">// ... earlier ingress code goes here ...
</span>            lag<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
            <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>user_meta<span style="color: #0550ae">.</span>out_port <span style="color: #0550ae">==</span> PORT_INVALID_VALUE<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
                ingress_drop<span style="color: #24292f;background-color: #f6f8fa">(</span>ostd_meta<span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
                send_to_port<span style="color: #24292f;background-color: #f6f8fa">(</span>ostd_meta<span style="color: #24292f;background-color: #f6f8fa">,</span> user_meta<span style="color: #0550ae">.</span>out_port<span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">}</span>
            <span style="color: #6e7781">// ... later ingress code goes here ...
</span>        <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Approach 2: Add extra parameters to the action</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this case, add a 1-bit parameter indicating whether to drop the
packet later.  An <code>if</code> statement is still needed after applying the
table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="color: #24292f;background-color: #f6f8fa"><code data-lang="p4">    <span style="color: #cf222e">action</span> set_output_port <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">PortId_t</span> p<span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #953800">bit</span><span style="color: #0550ae">&lt;</span><span style="color: #0550ae">1</span><span style="color: #0550ae">&gt;</span> drop<span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
        user_meta<span style="color: #0550ae">.</span>out_port <span style="color: #0550ae">=</span> p<span style="color: #24292f;background-color: #f6f8fa">;</span>
        user_meta<span style="color: #0550ae">.</span>drop <span style="color: #0550ae">=</span> drop<span style="color: #24292f;background-color: #f6f8fa">;</span>
    <span style="color: #24292f;background-color: #f6f8fa">}</span>

    <span style="color: #6e7781">// ...
</span>
        <span style="color: #cf222e">apply</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
            <span style="color: #6e7781">// ... earlier ingress code goes here ...
</span>            lag<span style="color: #0550ae">.</span><span style="color: #cf222e">apply</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
            <span style="color: #cf222e">if</span> <span style="color: #24292f;background-color: #f6f8fa">(</span>user_meta<span style="color: #0550ae">.</span>drop <span style="color: #0550ae">==</span> <span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">)</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
                ingress_drop<span style="color: #24292f;background-color: #f6f8fa">(</span>ostd_meta<span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">}</span> <span style="color: #cf222e">else</span> <span style="color: #24292f;background-color: #f6f8fa">{</span>
                send_to_port<span style="color: #24292f;background-color: #f6f8fa">(</span>ostd_meta<span style="color: #24292f;background-color: #f6f8fa">,</span> user_meta<span style="color: #0550ae">.</span>out_port<span style="color: #24292f;background-color: #f6f8fa">);</span>
            <span style="color: #24292f;background-color: #f6f8fa">}</span>
            <span style="color: #6e7781">// ... later ingress code goes here ...
</span>        <span style="color: #24292f;background-color: #f6f8fa">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In either case, an implementation might also support putting the <code>if</code>
statement inside of the action <code>set_output_port</code>, but this is not
required by PSA.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-revision-history">Appendix H: Revision History</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_changes_made_in_version_1_2">H.1. Changes made in version 1.2</h3>
<div class="paragraph">
<p>Version 1.2 was released December 22, 2022.</p>
</div>
<div class="paragraph">
<p>Summary of changes.  For some of these, additional explanation is
provided in sub-sections below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add <code>@p4runtime_translation</code> annotations for all seven PSA numeric
types in <code>psa.p4</code> (all changes in file <code>psa.p4</code>).</p>
</li>
<li>
<p>Add clarifications on <code>@p4runtime_translation</code> annotation behavior
(<a href="#sec-data-plane-vs-control-plane-values">Chapter 5</a>).</p>
</li>
<li>
<p>Add documentation about the behavior of each <code>match_kind</code>
(<a href="#sec-match-kinds">Section 4.3</a>).</p>
</li>
<li>
<p>Add explanation why there is no packet length field defined in PSA
(<a href="#sec-initial-values-egress">Section 7.5</a>).</p>
</li>
<li>
<p>Add match_kind <code>optional</code> (<a href="#sec-match-kinds">Section 4.3</a>).</p>
</li>
<li>
<p>Changed <code>psa.p4</code> file explicitly so that it is <em>not</em> usable for
compiling, by adding an <code>#error</code> preprocessor directive to it.
Added a copy of <code>psa-for-bmv2.p4</code> from open source <code>p4c</code> compiler to
<code>examples</code> directory for quick testing of correct syntax of example
programs (all changes in file <code>psa.p4</code>).</p>
</li>
<li>
<p>Remove control plane API function signatures from comments in file
<code>psa.p4</code> (all changes in file <code>psa.p4</code>).</p>
</li>
<li>
<p>Replace <code>@noWarnUnused</code> with standard <code>@noWarn("unused")</code>
annotations in <code>psa.p4</code> (all changes in file <code>psa.p4</code>).</p>
</li>
<li>
<p>Add <code>assert</code> and <code>assume</code> extern functions (all changes in file <code>psa.p4</code>).</p>
</li>
<li>
<p>Clarifications of the behavior for different possible values of
table property <code>psa_idle_timeout</code> (<a href="#sec-idle-timeout">Section 8.2.1</a>).</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_add_match_kind_optional">H.1.1. Add match_kind <code>optional</code></h4>
<div class="paragraph">
<p>This match kind was added to the v1model architecture in early 2020,
and seems useful in that it (a) provides additional information about
how the control plane plans to configure the matching rules of a
table, and (b) the additional restrictions it has over match kind
<code>ternary</code> provides opportunities for target devices to implement it
more efficiently than <code>ternary</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_remove_control_plane_api_function_signatures">H.1.2. Remove control plane API function signatures</h4>
<div class="paragraph">
<p>As a historical note, the control plane API function signatures that
were formerly given in comments preceded by the string
<code>@ControlPlaneAPI</code> were added very early in the process of writing
version 1.0 of the PSA specification, and were never reviewed
thoroughly.  The P4Runtime API specification version 1.0 was being
developed at the same time as version 1.0 of the PSA specification.
They were removed because we believe that no one ever implemented
precisely those APIs for any P4-programmable device (although similar
APIs have been implemented), and their presence was confusing those
new to the PSA specification, who believed that those function
signatures were required to be implemented.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_changes_made_in_version_1_1">H.2. Changes made in version 1.1</h3>
<div class="paragraph">
<p>Version 1.1 was released November 22, 2018.</p>
</div>
<div class="paragraph">
<p>Summary of changes.  For some of these, additional explanation is
provided in sub-sections below.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define numeric translation between P4Runtime API control plane and
data plane values.</p>
</li>
<li>
<p>Add the ability for packet clone sessions to create multiple copies.</p>
</li>
<li>
<p>Add <code>psa_idle_timeout</code> table property.</p>
</li>
<li>
<p>Add <code>psa_empty_group_action</code> table property.</p>
</li>
<li>
<p>No longer require PSA implementation to support <code>Digest</code> extern
instances in the egress pipeline.</p>
</li>
<li>
<p>Several changes to the <code>psa.p4</code> include file.</p>
</li>
<li>
<p>Several changes to example PSA programs in the <code>examples</code> directory.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_numeric_translation_between_p4runtime_api_values_and_data_plane_values">H.2.1. Numeric translation between P4Runtime API values and data plane values</h4>
<div class="paragraph">
<p>There was a series of meetings after PSA v1.0 was released to refine
the details of the plan to do numeric translation of values with type
<code>PortId_t</code> (and <code>ClassOfService_t</code>, and optionally other types in the
future).  PSA v1.1 reflects the latest design for how to accomplish
this.  Changes can be found here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Section 4.1 "PSA type definitions"</p>
</li>
<li>
<p>Section 4.4 "Data plane vs. control plane data representations"</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_add_the_ability_for_packet_clone_sessions_to_create_multiple_copies">H.2.2. Add the ability for packet clone sessions to create multiple copies</h4>
<div class="paragraph">
<p>In PSA v1.0, requesting to make a clone of a packet was restricted to
creating a single clone, sent to a single output port.  In PSA v1.1
you may now configure a clone session with a set of
<code>(egress_port, instance)</code> pairs, similar to how a multicast group can
be configured.  Changes can be found here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Section 6.2. "Behavior of packets after ingress processing is complete"</p>
</li>
<li>
<p>Section 6.4.5 "Multicast and clone copies" (formerly called "Multicast copies")</p>
</li>
<li>
<p>Section 6.5 "Behavior of packets after egress processing is complete"</p>
</li>
<li>
<p>Section 6.8 "Packet Cloning"</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_add_psa_idle_timeout_table_property">H.2.3. Add psa_idle_timeout table property</h4>
<div class="paragraph">
<p>Adding this brings PSA v1.1 up to date with the support for this
feature in the P4Runtime API.  Using this table property enables the
P4 developer to specify that a table must maintain some state of when
the last time each table entry was matched, and if an entry remains
unmatched for longer than a time configured by the controller, then a
notification message should be sent to the controller.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Section 7.2.1 "Table entry timeout notification"</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_add_psa_empty_group_action_table_property">H.2.4. Add psa_empty_group_action table property</h4>
<div class="paragraph">
<p>PSA v1.0 did not specify the behavior of a table with an
<code>ActionSelector</code> implementation, if a packet matched a table entry
that was configured with an empty action selector group.</p>
</div>
<div class="paragraph">
<p>PSA v1.1 recommends (but does not require) that implementations
support a new <code>psa_empty_group_action</code> table property, whose value is
an action that should be executed when this situation occurs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Section 7.12 "Action Selector"</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_other_changes">H.2.5. Other changes</h4>
<div class="paragraph">
<p>In PSA v1.0, the <code>Digest</code> extern was required to be supported in both
the <code>IngressDeparser</code> and <code>EgressDeparser</code> control blocks.  It is now
no longer required to be supported in the <code>EgressDeparser</code> control
block.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Table 5 "Summary of controls that can instantiate and invoke externs"</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_changes_to_the_psa_p4_include_file">H.2.6. Changes to the psa.p4 include file</h4>
<div class="ulist">
<ul>
<li>
<p>Updates for the latest plan on P4Runtime API numerical translation
of type <code>PortId_t</code> and <code>ClassOfService_t</code>.</p>
</li>
<li>
<p>Eliminate obsolete <code>ValueSet</code> extern, because the <code>value_set</code>
construct was added to the P4<sub>16</sub> language specification in version
1.1.0.</p>
</li>
<li>
<p>Fix a few typos in example control plane APIs in comments.</p>
</li>
<li>
<p>Eliminate <code>PSA_SWITCH</code> <code>#define</code> macro with arguments, since the
P4<sub>16</sub> language spec does not require that the P4<sub>16</sub> pre-processor
support such macros.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_changes_to_example_psa_programs_in_the_p4_16psaexamples_directory">H.2.7. Changes to example PSA programs in the <code>p4-16/psa/examples</code> directory</h4>
<div class="ulist">
<ul>
<li>
<p>Small changes required to bring them in harmony with the latest
details on P4Runtime API numerical translation of type <code>PortId_t</code>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. It is expected that `psa.p4` include files for different targets will typically be nearly identical to each other. Besides the possibility of differing bit widths for these PSA types, the only expected differences between `psa.p4` files for different targets would be annotations on externs, etc. that the P4 compiler for that target needs to do its job.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. The P4Runtime API is defined as a Google Protocol Buffer `.proto` file and an accompanying English specification document here: <a href="https://github.com/p4lang/p4runtime" class="bare">https://github.com/p4lang/p4runtime</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. While 10 Mbits sounds tiny to one accustomed to computers with hundreds of gigabytes of DRAM, the highest speed PSA implementations are ASICs that must keep tables in on-chip memories, similar to caches in general purpose CPUs.  The Intel i9-7980XE released in 2017 has 198 Mbits of on-chip L3 cache shared by its CPU cores.  Among Intel processors in Intel&#8217;s 7th generation Core released in 2017 with at least 100 Mbits of L3 cache, they all cost close to $9 per Mbit of L3 cache. <a href="https://en.wikipedia.org/wiki/List_of_Intel_microprocessors" class="bare">https://en.wikipedia.org/wiki/List_of_Intel_microprocessors</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. The open source `p4c` P4 compiler is planned to support an option to enable numerical translation for additional types, without modifying your P4 program, nor the `psa.p4` include file.  These additional types would be specified by their name.
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. <a href="https://en.wikipedia.org/wiki/Cut-through_switching" class="bare">https://en.wikipedia.org/wiki/Cut-through_switching</a>
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. <a href="http://p4.org/p4/inband-network-telemetry" class="bare">http://p4.org/p4/inband-network-telemetry</a>
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. <a href="https://en.wikipedia.org/wiki/Dynamic_frequency_scaling" class="bare">https://en.wikipedia.org/wiki/Dynamic_frequency_scaling</a>
</div>
<div class="footnote" id="_footnotedef_8">
<a href="#_footnoteref_8">8</a>. <a href="https://en.wikipedia.org/wiki/Precision_Time_Protocol" class="bare">https://en.wikipedia.org/wiki/Precision_Time_Protocol</a>
</div>
<div class="footnote" id="_footnotedef_9">
<a href="#_footnoteref_9">9</a>. <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol" class="bare">https://en.wikipedia.org/wiki/Network_Time_Protocol</a>
</div>
<div class="footnote" id="_footnotedef_10">
<a href="#_footnoteref_10">10</a>. Pavol Cerny, Nate Foster, Nilesh Jagnik, and Jedidiah McClurg, "Consistent Network Updates in Polynomial Time". International Symposium on Distributed Computing (DISC), Paris, France, September 2016.
</div>
<div class="footnote" id="_footnotedef_11">
<a href="#_footnoteref_11">11</a>. <a href="https://en.wikipedia.org/wiki/Explicit_Congestion_Notification" class="bare">https://en.wikipedia.org/wiki/Explicit_Congestion_Notification</a>
</div>
<div class="footnote" id="_footnotedef_12">
<a href="#_footnoteref_12">12</a>. <a href="https://en.wikipedia.org/wiki/Embarrassingly_parallel" class="bare">https://en.wikipedia.org/wiki/Embarrassingly_parallel</a>
</div>
<div class="footnote" id="_footnotedef_13">
<a href="#_footnoteref_13">13</a>. Here and elsewhere in P4 specification documents, the term "pipeline" refers to a portion of a P4 implementation that implements, for example, the behavior of IngressParser, Ingress, then IngressDeparser in PSA.  This is by now traditional in P4 specifications, and although we will not try to change that here, note that there are other reasonable hardware designs that can accomplish this goal that few would call a pipeline, e.g. a collection of CPU cores running in parallel, each processing different packets.
</div>
<div class="footnote" id="_footnotedef_14">
<a href="#_footnoteref_14">14</a>. S. Kandula, D. Katabi, S. Sinha, and A. Berger, "Dynamic load balancing without packet reordering", ACM SIGCOMM Computer Communication Review, Vol. 37, No. 2, April 2007
</div>
<div class="footnote" id="_footnotedef_15">
<a href="#_footnoteref_15">15</a>. M. Laor and L. Gendel, "The effect of packet reordering in a backbone link on application throughput", IEEE Network, 2002.
</div>
</div>
<div id="footer">
<div id="footer-text">
Version v1.2<br>
Last updated 2024-11-14 07:19:19 UTC
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>